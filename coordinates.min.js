const e="https://srmcgann.github.io/Coordinates";import*as a from"https://srmcgann.github.io/GenHash/hash.js";const t=document.createElement("script");await t.setAttribute("src",e+"/zip.js"),await document.body.appendChild(t);const r=Math.sin,o=Math.cos,n=Math.random;var i=!1;const s=document.createElement("canvas"),c=s.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1});new Image;var l;const p={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},h=async e=>{var a=0,t=0,n=0,i=1920,s=1080,c=0,l=0,p=0,h=2e3,u=!0,f=10,m=!1,d=.2,g=!1,v="default",y=!1,b=0,x="",R={mode:"webgl2",options:{alpha:!0,antialias:!1,desynchronized:!0,premultipliedAlpha:!1}},E=[];void 0!==e&&Object.keys(e).forEach(((r,o)=>{switch(r.toLowerCase()){case"plugins":e[r].map((e=>{if("post processing"===e.type.toLowerCase())if(void 0===e.enabled||e.enabled){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map((e=>e.toLowerCase())):[]};E.push(a)}}));break;case"width":i=e[r];break;case"height":s=e[r];break;case"alpha":g=e[r];break;case"x":a=e[r];break;case"y":t=e[r];break;case"z":n=e[r];break;case"roll":c=e[r];break;case"pitch":l=e[r];break;case"yaw":p=e[r];break;case"fov":h=e[r];break;case"clearcolor":e[r];break;case"attachtobody":u=!!e[r];break;case"exportgpuspecs":m=!!e[r];break;case"margin":f=e[r];break;case"cameramode":v=e[r];break;case"ambientlight":d=e[r];break;case"showcrosshair":y=!!e[r];break;case"crosshairsel":b=e[r];break;case"crosshairmap":x=e[r];break;case"context":R.mode=e[r].mode,R.options=e[r].options}}));const M=document.createElement("canvas"),A=M.getContext(R.mode,R.options);M.width=i,M.height=s,M.tabIndex=0,M.style.outline="none";const T=R.mode;if("2d"!=R.mode&&(console.log(`GLSL version: ${A.getParameter(A.SHADING_LANGUAGE_VERSION)}`),A.pixelStorei(A.UNPACK_ALIGNMENT,1)),m&&be(A),"2d"===R.mode);else A.viewport(0,0,M.width,M.height);var _,P;u&&(M.style.display="block",M.style.position="absolute",M.style.left="50vw",M.style.top="50vh",M.style.transform="translate(-50%, -50%)",M.style.background="#000",document.body.appendChild(M)),window.addEventListener("resize",_=e=>{var a,t=P.margin,r=document.body,o=0!==M.width?M.height/M.width:1;r.clientHeight/r.clientWidth>o?(M.style.width=(a=r.clientWidth)-2*t+"px",M.style.height=a*o-2*t+"px"):(M.style.height=(a=r.clientHeight)-2*t+"px",M.style.width=a/o-2*t+"px")}),P={c:M,ctx:A,contextType:T,t:0,alpha:g,width:i,height:s,x:a,y:t,z:n,roll:c,pitch:l,yaw:p,fov:h,ready:!1,ambientLight:d,pointLights:[],pointLightCols:[],alphaQueue:[],particleQueue:[],lineQueue:[],active:!0,cameraMode:v,showCrosshair:y,crosshairSel:b,crosshairMap:x,pageX:undefined,pageY:undefined,mouseX:undefined,mouseY:undefined,mouseButton:undefined,rsz:_,margin:f,optionalPlugins:E},_(),P["2d"==T?"ctx":"gl"]=A;var I=P;I.Clear=()=>{if("2d"===T)M.width=I.c.width;else A.clearColor(0,0,0,1),A.clear(A.COLOR_BUFFER_BIT),A.clear(A.DEPTH_BUFFER_BIT)};return I.Draw=(e,a=!1,t=!1)=>{var n,i,s=e.shader.datasets[e.datasetIdx],c=s.program;if(I.optionalPlugins.map((e=>{if("post processing"===e.name)if("equirectangular"===e.value)e.enabled&&(n=!0,I.equirectangularPlugin=!0,i=!(-1==e.params.indexOf("omitsplitcheck")));else n=!1,I.equirectangularPlugin=!1})),void 0!==e?.shader)if(!a&&(e.isSprite||e.isLight&&e.showSource)){switch(e.shapeType){case"sprite":case"point light":l="alphaQueue"}I[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...I[l]]}else{if(!a&&(e.isLine||e.isParticle)){var l;switch(e.shapeType){case"particles":l="particleQueue";break;case"lines":l="lineQueue"}I[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...I[l]]}A.useProgram(c);for(var p=0;p<(n&&!i?2:1);p++){if(A.uniform1i(s.locRotationMode,e.rotationMode),I.locPlugin=A.getUniformLocation(s.program,"plugin"),I.locOmitSplitCheck=A.getUniformLocation(s.program,"omitSplitCheck"),I.locSplitCheckPass=A.getUniformLocation(s.program,"splitCheckPass"),A.uniform1f(I.locPlugin,n?1:0),A.uniform1f(I.locOmitSplitCheck,i?1:0),A.uniform1f(I.locSplitCheckPass,p),e.showBounding)z(e,I,e.showBounding,n,i,p);if("particles"==e.shapeType||e.isParticle||"lines"==e.shapeType||e.isLine){if(I.ctx.blendFunc(A.ONE,A.SRC_ALPHA),I.ctx.enable(A.BLEND),A.uniform1f(s.locPointSize,e.size*(t?3:1)),"lines"==e.shapeType&&A.lineWidth(e.size*(t?3:1)),A.uniform1f(s.locIsParticle,e.isParticle),A.uniform1f(s.locIsLine,e.isLine),A.uniform1f(s.locPenumbraPass,e.penumbraPass?1:0),A.uniform1f(s.locT,I.t),A.uniform1f(s.locColorMix,e.colorMix),A.uniform1f(s.locIsSprite,e.isSprite),A.uniform1f(s.locIsLight,e.isLight),A.uniform1f(s.locCameraMode,"fps"==I.cameraMode.toLowerCase()?1:0),A.uniform1f(s.locAlpha,Math.min(1,Math.max(0,t?e.alpha*e.penumbra:e.alpha))),A.uniform3f(s.locColor,...ye(e.color)),A.uniform1f(s.locAmbientLight,P/8),A.uniform2f(s.locResolution,I.width,I.height),A.uniform3f(s.locCamPos,I.x,I.y,I.z),A.uniform3f(s.locCamOri,I.roll,I.pitch,I.yaw),A.uniform3f(s.locGeoPos,e.x,e.y,e.z),A.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),A.uniform1f(s.locFov,I.fov),A.uniform1f(s.locEquirectangular,e.equirectangular?1:0),A.uniform1f(s.locRenderNormals,0),e?.vertices?.length){var h,u,f,m,d,g,v,y,b,x;if(e.isLine){m=[];for(var R=I.fov,E=e.size*(t?4:1)/50,M=0;M<e.vertices.length;M+=6)F=e.vertices[M+0],L=e.vertices[M+1],U=e.vertices[M+2],k=e.vertices[M+3],S=e.vertices[M+4],B=e.vertices[M+5],g=C(F,L,U,e,I),v=C(k,S,B,e,I),(g[2]>-200&&v[0]>-200||n)&&(d=Math.atan2(v[0]-g[0],v[1]-g[1])+Math.PI/2,g[0]-=I.width/2,g[1]-=I.height/2,v[0]-=I.width/2,v[1]-=I.height/2,g[0]/=R/2,g[1]/=R/2,v[0]/=R/2,v[1]/=R/2,x=g[2],y=g[0]+r(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]-r(d)*E/x,b=g[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]+r(d)*E/x,b=v[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]+r(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x));m=new Float32Array(m),u=A.createBuffer(),A.bindBuffer(A.ARRAY_BUFFER,u),A.bufferData(A.ARRAY_BUFFER,m,A.STATIC_DRAW),A.bindBuffer(A.ARRAY_BUFFER,null),f=new Uint32Array(Array(m.length/3).fill().map(((e,a)=>a))),h=A.createBuffer(),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,h),A.bufferData(A.ELEMENT_ARRAY_BUFFER,f,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null)}else m=e.vertices,h=e.Vertex_Index_Buffer,u=e.vertex_buffer,f=e.vIndices;A.bindBuffer(A.ARRAY_BUFFER,u),A.bufferData(A.ARRAY_BUFFER,m,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,h),A.bufferData(A.ELEMENT_ARRAY_BUFFER,f,A.STATIC_DRAW),A.bindBuffer(A.ARRAY_BUFFER,u),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,h),s.locPosition=A.getAttribLocation(s.program,"position"),A.vertexAttribPointer(s.locPosition,3,A.FLOAT,!1,0,0),A.enableVertexAttribArray(s.locPosition),e.isLine?A.drawElements(A.TRIANGLES,m.length/3|0,A.UNSIGNED_INT,0):A.drawElements(A.POINTS,e.vertices.length/3|0,A.UNSIGNED_INT,0),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null)}if(I.ctx.blendFunc(A.ONE,A.ZERO),I.ctx.disable(A.BLEND),t)return}else{switch(A.activeTexture(A.TEXTURE0),e.textureMode){case"video":case"dataArray":w(A,s.resource,s.texture,e.textureMode,I.t,e);break;case"canvas":A.activeTexture(A.TEXTURE2),w(A,e.canvasTexture,s.texture,e.textureMode,I.t,e);break;case"image":e.rebindTextures&&w(A,e.image,s.texture,e.textureMode,I.t,e)}void 0!==e.canvasTexture&&(A.activeTexture(A.TEXTURE2),w(A,e.canvasTexture,s.supplementalTexture,"canvas",I.t,e),A.uniform1i(s.locSupplementalTexture,2),A.uniform1f(s.locSupplementalTextureMix,e.canvasTextureMix)),A.activeTexture(A.TEXTURE0),A.uniform1i(s.locTexture,s.texture),A.bindTexture(A.TEXTURE_2D,s.texture),e.heightMap?(A.activeTexture(A.TEXTURE4),A.uniform1i(s.locHeightMap,4),w(A,s.heightResource,s.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,I.t,e),A.uniform1i(s.locHeightTexture,s.heightTexture),A.uniform1f(s.locUseHeightMap,1),A.uniform1f(s.locHeightMapIntensity,e.heightMapIntensity),A.uniform1f(s.locMaxHeightmap,e.maxHeightmap),A.uniform1f(s.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),A.bindTexture(A.TEXTURE_2D,s.heightTexture),A.activeTexture(A.TEXTURE0)):A.uniform1f(s.locUseHeightMap,0),A.uniform1i(s.locPointLightCount,I.pointLights.length);var T=[],_=[];I.pointLights.map((e=>{T.push(e.x,e.y,e.z,e.lum);ye(e.color);_.push(...ye(e.color),1)})),T.length&&(A.uniform4fv(s.locPointLights,T),A.uniform4fv(s.locPointLightCols,_));var P=I.ambientLight;if(s.optionalLighting.map((e=>{if("ambientLight"===e.name)P=e.value})),s.optionalUniforms.map((a=>{if("object"==typeof a?.loc)switch(A[a.dataType](a.loc,a.value),A.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"reflection":A.activeTexture(A.TEXTURE1),"image"==a.textureMode&&e.rebindTextures&&w(A,a.image,a.refTexture,a.textureMode,I.t,a),"video"==a.textureMode&&w(A,a.video,a.refTexture,a.textureMode,I.t,a),A.useProgram(c),A.activeTexture(A.TEXTURE1),A.uniform1i(a.locRefTexture,1),A.bindTexture(A.TEXTURE_2D,a.refTexture),A.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"refraction":A.activeTexture(A.TEXTURE5),"video"==a.textureMode&&w(A,a.video,a.refractionTexture,a.textureMode,I.t,a),A.useProgram(c),A.activeTexture(A.TEXTURE5),A.uniform1i(a.locRefractionTexture,5),A.bindTexture(A.TEXTURE_2D,a.refractionTexture),A.uniform1f(a.locRefractionOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0),a.locAngleOfRefraction=A.getUniformLocation(s.program,"angleOfRefraction"),A.uniform1f(a.locAngleOfRefraction,a.angleOfRefraction),A.bindBuffer(A.ARRAY_BUFFER,a.refractionVec_buffer),A.bufferData(A.ARRAY_BUFFER,a.refractionVecs,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),A.bufferData(A.ELEMENT_ARRAY_BUFFER,a.refractionVecIndices,A.STATIC_DRAW),A.bindBuffer(A.ARRAY_BUFFER,a.refractionVec_buffer),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),A.vertexAttribPointer(s.locRefractionlVec,3,A.FLOAT,!1,0,0),A.enableVertexAttribArray(s.locRefractionlVec),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null);break;case"phong":a.locPhongTheta=A.getUniformLocation(s.program,"phongTheta"),A.uniform1f(a.locPhongTheta,a.theta+Math.PI);break;case"custom":if(a.uniformName){a.locCustomUniform=A.getUniformLocation(s.program,a.uniformName);var t=a.value;pe(t)?A[a.dataType](a.locCustomUniform,...a.value):A[a.dataType](a.locCustomUniform,a.value)}}})),A.uniform1f(s.locT,I.t),A.uniform1f(s.locIsParticle,e.isParticle),A.uniform1f(s.locIsLine,e.isLine),A.uniform1f(s.locPenumbraPass,0),A.uniform1f(s.locColorMix,e.colorMix),A.uniform1f(s.locIsSprite,e.isSprite),A.uniform1f(s.locIsLight,e.isLight),A.uniform1f(s.locCameraMode,"fps"==I.cameraMode.toLowerCase()?1:0),A.uniform1f(s.locAlpha,e.alpha),A.uniform3f(s.locColor,...ye(e.color)),A.uniform1f(s.locAmbientLight,P/8),A.uniform2f(s.locResolution,I.width,I.height),A.uniform3f(s.locCamPos,I.x,I.y,I.z),A.uniform3f(s.locCamOri,I.roll,I.pitch,I.yaw),A.uniform3f(s.locGeoPos,e.x,e.y,e.z),A.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),A.uniform1f(s.locFov,I.fov),A.uniform1f(s.locEquirectangular,e.equirectangular?1:0),A.uniform1f(s.locRenderNormals,0),A.bindBuffer(A.ARRAY_BUFFER,e.uv_buffer),A.bufferData(A.ARRAY_BUFFER,e.uvs,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),A.bufferData(A.ELEMENT_ARRAY_BUFFER,e.uvIndices,A.STATIC_DRAW),A.vertexAttribPointer(s.locUv,2,A.FLOAT,!1,0,0),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null),e?.normalVecs.length&&(A.bindBuffer(A.ARRAY_BUFFER,e.normalVec_buffer),A.bufferData(A.ARRAY_BUFFER,e.normalVecs,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),A.bufferData(A.ELEMENT_ARRAY_BUFFER,e.nIndices,A.STATIC_DRAW),A.bindBuffer(A.ARRAY_BUFFER,e.normalVec_buffer),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),s.locNormalVec=A.getAttribLocation(s.program,"normalVec"),A.vertexAttribPointer(s.locNormalVec,3,A.FLOAT,!1,0,0),A.enableVertexAttribArray(s.locNormalVec),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null)),e?.vertices?.length){if(A.bindBuffer(A.ARRAY_BUFFER,e.vertex_buffer),n){for(M=0;M<e.vertices;M+=9){var F=e.vertices[M+0],L=e.vertices[M+1],U=e.vertices[M+2],k=e.vertices[M+3],S=e.vertices[M+4],B=e.vertices[M+5];e.vertices[M+6],e.vertices[M+7],e.vertices[M+8]}A.bufferData(A.ARRAY_BUFFER,[],A.STATIC_DRAW)}else A.bufferData(A.ARRAY_BUFFER,e.vertices,A.STATIC_DRAW);A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),A.bufferData(A.ELEMENT_ARRAY_BUFFER,e.vIndices,A.STATIC_DRAW),A.bindBuffer(A.ARRAY_BUFFER,e.vertex_buffer),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),s.locPosition=A.getAttribLocation(s.program,"position"),A.vertexAttribPointer(s.locPosition,3,A.FLOAT,!1,0,0),A.enableVertexAttribArray(s.locPosition),A.drawElements(e.wireframe?A.LINE_STRIP:A.TRIANGLES,e.vertices.length/3|0,A.UNSIGNED_INT,0),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null)}A.uniform1f(s.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(A.bindBuffer(A.ARRAY_BUFFER,e.normal_buffer),A.bufferData(A.ARRAY_BUFFER,e.normals,A.STATIC_DRAW),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),A.bufferData(A.ELEMENT_ARRAY_BUFFER,e.nIndices,A.STATIC_DRAW),A.vertexAttribPointer(s.locNormal,3,A.FLOAT,!1,0,0),s.locNormal=A.getAttribLocation(s.program,"normal"),A.bindBuffer(A.ARRAY_BUFFER,e.normal_buffer),A.bufferData(A.ARRAY_BUFFER,e.normals,A.STATIC_DRAW),A.enableVertexAttribArray(s.locNormal),A.drawElements(A.LINES,e.normals.length/3|0,A.UNSIGNED_INT,0),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindBuffer(A.ARRAY_BUFFER,null))}}}e.rebindTextures=!1},I.nullShader=await B(I,[{uniform:{type:"phong",value:0}}]),I.alphaShader=await B(I,[]),window.addEventListener("mousemove",(e=>{var a=I.c.getBoundingClientRect();I.mouseX=(e.pageX-a.left)/I.c.clientWidth*I.width,I.mouseY=(e.pageY-a.top)/I.c.clientHeight*I.height})),window.addEventListener("mousedown",(e=>{I.mouseButton=e.buttons})),window.addEventListener("mouseup",(e=>{I.mouseButton=-1})),I},u=(e,a,t)=>{if(e.width=a,e.height=t,e.c.width=a,e.c.height=t,e.rsz(),"2d"===e.ctx.mode);else e.ctx.viewport(0,0,e.c.width,e.c.height)},f=e=>{e.c.remove(),e.active=!1},m=e=>{if("point light"===e.shapeType)e.renderer.pointLights=e.renderer.pointLights.filter(((a,t)=>t!=e.pointLightID)),e.renderer.pointLights.map(((e,a)=>e.pointLightID=a))},g=(e,a,t,r,o,n)=>{var i;e.split("\n").forEach((e=>{var n=e.split(" ");switch(n[0]){case"v":n.shift(),a.push(n.map((e=>+e)));break;case"vt":n.shift(),r.push(n.map((e=>+e)));break;case"vn":n.shift(),t.push(n.map((e=>+e)));break;case"f":n.shift(),o.push(n.map((e=>e)))}})),o.map((e=>{var o,s,c,l=[],p=[],h=[],u=!1;if(e.map((e=>{var n=e.split("/");switch(n.length){case 1:o=n[0],l.push(a[o-1]);break;case 2:o=n[0],s=n[1],l.push(a[o-1]),p.push(r[s-1]),!0;break;case 3:o=n[0],s=n[1],c=n[2],l.push(a[o-1]),p.push(r[s-1]),h.push(t[c-1]),u=!0}})),void 0!==l[0]){var f=l[0][0],m=l[0][1],d=l[0][2],g=l[1][0],v=l[1][1],y=l[1][2],b=l[2][0],x=l[2][1],R=l[2][2];if(u)var E=h[0][0],M=h[0][1],A=h[0][2],T=h[1][0],_=h[1][1],P=h[1][2],I=h[2][0],F=h[2][1],L=h[2][2];if(4==l.length){var w=l[3][0],U=l[3][1],k=l[3][2];if(u)var C=h[3][0],z=h[3][1],S=h[3][2]}}switch(l.length){case 3:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+M,d+A],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+F,R+L])})),h=i,n.vertices.push(...l[0],...l[1],...l[2]),p.length&&void 0!==p[0]&&n.uvs.push(...p[0],...p[1],...p[2]),h.length&&void 0!==h[0]&&n.normals.push(...h[0],...h[1],...h[2]);break;case 4:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+M,d+A],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+F,R+L],[w,U,k,w+C,U+z,k+S])})),h=i,n.vertices.push(...l[0],...l[1],...l[2],...l[2],...l[3],...l[0]),p.length&&n.uvs.push(...p[0],...p[1],...p[2],...p[2],...p[3],...p[0]),h.length&&n.normals.push(...h[0],...h[1],...h[2],...h[2],...h[3],...h[0])}}))},v=(e,a=0,t=0,r=0,o=0,n=0,i=0)=>{for(var s=0;s<e.uvs.length;s+=2)e.uvs[s+1]=1-e.uvs[s+1];for(s=0;s<e.normals.length;s+=3)e.normals[s+1]=e.normals[s+1];for(s=0;s<e.vertices.length;s+=3){var c=[e.vertices[s+0],e.vertices[s+1],e.vertices[s+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.vertices[s+0]=c[0],e.vertices[s+1]=c[1],e.vertices[s+2]=c[2];for(var l=2;l--;){var p=l?2*s:2*s+3;c=[e.normals[p+0],e.normals[p+1],e.normals[p+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.normals[p+0]=c[0],e.normals[p+1]=c[1],e.normals[p+2]=c[2]}}},y=async(e,a,t,r,o,n,i,s,c=!0,h=!0)=>{var u={vertices:[],normals:[],uvs:[]};if(h&&(l=p.objFiles.filter((a=>a.url==e))).length)u=l[0].ret;else{var f=[],m=[],d=[],y=[];await fetch(e).then((e=>e.text())).then((e=>{g(e,f,m,d,y,u)})),p.objFiles=[...structuredClone(p.objFiles),{url:e,ret:u}]}return v(u,t,r,o,n,i,s),u},b=(e,a,t,r,o=700)=>[r.width/2+e/t*o,r.height/2+a/t*o],x=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},R=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},E=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},M=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},A=(e,a,t)=>{var r=[],o=a.name,n={loaded:!1,curFrame:0,geometries:[],dir:1};return fetch(a.url).then((e=>e.blob())).then((i=>{new zip.ZipReader(new zip.BlobReader(i)).getEntries().then((i=>{var s=i.length;r=Array(s).fill().map((e=>({data:{}}))),i.forEach((async(i,c)=>{(await i.getData(await new zip.BlobWriter)).text().then((i=>{do{0}while("PK"==i.substr(0,2));if("custom shape"!=a.shapeType&&"lines"!=a.shapeType||(i=JSON.parse(i)),r[c].data=i,c==s-1){n.loaded=!0;var l=new zip.ZipWriter(new zip.BlobWriter);r.forEach(((r,i)=>{var c=(""+(i+1)).padStart(4,"0");i%1||!("lines"!=a.shapeType&&"custom shape"!=a.shapeType||void 0!==r.data.vertices&&r.data.vertices.length)||(a.geometryData=r.data,a.name=`${o?o+"_":""}frame${c}.json`,a.isFromZip=!0,I(e,a).then((async e=>{n.geometries[i/1|0]=e,await t.ConnectGeometry(e);for(var r=[],o=[],c=[],p=[],h=0;h<e.vertices.length;h++)r.push(Math.round(1e3*e.vertices[h])/1e3);for(h=0;h<e.uvs.length;h++)p.push(Math.round(1e3*e.uvs[h])/1e3);for(h=0;h<e.normals.length;h+=3)o.push(Math.round(1e3*e.normals[h+0])/1e3),o.push(Math.round(1e3*e.normals[h+1])/1e3),o.push(Math.round(1e3*e.normals[h+2])/1e3);for(h=0;h<e.normalVecs.length;h++)c.push(Math.round(1e3*e.normalVecs[h])/1e3);var u={vertices:r,uvs:p,normals:o,normalVecs:c},f=new zip.TextReader(JSON.stringify(u)),m=(""+(i+1)).padStart(4,"0");l.add(`frame_${m}.json`,f),i==s-1&&a.downloadShape&&await P(await l.close(),"animation.zip")})))}))}}))}))}))})),n},T=(e,a,t)=>{var r=e.t,o=0,n=0,i=0,s=0,c=0,l=0,p="reverse",h=1;if(void 0!==t&&Object.keys(t).forEach(((e,a)=>{switch(e.toLowerCase()){case"x":o=+t[e];break;case"y":n=+t[e];break;case"z":i=+t[e];break;case"roll":s=+t[e];break;case"pitch":c=+t[e];break;case"yaw":l=+t[e];break;case"loopmode":p=t[e];break;case"animationspeed":h=1/+t[e]|0}})),void 0!==a&&a.loaded&&a.geometries.length){for(var u=1;u--;){if(!h||(60*r|0)%h||(a.curFrame+=a.dir),a.curFrame>=a.geometries.length-("cycle"==p?0:1))if("cycle"===p)a.curFrame=0;else a.dir=-1;if(a.curFrame<("cycle"==p?0:1))if("cycle"===p)a.curFrame=a.geometries.length-1;else a.dir=1}var f=a.geometries[a.curFrame];void 0!==f&&void 0!==f.vertices&&f.vertices.length&&(f.x=o,f.y=n,f.z=i,f.roll=s,f.pitch=c,f.yaw=l,e.Draw(f))}},_=e=>{if(e.preComputeNormalAssocs){console.log("downloading custom shape, detected preComputeNormalAssocs");var a=[]}for(var t=[],r=[],o=[],n=[],i=0;i<e.vertices.length;i++)t.push(Math.round(1e3*e.vertices[i])/1e3);for(i=0;i<e.uvs.length;i++)n.push(Math.round(1e3*e.uvs[i])/1e3);for(i=0;i<e.normals.length;i++)r.push(Math.round(1e3*e.normals[i])/1e3);for(i=0;i<e.normalVecs.length;i++)o.push(Math.round(1e3*e.normalVecs[i])/1e3);if(e.preComputeNormalAssocs)for(i=0;i<e.normalAssocs.length;i++)a.push(e.normalAssocs[i]);if(e.preComputeNormalAssocs)var s={vertices:t,uvs:n,normals:r,normalVecs:o,normalAssocs:a};else s={vertices:t,uvs:n,normals:r,normalVecs:o};var c=document.createElement("a");c.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s)),e.name||e.name,c.download=e.name+".json",c.click()},P=(e,a="downloaded_file")=>{var t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download=a,t.click(),window.URL.revokeObjectURL(e)},I=async(a,t)=>{var r,o,n,i,s,c,h,u,f,m,d,b,x,R,M,A,T,P,I,F,L;const w=a.gl;var U,k,C,z=!1,B=!1,N=0,O=0,D=0,Y=!1,Z=!1,J=!1,te=0,re=0,oe=0,ne=1,ie=1,se=1,ce=1,le=1,pe=0,he=0,ue=!1,fe=16,me=40,de="",ge="",ve=1,ye=!1,be=0,xe=0,Re=3355443,Ee=.1,Me=-1,Ae=0,Te=-1,_e=!1,Pe=!1,Ie=!1,Fe="",Le="",we=1,Ue=6e6,ke=!1,Ce=-1,ze=!0,Se=8978210,Be=!1,Ne=0,Oe=0,Ve=0,De=0,Ye=!1,Xe=0,He=1,Ge=!0,qe="image",We=!1,je=!1,Ke=!1,$e=512,Qe=512,Ze=w.RGBA,Je=!1,ea=512,aa=512,ta=w.RGBA,ra=1,oa=1,na=[],ia=[],sa={};Object.keys(t).forEach(((e,a)=>{if("showsource"===e.toLowerCase())We=!!t[e]})),Object.keys(t).forEach(((a,l)=>{switch(a.toLowerCase()){case"x":N=t[a];break;case"y":O=t[a];break;case"z":D=t[a];break;case"roll":te=t[a];break;case"pitch":re=t[a];break;case"yaw":oe=t[a];break;case"shapetype":switch(M=t[a].toLowerCase()){case"sprite":Fe=`${e}/resources/sprite.png`;break;case"point light":Fe=We?`${e}/resources/stars/star.png`:""}break;case"size":ve=t[a];break;case"subs":be=t[a];break;case"equirectangular":Me=!!t[a];break;case"equirectangularheightmap":Te=!!t[a];break;case"flipnormals":Pe=!!t[a];break;case"shownormals":Ie=!!t[a];break;case"sphereize":xe=t[a];break;case"rotationmode":Ae=t[a];break;case"rebindtextures":ue=!!t[a];break;case"flipx":Y=t[a];break;case"flipy":Z=t[a];break;case"flipz":J=t[a];break;case"objx":r=t[a];break;case"objy":o=t[a];break;case"objz":n=t[a];break;case"objroll":i=t[a];break;case"objpitch":s=t[a];break;case"objyaw":c=t[a];break;case"scaleuvx":ce=t[a];break;case"scaleuvy":le=t[a];break;case"offsetuvx":pe=t[a];break;case"offsetuvy":he=t[a];break;case"scalex":ne=t[a];break;case"scaley":ie=t[a];break;case"scalez":se=t[a];break;case"wireframe":Ye=!!t[a];break;case"name":ge=t[a];break;case"color":Re=t[a];break;case"colormix":Ee=t[a];break;case"mapisdataarray":Ke=!!t[a];break;case"dataarraywidth":$e=+t[a];break;case"dataarrayheight":Qe=+t[a];break;case"dataarrayformat":Ze=t[a];break;case"heightmapisdataarray":Je=!!t[a];break;case"heightmapdataarraywidth":ea=+t[a];break;case"heightmapdataarrayheight":aa=+t[a];break;case"heightpamdataarrayformat":ta=t[a];break;case"exportshape":z=!!t[a];break;case"downloadshape":B=!!t[a];break;case"penumbra":Xe=t[a];break;case"url":de=t[a];break;case"map":Fe=t[a];break;case"heightmap":Le=t[a];break;case"heightmapintensity":we=t[a];break;case"maxheightmap":Ue=+t[a];break;case"heightmapiscanvas":ke=!!t[a];break;case"rows":fe=t[a];break;case"cols":me=t[a];break;case"disabledepthtest":je=t[a];break;case"canvastexturemix":Ce=t[a];break;case"canvastexture":F=t[a],qe="canvas";break;case"involvecache":Ge=!!t[a];break;case"muted":ze=!!t[a];break;case"lum":ra=t[a];break;case"alpha":oa=t[a];break;case"geometrydata":na=t[a];break;case"precomputenormalassocs":_e=!!t[a];break;case"texcoords":ia=t[a];break;case"boundingcolor":Se=t[a];break;case"showbounding":Be=!!t[a];break;case"issprite":Ne=t[a]?1:0;break;case"islight":Oe=t[a]?1:0;break;case"isparticle":Ve=t[a]?1:0;break;case"isline":De=t[a]?1:0;break;case"playbackspeed":He=t[a];break;case"averagenormals":ye=!!t[a];break;default:sa[a]=t[a]}})),void 0===r&&(r=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0!==t.canvasTexture?(-1==Ce&&(Ce=1),k=t.canvasTexture,delete t.canvasTexture):Ce=0,t.heightMapIsCanvas&&(C=t.heightMap,delete t.heightMap),t=structuredClone(t),void 0!==k&&(t.canvasTexture=k),void 0!==C&&(t.heightMap=C);var ca,la,pa=[],ha=[],ua=[],fa=[],ma=!1,da=!1;if(-1!=M.indexOf("custom shape")||de&&"lines"==M)ca=de,la=`${M} ${ge} (${de})`;else if(la=`${M}_${be}`,be<5&&la)switch(la){case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"cylinder_0":case"torus_0":case"torus knot_0":if("cylinder_0"!=la&&"torus_0"!=la||"cylinder_0"==la&&16==fe&&40==me||"torus_0"==la&&16==fe&&40==me||"torus knot_0"==la&&16==fe&&40==me)if(ma=!0,ca=`${de=`${e}/new%20shapes/`}${la}.json`,Ge&&(l=p.geometry.filter((e=>e.url==ca))).length)console.log(`found geometry (${la}) in cache... using it`),void 0!==(ga=l[0].data).normalAssocs&&(L=ga.normalAssocs),ua=new Float32Array(ga.vertices),ha=new Float32Array(ga.normals),fa=new Float32Array(ga.normalVecs),pa=new Float32Array(ga.uvs),da=!0,ma=!0;else await fetch(ca).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),ua=e.vertices,ha=e.normals,fa=e.normalVecs,pa=e.uvs,p.geometry.push({data:structuredClone(e),url:ca})})),ma=!0}if(!ma)switch(M){case"custom shape":case"lines":if("lines"==M){if(!de)break;De=!0}var ga;if(void 0===na.vertices&&Ge&&(l=p.customShapes.filter((e=>e.url==de))).length)console.log("found custom shape in cache... using it"),void 0!==(ga=l[0].data).normalAssocs&&(L=ga.normalAssocs),ua=ga.vertices,ha=ga.normals,fa=ga.normalVecs,pa=ga.uvs,ma=!0,da=!0;ma||(void 0!==na.vertices&&na.vertices.length?(void 0!==na.normalAssocs&&(L=na.normalAssocs),ua=na.vertices,ha=na.normals,fa=na.normalVecs,pa=na.uvs,ma=!0):await fetch(ca).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),ua=e.vertices,ha=e.normals,fa=e.normalVecs,pa=e.uvs,ma=!0,p.customShapes.push({data:structuredClone(e),url:de})})))}if(ma)switch(M){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==Me&&(Me=!0),-1==Te&&(Te=!0)}else switch(M){case"tetrahedron":-1==Me&&(Me=!0),-1==Te&&(Te=!0),(U=await q(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"octahedron":-1==Me&&(Me=!0),-1==Te&&(Te=!0),(U=await W(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"icosahedron":-1==Me&&(Me=!0),-1==Te&&(Te=!0),(U=await j(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"torus":(U=await H(ve,be,xe,Pe,M,fe,me)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"torus knot":(U=await G(ve,be,fe,me,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"cylinder":(U=await X(ve,be,fe,me,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"dynamic":(U=await V(na,ia,ve,be,xe,Pe,!!na.filter((e=>4==e.length)).length,M)).geometry.map((e=>{ua.push(...e.position),Pe?ha.push(...e.normal.map((e=>-1*e))):ha.push(...e.normal),void 0!==e.texCoord&&e.texCoord.length&&pa.push(...e.texCoord)}));break;case"lines":De=1,na.map((e=>{ua.push(...e)}));break;case"bspline":De=1,t.omitShape=!0,await ae(a,t).then((e=>{e.curve.map((e=>{ua.push(...e)}))}));break;case"curveto":De=1,t.omitShape=!0,await ee(a,t).then((e=>{e.map((e=>{ua.push(...e)}))}));break;case"cube":(U=await $(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"rectangle":(U=await Q(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"sprite":Ne=!0,(U=await Q(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"particles":Ve=1,na.map((e=>{ua.push(...e)}));break;case"point light":Oe=!0,(U=We?await Q(Math.max(ve,.5),be+1,xe,Pe,M):{geometry:[]}).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}));break;case"obj":if(na.length){var va={vertices:[],normals:[],uvs:[]};g(na,[],[],[],[],va),v(va),ua=va.vertices,ha=va.normals,pa=va.uvs,ma=!0}else U=await y(de,0,0,0,0,0,0,0,c,!1),ua=U.vertices,ha=U.normals,pa=U.uvs;break;case"dodecahedron":-1==Me&&(Me=!0),-1==Te&&(Te=!0),(U=await K(ve,be,xe,Pe,M)).geometry.map((e=>{ua.push(...e.position),ha.push(...e.normal),pa.push(...e.texCoord)}))}if(0!=pe||0!=he)for(var ya=0;ya<pa.length;ya+=2)pa[ya+0]+=pe,pa[ya+1]+=he;if(1!=ce||1!=le)for(ya=0;ya<pa.length;ya+=2)pa[ya+0]*=ce,pa[ya+1]*=le;if("lines"!=M&&"particles"!=M&&!Ve&&"custom shape"!=M&&"obj"!=M||xe||1!=ne||1!=ie||1!=se){var ba=xe,xa=1-xe,Ra=Ve||De?1:ve;for(ya=0;ya<ua.length;ya+=3){var Ea,Ma=ua[ya+0],Aa=ua[ya+1],Ta=ua[ya+2];Ma/=Ea=Math.hypot(Ma,Aa,Ta)+1e-4,Aa/=Ea,Ta/=Ea,Ma*=ba+Ea*xa,Aa*=ba+Ea*xa,Ta*=ba+Ea*xa,ua[ya+0]=Ma*Ra*ne,ua[ya+1]=Aa*Ra*ie,ua[ya+2]=Ta*Ra*se;var _a=ha[2*ya+0],Pa=ha[2*ya+1],Ia=ha[2*ya+2];ha[2*ya+0]+=ua[ya+0]-_a,ha[2*ya+1]+=ua[ya+1]-Pa,ha[2*ya+2]+=ua[ya+2]-Ia,ha[2*ya+3]+=ua[ya+0]-_a,ha[2*ya+4]+=ua[ya+1]-Pa,ha[2*ya+5]+=ua[ya+2]-Ia}}if(ye&&S(ua,ha,M),"dynamic"==M||_e){L=[];for(ya=0;ya<ua.length;ya+=3){for(var Fa=ua[ya+0],La=ua[ya+1],wa=ua[ya+2],Ua=[],ka=0;ka<ua.length;ka+=3){var Ca=ua[ka+0],za=ua[ka+1],Sa=ua[ka+2];Math.hypot(Fa-Ca,La-za,wa-Sa)<.001&&Ua.push(ka)}L.push(Ua)}}if("custom shape"!=M&&!Ve&&!De&&(!da||!ma||ye||z)){fa=[];for(ya=0;ya<ha.length;ya+=6){let e=ha[ya+3]-ha[ya+0],a=ha[ya+4]-ha[ya+1],t=ha[ya+5]-ha[ya+2];fa.push(e,a,t)}}if(("custom shape"==M||"obj"==M)&&(s||i||c||r||o||n))for(ya=0;ya<ua.length;ya+=3){N=ua[ya+0],O=ua[ya+1],D=ua[ya+2];var Ba=E(N,O,D,{roll:i,pitch:s,yaw:c});if(ua[ya+0]=Ba[0]+r,ua[ya+1]=Ba[1]+o,ua[ya+2]=Ba[2]+n,ha.length){for(var Na=2;Na--;){N=ha[2*ya+0+3*Na],O=ha[2*ya+1+3*Na],D=ha[2*ya+2+3*Na];Ba=E(N,O,D,{roll:i,pitch:s,yaw:c});ha[2*ya+0+3*Na]=Ba[0]+r,ha[2*ya+1+3*Na]=Ba[1]+o,ha[2*ya+2+3*Na]=Ba[2]+n}N=fa[ya+0],O=fa[ya+1],D=fa[ya+2];Ba=E(N,O,D,{roll:i,pitch:s,yaw:c});fa[ya+0]=Ba[0],fa[ya+1]=Ba[1],fa[ya+2]=Ba[2]}}if(Y)for(ya=0;ya<ua.length;ya+=3)ua[ya+1]*=-1;if(Z)for(ya=0;ya<ua.length;ya+=3)ua[ya+1]*=-1;if(J)for(ya=0;ya<ua.length;ya+=3)ua[ya+1]*=-1;if(Pe&&!z){for(ya=0;ya<ha.length;ya+=6)ha[ya+3]=ha[ya+0]-(ha[ya+3]-ha[ya+0]),ha[ya+4]=ha[ya+1]-(ha[ya+4]-ha[ya+1]),ha[ya+5]=ha[ya+2]-(ha[ya+5]-ha[ya+2]);for(ya=0;ya<fa.length;ya+=3)fa[ya+0]*=-1,fa[ya+1]*=-1,fa[ya+2]*=-1}if(z&&"background"!==ge){var Oa=document.createElement("div");Oa.style.position="fixed",Oa.style.zIndex=1e5,Oa.style.left="50%",Oa.style.top="50%",Oa.style.transform="translate(-50%, -50%)",Oa.style.background="#0008",Oa.style.padding="20px",Oa.style.width="600px",Oa.style.height="350px",Oa.style.border="1px solid #fff4",Oa.style.borderRadius="5px",Oa.style.fontFamily="monospace",Oa.style.fontSize="20px",Oa.style.color="#fff";var Va=document.createElement("div");Va.style.fontSize="24px",Va.style.color="#0f8c",Va.innerHTML=`Export Coordinates File -> ${M} `+(t?.name?`(${t.name})`:"")+"<br><br>",Oa.appendChild(Va);var Da=document.createElement("div");Da.style.minWidth="100%",Da.style.height="250px",Da.style.background="#333",Da.style.border="1px solid #fff4",Da.style.overflowY="auto",Da.style.wordWrap="break-word",Da.style.color="#888",Da.style.fontSize="10px",Oa.appendChild(Da);var Ya=document.createElement("button");Ya.style.border="none",Ya.style.padding="3px",Ya.style.cursor="pointer",Ya.fontSize="20px",Ya.style.borderRadius="10px",Ya.style.margin="10px",Ya.style.minWidth="100px",Ya.innerHTML="ðŸ“‹ copy",Ya.title="copy shape data to clipboard",Ya.onclick=()=>{var e=document.createRange();e.selectNode(Da),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),Ya.innerHTML="COPIED!",setTimeout((()=>{Ya.innerHTML="ðŸ“‹ copy"}),1e3)},Oa.appendChild(Ya);var Xa=document.createElement("button");Xa.onclick=()=>Oa.remove(),Xa.style.border="none",Xa.style.padding="3px",Xa.style.cursor="pointer",Xa.fontSize="20px",Xa.style.borderRadius="10px",Xa.style.margin="10px",Xa.style.background="#faa",Xa.style.minWidth="100px",Xa.innerHTML="close",Oa.appendChild(Xa);var Ha={vertices:[],normals:[],normalVecs:[],uvs:[]};ua.map((e=>Ha.vertices.push(Math.round(1e3*e)/1e3))),sa.preComputeNormalAssocs&&(Ha.normalAssocs=[],sa.normalAssocs.map((e=>Ha.vertices.push(e))));for(ya=0;ya<ha.length;ya+=6){Fa=ha[ya+0],La=ha[ya+1],wa=ha[ya+2],Ca=Pe?ha[ya+0]-(ha[ya+3]-ha[ya+0]):ha[ya+3],za=Pe?ha[ya+1]-(ha[ya+4]-ha[ya+1]):ha[ya+4],Sa=Pe?ha[ya+2]-(ha[ya+5]-ha[ya+2]):ha[ya+5];Fa=Math.round(1e3*Fa)/1e3,La=Math.round(1e3*La)/1e3,wa=Math.round(1e3*wa)/1e3,Ca=Math.round(1e3*Ca)/1e3,za=Math.round(1e3*za)/1e3,Sa=Math.round(1e3*Sa)/1e3,Ha.normals.push(Fa,La,wa,Ca,za,Sa)}for(ya=0;ya<fa.length;ya++)Ha.normalVecs.push((Pe?-1:1)*Math.round(1e3*fa[ya])/1e3);pa.map((e=>Ha.uvs.push(Math.round(1e3*e)/1e3))),Da.innerHTML=JSON.stringify(Ha),document.body.appendChild(Oa)}da||(ua=new Float32Array(ua),ha=new Float32Array(ha),fa=new Float32Array(fa),pa=new Float32Array(pa)),h=w.createBuffer(),w.bindBuffer(w.ARRAY_BUFFER,h),w.bufferData(w.ARRAY_BUFFER,ua,w.STATIC_DRAW),w.bindBuffer(w.ARRAY_BUFFER,null),A=new Uint32Array(Array(ua.length/3).fill().map(((e,a)=>a))),u=w.createBuffer(),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,u),w.bufferData(w.ELEMENT_ARRAY_BUFFER,A,w.STATIC_DRAW),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,null),d=w.createBuffer(),w.bindBuffer(w.ARRAY_BUFFER,d),w.bufferData(w.ARRAY_BUFFER,fa,w.STATIC_DRAW),w.bindBuffer(w.ARRAY_BUFFER,null),P=new Uint32Array(Array(fa.length/3).fill().map(((e,a)=>a))),b=w.createBuffer(),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,b),w.bufferData(w.ELEMENT_ARRAY_BUFFER,P,w.STATIC_DRAW),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,null),f=w.createBuffer(),w.bindBuffer(w.ARRAY_BUFFER,f),w.bufferData(w.ARRAY_BUFFER,ha,w.STATIC_DRAW),w.bindBuffer(w.ARRAY_BUFFER,null),T=new Uint32Array(Array(ha.length/3).fill().map(((e,a)=>a))),m=w.createBuffer(),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,m),w.bufferData(w.ELEMENT_ARRAY_BUFFER,T,w.STATIC_DRAW),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,null),x=w.createBuffer(),w.bindBuffer(w.ARRAY_BUFFER,x),w.bufferData(w.ARRAY_BUFFER,pa,w.STATIC_DRAW),w.bindBuffer(w.ARRAY_BUFFER,null),I=new Uint32Array(Array(pa.length/2).fill().map(((e,a)=>a))),R=w.createBuffer(),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,R),w.bufferData(w.ELEMENT_ARRAY_BUFFER,I,w.STATIC_DRAW),w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,null),-1==Me&&(Me=!1),-1==Te&&(Te=!1);var Ga={x:N,y:O,z:D,rows:fe,cols:me,roll:te,pitch:re,yaw:oe,color:Re,colorMix:Ee,size:ve,subs:be,name:ge,url:de,averageNormals:ye,showNormals:Ie,exportShape:z,downloadShape:B,shapeType:Ve?"particles":De?"lines":M,normalAssocs:L,sphereize:xe,equirectangular:Me,flipNormals:Pe,vertices:ua,normals:ha,normalVecs:fa,uvs:pa,vertex_buffer:h,Vertex_Index_Buffer:u,normal_buffer:f,Normal_Index_Buffer:m,muted:ze,normalVec_buffer:d,NormalVec_Index_Buffer:b,nVecIndices:P,uv_buffer:x,UV_Index_Buffer:R,vIndices:A,nIndices:T,uvIndices:I,map:Fe,video:undefined,textureMode:qe,isSprite:Ne,isLight:Oe,playbackSpeed:He,disableDepthTest:je,lum:ra,alpha:oa,involveCache:Ge,renderer:a,isParticle:Ve,isLine:De,penumbra:Xe,wireframe:Ye,canvasTexture:F,canvasTextureMix:Ce,showBounding:Be,boundingColor:Se,heightMap:Le,heightMapIntensity:we,heightMapIsCanvas:ke,equirectangularHeightmap:Te,flipX:Y,flipY:Z,flipZ:J,isFromZip:false,rotationMode:Ae,mapIsDataArray:Ke,dataArrayFormat:Ze,maxHeightmap:Ue,dataArrayWidth:$e,dataArrayHeight:Qe,preComputeNormalAssocs:_e,heightmapIsDataArray:Je,heightmapDataArrayFormat:ta,heightmapDataArrayWidth:ea,heightmapDataArrayHeight:aa,rebindTextures:ue};return Object.keys(Ga).forEach(((e,a)=>{sa[e]=Ga[e]})),"particles"==sa.shapeType||Ve||"lines"==sa.shapeType||De?await a.alphaShader.ConnectGeometry(sa):("point light"!=M&&"sprite"!=M||(void 0===t.color&&(sa.color=11184810),"point light"==M&&(sa.pointLightID=a.pointLights.length,a.pointLights.push(sa))),await a.nullShader.ConnectGeometry(sa)),sa.downloadShape&&_(sa),sa},F=async(e="",a=!1,t=(()=>{}),r=400,o=300)=>{var n=document.createElement("div");n.className="genericPopup",n.style.position="fixed",n.style.zIndex=1e5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.background="#0008",n.style.padding="20px",n.style.width=`${r}px`,n.style.height=`${o}px`,n.style.border="1px solid #fff4",n.style.borderRadius="5px",n.style.fontFamily="monospace",n.style.fontSize="20px",n.style.color="#fff";var i=document.createElement("div");if(i.style.fontSize="24px",i.style.color="#0f8c",i.innerHTML=e,n.appendChild(i),a){var s=document.createElement("button");s.onclick=()=>{t(),n.remove()},s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="SURE!",n.appendChild(s)}var c=document.createElement("button");c.onclick=()=>n.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",n.appendChild(c),document.body.appendChild(n)},L=e=>{let a=e;if(!Z(e.width)||!Z(e.height)){let t,r,o=document.createElement("canvas"),n=o.getContext("2d",{imageSmoothingEnabled:!0}),i=8,s=0,c=6e6,l=Math.hypot(e.width,e.height);for(let e=0;e<16;e++)(t=Math.abs(s-l))<c&&(c=t,s=i*2**e,r=e);s-=i*2**(r-1),o.width=s,o.height=s,n.drawImage(e,0,0,o.width,o.height),a=new Image,a=o}return a},w=(e,a,t,r="image",o=-1,n={},i=!0)=>{let h;switch(r){case"canvas":case"heightImage":h=a;break;case"dataArray":h=n.map,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"heightmapDataArray":h=n.heightMap,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"video":i&&(l=p.texImages.filter((e=>e.url==n.map&&-1!=o&&e.tVal==o))).length?(console.log("found video texture in cache... using it"),h=l[0].texImage):(h=(e=>{if(void 0!==e){let a,t;if(s.width!=e.videoWidth||s.height!=e.videoHeight?(a=e.videoWidth,t=e.videoHeight):(a=s.width,t=s.height),!Z(a)||!Z(t)){let e,r,o=8,n=0,i=6e6,s=Math.hypot(a,t);for(let a=0;a<12;a++)(e=Math.abs(n-s))<i&&(i=e,n=o*2**a,r=a);n-=o*2**(r-1),n=Math.min(512,n),a=n/1,t=n/1}s.width==a&&s.width==t||(s.width=a,s.height=t),c.drawImage(e,0,0,a,t)}else s.width=1,s.height=1;return s})(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}));break;case"image":i&&(l=p.texImages.filter((e=>e.url==n.map))).length?(console.log("found image texture in cache... using it"),h=l[0].texImage):(h=L(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}))}e.bindTexture(e.TEXTURE_2D,t),"dataArray"==r?void 0!==n.dataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.dataArrayFormat,n.dataArrayWidth,n.dataArrayHeight,0,n.dataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):"heightmapDataArray"==r?void 0!==n.heightmapDataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.heightmapDataArrayFormat,n.heightmapDataArrayWidth,n.heightmapDataArrayHeight,0,n.heightmapDataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):void 0!==h&&h.width&&h.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},U=e=>{var a=e.vertices;e.preComputeNormalAssocs=!0,e.normalAssocs=[];for(var t=0;t<a.length;t+=3){for(var r=a[t+0],o=a[t+1],n=a[t+2],i=[],s=0;s<a.length;s+=3){var c=a[s+0],l=a[s+1],p=a[s+2];Math.hypot(r-c,o-l,n-p)<.001&&i.push(s)}e.normalAssocs.push(i)}},k=(e,a=!1,t=!1,r=!0,o=0,n=0,i=0)=>{for(var s,c,l,p,h,u,f,m,d,g,v=[],y=0;y<e.vertices.length;y+=9)s=e.vertices[y+0],c=e.vertices[y+1],l=e.vertices[y+2],p=e.vertices[y+3],h=e.vertices[y+4],u=e.vertices[y+5],f=e.vertices[y+6],m=e.vertices[y+7],d=e.vertices[y+8],g=ne([[s,c,l],[p,h,u],[f,m,d]],r,o,n,i),v.push(g);var b=e.flipNormals?1:-1;if(v.map(((a,t)=>{for(var r=0;r<3;r++)e.normals[18*t+6*r+0]=e.vertices[9*t+3*r+0],e.normals[18*t+6*r+1]=e.vertices[9*t+3*r+1],e.normals[18*t+6*r+2]=e.vertices[9*t+3*r+2],e.normals[18*t+6*r+3]=e.vertices[9*t+3*r+0]+(a[3]-a[0])*b,e.normals[18*t+6*r+4]=e.vertices[9*t+3*r+1]+(a[4]-a[1])*b,e.normals[18*t+6*r+5]=e.vertices[9*t+3*r+2]+(a[5]-a[2])*b,e.normalVecs[9*t+3*r+0]=e.normals[18*t+6*r+3]-e.normals[18*t+6*r+0],e.normalVecs[9*t+3*r+1]=e.normals[18*t+6*r+4]-e.normals[18*t+6*r+1],e.normalVecs[9*t+3*r+2]=e.normals[18*t+6*r+5]-e.normals[18*t+6*r+2]})),a){(void 0===e.normalAssocs||e.normalAssocs.length!=e.vertices.length/3|0)&&(console.log("generating normal assocs"),U(e));var x=structuredClone(e.normalVecs);for(y=0;y<e.normalVecs.length;y+=3){var R=y/3,E=[0,0,0];e.normalAssocs[R].forEach((e=>{0;for(var a=0;a<3;a++)E[a]+=x[e+a]}));for(var M=0;M<3;M++)e.normalVecs[y+M]=E[M]/=3,e.normals[2*y+M]=e.vertices[y+M],e.normals[2*y+M+3]=e.vertices[y+M]+E[M]}}},C=(e,a,t,n,i,s=0,c=0,l=0,p=0,h=0,u=!1,f=!0,m=0)=>{var d,g,v,y;if(n.heightMap&&Ee.length){var b;if(n.equirectangularHeightmap){var x,E=e,A=a,T=t,_=Math.hypot(E,A,T);b=[S=(x=Math.atan2(E,T))/Math.PI/2,N=Math.acos(A/(Math.hypot(E,A,T)+1e-5))/Math.PI]}else b=[p,h];var P=4*((Me.width*b[0]|0)+(Me.height*Me.width*b[1]|0)),I=Ee[P+0]/256,F=Ee[P+1]/256,L=Ee[P+2]/256,w=Math.min(n.maxHeightmap,(I+F+L)/3*n.heightMapIntensity/2);e+=s*w,a+=c*w,t+=l*w}e=(y=R(e,a*=-1,t,{roll:1e-4-n.roll,pitch:-n.pitch,yaw:n.yaw},!1))[0],a=y[1],t=y[2],n.isLight&&(e=(y=M(e,a,t,{roll:i.roll,pitch:i.pitch,yaw:-i.yaw},!1))[0],a=y[1],t=y[2]);var U=i.x,k=i.y,C=i.z;e+=n.x,a-=n.y,t+=n.z,"fps"==i.cameraMode.toLowerCase()?(e=(y=R(e+=U,a-=k,t+=C,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],t=y[2],U=0,k=0,C=0):(e=(y=R(e,a,t,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],t=y[2]);var z=!1;if(u){d=e+U,g=a-k,v=t+C;var S,B;_=Math.hypot(d,g,v);f?S=Math.atan2(d,v)/Math.PI:0==m?(x=Math.atan2(d,v)+Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)<=-1,S+=.5):(x=Math.atan2(d,v)-Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)>=1,S-=.5);var N=-(Math.acos(g/(_+1e-4))/Math.PI*2-1);return!z&&[i.width/2+S*i.width/2,i.height/2+N*i.height/2,_]}e+=U,a-=k,t-=C;var O=i.fov;return(v=t+(C/1e3*O+C))>0&&[d=i.width/2+e/v*O/2,g=i.height/2+a/v*O/2,v]},z=(e,a,t=!0,r=-1,o=!0,n=0)=>{if(-1==r&&(r=a.equirectangularPlugin),e.isLight)return[];var i,s,c,l,p,h=[],u=[];const f=(e,a,r=-1,o=9)=>{r!=a&&(r=a,h.push(a),M=e[a][0],A=e[a][1],l=p=-9,e.map(((t,r)=>{r!=a&&(T=e[r][0],_=e[r][1],(d=Math.atan2(_-A-1e-5,M-T))>=l&&d<=o&&(l=d,p=r))})),-9!=p&&(t&&u.push(...e[p]),f(e,p,r,l)))};var m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,F=[],L=-1,w=1e6,U=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(Me.width=U.heightResource.videoWidth/2,Me.height=U.heightResource.videoHeight/2):(Me.width=U.heightResource.width/2,Me.height=U.heightResource.height/2),Ae.drawImage(U.heightResource,0,0,Me.width,Me.height),Ee=Me.width?Ae.getImageData(0,0,Me.width,Me.height).data:[]);for(var k=0;k<e.vertices.length;k+=3){(!e.isLine||k%2)&&(e.isLine||!e.isParticle&&k%9)||(g=v=0,m=[]),i=e.vertices[k+0],s=e.vertices[k+1],c=e.vertices[k+2],y=k+0<e.normalVecs.length?e.normalVecs[k+0]:0,b=k+1<e.normalVecs.length?e.normalVecs[k+1]:0,x=k+2<e.normalVecs.length?e.normalVecs[k+2]:0;var z=2*(k/3|0);R=z+0<e.uvs.length?e.uvs[z+0]:0,E=z+1<e.uvs.length?e.uvs[z+1]:0;var S=C(i,s,c,e,a,y,b,x,R,E,r,o,n);S&&(m.push([S[0],S[1]]),g+=S[0],v+=S[1],(e.isLine&&k%9==3||!e.isLine&&(e.isParticle||k%9==6))&&(g/=3,v/=3,Math.hypot(g-L,v-w)>10&&(L=g,w=v,F.push(m))))}e.isParticle||e.isLine?(m=[],F.map(((e,a)=>{M=e[0][0],A=e[0][1],m.filter((e=>e[0]==M&&e[1]==A)).length||m.push([M,A])}))):(m=[],F.map(((e,a)=>{e.length>2&&(M=e[0][0],A=e[0][1],T=e[1][0],_=e[1][1],P=e[2][0],I=e[2][1],m.filter((e=>e[0]==M&&e[1]==A)).length||m.push([M,A]),m.filter((e=>e[0]==T&&e[1]==_)).length||m.push([T,_]),m.filter((e=>e[0]==P&&e[1]==I)).length||m.push([P,I]))})));var B,N=6e6,O=-1;if(m.map(((e,a)=>{e[1]<=N&&(O=a,N=e[1])})),m.length&&(f(m,O),t)){var V=ve(e.boundingColor);Re.ctx.strokeStyle=`rgba(${256*V[0]},${256*V[1]},${256*V[2]},.5)`,Re.ctx.globalAlpha=1,Re.ctx.beginPath(),u.map(((e,a)=>{Re.ctx.lineWidth=10;var t=u[a][0],r=u[a][1],i=u[B=(a+1)%u.length][0],s=u[B][1];o?(Re.ctx.moveTo(t,r),Re.ctx.lineTo(i,s)):0==n?t>=Re.width/2-Re.width/8&&t<Re.width+Re.width/8&&i>=Re.width/2-Re.width/8&&i<Re.width+Re.width/8&&(Re.ctx.moveTo(t,r),Re.ctx.lineTo(i,s)):t<=Re.width/2+Re.width/8&&t>-Re.width/8&&i<=Re.width/2+Re.width/8&&i>-Re.width/8&&(Re.ctx.moveTo(t,r),Re.ctx.lineTo(i,s))})),Re.ctx.stroke()}return h.map((e=>[m[e][0],m[e][1]]))},S=(e,a,t)=>{for(var r,o=[],n=O(t),i=0;i<e.length;i+=3)i%9||(r=ne([[e[i+0],e[i+1],e[i+2]],[e[i+3],e[i+4],e[i+5]],[e[i+6],e[i+7],e[i+8]]],n)),o[2*i+0]=e[i+0],o[2*i+1]=e[i+1],o[2*i+2]=e[i+2],o[2*i+3]=e[i+0]+(r[0]-r[3]),o[2*i+4]=e[i+1]+(r[1]-r[4]),o[2*i+5]=e[i+2]+(r[2]-r[5]);var s,c,l,p,h,u,f,m,d,g,v,y,b,x=structuredClone(o);for(i=0;i<o.length;i+=6){h=o[i+0],u=o[i+1],f=o[i+2],c=o[i+3],l=o[i+4],p=o[i+5],s=1;for(var R=0;R<o.length;R+=6)R!=i&&(m=o[R+0],d=o[R+1],g=o[R+2],v=o[R+3],y=o[R+4],b=o[R+5],Math.hypot(h-m,u-d,f-g)<.01&&(c+=v,l+=y,p+=b,s++));x[i+3]=c/=s,x[i+4]=l/=s,x[i+5]=p/=s}x.map(((e,a)=>o[a]=e)),o.forEach(((e,t)=>a[t]=e))},B=async(e,a=[])=>{const t=e.gl;var r={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};await a.map((a=>{Object.keys(a).forEach(((t,o)=>{switch(t.toLowerCase()){case"lighting":if("ambientlight"===a[t].type.toLowerCase())if(void 0===a[t]?.enabled||a[t].enabled){var n={name:a[t].type,value:void 0===a[t].value?e.ambientLight:a[t].value};r.optionalLighting.push(n)}break;case"uniform":switch(a[t].type.toLowerCase()){case"custom":if(void 0===a[t]?.enabled||a[t].enabled){var i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,uniformName:void 0===a[t].name?"":a[t].name,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?0:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,dataType:void 0===a[t].dataType?"uniform1f":a[t].dataType,vertDeclaration:void 0===a[t].vertDeclaration?"":a[t].vertDeclaration,vertCode:void 0===a[t].vertCode?"":a[t].vertCode,fragDeclaration:void 0===a[t].fragDeclaration?"":a[t].fragDeclaration,fragCode:void 0===a[t].fragCode?"":a[t].fragCode};r.optionalUniforms.push(i)}break;case"reflection":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:" \n                  ",fragDeclaration:"\n                    uniform float reflection;\n                    uniform float refFlatShading;\n                    uniform float refOmitEquirectangular;\n                    uniform float refFlipRefs;\n                    uniform sampler2D reflectionMap;\n                  ",fragCode:"\n                    //light.rgb *= .5;\n                    //light.rgb += .05;\n                    float refP1, refP2;\n                    if(refOmitEquirectangular != 1.0){\n                      vec3 reflectionPos = R_rpy(nV, vec3(0.0,\n                                                      -camOri.y, -camOri.z));\n                      float px = reflectionPos.x;\n                      float py = reflectionPos.y;\n                      float pz = reflectionPos.z;\n                      refP1 = -atan(px, pz) / M_PI / 4.0;\n                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refFlipRefs == 1.0) refP2 = 1.0 - refP2;\n                    } else {\n                      refP1 = vUv.x;\n                      refP2 = vUv.y;\n                    }\n                    \n                    vec2 refCoords = vec2(1.0 - refP1 * 2.0, refP2);\n                    vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 1.0);\n                    mixColor = merge(mixColor, refCol);\n                    baseColorIp = 1.0 - reflection; //min(1.0, 2.0 - reflection);\n                    //light += reflection / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"refraction":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,angleOfRefraction:void 0===a[t].angleOfRefraction?1:a[t].angleOfRefraction,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,flatShadingUniform:"refractionFlatShading",dataType:"uniform1f",vertDeclaration:"\n                    attribute vec3 nVecRefraction;\n                    varying vec3 nVrefraction;\n                  ",vertCode:"\n                    vec3 nVrefraction = nVecRefraction;\n                  ",fragDeclaration:"\n                    uniform float refraction;\n                    uniform float refractionFlatShading;\n                    uniform float refractionOmitEquirectangular;\n                    uniform float refractionFlipRefs;\n                    uniform float angleOfRefraction;\n                    uniform sampler2D refractionMap;\n                    varying vec3 nVrefraction;\n                  ",fragCode:"\n                    float refractionP1, refractionP2;\n                    float refractionP1a, refractionP2a;\n                    float refractionP1b, refractionP2b;\n                    if(refractionOmitEquirectangular != 1.0){\n\n                      vec3 refractionPos = R_rpy(nV, vec3(0.0,-camOri.y, -camOri.z));\n\n                      float px = refractionPos.x;\n                      float py = refractionPos.y;\n                      float pz = refractionPos.z;\n                      refractionP1a = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2a = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2a = 1.0 - refractionP2a;\n\n                      refractionPos = R_rpy(nVrefraction, vec3(0.0,-camOri.y, -camOri.z));\n                      px = refractionPos.x;\n                      py = refractionPos.y;\n                      pz = refractionPos.z;\n                      refractionP1b = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2b = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2b = 1.0 - refractionP2b;\n\n                      //refractionP1a *= 0.0; //angleOfRefraction;\n                      //refractionP2a *= 1.0; //angleOfRefraction;\n                      //refractionP1 = (refractionP1a + refractionP1b) / 2.0;\n                      //refractionP2 = (refractionP2a + refractionP2b) / 2.0;\n\n                      refractionP1 = refractionP1b;\n                      refractionP2 = refractionP2b;\n\n                    } else {\n                      refractionP1a = vUv.x;\n                      refractionP2a = vUv.y;\n                    }\n                    \n                    vec2 refractionCoords = vec2(1.0 - refractionP1 * 2.0, refractionP2);\n                    vec4 refractionCol = vec4(texture2D(refractionMap, vec2(refractionCoords.x, refractionCoords.y)).rgb * 1.25, refraction / 1.0);\n                    mixColor2 = merge(mixColor2, refractionCol);\n                    baseColorIp2 = 1.0 - refraction;\n                    //light += refraction / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"phong":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,loc:"",value:void 0===a[t].value?.3:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[t].theta?.5:a[t].theta,dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:"\n                    hasPhong = 1.0;\n                  ",fragDeclaration:"\n                    uniform float phong;\n                    uniform float phongTheta;\n                    uniform float phongFlatShading;\n                  ",fragCode:"\n                    if(isLight == 0.0 &&\n                       isSprite == 0.0 &&\n                       isParticle == 0.0 &&\n                       isLine == 0.0){\n                      //light.rgb *= .5;\n                      float phongP1, phongP2;\n                      float px, py, pz;\n                      if(phongFlatShading != 0.0){\n                        px = nVec.x;\n                        py = nVec.y;\n                        pz = nVec.z;\n                      }else{\n                        vec3 phongPos = R_rpy(nV, vec3(camOri.x, 0.0, 0.0));\n                        px = phongPos.x;\n                        py = phongPos.y;\n                        pz = phongPos.z;\n                      }\n\n                      phongP1 = atan(px, pz) + phongTheta;\n                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)));\n                      \n                      //if(refFlipRefs == 1.0) phongP2 = M_PI - phongP2;\n\n                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong +\n                      pow(pow((1.0+cos(phongP1 + M_PI)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong;\n                      light = vec4(light.rgb + fact, 1.0) * 15.0;\n                    }\n                  "};r.optionalUniforms.push(i)}}}}))}));let o={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){t.enable(t.DEPTH_TEST),t.cullFace(t.BACK),e.alpha&&(t.blendFunc(t.SRC_ALPHA,t.ONE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST));let a="";r.optionalUniforms.map((e=>{a+="\n"+e.vertDeclaration+"\n"}));let n="";r.optionalUniforms.map((e=>{n+="\n"+e.vertCode+"\n"}));let s="";r.optionalUniforms.map((e=>{s+="\n"+e.fragDeclaration+"\n"}));let c="";r.optionalUniforms.map((e=>{c+="\n"+e.fragCode+"\n"})),o.vert=`\n      precision highp float;\n      #define M_PI 3.14159265358979323\n      attribute vec2 uv;\n      ${a}\n      \n      uniform float t;\n      uniform vec3 color;\n      uniform float factor;\n      uniform float flatShading;\n      uniform float ambientLight;\n      uniform float plugin;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      uniform int rotationMode;\n      uniform float omitSplitCheck;\n      uniform float splitCheckPass;\n      uniform float pointSize;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float cameraMode;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float penumbraPass;\n      uniform float fov;\n      uniform float equirectangular;\n      uniform float maxHeightmap;\n      uniform float equirectangularHeightmap;\n      uniform float renderNormals;\n      uniform vec2 resolution;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform sampler2D heightMap;\n      attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec3 normalVec;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      \n      vec3 pFunc(vec3 pt, float cosa, float sina,\n                          float cosb, float sinb,\n                          float cosc, float sinc){\n        float xx, xy, xz, yx, yy, yz, zx, zy, zz;\n        xx = cosa*cosb;\n        xy = cosa*sinb*sinc - sina*cosc;\n        xz = cosa*sinb*cosc + sina*sinc;\n        yx = sina*cosb;\n        yy = sina*sinb*sinc + cosa*cosc;\n        yz = sina*sinb*cosc - cosa*sinc;\n        zx = -sinb;\n        zy = cosb*sinc;\n        zz = cosb*cosc;\n        return vec3(xx*pt.x + xy*pt.y + xz*pt.z,\n                    yx*pt.x + yy*pt.y + yz*pt.z,\n                    zx*pt.x + zy*pt.y + zz*pt.z);\n      }\n      vec3 Quat(vec3 pos, vec3 rot, int isGeo){\n        \n        if(isLine != 0.0) return pos;\n        float cosa, sina, cosb, sinb, cosc, sinc;\n        vec3 ret = vec3(pos.x, pos.y, pos.z);\n        if(rotationMode == 0 || isGeo == 0){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 1 && isGeo == 1){\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 2 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 3 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        return ret;\n      }\n      \n      vec3 R(vec3 pos, vec3 rot, int isGeo){\n        if(isLine != 0.0) return pos;\n        \n        float p, d;\n        if(rotationMode == 0 || isGeo == 0) {\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 1 && isGeo == 1) {\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 2 && isGeo == 1) {\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n        }\n        return pos;\n      }\n      \n      void main(){\n        \n        hasPhong = 0.0;\n        \n        float cx, cy, cz;\n        \n        if(renderNormals == 1.0){\n          cx = normal.x;\n          cy = normal.y;\n          cz = normal.z;\n        }else{\n          cx = position.x;\n          cy = position.y;\n          cz = position.z;\n        }\n        \n        if(useHeightMap != 0.0 && renderNormals == 0.0){\n          nVeci = normalVec;\n          vec4 h;\n          float lum;\n\n          if(equirectangularHeightmap != 0.0){\n            float p;\n            float p2;\n            vec3 cpos = vec3(cx, cy, cz);\n            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);\n            float p1;\n            p1 = p / M_PI / 2.0;\n            p2 = flatShading == 1.0 ?\n                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :\n                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n            uvi = vec2(p1, p2);\n          } else {\n            uvi = uv;\n          }\n\n            \n          h = texture2D( heightMap, uvi);\n          lum = min(maxHeightmap, ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0);\n          cx += normalVec.x * lum;\n          cy += normalVec.y * lum;\n          cz += normalVec.z * lum;\n\n          \n        }else{\n          uvi = uv / 2.0;\n          uvi = vec2(uvi.x, .5 - uvi.y);\n          nVeci = normalVec;\n        }\n        \n        fPosi = vec3(cx, cy, cz);\n        \n        // camera rotation\n        \n        vec3 geo, pos;\n        float cpx = camPos.x;\n        float cpy = camPos.y;\n        float cpz = camPos.z;\n        \n        if(cameraMode == 1.0){  // 'FPS' mode\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos,  vec3(0.0, camOri.y, 0.0), 0);\n            pos = Quat(pos,  vec3(0.0, 0.0, camOri.z), 0);\n            pos = Quat(pos,  vec3(camOri.x, 0.0, 0.0), 0);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = Quat(vec3(cx, cy, cz), vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n          }\n          cpx = 0.0;\n          cpy = 0.0;\n          cpz = 0.0;\n          fPos = pos;\n        }else{\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z+M_PI/2.0), 0);\n            pos = vec3(cx, cy, cz);\n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos = Quat(pos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            \n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n          }\n          fPos = pos;\n        }\n        \n        ${n}\n        \n        float camz = cpz / 1e3 * fov;\n        \n        float X, Y;\n        float Z = pos.z + camz + geo.z;\n        if((isLine != 0.0 || isParticle != 0.0) &&\n          penumbraPass != 0.0) Z += .001;\n        if(isLine != 0.0){\n          X = position.x / resolution.x * fov;\n          Y = position.y / resolution.y * fov;\n          Z = position.z;\n          gl_Position = vec4(X, Y, Z/500000.0, 1.0);\n          skip = 0.0;\n          vUv = uv;\n        }else{\n          if( plugin ==  1.0 ){   // equirectangular post-processing plugin\n            X = pos.x + cpx + geo.x;\n            Y = pos.y + cpy + geo.y;\n            Z = pos.z + cpz + geo.z;\n            float dist = sqrt(X*X + Y*Y + Z*Z);\n            float p1;\n            if(omitSplitCheck == 0.0){\n              if(splitCheckPass == 0.0){\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 <= -0.75 ? 1.0 : 0.0;\n                p1 += .5;\n              }else{\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 >= 0.75 ? 1.0 : 0.0;\n                p1 -= .5;\n              }\n            }else{\n              skip = 0.0;\n              p1 = atan(X, Z) / M_PI;\n            }\n            if(skip == 0.0){\n              float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;\n              gl_PointSize = 100.0 * pointSize / dist;\n              gl_Position = vec4(p1, p2, dist/500000.0, 1.0);\n              vUv = uv;\n            }\n          } else {  // default projection\n            X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;\n            Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;\n            if(Z > 0.0) {\n              gl_PointSize = 100.0 * pointSize / Z;\n              gl_Position = vec4(X, Y, Z/500000.0, 1.0);\n              skip = 0.0;\n              vUv = uv;\n            }else{\n              skip = 1.0;\n            }\n          }\n        }\n      }\n    `,o.frag=`\n      #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n      #else\n        precision mediump float;\n      #endif\n      #define M_PI 3.14159265358979323\n      ${s}\n      uniform float t;\n      uniform float factor;\n      uniform vec2 resolution;\n      uniform float plugin;\n      uniform float flatShading;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float cameraMode;\n      uniform vec4 pointLightPos[16];\n      uniform vec4 pointLightCol[16];\n      uniform int pointLightCount;\n      uniform float ambientLight;\n      uniform float renderNormals;\n      uniform float equirectangular;\n      uniform float equirectangularHeightmap;\n      uniform float colorMix;\n      //uniform float penumbraPass;\n      uniform vec3 color;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform float maxHeightmap;\n      uniform sampler2D heightMap;\n      uniform sampler2D baseTexture;\n      uniform sampler2D supplementalTexture;\n      uniform float supplementalTextureMix;\n      uniform float alpha;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      vec3 rgeoPos;\n      float rheightMapIntensity;\n      float rmaxHeightmap;\n\n      vec4 merge (vec4 col1, vec4 col2){\n        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);\n      }\n      \n      vec2 Coords(float flatShading, vec3 nV) {\n        vec2 ret;\n        if(equirectangular == 1.0){\n          float p;\n          float p2;\n          vec3 cpos = fPosi;\n          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n          float p1;\n          p1 = p / M_PI / 2.0;\n          p2 = flatShading == 1.0 ?\n                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n          ret = vec2(p1, p2);\n        }else{\n          ret = vUv;\n        }\n        return ret;\n      }\n\n      vec3 R_ypr(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_yrp(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_rpy(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec4 GetPointLight(){\n        \n        float ret = 0.0;\n        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);\n        for(int i=0; i < 16; i++){\n          //if(i >= pointLightCount) break;\n          vec3 lpos = pointLightPos[i].xyz;\n          lpos.x -= rgeoPos.x; //- camPos.x;\n          lpos.y -= rgeoPos.y; //- camPos.y;\n          lpos.z -= rgeoPos.z; //- camPos.z;\n          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));\n\n          float mag = pointLightPos[i].w;\n          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +\n          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 20.0;\n          \n          rgba.r += ret * pointLightCol[i].r;\n          rgba.g += ret * pointLightCol[i].g;\n          rgba.b += ret * pointLightCol[i].b;\n        }\n        \n        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);\n      }\n\n      void main() {\n\n        rgeoPos = geoPos / factor;\n        rheightMapIntensity = heightMapIntensity / factor;\n        rmaxHeightmap = maxHeightmap / factor;\n\n\n        if(isParticle != 0.0 || isLine != 0.0){\n          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));\n        }else{\n          float mixColorIp = colorMix;\n          float mixColorIp2 = 1.0;\n          float baseColorIp = 1.0 - mixColorIp;\n          float baseColorIp2 = 1.0 - mixColorIp2;\n          vec4 mixColor = vec4(color.rgb, mixColorIp);\n          vec4 mixColor2 = vec4(color.rgb, mixColorIp2);\n          vec4 light = hasPhong == 1.0 ? GetPointLight() :\n                vec4(ambientLight, ambientLight, ambientLight, 1.0);\n          float colorMag = 1.0;\n          if(skip != 1.0){\n            if(renderNormals == 1.0){\n              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }else{\n              float p;\n              vec3 nV, nVi;\n              if(useHeightMap != 0.0){\n                \n                float rad = .02;\n                float rad2 = -.25;\n                vec2 cr1, cr2, cr3;\n                float lum1, lum2, lum3;\n                for(float j=0.0; j<3.0; j+=1.0){\n                  \n                  float tx, ty;\n                  p = M_PI * 2.0 / 3.0 * j;\n                  tx = -sin(p) * rad;\n                  ty = -cos(p) * rad;\n                \n                  vec2 hcoords;\n                  if(equirectangularHeightmap == 1.0){\n                    float p;\n                    float p2;\n                    vec3 cpos = fPosi;\n                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n                    float p1;\n                    p1 = p / M_PI / 2.0;\n                    p2 = flatShading == 1.0 ?\n                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n                    tx += p1;\n                    ty += p2;\n                    hcoords = vec2(tx, ty);\n                  }else{\n                    hcoords = vUv + vec2(tx, ty);\n                  }\n                  \n                  vec4 htexel = texture2D( heightMap, hcoords);\n                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;\n                  if(j == 0.0) {\n                    lum1 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 1.0) {\n                    lum2 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 2.0) {\n                    lum3 = lum;\n                    cr2 = hcoords;\n                  }\n                }\n\n                float a1 = cr1.x;\n                float a2 = cr1.y;\n                float a3 = (lum1 - 0.5) * rad2;\n                \n                float b1 = cr2.x - a1;\n                float b2 = cr2.y - a2;\n                float b3 = (lum2 - 0.5) * rad2 - a3;\n                float c1 = cr3.x - cr2.x;\n                float c2 = cr3.y - cr2.y;\n                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;\n                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * min(maxHeightmap / 5.0, (1.0 + heightMapIntensity) / 2.0);\n                nV = normalize( nVec + anorm);\n                nVi = normalize( nVeci + anorm);\n              }else{\n                nV = nVec;\n                nVi = nVeci;\n              }\n              \n              \n              ${c}\n              vec2 coords = Coords(0.0, nVi);\n              vec4 texel = texture2D( baseTexture, coords);\n              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));\n              if(isSprite != 0.0 || isLight != 0.0){\n                gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);\n              }else{\n                \n                texel.a = baseColorIp / 2.0;\n                vec4 col = merge(mixColor, texel);\n                col.a = 1.0;\n                if(baseColorIp2 != 0.0){\n                  mixColor2.a = baseColorIp2;\n                  col = merge(mixColor2, col); // refractions\n                }\n                col.rgb *= light.rgb;\n                gl_FragColor = vec4(col.rgb * colorMag, 1.0);\n              }\n            }\n          }\n        }\n      }\n    `;const h=t.createShader(t.VERTEX_SHADER);t.shaderSource(h,o.vert),t.compileShader(h);const u=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(u,o.frag),t.compileShader(u),o.ConnectGeometry=(a,n=!1)=>{var s=a.involveCache,c=structuredClone(r);o.datasets.push(c),c.program=t.createProgram(),t.attachShader(c.program,h),t.attachShader(c.program,u),t.linkProgram(c.program),a.shader=o;var f=a.map,m=a.heightMap;if(a.datasetIdx=o.datasets.length-1,t.getProgramParameter(c.program,t.LINK_STATUS)){if(t.useProgram(c.program),t.bindBuffer(t.ARRAY_BUFFER,a.vertex_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=t.getAttribLocation(c.program,"position"),t.vertexAttribPointer(c.locPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locPosition),t.bindBuffer(t.ARRAY_BUFFER,a.uv_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=t.getAttribLocation(c.program,"uv"),t.vertexAttribPointer(c.locUv,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locUv),t.bindBuffer(t.ARRAY_BUFFER,a.normal_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=t.getAttribLocation(c.program,"normal"),t.vertexAttribPointer(c.locNormal,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormal),t.bindBuffer(t.ARRAY_BUFFER,a.normalVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=t.getAttribLocation(c.program,"normalVec"),t.vertexAttribPointer(c.locNormalVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormalVec),!n){if(a.isLight||c.optionalUniforms.map((async e=>{switch(e.name){case"reflection":if(n=e.map){let a,c=(a=n.split("."))[a.length-1].toLowerCase();switch(e.refTexture=t.createTexture(),c){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE1),w(t,e.video,e.refTexture,e.textureMode,-1,{url:n}),p.textures.push({url:n,resource:e.video,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";var r=new Image;o.datasets.push({texture:e.refTexture,iURL:n}),t.uniform1f(e.locRefFlipRefs,e.flipReflections),t.bindTexture(t.TEXTURE_2D,e.refTexture),r.onload=()=>{t.activeTexture(t.TEXTURE1),w(t,r,e.refTexture,e.textureMode,-1,{url:n})},e.image=r,p.textures.push({url:n,resource:r,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE1),e.locRefOmitEquirectangular=t.getUniformLocation(c.program,"refOmitEquirectangular"),t.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefFlipRefs=t.getUniformLocation(c.program,"refFlipRefs"),t.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=t.getUniformLocation(c.program,"reflectionMap"),t.bindTexture(t.TEXTURE_2D,e.refTexture),t.uniform1i(e.locRefTexture,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e.refTexture);break;case"refraction":var n;if(n=e.map){var h,u,f,m;e.refractionVecs=[];for(var g=0;g<a.normalVecs.length;g+=3){for(var v=a.vertices[g+0],y=a.vertices[g+1],b=a.vertices[g+2],x=a.normalVecs[g+0],R=a.normalVecs[g+1],E=a.normalVecs[g+2],M=6e6,A=0;6e6==M&&A<a.vertices.length;A+=9)if(6e6==M){var T=[];h=a.vertices[A+0],u=a.vertices[A+1],f=a.vertices[A+2],T.push(h,u,f),h=a.vertices[A+3],u=a.vertices[A+4],f=a.vertices[A+5],T.push(h,u,f),h=a.vertices[A+6],u=a.vertices[A+7],f=a.vertices[A+8],T.push(h,u,f),(m=J(v-.01*x,y-.01*R,b-.01*E,v-1e4*x,y-1e4*R,b-1e4*E,T,!0))&&(d=Math.hypot(m[0][0]-v,m[0][1]-y,m[0][2]-b))<M&&(A,M=d)}3*(g%9/3|0),e.refractionVecs.push(a.normalVecs[g+0]),e.refractionVecs.push(a.normalVecs[g+1]),e.refractionVecs.push(a.normalVecs[g+2])}let c;e.refractionVecs=new Float32Array(e.refractionVecs),e.refractionVec_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bufferData(t.ARRAY_BUFFER,e.refractionVecs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.refractionVecIndices=new Uint32Array(Array(e.refractionVecs.length/3).fill().map(((e,a)=>a))),e.RefractionVec_Index_Buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.refractionVecIndices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer);let _=(c=n.split("."))[c.length-1].toLowerCase();switch(e.refractionTexture=t.createTexture(),_){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refractionTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE5),w(t,e.video,e.refractionTexture,e.textureMode,-1,e),p.textures.push({url:n,resource:e.video,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";r=new Image;o.datasets.push({texture:e.refractionTexture,iURL:n}),t.activeTexture(t.TEXTURE5),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractionlections),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),r.onload=()=>{w(t,r,e.refractionTexture,e.textureMode,-1,e)},p.textures.push({url:n,resource:r,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE5),t.uniform1i(e.locRefractionTexture,5),c.locRefractionlVec=t.getAttribLocation(c.program,"nVecRefraction"),t.vertexAttribPointer(c.locRefractionVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locRefractionVec),e.locRefractionOmitEquirectangular=t.getUniformLocation(c.program,"refractionOmitEquirectangular"),t.uniform1f(e.locRefractionOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefractionFlipRefs=t.getUniformLocation(c.program,"refractionFlipRefs"),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractions),e.locRefractionTexture=t.getUniformLocation(c.program,"refractionMap"),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),t.uniform1i(e.locRefractionTexture,5),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,e.refractionTexture);break;case"phong":e.locPhongTheta=t.getUniformLocation(c.program,e.theta),t.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=t.getUniformLocation(c.program,e.flatShadingUniform),t.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=t.getUniformLocation(c.program,e.name),t[e.dataType](e.loc,e.value)})),c.locColor=t.getUniformLocation(c.program,"color"),t.uniform3f(c.locColor,...ye(a.color)),("particles"==a.shapeType||a.isParticle||"lines"==a.shapeType||a.isLine)&&(c.locPointSize=t.getUniformLocation(c.program,"pointSize"),t.uniform1f(c.locPointSize,a.size)),c.locColorMix=t.getUniformLocation(c.program,"colorMix"),t.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=t.getUniformLocation(c.program,"isSprite"),t.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=t.getUniformLocation(c.program,"cameraMode"),t.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=t.getUniformLocation(c.program,"supplementalTextureMix"),t.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locIsLight=t.getUniformLocation(c.program,"isLight"),t.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=t.getUniformLocation(c.program,"isParticle"),t.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locIsLine=t.getUniformLocation(c.program,"isLine"),t.uniform1f(c.locIsLine,a.isLine?1:0),c.locPenumbraPass=t.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=t.getUniformLocation(c.program,"alpha"),t.uniform1f(c.locAlpha,a.alpha),c.locPointLights=t.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=t.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=t.getUniformLocation(c.program,"pointLightCount"),t.uniform1i(c.locPointLightCount,0),c.locResolution=t.getUniformLocation(c.program,"resolution"),t.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=t.getUniformLocation(c.program,"equirectangular"),t.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=t.getUniformLocation(c.program,"t"),t.uniform1f(c.locT,0),c.locAmbientLight=t.getUniformLocation(c.program,"ambientLight"),t.uniform1f(c.locAmbientLight,e.ambientLight),c.locRotationMode=t.getUniformLocation(c.program,"rotationMode"),t.uniform1i(c.locRotationMode,a.rotationMode),c.texture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),c.locTexture=t.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=t.createTexture(),c.locHeightMap=t.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=t.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=t.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=t.getUniformLocation(c.program,"heightMapIntensity"),c.locMaxHeightmap=t.getUniformLocation(c.program,"maxHeightmap"),t.activeTexture(t.TEXTURE0)),c.supplementalTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=t.getUniformLocation(c.program,"supplementalTexture"),f)if(pe(f))a.textureMode="dataArray",a.mapIsDataArray=!0,w(t,"",c.texture,a.textureMode,0,a);else{let e;switch(c.iURL=f,(e=f.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",s&&(l=p.textures.filter((e=>e.url==c.iURL))).length?(console.log("found video in cache... using it"),c.resource=l[0].resource,c.texture=l[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",(()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed})),c.resource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()}))),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},p.textures.push({url:f,resource:c.resource,texture:c.texture}),fetch(f).then((e=>e.blob())).then((e=>{c.resource.src=URL.createObjectURL(e)})));break;default:a.textureMode="image";var g=new Image;a.image=g,p.textures.push({url:f,resource:g,texture:c.texture}),g.onload=async()=>{t.activeTexture(t.TEXTURE0),w(t,g,c.texture,a.textureMode,-1,{map:f})},fetch(f).then((e=>e.blob())).then((e=>{g.src=URL.createObjectURL(e)}))}}if(t.useProgram(c.program),t.activeTexture(t.TEXTURE0),t.uniform1i(c.locTexture,0),t.bindTexture(t.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=m;else if(m)if(pe(m))a.heightTextureMode="heightmapDataArray",a.heightmapIsDataArray=!0,w(t,"",c.texture,a.heightTextureMode,0,{map:m});else{let e;switch(c.heightMapURL=m,(e=m.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",s&&(l=p.textures.filter((e=>e.url==c.heightMapURL))).length?(console.log("found video in cache... using it"),c.heightResource=l[0].resource,c.heightTexture=l[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",(()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed})),c.heightResource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()}))),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},p.textures.push({url:m,resource:c.heightResource,texture:c.heightTexture}),fetch(m).then((e=>e.blob())).then((e=>{c.heightResource.src=URL.createObjectURL(e)})));break;default:a.heightTextureMode="heightImage";var v=new Image;c.heightResource=v,p.textures.push({url:m,resource:v,texture:c.heightTexture}),v.onload=async()=>{t.useProgram(c.program),t.activeTexture(t.TEXTURE4),t.uniform1i(c.locHeightMap,4),w(t,v,c.heightTexture,a.heightTextureMode,-1,{heightMapURL:m}),t.activeTexture(t.TEXTURE0)},fetch(m).then((e=>e.blob())).then((e=>{v.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),c.locCamPos=t.getUniformLocation(c.program,"camPos"),c.locCamOri=t.getUniformLocation(c.program,"camOri"),c.locGeoPos=t.getUniformLocation(c.program,"geoPos"),c.locGeoOri=t.getUniformLocation(c.program,"geoOri"),c.locFov=t.getUniformLocation(c.program,"fov"),c.locRenderNormals=t.getUniformLocation(c.program,"renderNormals"),t.uniform3f(c.locCamPos,e.x,e.y,e.z),t.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),t.uniform3f(c.locGeoPos,e.x,e.y,e.z),t.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),t.uniform1f(c.locFov,e.fov),t.uniform1f(c.locRenderNormals,0)}}else{var y=t.getProgramInfoLog(c.program),b=t.getShaderInfoLog(h),x=t.getShaderInfoLog(u);console.error(`bad shader :( ${y}`),console.error(`vShader info : ${b}`,o.vert),console.error(`fShader info : ${x}`,o.frag)}}}return o},N=async(e,a={})=>{var t=!0,r=[],o={size:1,alpha:.8,penumbra:.5,shapeType:"lines",color:16777215};Object.keys(e).forEach(((a,t)=>{switch(a.toLowerCase()){case"shapetype":default:break;case"x":case"y":case"z":case"roll":case"pitch":case"yaw":o[a]=e[a]}})),Object.keys(a).forEach(((e,r)=>{switch(e.toLowerCase()){case"shapetype":break;case"closepaths":t=a[e];break;default:o[e]=a[e]}}));const n=(e,a,t,o,n,i)=>{for(var s,c,l,p,h,u,f=!0,m=r,d=0;f&&d<m.length;d+=6)s=m[d+0],c=m[d+1],l=m[d+2],p=m[d+3],h=m[d+4],u=m[d+5],(s==e&&c==a&&l==t&&p==o&&h==n&&u==i||s==o&&c==n&&l==i&&p==e&&h==a&&u==t)&&(f=!1);return f};for(var i,s=e.vertices,c=0;c<s.length;c+=9){var l,p,h,u,f,m,d,g,v;l=-s[c+0],p=-s[c+1],h=-s[c+2],u=-s[c+3],f=-s[c+4],m=-s[c+5],d=-s[c+6],g=-s[c+7],v=-s[c+8],i=[],n(l,p,h,u,f,m)&&i.push(l,p,h,u,f,m),n(u,f,m,d,g,v)&&i.push(u,f,m,d,g,v),t&&n(d,g,v,l,p,h)&&i.push(d,g,v,l,p,h),r.push(...i)}var y=[];for(c=0;c<r.length;c+=3)y.push([r[c+0],r[c+1],r[c+2]]);o.geometryData=y;var b={shape:null};return I(e.renderer,o).then((e=>{b.shape=e})),b},O=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},V=(e,a,t,r,o,n,i=!1,s="")=>{var c,l,p,h,u,f=[],m=[],d=e,g=[],v=`${s}_${r}`,y=O(s);if("obj"===s)u=D(0,1,o,d,a,v);else u=D(r+(y?1:0),1,o,d,a,v);for(u.map((e=>{e.verts.map((e=>{e[0]*=t,e[1]*=t,e[2]*=t})),i?(f.push(e.verts[0],e.verts[1],e.verts[2],e.verts[2],e.verts[3],e.verts[0]),void 0!==e.uvs&&e.uvs.length&&m.push(e.uvs[0],e.uvs[1],e.uvs[2],e.uvs[2],e.uvs[3],e.uvs[0])):(f.push(...e.verts),void 0!==e.uvs&&e.uvs.length&&m.push(...e.uvs))})),l=0;l<f.length;l++){var b;p=[f[3*(c=l/3|0)+0],f[3*c+1],f[3*c+2]],l%3||(b=ne(p,y),n||(b[3]=b[0]+(b[0]-b[3]),b[4]=b[1]+(b[1]-b[4]),b[5]=b[2]+(b[2]-b[5]))),h=n?f.length-l-1:l,g.push({position:f[h],normal:[...f[h],f[h][0]+(b[3]-b[0]),f[h][1]+(b[4]-b[1]),f[h][2]+(b[5]-b[2])],texCoord:m[h]})}return{geometry:g}},D=(e,a,t,r,o,n="")=>{var i,s,c,l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,F,L,w,U,k,C,z,S,B,N,O,V,D,Y,X,H,G,q,W,j,K,$,Q,Z,J,ee,ae,te,re,oe,ne,ie,se,ce,le,pe,he,ue,fe,me,de,ge,ve,ye=!1;if(!ye)for(var be=e;be--;)i=r,s=o,r=[],o=[],i.map(((e,a)=>{switch(u=e[c=0][0],f=e[c][1],m=e[c][2],s.length&&s[a].length>c&&(ve=s[a],L=ve[c][0],w=ve[c][1]),d=e[c=1][0],g=e[c][1],v=e[c][2],s.length&&s[a].length>c&&(U=ve[c][0],k=ve[c][1]),y=e[c=2][0],b=e[c][1],x=e[c][2],s.length&&s[a].length>c&&(C=ve[c][0],z=ve[c][1]),e.length>3&&(R=e[c=3][0],E=e[c][1],M=e[c][2],s.length&&s[a].length>c&&(S=ve[c][0],B=ve[c][1]),e.length>4&&(A=e[c=4][0],T=e[c][1],_=e[c][2],s.length&&s[a].length>c&&(N=ve[c][0],O=ve[c][1]),e.length>5&&(P=e[c=5][0],I=e[c][1],F=e[c][2],s.length&&s[a].length>c&&(V=ve[c][0],D=ve[c][1])))),Y=(u+d)/2,X=(f+g)/2,H=(m+v)/2,G=(d+y)/2,q=(g+b)/2,W=(v+x)/2,void 0!==L&&(ee=(L+U)/2,ae=(w+k)/2,te=(U+C)/2,re=(k+z)/2),fe=[],me=[],e.length){case 3:j=(y+u)/2,K=(b+f)/2,$=(x+m)/2,void 0!==L&&(oe=(C+L)/2,ne=(z+w)/2,l=L,p=w,me.push([l,p]),l=ee,p=ae,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=U,p=k,me.push([l,p]),l=te,p=re,me.push([l,p]),o.push(me),(me=[]).push([l=oe,p=ne]),l=te,p=re,me.push([l,p]),l=C,p=z,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=te,p=re,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me)),l=u,p=f,h=m,fe.push([l,p,h]),l=Y,p=X,h=H,fe.push([l,p,h]),l=j,p=K,h=$,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,fe.push([l,p,h]),l=G,p=q,h=W,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=j,p=K,h=$]),l=G,p=q,h=W,fe.push([l,p,h]),l=y,p=b,h=x,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=G,p=q,h=W,fe.push([l,p,h]),l=j,p=K,h=$,fe.push([l,p,h]),r.push(fe);break;case 4:j=(y+R)/2,K=(b+E)/2,$=(x+M)/2,Q=(R+u)/2,Z=(E+f)/2,J=(M+m)/2,void 0!==L&&(oe=(C+S)/2,ne=(z+B)/2,ie=(S+L)/2,se=(B+w)/2,de=(L+U+C+S)/4,ge=(w+k+z+B)/4,l=L,p=w,me.push([l,p]),l=ee,p=ae,me.push([l,p]),l=de,p=ge,me.push([l,p]),l=ie,p=se,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=U,p=k,me.push([l,p]),l=te,p=re,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=de,p=ge]),l=te,p=re,me.push([l,p]),l=C,p=z,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me),(me=[]).push([l=ie,p=se]),l=de,p=ge,me.push([l,p]),l=oe,p=ne,me.push([l,p]),l=S,p=B,me.push([l,p]),o.push(me)),ce=(u+d+y+R)/4,le=(f+g+b+E)/4,pe=(m+v+x+M)/4,l=u,p=f,h=m,fe.push([l,p,h]),l=Y,p=X,h=H,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),l=Q,p=Z,h=J,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,fe.push([l,p,h]),l=G,p=q,h=W,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=ce,p=le,h=pe]),l=G,p=q,h=W,fe.push([l,p,h]),l=y,p=b,h=x,fe.push([l,p,h]),l=j,p=K,h=$,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Q,p=Z,h=J]),l=ce,p=le,h=pe,fe.push([l,p,h]),l=j,p=K,h=$,fe.push([l,p,h]),l=R,p=E,h=M,fe.push([l,p,h]),r.push(fe);break;case 5:ce=(u+d+y+R+A)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+M+_)/5,void 0!==L&&(de=(L+U+C+S+N)/5,ge=(w+k+z+B+O)/5,oe=(C+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+L)/2,(O+w)/2,l=L,p=w,me.push([l,p]),l=U,p=k,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=U,p=k]),l=C,p=z,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=C,p=z]),l=S,p=B,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=S,p=B]),l=N,p=O,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=N,p=O]),l=L,p=w,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),me=[]),j=(y+R)/2,K=(b+E)/2,$=(x+M)/2,Q=(R+A)/2,Z=(E+T)/2,J=(M+_)/2,(A+u)/2,(T+f)/2,(_+m)/2,l=u,p=f,h=m,fe.push([l,p,h]),l=d,p=g,h=v,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=y,p=b,h=x]),l=R,p=E,h=M,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=R,p=E,h=M]),l=A,p=T,h=_,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=A,p=T,h=_]),l=u,p=f,h=m,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),fe=[];break;case 6:ce=(u+d+y+R+A)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+M+_)/5,void 0!==L&&(de=(L+U+C+S+N+V)/6,ge=(w+k+z+B+O+D)/6,oe=(C+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+V)/2,(O+D)/2,(V+L)/2,(D+w)/2,l=L,p=w,me.push([l,p]),l=U,p=k,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=U,p=k]),l=C,p=z,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=C,p=z]),l=S,p=B,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=S,p=B]),l=N,p=O,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=N,p=O]),l=V,p=D,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=V,p=D]),l=L,p=w,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),me=[]),j=(y+R)/2,K=(b+E)/2,$=(x+M)/2,Q=(R+A)/2,Z=(E+T)/2,J=(M+_)/2,(A+P)/2,(T+I)/2,(_+F)/2,(P+u)/2,(I+f)/2,(F+m)/2,(fe=[]).push([l=u,p=f,h=m]),l=d,p=g,h=v,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=y,p=b,h=x]),l=R,p=E,h=M,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=R,p=E,h=M]),l=A,p=T,h=_,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=A,p=T,h=_]),l=P,p=I,h=F,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=P,p=I,h=F]),l=u,p=f,h=m,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),fe=[]}}));if(t){var xe;he=t,ue=1-t;for(be=2;be--;)(be?r:o).map((e=>{e.map((e=>{l=e[0],p=e[1],h=be?e[2]:0,xe=Math.hypot(l,p,h),l/=xe,p/=xe,h/=xe,e[0]=l*=he+xe*ue,e[1]=p*=he+xe*ue,be&&(e[2]=h*=he+xe*ue)}))}))}return r.map(((e,a)=>({verts:e,uvs:o[a]})))},Y=(e,a,t,r,o)=>{let i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=Array(r).fill().map((e=>(i=n()-.5,s=n()-.5,c=n()-.5,[i,s,c])));for(let e=50;e--;)x.map(((e,a)=>{i=e[0],s=e[1],c=e[2],x.map(((e,t)=>{t!=a&&(u=e[0],f=e[1],m=e[2],g=1+(Math.hypot(i-u,s-f,c-m)*(3+r/80)*3)**3,i+=9*(i-u)/g,s+=9*(s-f)/g,c+=9*(c-m)/g)})),g=Math.hypot(i,s,c),e[0]=i/g,e[1]=s/g,e[2]=c/g}));return d=6e6,x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(v=l-u,y=p-f,b=h-m),g<d&&(d=g))}))})),v=[],x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(l-u,p-f,h-m),g<2*d&&(v.filter((e=>e[0]==u&&e[1]==f&&e[2]==m&&e[3]==l&&e[4]==p&&e[5]==h)).length||v.push([l*o,p*o,h*o,u*o,f*o,m*o])))}))})),x.map((r=>{r[0]*=o/1.3333,r[1]*=o/1.3333,r[2]*=o/1.3333,r[0]+=e,r[1]+=a,r[2]+=t})),[e,a,t,o,x,v]},X=(e=1,a=0,t,n,i=0,s=!1,c="cylinder")=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,F=[],L=[],w=0;w<t;w++)for(var U=w-.5,k=0;k<n;k++){l=r(2*Math.PI/n*k),p=1/t*U-.5,h=o(2*Math.PI/n*k),u=r(2*Math.PI/n*(k+1)),f=1/t*U-.5,m=o(2*Math.PI/n*(k+1)),d=r(2*Math.PI/n*(k+1)),g=1/t*(U+1)-.5,v=o(2*Math.PI/n*(k+1)),y=r(2*Math.PI/n*k),b=1/t*(U+1)-.5,x=o(2*Math.PI/n*k);var C=Math.atan2(l,h),z=Math.atan2(u,m),S=Math.atan2(d,v),B=Math.atan2(y,x);Math.abs(C-z)>Math.PI&&(C-=2*Math.PI,B-=2*Math.PI),R=(C+Math.PI)/Math.PI/2,E=p+.5,M=(z+Math.PI)/Math.PI/2,A=f+.5,T=(S+Math.PI)/Math.PI/2,_=g+.5,P=(B+Math.PI)/Math.PI/2,I=b+.5,F.push([[l,p,h],[u,f,m],[d,g,v],[y,b,x]]),L.push([[R,E],[M,A],[T,_],[P,I]])}return V(F,L,e/1.2,a,i,s,!0,c)},H=async(e=1,a=0,t=0,n=!1,i="torus",s,c)=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,F,L,w,U,k=[],C=[],z=4*s,S=.5,B=1.25,N=0;N<z;N++)for(var O=N+.5,D=0;D<c;D++){l=r(w=2*Math.PI/c*D)*S+B,p=o(w)*S,0,w=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,U=Math.hypot(l,0),h=r(w)*U,u=p,f=o(w)*U,l=r(w=2*Math.PI/c*(D+1))*S+B,p=o(w)*S,w=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,U=Math.hypot(l,0),m=r(w)*U,d=p,g=o(w)*U,l=r(w=2*Math.PI/c*(D+1))*S+B,p=o(w)*S,w=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,U=Math.hypot(l,0),v=r(w)*U,y=p,b=o(w)*U,l=r(w=2*Math.PI/c*D)*S+B,p=o(w)*S,w=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,U=Math.hypot(l,0),x=r(w)*U,R=p,E=o(w)*U;var Y=Math.atan2(h,f),X=Math.atan2(m,g),H=Math.atan2(v,b),G=Math.atan2(x,E);Math.abs(Y-H)>Math.PI&&(H+=2*Math.PI,G+=2*Math.PI),M=(Y+Math.PI)/Math.PI/2,A=u+.5,T=(X+Math.PI)/Math.PI/2,_=d+.5,P=(H+Math.PI)/Math.PI/2,I=y+.5,F=(G+Math.PI)/Math.PI/2,L=R+.5,k.push([[h,u,f],[m,d,g],[v,y,b],[x,R,E]]),C.push([[M,A],[T,_],[P,I],[F,L]])}return V(k,C,e/1.2,a,t,n,!0,i)},G=async(e=1,a=0,t,n,i=0,s=!1,c="torus knot")=>{var l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,F,L,w,U,k,C=[],z=[],S=8*t;n/=1;for(var B,N,O,D,Y,X,H,G=.75,q=0;q<2*S;q++)for(var W=0;W<n;W++){var j=q+.5,K=q+1.5,$=q+2.5;u=3+r(B=2*Math.PI*1.5*1/S*j)/1,f=X=2*o(B),d=3+r(N=2*Math.PI*1.5*1/S*K)/1,g=H=2*o(N),y=3+r(O=2*Math.PI*1.5*1/S*$)/1,b=2*o(O),D=(Math.acos((g-f)/(Math.hypot(d-u,g-f)+1e-4))-Math.PI/2)/2,Y=(Math.acos((b-g)/(Math.hypot(y-d,b-g)+1e-4))-Math.PI/2)/2;var Q=3+r(B)/1;l=r(U=2*Math.PI/n*W)*G+Q,p=o(U)*G+X,h=0,U=Math.atan2(p,h)+D,k=Math.hypot(p,h),p=r(U)*k,h=o(U)*k,U=Math.atan2(l,h)+2*Math.PI/S*j+Math.PI/2,k=Math.hypot(l,h),u=r(U)*k,f=p,m=o(U)*k,l=r(U=2*Math.PI/n*(W+1))*G+Q,p=o(U)*G+X,h=0,U=Math.atan2(p,h)+D,k=Math.hypot(p,h),p=r(U)*k,h=o(U)*k,U=Math.atan2(l,h)+2*Math.PI/S*j+Math.PI/2,k=Math.hypot(l,h),d=r(U)*k,g=p,v=o(U)*k,Q=3+r(N)/1,l=r(U=2*Math.PI/n*(W+1))*G+Q,p=o(U)*G+H,h=0,U=Math.atan2(p,h)+Y,k=Math.hypot(p,h),p=r(U)*k,h=o(U)*k,U=Math.atan2(l,h)+2*Math.PI/S*K+Math.PI/2,k=Math.hypot(l,h),y=r(U)*k,b=p,x=o(U)*k,l=r(U=2*Math.PI/n*W)*G+Q,p=o(U)*G+H,h=0,U=Math.atan2(p,h)+Y,k=Math.hypot(p,h),p=r(U)*k,h=o(U)*k,U=Math.atan2(l,h)+2*Math.PI/S*K+Math.PI/2,k=Math.hypot(l,h),R=r(U)*k,E=p,M=o(U)*k;var Z=Math.atan2(u,m),J=Math.atan2(d,v),ee=Math.atan2(y,x),ae=Math.atan2(R,M);Math.abs(Z-ee)>Math.PI&&(ee+=2*Math.PI,ae+=2*Math.PI),A=(Z+Math.PI)/Math.PI/2,T=f+.5,_=(J+Math.PI)/Math.PI/2,P=g+.5,I=(ee+Math.PI)/Math.PI/2,F=b+.5,L=(ae+Math.PI)/Math.PI/2,w=E+.5,C.push([[u,f,m],[d,g,v],[y,b,x],[R,E,M]]),z.push([[A,T],[_,P],[I,F],[L,w]])}return V(C,z,e/1.2,a,i,s,!0,c)},q=async(e=1,a=0,t=0,n=!1,i="tetrahedron")=>{var s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];y=[];let R=1/1.4142/1.25;for(g=3;g--;)s=1*r(p=2*Math.PI/3*g)/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]);for(x.push(y),v=3;v--;)(y=[]).push([s=0,c=0,l=-R]),s=1*r(p=2*Math.PI/3*v)/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]),s=1*r(p=2*Math.PI/3*(v+1))/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]),x.push(y);f=m=d=b=0,x.map((e=>{e.map((e=>{f+=e[0],m+=e[1],d+=e[2],b++}))})),f/=b,m/=b,d/=b,x.map((e=>{e.map((e=>{e[0]-=f,e[1]-=m,e[2]-=d}))}));var E=x,M=[];for(g=0;g<E.length;g++){y=[];for(var A=E[g].length;A--;){switch(A){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}y.push([h,u])}M.push(y)}return V(E,M,e,a,t,n,!1,i)},W=async(e=1,a=0,t=0,n=!1,i="octahedron")=>{var s,c,l,p,h,u,f,m,d,g=[];for(m=8;m--;)(d=[]).push([s=0,c=0,l=.8*(m<4?-1:1)]),s=1*r(p=2*Math.PI/4*m)/1.25,c=1*o(p)/1.25,l=0,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*(m+1))/1.25,c=1*o(p)/1.25,l=0,d.push([s,c,l]),g.push(d);var v=g,y=[];for(f=0;f<v.length;f++){d=[];for(var b=v[f].length;b--;){switch(b){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}d.push([h,u])}y.push(d)}return V(v,y,e,a,t,n,!1,i)},j=async(e=1,a=0,t=0,r=!1,o="icosahedron")=>{var n,i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];for(u=[[-(h=.5+5**.5/2),-1,0],[h,-1,0],[h,1,0],[-h,1,0]],p=3;p--;x.push(i))for(i=[],n=4;n--;)i.push([u[n][p],u[n][(p+1)%3],u[n][(p+2)%3]]);x.map((e=>{e.map((e=>{e[0]*=1/2.25,e[1]*=1/2.25,e[2]*=1/2.25}))})),f=JSON.parse(JSON.stringify(x)),l=[],u=[],[[[0,3],[1,0],[2,2]],[[0,3],[1,0],[1,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[0,2],[1,3],[1,0]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[1,0],[2,2],[2,1]],[[1,1],[2,2],[2,1]],[[1,1],[2,2],[0,0]],[[1,1],[2,1],[0,1]],[[0,2],[2,1],[0,1]],[[2,0],[1,2],[2,3]],[[0,0],[0,3],[2,3]],[[1,3],[2,0],[2,3]],[[2,3],[0,0],[1,2]],[[1,2],[2,0],[0,1]],[[0,0],[1,2],[1,1]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]]].map((e=>{m=e[0][0],d=e[1][0],g=e[2][0],v=e[0][1],y=e[1][1],b=e[2][1],u.push([f[m][v],f[d][y],f[g][b]])})),l.push(...u);var R=l,E=[];for(n=0;n<R.length;n++){u=[];for(var M=R[n].length;M--;){switch(M){case 0:s=0,c=0;break;case 1:s=1,c=0;break;case 2:s=1,c=1;break;case 3:s=0,c=.5;break;case 4:s=0,c=1}u.push([s,c])}E.push(u)}return V(R,E,e,a,t,r,!1,o)},K=async(e=1,a=0,t=0,n=!1,i="dodecahedron")=>{var s,c,l,p,h,u,f,m,d,g,v=[],y=[];let b=-6e6;for(g=5;g--;)s=r(u=2*Math.PI/5*g+Math.PI/5),c=o(u),l=0,c>b&&(b=c),y.push([s,c,l]);y=y.map((e=>(s=e[0],c=e[1]-=b,l=e[2],x(s,c,l,{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0})))),(h=structuredClone(y)).map((e=>{e[1]*=-1})),v.push(y,h),b=-6e6,v.map((e=>{e.map((e=>{s=e[0],c=e[1],(l=e[2])>b&&(b=l)}))})),p=Math.hypot(v[0][0][0]-v[0][1][0],v[0][0][1]-v[0][1][1],v[0][0][2]-v[0][1][2]),v.map((e=>{e.map((e=>{e[2]-=b+p/2}))})),(h=structuredClone(v)).map((e=>{e.map((e=>{e[2]*=-1}))})),v.push(...h),(h=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),(E=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),v.push(...h,...E);var E=v,M=[];for(g=0;g<E.length;g++){y=[];for(var A=E[g].length;A--;){switch(A){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y.push([m,d])}M.push(y)}return V(E,M,e/Math.max(1,2-t),a,t,n,!1,i)},$=(e=1,a=0,t=0,n=!1,i="cube")=>{var s,c,l,p,h,u,f,m,d=Math.PI,g=[];for(h=6;h--;g.push(l))for(l=[],u=4;u--;)l.push([(c=[r(s=2*d/4*u+d/4),o(s),2**.5/2])[h%3]*(p=h<3?1:-1),c[(h+1)%3]*p,c[(h+2)%3]*p]);var v=[];for(h=0;h<g.length;h++){c=[];for(var y=g[h].length;y--;){switch(y){case 0:f=0,m=0;break;case 1:f=1,m=0;break;case 2:f=1,m=1;break;case 3:f=0,m=1}c.push([f,m])}v.push(c)}return V(g,v,e/1.2,a,t,n,!0,i)},Q=async(e=1,a=0,t=0,r=!1,o="rectangle")=>{Math.PI;return V([[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]]],[[[0,0],[1,0],[1,1],[0,1]]],e/1.5,Math.max("sprite"==o?0:2,a),"sprite"==o||"point light"==o?0:t,r,!0,o)},Z=(e,a=0)=>!(a>300)&&(2==e||Z(e/2,a+1)),J=(e,a,t,n,i,s,c,l=!1)=>{let p,h,u,f,m,d,g,v,y,b=(e,a,t,r,o,n,i,s)=>(d=((i-o)*(a-n)-(s-n)*(e-o))/(g=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&d<=1&&(v=((t-e)*(a-n)-(r-a)*(e-o))/g)>=0&&v<=1?[e+d*(t-e),a+d*(r-a)]:0,x=(e,a,t,n)=>{let i=Math,s=i.atan2,c=i.hypot;p=r(y=s(p,h)+e)*(f=c(p,h)),h=o(y)*f,p=r(y=s(p,u)+t)*(f=c(p,u)),u=o(y)*f,h=r(y=s(h,u)+a)*(f=c(h,u)),u=o(y)*f,n&&(p+=oX,h+=oY,u+=oZ)},R=e=>{switch(e){case 0:x(0,0,Math.PI/2);break;case 1:x(0,Math.PI/2,0);break;case 2:x(Math.PI/2,0,Math.PI/2)}},E=0,M=0,A=0;c.map((e=>{E+=e[0],M+=e[1],A+=e[2]})),E/=c.length,M/=c.length,A/=c.length;let T=c[2][0]-c[1][0],_=c[2][1]-c[1][1],P=c[2][2]-c[1][2],I=c[1][0]-c[0][0],F=c[1][1]-c[0][1],L=c[1][2]-c[0][2],w=[_*L-P*F,P*I-T*L,T*F-_*I];f=Math.hypot(...w)+.001;w=w.map((e=>e/f*1));let U=E,k=M,C=A,z=1;if(l){let r=Math.hypot(U-e,k-a,C-t);z=Math.hypot(e-(E+w[0]/99),a-(M+w[1]/99),t-(A+w[2]/99))>r?-1:1}let S=E+(w[0]*=z),B=M+(w[1]*=z),N=A+(w[2]*=z),O=Math.atan2(S-U,N-C),V=-(Math.acos((B-k)/(Math.hypot(S-U,B-k,N-C)+.001))+Math.PI/2),D=!1,Y=[!1,!1,!1];p=e,h=a,u=t,x(0,-V,-O);let X=p,H=h,G=u;for(let e=3;e--;)!1===D&&(p=X,h=H,u=G,R(e),U=p,k=h,C=u=5,p=n,h=i,u=s,x(0,-V,-O),R(e),S=p,B=h,N=u,c.map(((a,t)=>{if(!1===D){let a=t;p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);let r=p,o=h;a=(t+1)%c.length,p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);(m=b(U,k,S,B,r,o,p,h))&&(Y[e]=m)}})));if(3==Y.filter((e=>!1!==e)).length){let e=Y[1][0],a=Y[0][1],t=Y[0][0],r=!0;E=0,M=0,A=0,c.map(((e,a)=>{E+=e[0],M+=e[1],A+=e[2]})),E/=c.length,M/=c.length,A/=c.length,p=E,h=M,u=A,x(0,-V,-O),U=p,k=h,C=u,S=e,B=a,N=t,c.map(((e,a)=>{if(r){let e=a;p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);let t=p,o=h;e=(a+1)%c.length,p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);b(U,k,S,B,t,o,p,h)&&(r=!1)}})),r&&(p=e,h=a,u=t,x(0,V,0),x(0,0,O),D=[[p,h,u],[w[0],w[1],w[2]]])}return D},ee=async(e,a)=>{var t,r=[],o=a.omitShape;(a.omitShape=!0,a.geometryData.map((async t=>{var o,n,i,s,c,l,p=t[0][0],h=t[0][1],u=t[0][2],f=t[1][0],m=t[1][1],d=t[1][2];"horizontal"!=a.alignment&&(Math.abs(f-p)>Math.abs(m-h)||"vertical"==a.alignment)?(o=p,n=(h+m)/2,i=(u+d)/2,s=f,c=(h+m)/2,l=(u+d)/2):(o=(p+f)/2,n=h,i=(u+d)/2,s=(p+f)/2,c=m,l=(u+d)/2),a.geometryData=[[p,h,u],[o,n,i],[s,c,l],[f,m,d]],await ae(e,a).then((e=>{r.push(...e.curve)}))})),o)||(a.shapeType="lines",a.geometryData=r,I(e,a).then((e=>{t=e})),r=t);return r},ae=async(e,a)=>{var t=[],r=10;void 0!==a&&Object.keys(a).forEach(((e,t)=>{if("steps"===e.toLowerCase())r=Math.floor(a[e])}));var o,n,i,s=structuredClone(a.geometryData);o=s[0][0]-(s[1][0]-s[0][0]),n=s[0][1]-(s[1][1]-s[0][1]),i=s[0][2]-(s[1][2]-s[0][2]),s[0][0]=o,s[0][1]=n,s[0][2]=i;var c=s.length-1;o=s[c][0]+(s[c][0]-s[c-1][0]),n=s[c][1]+(s[c][1]-s[c-1][1]),i=s[c][2]+(s[c][2]-s[c-1][2]),s[c][0]=o,s[c][1]=n,s[c][2]=i,s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,p=s[c][0],h=s[c][1],u=s[c][2],f=s[l][0],m=s[l][1],d=s[l][2],g=(o+p)/2,v=(n+h)/2,y=(i+u)/2,b=(p+f)/2,x=(h+m)/2,R=(u+d)/2;t.push([g,v,y]),a==s.length-3&&t.push([b,x,R]);for(var E=0;E<r+1;E++);}}));var l,p=[];return s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,h=s[c][0],u=s[c][1],f=s[c][2],m=(o+h)/2,d=(n+u)/2,g=(i+f)/2,v=(h+s[l][0])/2,y=(u+s[l][1])/2,b=(f+s[l][2])/2;t.push([m,d,g]);for(var x=m,R=d,E=g,M=0;M<r+1;M++){if(M){var A=oe(m+(h-m)/r*M,d+(u-d)/r*M,h+(v-h)/r*M,u+(y-u)/r*M,m+(h-m)/r*(M+1),d+(u-d)/r*(M+1),h+(v-h)/r*(M+1),u+(y-u)/r*(M+1));M<r&&(A?(p.push([x,R,E],[...A,0]),x=A[0],R=A[1],E=0):(p.push([x,R,E],[v,y,b]),x=v,R=y,E=b)),M>=r&&p.push([x,R,E],[v,y,0])}}}})),a.omitShape?{curve:p,midPoints:t,controlPoints:s}:(a.shapeType="lines",a.geometryData=p,I(e,a).then((async e=>l=e)),{curve:p,shape:l,midPoints:t,controlPoints:s})},te=(e,a)=>{let t=Math.hypot(...e)+1e-5,r=Math.hypot(...a)+1e-5;e[0]/=t,e[1]/=t,e[2]/=t,a[0]/=r,a[1]/=r,a[2]/=r;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2];return[-(-e[0]-2*a[0]*o)*t,-(-e[1]-2*a[1]*o)*t,-(-e[2]-2*a[2]*o)*t]},re=(e,a,t)=>{var r,o,n,i,s,c,l,p=0;return t.map((e=>{e[0],e[1],p++})),p,p,r=e,o=a,1e6,1e6,p=0,t.map(((e,a)=>{n=t[l=a][0],i=t[l][1],l=(a+1)%t.length,s=t[l][0],c=t[l][1],oe(r,o,1e6,1e6,n,i,s,c)&&p++})),1==p},oe=(e,a,t,r,o,n,i,s)=>{var c,l,p;return(c=((i-o)*(a-n)-(s-n)*(e-o))/(l=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&c<=1&&(p=((t-e)*(a-n)-(r-a)*(e-o))/l)>=0&&p<=1&&[e+c*(t-e),a+c*(r-a)]},ne=(e,a=!1,t=0,r=0,o=0)=>{var n,i,s=0,c=0,l=0;e.map((e=>{s+=e[0],c+=e[1],l+=e[2]})),s/=e.length,c/=e.length,l/=e.length;var p=e[2][0]-e[1][0],h=e[2][1]-e[1][1],u=e[2][2]-e[1][2],f=e[1][0]-e[0][0],m=e[1][1]-e[0][1],d=e[1][2]-e[0][2];n=[h*d-u*m,u*f-p*d,p*m-h*f],i=Math.hypot(...n)+1e-4;n=n.map((e=>e/i*1));var g=s,v=c,y=l,b=1;if(a){var x=Math.hypot(g-t,v-r,y-o);b=Math.hypot(t-(s+n[0]/99),r-(c+n[1]/99),o-(l+n[2]/99))>x?-1:1}return[g,v,y,s+(n[0]*=b),c+(n[1]*=b),l+(n[2]*=b)]},ie=async(a,t)=>{a.grav=.01,a.mspeed=1,a.rspeed=1,a.cameraMode="fps",a.crosshairMap="",a.showCrosshair=!0,a.crosshairSize=1,a.lastInteraction=0,a.hasTraction=!0,a.focusRequiredForMouse=!0,a.flyMode=!1,a.useKeys=!0,a.crosshairSel=0,a.crosshairAlpha=.6,a.useFPSControls=!0;var n=Array(4).fill().map(((a,t)=>`${e}/resources/crosshairs/crosshair${t+1}.png`));void 0!==t&&Object.keys(t).forEach(((e,r)=>{switch(e.toLowerCase()){case"mspeed":a.mspeed=+t[e];break;case"rspeed":a.rspeed=+t[e];break;case"grav":a.grav=+t[e];break;case"crosshairsel":a.crosshairSel=+t[e];break;case"crosshairsize":a.crosshairSize=+t[e];break;case"flymode":a.flyMode=!!t[e];break;case"usekeys":a.useKeys=!!t[e];break;case"crosshairmap":a.crosshairMap=t[e];break;case"crosshairalpha":a.crosshairAlpha=+t[e];break;case"showcrosshair":a.showCrosshair=!!t[e];break;case"focusrequiredformouse":a.focusRequiredForMouse=!!t[e]}}));if(a.crosshairImages=Array(n.length).fill(),a.crosshairImages.map((async(e,t)=>{a.crosshairImages[t]={img:new Image,loaded:!1},a.crosshairImages[t].img.onload=()=>{a.crosshairImages[t].loaded=!0},await fetch(n[t]).then((e=>e.blob())).then((e=>{a.crosshairImages[t].img.src=URL.createObjectURL(e)}))})),a.crosshairMap&&(a.crosshairSel=n.length,a.crosshairImages.push({img:new Image,loaded:!1}),a.crosshairImages[a.crosshairImages.length-1].img.onload=()=>{a.crosshairImages[a.crosshairImages.length-1].loaded=!0},await fetch(a.crosshairMap).then((e=>e.blob())).then((e=>{a.crosshairImages[a.crosshairImages.length-1].img.src=URL.createObjectURL(e)}))),a.useKeys){var i=.1*a.mspeed,s=.005*a.rspeed,c=0,l=0,p=0,h=0,u=0,f=1;a.keys=Array(256).fill().map(((e,a)=>!1)),a.keyTimers=Array(256).fill(0),a.keyTimerInterval=.2,window.addEventListener("keydown",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!0,a.lastInteraction=a.t)})),window.addEventListener("keyup",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!1,a.lastInteraction=a.t)})),window.addEventListener("mousedown",(e=>{(a.lastInteraction=a.t,0===e.button)&&(!0,document.querySelectorAll(".genericPopup").length||"CANVAS"!=document.activeElement.nodeName||a.c.requestPointerLock({unadjustedMovement:!0}))})),window.addEventListener("mouseup",(e=>{a.lastInteraction=a.t,0===e.button&&!1})),window.addEventListener("mousemove",(e=>{if(a.lastInteraction=a.t,document.pointerLockElement==a.c||!a.focusRequiredForMouse){var t=a.c.getBoundingClientRect();(e.pageX-t.left)/a.c.clientWidth*a.c.width,(e.pageY-t.top)/a.c.clientHeight*a.c.height,c-=e.movementX*s,l+=e.movementY*s}})),a.doKeys=async()=>{if(i=.1*a.mspeed,s=.005*a.rspeed,a.yaw+=c,a.pitch+=l,a.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,a.pitch)),c/=1.66,l/=1.66,a.x+=p,a.y+=h,a.z+=u,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&(p/=1.2,h/=1.2,u/=1.2),a.flyMode&&"CANVAS"==document.activeElement.nodeName){var e=-a.yaw+Math.PI,t=a.pitch;switch(a.mouseButton){case 1:p-=r(e)*r(t)*i*f,h+=o(t)*i*f,u-=o(e)*r(t)*i*f;break;case 2:p+=r(e)*r(t)*i*f,h-=o(t)*i*f,u+=o(e)*r(t)*i*f}}f=1,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&a.keys.map(((e,t)=>{if(a.keys[t])switch(t){case 16:f=3;break;case 37:c+=12*s;break;case 38:l-=12*s;break;case 39:c-=12*s;break;case 40:l+=12*s;break;case 87:var n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p+=r(n)*r(m)*i*f,h-=o(m)*i*f,u+=o(n)*r(m)*i*f):(p+=r(n)*i*f,u+=o(n)*i*f);break;case 65:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=r(n)*i*f,u+=o(n)*i*f;break;case 83:n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p-=r(n)*r(m)*i*f,h+=o(m)*i*f,u-=o(n)*r(m)*i*f):(p-=r(n)*i*f,u-=o(n)*i*f);break;case 68:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=-r(n)*i*f,u+=-o(n)*i*f}}))}}},se=(e,a)=>{const t=async()=>{Re.margin=e.margin,Re.rsz(),Re.width=e.width,Re.height=e.height,Re.c.width=e.c.width,Re.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a]();if(["alphaQueue","lineQueue","particleQueue"].forEach((a=>{if(e[a].length){var t,r=[];e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,i=a.y+e.y,s=a.z+e.z;t=x(n,i,s,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1);var c=e.z/1e3*e.fov;r.push({idx:o,z:c+t[2]})})),r.sort(((e,a)=>a.z-e.z)),e[a].map((async(t,o)=>{var n=e[a][r[o].idx].geometry,i=n.vertices,s=n.size;n.size=e[a][r[o].idx].size,n.vertices=e[a][r[o].idx].vertices,n.x=e[a][r[o].idx].x,n.y=e[a][r[o].idx].y,n.z=e[a][r[o].idx].z,n.roll=e[a][r[o].idx].roll,n.pitch=e[a][r[o].idx].pitch,n.yaw=e[a][r[o].idx].yaw;for(var c=n.penumbra,l=1+((n.isLine||n.isParticle)&&c?1:0);l--;)e.Draw(n,!0,(n.isParticle||n.isLine)&&c&&!l);n.vertices=i,n.size=s})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e[a]=[]})),e.t+=1/60,requestAnimationFrame(t),"fps"==e.cameraMode&&(e.useKeys&&e.doKeys&&await e.doKeys(),e.showCrosshair&&e.crosshairImages[e.crosshairSel].loaded)){var r=200*e.crosshairSize;Re.ctx.globalAlpha=e.crosshairAlpha,Re.ctx.drawImage(e.crosshairImages[e.crosshairSel].img,Re.width/2-r/2,Re.height/2-r/2,r,r),Re.ctx.globalAlpha=1}};window.addEventListener("load",(()=>{e.ready=!0,t()}))},ce=(e,a,t)=>le(e,a,t),le=(e,a,t)=>{let r=e/255,o=a/255,n=t/255,i=Math.min(r,o,n),s=Math.max(r,o,n),c=s,l=s-i,p=s?l/s:0,h=Math.min(e,a,t),u=Math.max(e,a,t),f=0;for(l&&(e>=a&&e>=t&&(f=(a-t)/(u-h)),a>=e&&a>=t&&(f=2+(t-e)/(u-h)),t>=a&&t>=e&&(f=4+(e-a)/(u-h))),f*=60;f<0;)f+=360;for(;f>=360;)f-=360;return[f,p,c]},pe=e=>void 0!==e.length&&void 0!==e.forEach,he=(e,a,t)=>ue(e,a,t),ue=(e,a,t)=>{let r=me(e,a,t);return ge(...r)},fe=(e,a,t)=>me(e,a,t),me=(e,a,t)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let r,o,n,i=t*a,s=i*(1-Math.abs(e/60%2-1)),c=t-i;return e>=0&&e<60&&(r=i,o=s,n=0),e>=60&&e<120&&(r=s,o=i,n=0),e>=120&&e<180&&(r=0,o=i,n=s),e>=180&&e<240&&(r=0,o=s,n=i),e>=240&&e<300&&(r=s,o=0,n=i),e>=300&&e<360&&(r=i,o=0,n=s),[255*(r+c),255*(o+c),255*(n+c)]},de=(e,a,t)=>ge(e,a,t),ge=(e,a,t)=>{let r="0123456789abcdef",o="";return o+=r[e/16|0],o+=r[e-16*(e/16|0)|0],o+=r[a/16|0],o+=r[a-16*(a/16|0)|0],o+=r[t/16|0],o+=r[t-16*(t/16|0)|0],Number("0x"+o)},ve=e=>ye(e),ye=e=>[e/256**3-(e/256**3|0),e/65536-(e/65536|0),e/256-(e/256|0)],be=e=>{var a=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map((t=>{a.push({name:t,val:e.getParameter(e[t])})}));var t=document.createElement("div");t.style.position="fixed",t.style.zIndex=1e5,t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.background="#0008",t.style.padding="20px",t.style.width="600px",t.style.height="350px",t.style.border="1px solid #fff4",t.style.borderRadius="5px",t.style.fontFamily="monospace",t.style.fontSize="20px",t.style.color="#fff";var r=document.createElement("div");r.style.fontSize="24px",r.style.color="#0f8c",r.innerHTML="rendering context parameters<br><br>",t.appendChild(r);var o=document.createElement("div");o.style.minWidth="100%",o.style.height="250px",o.style.background="#333",o.style.border="1px solid #fff4",o.style.overflowY="auto",o.style.wordWrap="break-word",o.style.color="#888",o.style.fontSize="10px",t.appendChild(o);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="ðŸ“‹ copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(o),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout((()=>{n.innerHTML="ðŸ“‹ copy"}),1e3)},t.appendChild(n);var i=document.createElement("button");i.onclick=()=>t.remove(),i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="close",t.appendChild(i),o.innerHTML=JSON.stringify(a),document.body.appendChild(t)},xe=e=>a.GenHash(e);var Re;(Re=await h({context:{mode:"2d",margin:0}})).c.style.background="#0000",Re.c.style.zIndex=10;var Ee,Me=document.createElement("canvas"),Ae=Me.getContext("2d",{willReadFrequently:!0});export{h as Renderer,I as LoadGeometry,B as BasicShader,f as DestroyRenderer,u as ResizeRenderer,m as DestroyShape,se as AnimationLoop,q as Tetrahedron,$ as Cube,W as Octahedron,j as Icosahedron,K as Dodecahedron,X as Cylinder,H as Torus,_ as DownloadCustomShape,A as LoadAnimationFromZip,T as DrawAnimation,G as TorusKnot,Q as Rectangle,b as Q,x as R,R as R_ypr,E as R_pyr,M as R_rpy,U as ComputeNormalAssocs,k as SyncNormals,oe as Intersects,re as PointInPoly2D,J as PointInPoly3D,N as ShapeToLines,z as ShowBounding,C as GetShaderCoord,te as Reflect,ne as Normal,ae as BSpline,ee as CurveTo,L as ImageToPo2,y as LoadOBJ,Z as IsPowerOf2,ce as RGBToHSV,he as HSVToHex,ue as HexFromHSV,fe as HSVToRGB,me as RGBFromHSV,de as HexFromRGB,ge as RGBToHex,ve as RGBFromHex,ye as HexToRGB,Y as GeoSphere,e as ModuleBase,ie as LoadFPSControls,Re as Overlay,xe as GenHash,pe as IsArray};