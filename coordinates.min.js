const e="https://srmcgann.github.io/Coordinates";import*as a from"https://srmcgann.github.io/GenHash/hash.js";const t=document.createElement("script");await t.setAttribute("src",e+"/zip.js"),await document.body.appendChild(t);const r=Math.sin,o=Math.cos,n=Math.random;var i=!1;const s=document.createElement("canvas"),c=s.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1});new Image;var l;const p={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},h=async e=>{var a=0,t=0,n=0,i=1920,s=1080,c=0,l=0,p=0,h=2e3,u=!0,f=10,m=!1,d=.2,g=!1,v="default",y=!1,b=0,x="",R={mode:"webgl2",options:{alpha:!0,antialias:!1,desynchronized:!0,premultipliedAlpha:!1}},E=[],A=[0,0,0],M={data:[],items:[]};void 0!==e&&Object.keys(e).forEach(((r,o)=>{switch(r.toLowerCase()){case"plugins":e[r].map((e=>{if("post processing"===e.type.toLowerCase())if(void 0===e.enabled||e.enabled){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map((e=>e.toLowerCase())):[]};E.push(a)}}));break;case"width":i=e[r];break;case"height":s=e[r];break;case"alpha":g=e[r];break;case"x":a=e[r];break;case"y":t=e[r];break;case"z":n=e[r];break;case"roll":c=e[r];break;case"pitch":l=e[r];break;case"yaw":p=e[r];break;case"fov":h=e[r];break;case"fog":e[r];break;case"fogcolor":A=e[r];break;case"clearcolor":e[r];break;case"attachtobody":u=!!e[r];break;case"exportgpuspecs":m=!!e[r];break;case"margin":f=e[r];break;case"cameramode":v=e[r];break;case"ambientlight":d=e[r];break;case"showcrosshair":y=!!e[r];break;case"dataarray":M=e[r];break;case"crosshairsel":b=e[r];break;case"crosshairmap":x=e[r];break;case"context":R.mode=e[r].mode,R.options=e[r].options}}));const T=document.createElement("canvas"),_=T.getContext(R.mode,R.options);T.width=i,T.height=s,T.tabIndex=0,T.style.outline="none";const P=R.mode;if("2d"!=R.mode&&(console.log(`GLSL version: ${_.getParameter(_.SHADING_LANGUAGE_VERSION)}`),_.pixelStorei(_.UNPACK_ALIGNMENT,1)),m&&xe(_),"2d"===R.mode);else _.viewport(0,0,T.width,T.height);var I,w;u&&(T.style.display="block",T.style.position="absolute",T.style.left="50vw",T.style.top="50vh",T.style.transform="translate(-50%, -50%)",document.body.appendChild(T)),window.addEventListener("resize",I=e=>{var a,t=w.margin,r=document.body,o=0!==T.width?T.height/T.width:1;r.clientHeight/r.clientWidth>o?(T.style.width=(a=r.clientWidth)-2*t+"px",T.style.height=a*o-2*t+"px"):(T.style.height=(a=r.clientHeight)-2*t+"px",T.style.width=a/o-2*t+"px")}),w={c:T,ctx:_,contextType:P,t:0,alpha:g,width:i,height:s,x:a,y:t,z:n,roll:c,pitch:l,yaw:p,fov:h,ready:!1,ambientLight:d,pointLights:[],pointLightCols:[],dataArray:M,alphaQueue:[],particleQueue:[],lineQueue:[],active:!0,cameraMode:v,showCrosshair:y,crosshairSel:b,crosshairMap:x,pageX:undefined,pageY:undefined,mouseX:undefined,mouseY:undefined,mouseButton:undefined,rsz:I,margin:f,optionalPlugins:E,fogColor:A},I(),w["2d"==P?"ctx":"gl"]=_;var F=w;F.Clear=()=>{if("2d"===P)T.width=F.c.width;else _.clearColor(...be(F.clearColor),1),_.clear(_.COLOR_BUFFER_BIT),_.clear(_.DEPTH_BUFFER_BIT)};return F.Draw=(e,a=!1,t=!1)=>{var n,i,s=e.shader.datasets[e.datasetIdx],c=s.program;if(F.optionalPlugins.map((e=>{if("post processing"===e.name)if("equirectangular"===e.value)e.enabled&&(n=!0,F.equirectangularPlugin=!0,i=!(-1==e.params.indexOf("omitsplitcheck")));else n=!1,F.equirectangularPlugin=!1})),void 0!==e?.shader)if(!a&&(e.isSprite||e.isLight&&e.showSource)){switch(e.shapeType){case"sprite":case"point light":l="alphaQueue"}F[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...F[l]]}else{if(!a&&(e.isLine||e.isParticle)){var l;switch(e.shapeType){case"particles":l="particleQueue";break;case"lines":l="lineQueue"}F[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...F[l]]}_.useProgram(c);for(var p=0;p<(n&&!i?2:1);p++){if(_.uniform1i(s.locRotationMode,e.rotationMode),F.locPlugin=_.getUniformLocation(s.program,"plugin"),F.locOmitSplitCheck=_.getUniformLocation(s.program,"omitSplitCheck"),F.locSplitCheckPass=_.getUniformLocation(s.program,"splitCheckPass"),_.uniform1f(F.locPlugin,n?1:0),_.uniform1f(F.locOmitSplitCheck,i?1:0),_.uniform1f(F.locSplitCheckPass,p),e.showBounding)S(e,F,e.showBounding,n,i,p);if("particles"==e.shapeType||e.isParticle||"lines"==e.shapeType||e.isLine){if(F.ctx.blendFunc(_.ONE,_.SRC_ALPHA),F.ctx.enable(_.BLEND),_.uniform1f(s.locPointSize,e.size*(t?3:1)),"lines"==e.shapeType&&_.lineWidth(e.size*(t?3:1)),_.uniform1f(s.locIsParticle,e.isParticle),_.uniform1f(s.locIsLine,e.isLine),_.uniform1f(s.locPenumbraPass,e.penumbraPass?1:0),_.uniform1f(s.locT,F.t),_.uniform1f(s.locColorMix,e.colorMix),_.uniform1f(s.locIsSprite,e.isSprite),_.uniform1f(s.locIsLight,e.isLight),_.uniform1f(s.locCameraMode,"fps"==F.cameraMode.toLowerCase()?1:0),_.uniform1f(s.locAlpha,Math.min(1,Math.max(0,t?e.alpha*e.penumbra:e.alpha))),_.uniform3f(s.locColor,...be(e.color)),_.uniform1f(s.locAmbientLight,P/8),_.uniform2f(s.locResolution,F.width,F.height),_.uniform3f(s.locCamPos,F.x,F.y,F.z),_.uniform3f(s.locCamOri,F.roll,F.pitch,F.yaw),_.uniform3f(s.locGeoPos,e.x,e.y,e.z),_.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),_.uniform1f(s.locFov,F.fov),_.uniform1f(s.locEquirectangular,e.equirectangular?1:0),_.uniform1f(s.locRenderNormals,0),e?.vertices?.length){var h,u,f,m,d,g,v,y,b,x;if(e.isLine){m=[];for(var R=F.fov,E=e.size*(t?4:1)/50,A=0;A<e.vertices.length;A+=6)I=e.vertices[A+0],w=e.vertices[A+1],L=e.vertices[A+2],C=e.vertices[A+3],k=e.vertices[A+4],B=e.vertices[A+5],g=z(I,w,L,e,F),v=z(C,k,B,e,F),(g[2]>-200&&v[0]>-200||n)&&(d=Math.atan2(v[0]-g[0],v[1]-g[1])+Math.PI/2,g[0]-=F.width/2,g[1]-=F.height/2,v[0]-=F.width/2,v[1]-=F.height/2,g[0]/=R/2,g[1]/=R/2,v[0]/=R/2,v[1]/=R/2,x=g[2],y=g[0]+r(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]-r(d)*E/x,b=g[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]+r(d)*E/x,b=v[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]+r(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x));m=new Float32Array(m),u=_.createBuffer(),_.bindBuffer(_.ARRAY_BUFFER,u),_.bufferData(_.ARRAY_BUFFER,m,_.STATIC_DRAW),_.bindBuffer(_.ARRAY_BUFFER,null),f=new Uint32Array(Array(m.length/3).fill().map(((e,a)=>a))),h=_.createBuffer(),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,h),_.bufferData(_.ELEMENT_ARRAY_BUFFER,f,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null)}else m=e.vertices,h=e.Vertex_Index_Buffer,u=e.vertex_buffer,f=e.vIndices;_.bindBuffer(_.ARRAY_BUFFER,u),_.bufferData(_.ARRAY_BUFFER,m,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,h),_.bufferData(_.ELEMENT_ARRAY_BUFFER,f,_.STATIC_DRAW),_.bindBuffer(_.ARRAY_BUFFER,u),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,h),s.locPosition=_.getAttribLocation(s.program,"position"),_.vertexAttribPointer(s.locPosition,3,_.FLOAT,!1,0,0),_.enableVertexAttribArray(s.locPosition),e.isLine?_.drawElements(_.TRIANGLES,m.length/3|0,_.UNSIGNED_INT,0):_.drawElements(_.POINTS,e.vertices.length/3|0,_.UNSIGNED_INT,0),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null)}if(F.ctx.blendFunc(_.ONE,_.ZERO),F.ctx.disable(_.BLEND),t)return}else{switch(_.activeTexture(_.TEXTURE0),e.textureMode){case"video":case"dataArray":U(_,s.resource,s.texture,e.textureMode,F.t,e);break;case"canvas":_.activeTexture(_.TEXTURE2),U(_,e.canvasTexture,s.texture,e.textureMode,F.t,e);break;case"image":e.rebindTextures&&U(_,e.image,s.texture,e.textureMode,F.t,e)}void 0!==e.canvasTexture&&(_.activeTexture(_.TEXTURE2),U(_,e.canvasTexture,s.supplementalTexture,"canvas",F.t,e),_.uniform1i(s.locSupplementalTexture,2),_.uniform1f(s.locSupplementalTextureMix,e.canvasTextureMix)),_.activeTexture(_.TEXTURE0),_.uniform1i(s.locTexture,s.texture),_.bindTexture(_.TEXTURE_2D,s.texture),e.heightMap?(_.activeTexture(_.TEXTURE4),_.uniform1i(s.locHeightMap,4),U(_,s.heightResource,s.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,F.t,e),_.uniform1i(s.locHeightTexture,s.heightTexture),_.uniform1f(s.locUseHeightMap,1),_.uniform1f(s.locHeightMapIntensity,e.heightMapIntensity),_.uniform1f(s.locMaxHeightmap,e.maxHeightmap),_.uniform1f(s.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),_.bindTexture(_.TEXTURE_2D,s.heightTexture),_.activeTexture(_.TEXTURE0)):_.uniform1f(s.locUseHeightMap,0),_.uniform1i(s.locPointLightCount,F.pointLights.length);var M=[],T=[];F.pointLights.map((e=>{M.push(e.x,e.y,e.z,e.lum);be(e.color);T.push(...be(e.color),1)})),M.length&&(_.uniform4fv(s.locPointLights,M),_.uniform4fv(s.locPointLightCols,T));var P=F.ambientLight;if(s.optionalLighting.map((e=>{if("ambientLight"===e.name)P=e.value})),_.useProgram(c),F.hasFog||(_.uniform1f(s.locFog,0),_.uniform3f(s.locFogColor,...F.fogColor)),s.optionalUniforms.map((a=>{if("object"==typeof a?.loc)switch(_[a.dataType](a.loc,a.value),_.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"fog":_.uniform1f(s.locFog,a.value),_.uniform3f(s.locFogColor,...be(a.color));break;case"reflection":_.activeTexture(_.TEXTURE1),"image"==a.textureMode&&e.rebindTextures&&U(_,a.image,a.refTexture,a.textureMode,F.t,a),"video"==a.textureMode&&U(_,a.video,a.refTexture,a.textureMode,F.t,a),_.activeTexture(_.TEXTURE1),_.uniform1i(a.locRefTexture,1),_.bindTexture(_.TEXTURE_2D,a.refTexture),_.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"refraction":_.activeTexture(_.TEXTURE5),"video"==a.textureMode&&U(_,a.video,a.refractionTexture,a.textureMode,F.t,a),_.activeTexture(_.TEXTURE5),_.uniform1i(a.locRefractionTexture,5),_.bindTexture(_.TEXTURE_2D,a.refractionTexture),_.uniform1f(a.locRefractionOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0),a.locAngleOfRefraction=_.getUniformLocation(s.program,"angleOfRefraction"),_.uniform1f(a.locAngleOfRefraction,a.angleOfRefraction),_.bindBuffer(_.ARRAY_BUFFER,a.refractionVec_buffer),_.bufferData(_.ARRAY_BUFFER,a.refractionVecs,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,a.refractionVecIndices,_.STATIC_DRAW),_.bindBuffer(_.ARRAY_BUFFER,a.refractionVec_buffer),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),_.vertexAttribPointer(s.locRefractionlVec,3,_.FLOAT,!1,0,0),_.enableVertexAttribArray(s.locRefractionlVec),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null);break;case"phong":a.locPhongTheta=_.getUniformLocation(s.program,"phongTheta"),_.uniform1f(a.locPhongTheta,a.theta+Math.PI);break;case"custom":if(a.uniformName){a.locCustomUniform=_.getUniformLocation(s.program,a.uniformName);var t=a.value;he(t)?_[a.dataType](a.locCustomUniform,...a.value):_[a.dataType](a.locCustomUniform,a.value)}}})),_.uniform1f(s.locT,F.t),_.uniform1f(s.locIsParticle,e.isParticle),_.uniform1f(s.locIsLine,e.isLine),_.uniform1f(s.locPenumbraPass,0),_.uniform1f(s.locColorMix,e.colorMix),_.uniform1f(s.locIsSprite,e.isSprite),_.uniform1f(s.locIsLight,e.isLight),_.uniform1f(s.locCameraMode,"fps"==F.cameraMode.toLowerCase()?1:0),_.uniform1f(s.locAlpha,e.alpha),_.uniform3f(s.locColor,...be(e.color)),_.uniform1f(s.locAmbientLight,P/8),_.uniform2f(s.locResolution,F.width,F.height),_.uniform3f(s.locCamPos,F.x,F.y,F.z),_.uniform3f(s.locCamOri,F.roll,F.pitch,F.yaw),_.uniform3f(s.locGeoPos,e.x,e.y,e.z),_.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),_.uniform1f(s.locFov,F.fov),_.uniform1f(s.locEquirectangular,e.equirectangular?1:0),_.uniform1f(s.locRenderNormals,0),_.bindBuffer(_.ARRAY_BUFFER,e.uv_buffer),_.bufferData(_.ARRAY_BUFFER,e.uvs,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,e.uvIndices,_.STATIC_DRAW),_.vertexAttribPointer(s.locUv,2,_.FLOAT,!1,0,0),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null),e?.normalVecs.length&&(_.bindBuffer(_.ARRAY_BUFFER,e.normalVec_buffer),_.bufferData(_.ARRAY_BUFFER,e.normalVecs,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,e.nIndices,_.STATIC_DRAW),_.bindBuffer(_.ARRAY_BUFFER,e.normalVec_buffer),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),s.locNormalVec=_.getAttribLocation(s.program,"normalVec"),_.vertexAttribPointer(s.locNormalVec,3,_.FLOAT,!1,0,0),_.enableVertexAttribArray(s.locNormalVec),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null)),e?.vertices?.length){if(_.bindBuffer(_.ARRAY_BUFFER,e.vertex_buffer),n){for(A=0;A<e.vertices;A+=9){var I=e.vertices[A+0],w=e.vertices[A+1],L=e.vertices[A+2],C=e.vertices[A+3],k=e.vertices[A+4],B=e.vertices[A+5];e.vertices[A+6],e.vertices[A+7],e.vertices[A+8]}_.bufferData(_.ARRAY_BUFFER,[],_.STATIC_DRAW)}else _.bufferData(_.ARRAY_BUFFER,e.vertices,_.STATIC_DRAW);_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,e.vIndices,_.STATIC_DRAW),_.bindBuffer(_.ARRAY_BUFFER,e.vertex_buffer),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),s.locPosition=_.getAttribLocation(s.program,"position"),_.vertexAttribPointer(s.locPosition,3,_.FLOAT,!1,0,0),_.enableVertexAttribArray(s.locPosition),_.drawElements(e.wireframe?_.LINE_STRIP:_.TRIANGLES,e.vertices.length/3|0,_.UNSIGNED_INT,0),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null)}_.uniform1f(s.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(_.bindBuffer(_.ARRAY_BUFFER,e.normal_buffer),_.bufferData(_.ARRAY_BUFFER,e.normals,_.STATIC_DRAW),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,e.nIndices,_.STATIC_DRAW),_.vertexAttribPointer(s.locNormal,3,_.FLOAT,!1,0,0),s.locNormal=_.getAttribLocation(s.program,"normal"),_.bindBuffer(_.ARRAY_BUFFER,e.normal_buffer),_.bufferData(_.ARRAY_BUFFER,e.normals,_.STATIC_DRAW),_.enableVertexAttribArray(s.locNormal),_.drawElements(_.LINES,e.normals.length/3|0,_.UNSIGNED_INT,0),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindBuffer(_.ARRAY_BUFFER,null))}}}e.rebindTextures=!1},F.nullShader=await N(F,[{uniform:{type:"phong",value:0}}]),F.alphaShader=await N(F,[]),window.addEventListener("mousemove",(e=>{var a=F.c.getBoundingClientRect();F.mouseX=(e.pageX-a.left)/F.c.clientWidth*F.width,F.mouseY=(e.pageY-a.top)/F.c.clientHeight*F.height})),window.addEventListener("mousedown",(e=>{F.mouseButton=e.buttons})),window.addEventListener("mouseup",(e=>{F.mouseButton=-1})),F},u=(e,a,t)=>{if(e.width=a,e.height=t,e.c.width=a,e.c.height=t,e.rsz(),"2d"===e.ctx.mode);else e.ctx.viewport(0,0,e.c.width,e.c.height)},f=e=>{e.c.remove(),e.active=!1},m=e=>{if("point light"===e.shapeType)e.renderer.pointLights=e.renderer.pointLights.filter(((a,t)=>t!=e.pointLightID)),e.renderer.pointLights.map(((e,a)=>e.pointLightID=a))},g=(e,a,t,r,o,n)=>{var i;e.split("\n").forEach((e=>{var n=e.split(" ");switch(n[0]){case"v":n.shift(),a.push(n.map((e=>+e)));break;case"vt":n.shift(),r.push(n.map((e=>+e)));break;case"vn":n.shift(),t.push(n.map((e=>+e)));break;case"f":n.shift(),o.push(n.map((e=>e)))}})),o.map((e=>{var o,s,c,l=[],p=[],h=[],u=!1;if(e.map((e=>{var n=e.split("/");switch(n.length){case 1:o=n[0],l.push(a[o-1]);break;case 2:o=n[0],s=n[1],l.push(a[o-1]),p.push(r[s-1]),!0;break;case 3:o=n[0],s=n[1],c=n[2],l.push(a[o-1]),p.push(r[s-1]),h.push(t[c-1]),u=!0}})),void 0!==l[0]){var f=l[0][0],m=l[0][1],d=l[0][2],g=l[1][0],v=l[1][1],y=l[1][2],b=l[2][0],x=l[2][1],R=l[2][2];if(u)var E=h[0][0],A=h[0][1],M=h[0][2],T=h[1][0],_=h[1][1],P=h[1][2],I=h[2][0],w=h[2][1],F=h[2][2];if(4==l.length){var L=l[3][0],U=l[3][1],C=l[3][2];if(u)var k=h[3][0],z=h[3][1],S=h[3][2]}}switch(l.length){case 3:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+A,d+M],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F])})),h=i,n.vertices.push(...l[0],...l[1],...l[2]),p.length&&void 0!==p[0]&&n.uvs.push(...p[0],...p[1],...p[2]),h.length&&void 0!==h[0]&&n.normals.push(...h[0],...h[1],...h[2]);break;case 4:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+A,d+M],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F],[L,U,C,L+k,U+z,C+S])})),h=i,n.vertices.push(...l[0],...l[1],...l[2],...l[2],...l[3],...l[0]),p.length&&n.uvs.push(...p[0],...p[1],...p[2],...p[2],...p[3],...p[0]),h.length&&n.normals.push(...h[0],...h[1],...h[2],...h[2],...h[3],...h[0])}}))},v=(e,a=0,t=0,r=0,o=0,n=0,i=0)=>{for(var s=0;s<e.uvs.length;s+=2)e.uvs[s+1]=1-e.uvs[s+1];for(s=0;s<e.normals.length;s+=3)e.normals[s+1]=e.normals[s+1];for(s=0;s<e.vertices.length;s+=3){var c=[e.vertices[s+0],e.vertices[s+1],e.vertices[s+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.vertices[s+0]=c[0],e.vertices[s+1]=c[1],e.vertices[s+2]=c[2];for(var l=2;l--;){var p=l?2*s:2*s+3;c=[e.normals[p+0],e.normals[p+1],e.normals[p+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.normals[p+0]=c[0],e.normals[p+1]=c[1],e.normals[p+2]=c[2]}}},y=async(e,a,t,r,o,n,i,s,c=!0,h=!0)=>{var u={vertices:[],normals:[],uvs:[]};if(h&&(l=p.objFiles.filter((a=>a.url==e))).length)u=l[0].ret;else{var f=[],m=[],d=[],y=[];await fetch(e).then((e=>e.text())).then((e=>{g(e,f,m,d,y,u)})),p.objFiles=[...structuredClone(p.objFiles),{url:e,ret:u}]}return v(u,t,r,o,n,i,s),u},b=(e,a,t,r,o=700)=>[r.width/2+e/t*o,r.height/2+a/t*o],x=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},R=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},E=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},A=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},M=(e,a,t)=>{var r=[],o=a.name,n={loaded:!1,curFrame:0,geometries:[],dir:1};return fetch(a.url).then((e=>e.blob())).then((i=>{new zip.ZipReader(new zip.BlobReader(i)).getEntries().then((i=>{var s=i.length;r=Array(s).fill().map((e=>({data:{}}))),i.forEach((async(i,c)=>{(await i.getData(await new zip.BlobWriter)).text().then((i=>{do{0}while("PK"==i.substr(0,2));if("custom shape"!=a.shapeType&&"lines"!=a.shapeType||(i=JSON.parse(i)),r[c].data=i,c==s-1){n.loaded=!0;var l=new zip.ZipWriter(new zip.BlobWriter);r.forEach(((r,i)=>{var c=(""+(i+1)).padStart(4,"0");i%1||!("lines"!=a.shapeType&&"custom shape"!=a.shapeType||void 0!==r.data.vertices&&r.data.vertices.length)||(a.geometryData=r.data,a.name=`${o?o+"_":""}frame${c}.json`,a.isFromZip=!0,w(e,a).then((async e=>{n.geometries[i/1|0]=e,await t.ConnectGeometry(e);for(var r=[],o=[],c=[],p=[],h=0;h<e.vertices.length;h++)r.push(Math.round(1e3*e.vertices[h])/1e3);for(h=0;h<e.uvs.length;h++)p.push(Math.round(1e3*e.uvs[h])/1e3);for(h=0;h<e.normals.length;h+=3)o.push(Math.round(1e3*e.normals[h+0])/1e3),o.push(Math.round(1e3*e.normals[h+1])/1e3),o.push(Math.round(1e3*e.normals[h+2])/1e3);for(h=0;h<e.normalVecs.length;h++)c.push(Math.round(1e3*e.normalVecs[h])/1e3);var u={vertices:r,uvs:p,normals:o,normalVecs:c},f=new zip.TextReader(JSON.stringify(u)),m=(""+(i+1)).padStart(4,"0");l.add(`frame_${m}.json`,f),i==s-1&&a.downloadShape&&await I(await l.close(),"animation.zip")})))}))}}))}))}))})),n},T=(e,a,t)=>{var r=e.t,o=0,n=0,i=0,s=0,c=0,l=0,p="reverse",h=1;if(void 0!==t&&Object.keys(t).forEach(((e,a)=>{switch(e.toLowerCase()){case"x":o=+t[e];break;case"y":n=+t[e];break;case"z":i=+t[e];break;case"roll":s=+t[e];break;case"pitch":c=+t[e];break;case"yaw":l=+t[e];break;case"loopmode":p=t[e];break;case"animationspeed":h=1/+t[e]|0}})),void 0!==a&&a.loaded&&a.geometries.length){for(var u=1;u--;){if(!h||(60*r|0)%h||(a.curFrame+=a.dir),a.curFrame>=a.geometries.length-("cycle"==p?0:1))if("cycle"===p)a.curFrame=0;else a.dir=-1;if(a.curFrame<("cycle"==p?0:1))if("cycle"===p)a.curFrame=a.geometries.length-1;else a.dir=1}var f=a.geometries[a.curFrame];void 0!==f&&void 0!==f.vertices&&f.vertices.length&&(f.x=o,f.y=n,f.z=i,f.roll=s,f.pitch=c,f.yaw=l,e.Draw(f))}},_=e=>{var a="",t=[],r=[],o=[],n=[];if(e?.vertices){t=e.vertices;for(var i=0,s=[],c=0;c<t.length;c+=3){var l=-Math.round(1e4*t[c+0])/1e4,p=Math.round(1e4*t[c+1])/1e4,h=Math.round(1e4*t[c+2])/1e4;a+=`v ${l} ${p} ${h}\n`,s.push(c/3),3==++i&&(i=0,n.push(s),s=[])}}if(e?.normalVecs){o=e.normalVecs;for(c=0;c<o.length;c+=3){var u=-Math.round(1e4*o[c+0])/1e4,f=Math.round(1e4*o[c+1])/1e4,m=Math.round(1e4*o[c+2])/1e4;a+=`vn ${u} ${f} ${m}\n`}}if(e?.uvs){r=e.uvs;for(c=0;c<r.length;c+=2){var d=Math.round(1e4*r[c+0])/1e4,g=Math.round(1e4*r[c+1])/1e4;a+=`vt ${d} ${g}\n`}}return n.forEach(((e,t)=>{var r=t/1|0;a+=`f ${3*r+1}/${2*r+1}/${3*r+1} ${3*r+2}/${2*r+2}/${3*r+2} ${3*r+3}/${2*r+3}/${3*r+3}\n`})),a},P=e=>{if(e.preComputeNormalAssocs){console.log("downloading custom shape, detected preComputeNormalAssocs");var a=[]}for(var t=[],r=[],o=[],n=[],i=0;i<e.vertices.length;i++)t.push(Math.round(1e3*e.vertices[i])/1e3);for(i=0;i<e.uvs.length;i++)n.push(Math.round(1e3*e.uvs[i])/1e3);for(i=0;i<e.normals.length;i++)r.push(Math.round(1e3*e.normals[i])/1e3);for(i=0;i<e.normalVecs.length;i++)o.push(Math.round(1e3*e.normalVecs[i])/1e3);if(e.preComputeNormalAssocs)for(i=0;i<e.normalAssocs.length;i++)a.push(e.normalAssocs[i]);if(e.preComputeNormalAssocs)var s={vertices:t,uvs:n,normals:r,normalVecs:o,normalAssocs:a};else s={vertices:t,uvs:n,normals:r,normalVecs:o};var c=document.createElement("a");c.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s)),e.name||e.name,c.download=e.name+".json",c.click()},I=(e,a="downloaded_file")=>{var t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download=a,t.click(),window.URL.revokeObjectURL(e)},w=async(a,t)=>{var r,o,n,i,s,c,h,u,f,m,d,b,x,R,A,M,T,I,w,F,L;const U=a.gl;var C,k,z,S=!1,N=!1,O=!1,V=!1,Y=0,X=0,J=0,ee=!1,re=!1,oe=!1,ne=0,ie=0,se=0,ce=1,le=1,pe=1,he=1,ue=1,fe=0,me=0,de=!1,ge=16,ve=40,ye="",be="",xe=1,Re=!1,Ee=0,Ae=0,Me=3355443,Te=.1,_e=-1,Pe=0,Ie=-1,we=!1,Fe=!1,Le=!1,Ue="",Ce=!1,ke="",ze=1,Se=6e6,Be=!1,Ne=-1,Oe=!0,Ve=8978210,De=!1,Ye=0,Xe=0,He=0,qe=0,Ge=!1,We=0,je=1,$e=!0,Ke="image",Ze=!1,Qe=!1,Je=!1,ea=512,aa=512,ta=U.RGBA,ra=!1,oa=512,na=512,ia=U.RGBA,sa=1,ca=1,la=[],pa=[],ha={};Object.keys(t).forEach(((e,a)=>{if("showsource"===e.toLowerCase())Ze=!!t[e]})),Object.keys(t).forEach(((a,l)=>{switch(a.toLowerCase()){case"x":Y=t[a];break;case"y":X=t[a];break;case"z":J=t[a];break;case"roll":ne=t[a];break;case"pitch":ie=t[a];break;case"yaw":se=t[a];break;case"shapetype":switch(A=t[a].toLowerCase()){case"sprite":Ue=`${e}/resources/sprite.png`;break;case"point light":Ue=Ze?`${e}/resources/stars/star.png`:""}break;case"size":xe=t[a];break;case"subs":Ee=t[a];break;case"equirectangular":_e=!!t[a];break;case"equirectangularheightmap":Ie=!!t[a];break;case"flipnormals":Fe=!!t[a];break;case"shownormals":Le=!!t[a];break;case"sphereize":Ae=t[a];break;case"rotationmode":Pe=t[a];break;case"rebindtextures":de=!!t[a];break;case"flipx":ee=t[a];break;case"flipy":re=t[a];break;case"flipz":oe=t[a];break;case"objx":r=t[a];break;case"objy":o=t[a];break;case"objz":n=t[a];break;case"objroll":i=t[a];break;case"objpitch":s=t[a];break;case"objyaw":c=t[a];break;case"scaleuvx":he=t[a];break;case"scaleuvy":ue=t[a];break;case"offsetuvx":fe=t[a];break;case"offsetuvy":me=t[a];break;case"scalex":ce=t[a];break;case"scaley":le=t[a];break;case"scalez":pe=t[a];break;case"wireframe":Ge=!!t[a];break;case"name":be=t[a];break;case"color":Me=t[a];break;case"colormix":Te=t[a];break;case"mapisdataarray":Je=!!t[a];break;case"dataarraywidth":ea=+t[a];break;case"dataarrayheight":aa=+t[a];break;case"dataarrayformat":ta=t[a];break;case"heightmapisdataarray":ra=!!t[a];break;case"heightmapdataarraywidth":oa=+t[a];break;case"heightmapdataarrayheight":na=+t[a];break;case"heightpamdataarrayformat":ia=t[a];break;case"exportshape":S=!!t[a];break;case"downloadshape":N=!!t[a];break;case"exportasobj":O=!!t[a];break;case"downloadasobj":V=!!t[a];break;case"penumbra":We=t[a];break;case"url":ye=t[a];break;case"map":Ue=t[a];break;case"heightmap":ke=t[a];break;case"heightmapintensity":ze=t[a];break;case"maxheightmap":Se=+t[a];break;case"heightmapiscanvas":Be=!!t[a];break;case"rows":ge=t[a];break;case"cols":ve=t[a];break;case"disabledepthtest":Qe=t[a];break;case"canvastexturemix":Ne=t[a];break;case"canvastexture":F=t[a],Ke="canvas";break;case"involvecache":$e=!!t[a];break;case"muted":Oe=!!t[a];break;case"lum":sa=t[a];break;case"alpha":ca=t[a];break;case"geometrydata":la=t[a];break;case"precomputenormalassocs":we=!!t[a];break;case"texcoords":pa=t[a];break;case"boundingcolor":Ve=t[a];break;case"showbounding":De=!!t[a];break;case"issprite":Ye=t[a]?1:0;break;case"islight":Xe=t[a]?1:0;break;case"isparticle":He=t[a]?1:0;break;case"isline":qe=t[a]?1:0;break;case"playbackspeed":je=t[a];break;case"averagenormals":Re=!!t[a];break;default:ha[a]=t[a]}})),void 0===r&&(r=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0!==t.canvasTexture?(-1==Ne&&(Ne=1),k=t.canvasTexture,delete t.canvasTexture):Ne=0,t.heightMapIsCanvas&&(z=t.heightMap,delete t.heightMap),t=structuredClone(t),void 0!==k&&(t.canvasTexture=k),void 0!==z&&(t.heightMap=z);var ua,fa,ma=[],da=[],ga=[],va=[],ya=!1,ba=!1;if(-1!=A.indexOf("custom shape")||ye&&"lines"==A)ua=ye,fa=`${A} ${be} (${ye})`;else if(fa=`${A}_${Ee}`,Ee<5&&fa)switch(fa){case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"tetrahedron_5":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"cube_5":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"octahedron_5":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"dodecahedron_5":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"icosahedron_5":case"cylinder_0":case"torus_0":case"torus knot_0":if("cylinder_0"!=fa&&"torus_0"!=fa||"cylinder_0"==fa&&16==ge&&40==ve||"torus_0"==fa&&16==ge&&40==ve||"torus knot_0"==fa&&16==ge&&40==ve)if(ya=!0,ua=`${ye=`${e}/new%20shapes/`}${fa}.json`,$e&&(l=p.geometry.filter((e=>e.url==ua))).length)console.log(`found geometry (${fa}) in cache... using it`),void 0!==(xa=l[0].data).normalAssocs&&(L=xa.normalAssocs),ga=new Float32Array(xa.vertices),da=new Float32Array(xa.normals),va=new Float32Array(xa.normalVecs),ma=new Float32Array(xa.uvs),ba=!0,ya=!0;else await fetch(ua).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),ga=e.vertices,da=e.normals,va=e.normalVecs,ma=e.uvs,p.geometry.push({data:structuredClone(e),url:ua})})),ya=!0}if(!ya)switch(A){case"custom shape":case"lines":if("lines"==A){if(!ye)break;qe=!0}var xa;if(void 0===la.vertices&&$e&&(l=p.customShapes.filter((e=>e.url==ye))).length)console.log("found custom shape in cache... using it"),void 0!==(xa=l[0].data).normalAssocs&&(L=xa.normalAssocs),ga=xa.vertices,da=xa.normals,va=xa.normalVecs,ma=xa.uvs,ya=!0,ba=!0;ya||(void 0!==la.vertices&&la.vertices.length?(void 0!==la.normalAssocs&&(L=la.normalAssocs),ga=la.vertices,da=la.normals,va=la.normalVecs,ma=la.uvs,ya=!0):await fetch(ua).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),ga=e.vertices,da=e.normals,va=e.normalVecs,ma=e.uvs,ya=!0,p.customShapes.push({data:structuredClone(e),url:ye})})))}if(ya)switch(A){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==_e&&(_e=!0),-1==Ie&&(Ie=!0)}else switch(A){case"tetrahedron":-1==_e&&(_e=!0),-1==Ie&&(Ie=!0),(C=await W(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"octahedron":-1==_e&&(_e=!0),-1==Ie&&(Ie=!0),(C=await j(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"icosahedron":-1==_e&&(_e=!0),-1==Ie&&(Ie=!0),(C=await $(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"torus":(C=await q(xe,Ee,Ae,Fe,A,ge,ve)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"torus knot":(C=await G(xe,Ee,ge,ve,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"cylinder":(C=await H(xe,Ee,ge,ve,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"dynamic":(C=await D(la,pa,xe,Ee+1,Ae,Fe,!!la.filter((e=>4==e.length)).length,A)).geometry.map((e=>{ga.push(...e.position),Fe?da.push(...e.normal.map((e=>-1*e))):da.push(...e.normal),void 0!==e.texCoord&&e.texCoord.length&&ma.push(...e.texCoord)}));break;case"lines":qe=1,la.map((e=>{ga.push(...e)}));break;case"bspline":qe=1,t.omitShape=!0,await te(a,t).then((e=>{e.curve.map((e=>{ga.push(...e)}))}));break;case"curveto":qe=1,t.omitShape=!0,await ae(a,t).then((e=>{e.map((e=>{ga.push(...e)}))}));break;case"cube":(C=await Z(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"rectangle":(C=await Q(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"sprite":Ye=!0,(C=await Q(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"particles":He=1,la.map((e=>{ga.push(...e)}));break;case"point light":Xe=!0,(C=Ze?await Q(Math.max(xe,.5),Ee+1,Ae,Fe,A):{geometry:[]}).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}));break;case"obj":if(la.length){var Ra={vertices:[],normals:[],uvs:[]};g(la,[],[],[],[],Ra),v(Ra),ga=Ra.vertices,da=Ra.normals,ma=Ra.uvs,ya=!0}else C=await y(ye,0,0,0,0,0,0,0,c,!1),ga=C.vertices,da=C.normals,ma=C.uvs;break;case"dodecahedron":-1==_e&&(_e=!0),-1==Ie&&(Ie=!0),(C=await K(xe,Ee,Ae,Fe,A)).geometry.map((e=>{ga.push(...e.position),da.push(...e.normal),ma.push(...e.texCoord)}))}if(0!=fe||0!=me)for(var Ea=0;Ea<ma.length;Ea+=2)ma[Ea+0]+=fe,ma[Ea+1]+=me;if(1!=he||1!=ue)for(Ea=0;Ea<ma.length;Ea+=2)ma[Ea+0]*=he,ma[Ea+1]*=ue;if("lines"!=A&&"particles"!=A&&!He&&"custom shape"!=A&&"obj"!=A||Ae||1!=ce||1!=le||1!=pe){var Aa=Ae,Ma=1-Ae,Ta=He||qe?1:xe;for(Ea=0;Ea<ga.length;Ea+=3){var _a,Pa=ga[Ea+0],Ia=ga[Ea+1],wa=ga[Ea+2];Pa/=_a=Math.hypot(Pa,Ia,wa)+1e-4,Ia/=_a,wa/=_a,Pa*=Aa+_a*Ma,Ia*=Aa+_a*Ma,wa*=Aa+_a*Ma,ga[Ea+0]=Pa*Ta*ce,ga[Ea+1]=Ia*Ta*le,ga[Ea+2]=wa*Ta*pe;var Fa=da[2*Ea+0],La=da[2*Ea+1],Ua=da[2*Ea+2];da[2*Ea+0]+=ga[Ea+0]-Fa,da[2*Ea+1]+=ga[Ea+1]-La,da[2*Ea+2]+=ga[Ea+2]-Ua,da[2*Ea+3]+=ga[Ea+0]-Fa,da[2*Ea+4]+=ga[Ea+1]-La,da[2*Ea+5]+=ga[Ea+2]-Ua}}if(Re&&B(ga,da,A,va,Fe),"dynamic"==A||we){L=[];for(Ea=0;Ea<ga.length;Ea+=3){for(var Ca=ga[Ea+0],ka=ga[Ea+1],za=ga[Ea+2],Sa=[],Ba=0;Ba<ga.length;Ba+=3){var Na=ga[Ba+0],Oa=ga[Ba+1],Va=ga[Ba+2];Math.hypot(Ca-Na,ka-Oa,za-Va)<.001&&Sa.push(Ba)}L.push(Sa)}}if(("custom shape"==A||"obj"==A)&&(s||i||c||r||o||n))for(Ea=0;Ea<ga.length;Ea+=3){Y=ga[Ea+0],X=ga[Ea+1],J=ga[Ea+2];var Da=E(Y,X,J,{roll:i,pitch:s,yaw:c});if(ga[Ea+0]=Da[0]+r,ga[Ea+1]=Da[1]+o,ga[Ea+2]=Da[2]+n,da.length){for(var Ya=2;Ya--;){Y=da[2*Ea+0+3*Ya],X=da[2*Ea+1+3*Ya],J=da[2*Ea+2+3*Ya];Da=E(Y,X,J,{roll:i,pitch:s,yaw:c});da[2*Ea+0+3*Ya]=Da[0]+r,da[2*Ea+1+3*Ya]=Da[1]+o,da[2*Ea+2+3*Ya]=Da[2]+n}Y=va[Ea+0],X=va[Ea+1],J=va[Ea+2];Da=E(Y,X,J,{roll:i,pitch:s,yaw:c});va[Ea+0]=Da[0],va[Ea+1]=Da[1],va[Ea+2]=Da[2]}}if(!("custom shape"==A||"obj"==A||He||qe||Re||ba&&ya)){va=[];for(Ea=0;Ea<da.length;Ea+=6){let e=da[Ea+3]-da[Ea+0],a=da[Ea+4]-da[Ea+1],t=da[Ea+5]-da[Ea+2];va.push(e,a,t)}}if(ee)for(Ea=0;Ea<ga.length;Ea+=3)ga[Ea+1]*=-1;if(re)for(Ea=0;Ea<ga.length;Ea+=3)ga[Ea+1]*=-1;if(oe)for(Ea=0;Ea<ga.length;Ea+=3)ga[Ea+1]*=-1;if(Fe&&!Re){for(Ea=0;Ea<da.length;Ea+=6)da[Ea+3]=da[Ea+0]-(da[Ea+3]-da[Ea+0]),da[Ea+4]=da[Ea+1]-(da[Ea+4]-da[Ea+1]),da[Ea+5]=da[Ea+2]-(da[Ea+5]-da[Ea+2]);for(Ea=0;Ea<va.length;Ea+=3)va[Ea+0]*=-1,va[Ea+1]*=-1,va[Ea+2]*=-1}if(S){(Ha=document.createElement("div")).style.position="fixed",Ha.style.zIndex=1e5,Ha.style.left="50%",Ha.style.top="50%",Ha.style.transform="translate(-50%, -50%)",Ha.style.background="#0008",Ha.style.padding="20px",Ha.style.width="600px",Ha.style.height="350px",Ha.style.border="1px solid #fff4",Ha.style.borderRadius="5px",Ha.style.fontFamily="monospace",Ha.style.fontSize="20px",Ha.style.color="#fff",(qa=document.createElement("div")).style.fontSize="24px",qa.style.color="#0f8c",qa.innerHTML=`Export Coordinates File -> ${A} `+(t?.name?`(${t.name})`:"")+"<br><br>",Ha.appendChild(qa),(Ga=document.createElement("div")).style.minWidth="100%",Ga.style.height="250px",Ga.style.background="#333",Ga.style.border="1px solid #fff4",Ga.style.overflowY="auto",Ga.style.wordWrap="break-word",Ga.style.color="#888",Ga.style.fontSize="10px",Ha.appendChild(Ga),(Wa=document.createElement("button")).style.border="none",Wa.style.padding="3px",Wa.style.cursor="pointer",Wa.fontSize="20px",Wa.style.borderRadius="10px",Wa.style.margin="10px",Wa.style.minWidth="100px",Wa.innerHTML="📋 copy",Wa.title="copy shape data to clipboard",Wa.onclick=()=>{var e=document.createRange();e.selectNode(Ga),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),Wa.innerHTML="COPIED!",setTimeout((()=>{Wa.innerHTML="📋 copy"}),1e3)},Ha.appendChild(Wa),(ja=document.createElement("button")).onclick=()=>Ha.remove(),ja.style.border="none",ja.style.padding="3px",ja.style.cursor="pointer",ja.fontSize="20px",ja.style.borderRadius="10px",ja.style.margin="10px",ja.style.background="#faa",ja.style.minWidth="100px",ja.innerHTML="close",Ha.appendChild(ja);var Xa={vertices:[],normals:[],normalVecs:[],uvs:[]};ga.map((e=>Xa.vertices.push(Math.round(1e3*e)/1e3))),ha.preComputeNormalAssocs&&(Xa.normalAssocs=[],ha.normalAssocs.map((e=>Xa.vertices.push(e))));for(Ea=0;Ea<da.length;Ea+=6){Ca=da[Ea+0],ka=da[Ea+1],za=da[Ea+2],Na=Fe?da[Ea+0]-(da[Ea+3]-da[Ea+0]):da[Ea+3],Oa=Fe?da[Ea+1]-(da[Ea+4]-da[Ea+1]):da[Ea+4],Va=Fe?da[Ea+2]-(da[Ea+5]-da[Ea+2]):da[Ea+5];Ca=Math.round(1e3*Ca)/1e3,ka=Math.round(1e3*ka)/1e3,za=Math.round(1e3*za)/1e3,Na=Math.round(1e3*Na)/1e3,Oa=Math.round(1e3*Oa)/1e3,Va=Math.round(1e3*Va)/1e3,Xa.normals.push(Ca,ka,za,Na,Oa,Va)}for(Ea=0;Ea<va.length;Ea++)Xa.normalVecs.push((Fe?-1:1)*Math.round(1e3*va[Ea])/1e3);ma.map((e=>Xa.uvs.push(Math.round(1e3*e)/1e3))),Ga.innerHTML=JSON.stringify(Xa),document.body.appendChild(Ha)}if(O){var Ha,qa,Ga,Wa,ja;(Ha=document.createElement("div")).style.position="fixed",Ha.style.zIndex=1e5,Ha.style.left="50%",Ha.style.top="50%",Ha.style.transform="translate(-50%, -50%)",Ha.style.background="#0008",Ha.style.padding="20px",Ha.style.width="600px",Ha.style.height="350px",Ha.style.border="1px solid #fff4",Ha.style.borderRadius="5px",Ha.style.fontFamily="monospace",Ha.style.fontSize="20px",Ha.style.color="#fff",(qa=document.createElement("div")).style.fontSize="24px",qa.style.color="#0f8c",qa.innerHTML=`Export OBJ File -> ${A} `+(t?.name?`(${t.name})`:"")+"<br><br>",Ha.appendChild(qa),(Ga=document.createElement("div")).style.minWidth="100%",Ga.style.height="250px",Ga.style.background="#333",Ga.style.border="1px solid #fff4",Ga.style.overflowY="auto",Ga.style.wordWrap="break-word",Ga.style.color="#888",Ga.style.fontSize="10px",Ha.appendChild(Ga),(Wa=document.createElement("button")).style.border="none",Wa.style.padding="3px",Wa.style.cursor="pointer",Wa.fontSize="20px",Wa.style.borderRadius="10px",Wa.style.margin="10px",Wa.style.minWidth="100px",Wa.innerHTML="📋 copy",Wa.title="copy shape data to clipboard",Wa.onclick=()=>{var e=document.createRange();e.selectNode(Ga),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),Wa.innerHTML="COPIED!",setTimeout((()=>{Wa.innerHTML="📋 copy"}),1e3)},Ha.appendChild(Wa),(ja=document.createElement("button")).onclick=()=>Ha.remove(),ja.style.border="none",ja.style.padding="3px",ja.style.cursor="pointer",ja.fontSize="20px",ja.style.borderRadius="10px",ja.style.margin="10px",ja.style.background="#faa",ja.style.minWidth="100px",ja.innerHTML="close",Ha.appendChild(ja);var $a=_({vertices:ga,normalVecs:va,uvs:ma,shapeType:A,averageNormals:Re});$a=$a.replaceAll("\n","<br>"),Ga.innerHTML=$a,document.body.appendChild(Ha)}ba||(ga=new Float32Array(ga),da=new Float32Array(da),va=new Float32Array(va),ma=new Float32Array(ma)),h=U.createBuffer(),U.bindBuffer(U.ARRAY_BUFFER,h),U.bufferData(U.ARRAY_BUFFER,ga,U.STATIC_DRAW),U.bindBuffer(U.ARRAY_BUFFER,null),M=new Uint32Array(Array(ga.length/3).fill().map(((e,a)=>a))),u=U.createBuffer(),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,u),U.bufferData(U.ELEMENT_ARRAY_BUFFER,M,U.STATIC_DRAW),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,null),d=U.createBuffer(),U.bindBuffer(U.ARRAY_BUFFER,d),U.bufferData(U.ARRAY_BUFFER,va,U.STATIC_DRAW),U.bindBuffer(U.ARRAY_BUFFER,null),I=new Uint32Array(Array(va.length/3).fill().map(((e,a)=>a))),b=U.createBuffer(),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,b),U.bufferData(U.ELEMENT_ARRAY_BUFFER,I,U.STATIC_DRAW),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,null),f=U.createBuffer(),U.bindBuffer(U.ARRAY_BUFFER,f),U.bufferData(U.ARRAY_BUFFER,da,U.STATIC_DRAW),U.bindBuffer(U.ARRAY_BUFFER,null),T=new Uint32Array(Array(da.length/3).fill().map(((e,a)=>a))),m=U.createBuffer(),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,m),U.bufferData(U.ELEMENT_ARRAY_BUFFER,T,U.STATIC_DRAW),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,null),x=U.createBuffer(),U.bindBuffer(U.ARRAY_BUFFER,x),U.bufferData(U.ARRAY_BUFFER,ma,U.STATIC_DRAW),U.bindBuffer(U.ARRAY_BUFFER,null),w=new Uint32Array(Array(ma.length/2).fill().map(((e,a)=>a))),R=U.createBuffer(),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,R),U.bufferData(U.ELEMENT_ARRAY_BUFFER,w,U.STATIC_DRAW),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,null),-1==_e&&(_e=!1),-1==Ie&&(Ie=!1);var Ka={x:Y,y:X,z:J,rows:ge,cols:ve,roll:ne,pitch:ie,yaw:se,color:Me,colorMix:Te,size:xe,subs:Ee,name:be,url:ye,averageNormals:Re,showNormals:Le,exportShape:S,downloadShape:N,shapeType:He?"particles":qe?"lines":A,normalAssocs:L,sphereize:Ae,equirectangular:_e,flipNormals:Fe,vertices:ga,normals:da,normalVecs:va,uvs:ma,vertex_buffer:h,Vertex_Index_Buffer:u,normal_buffer:f,Normal_Index_Buffer:m,muted:Oe,normalVec_buffer:d,NormalVec_Index_Buffer:b,nVecIndices:I,uv_buffer:x,UV_Index_Buffer:R,vIndices:M,nIndices:T,uvIndices:w,map:Ue,video:undefined,textureMode:Ke,isSprite:Ye,isLight:Xe,playbackSpeed:je,disableDepthTest:Qe,lum:sa,alpha:ca,involveCache:$e,renderer:a,isParticle:He,isLine:qe,penumbra:We,wireframe:Ge,canvasTexture:F,canvasTextureMix:Ne,showBounding:De,boundingColor:Ve,heightMap:ke,heightMapIntensity:ze,heightMapIsCanvas:Be,equirectangularHeightmap:Ie,flipX:ee,flipY:re,flipZ:oe,isFromZip:Ce,rotationMode:Pe,mapIsDataArray:Je,dataArrayFormat:ta,maxHeightmap:Se,dataArrayWidth:ea,dataArrayHeight:aa,preComputeNormalAssocs:we,heightmapIsDataArray:ra,heightmapDataArrayFormat:ia,heightmapDataArrayWidth:oa,heightmapDataArrayHeight:na,rebindTextures:de,exportAsOBJ:O,downloadAsOBJ:V};return Object.keys(Ka).forEach(((e,a)=>{ha[e]=Ka[e]})),"particles"==ha.shapeType||He||"lines"==ha.shapeType||qe?await a.alphaShader.ConnectGeometry(ha):("point light"!=A&&"sprite"!=A||(void 0===t.color&&(ha.color=11184810),"point light"==A&&(ha.pointLightID=a.pointLights.length,a.pointLights.push(ha))),await a.nullShader.ConnectGeometry(ha)),ha.downloadShape&&P(ha),ha.downloadAsOBJ&&(e=>{console.log(`downloading '${e.name?e.name:e.shapeType}' as OBJ file`);var a=document.createElement("a");a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(_(e)),a.download=(e.name?e.name:e.shapeType)+".obj",a.click()})(ha),ha},F=async(e="",a=!1,t=(()=>{}),r=400,o=300)=>{var n=document.createElement("div");n.className="genericPopup",n.style.position="fixed",n.style.zIndex=1e5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.background="#0008",n.style.padding="20px",n.style.width=`${r}px`,n.style.height=`${o}px`,n.style.border="1px solid #fff4",n.style.borderRadius="5px",n.style.fontFamily="monospace",n.style.fontSize="20px",n.style.color="#fff";var i=document.createElement("div");if(i.style.fontSize="24px",i.style.color="#0f8c",i.innerHTML=e,n.appendChild(i),a){var s=document.createElement("button");s.onclick=()=>{t(),n.remove()},s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="SURE!",n.appendChild(s)}var c=document.createElement("button");c.onclick=()=>n.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",n.appendChild(c),document.body.appendChild(n)},L=e=>{let a=e;if(!J(e.width)||!J(e.height)){let t,r,o=document.createElement("canvas"),n=o.getContext("2d",{imageSmoothingEnabled:!0}),i=8,s=0,c=6e6,l=Math.hypot(e.width,e.height);for(let e=0;e<16;e++)(t=Math.abs(s-l))<c&&(c=t,s=i*2**e,r=e);s-=i*2**(r-1),o.width=s,o.height=s,n.drawImage(e,0,0,o.width,o.height),a=new Image,a=o}return a},U=(e,a,t,r="image",o=-1,n={},i=!0)=>{let h;switch(r){case"canvas":case"heightImage":h=a;break;case"dataArray":h=n.map,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"heightmapDataArray":h=n.heightMap,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"video":i&&(l=p.texImages.filter((e=>e.url==n.map&&-1!=o&&e.tVal==o))).length?(console.log("found video texture in cache... using it"),h=l[0].texImage):(h=(e=>{if(void 0!==e){let a,t;if(s.width!=e.videoWidth||s.height!=e.videoHeight?(a=e.videoWidth,t=e.videoHeight):(a=s.width,t=s.height),!J(a)||!J(t)){let e,r,o=8,n=0,i=6e6,s=Math.hypot(a,t);for(let a=0;a<12;a++)(e=Math.abs(n-s))<i&&(i=e,n=o*2**a,r=a);n-=o*2**(r-1),n=Math.min(512,n),a=n/1,t=n/1}s.width==a&&s.width==t||(s.width=a,s.height=t),c.drawImage(e,0,0,a,t)}else s.width=1,s.height=1;return s})(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}));break;case"image":i&&(l=p.texImages.filter((e=>e.url==n.map))).length?(console.log("found image texture in cache... using it"),h=l[0].texImage):(h=L(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}))}e.bindTexture(e.TEXTURE_2D,t),"dataArray"==r?void 0!==n.dataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.dataArrayFormat,n.dataArrayWidth,n.dataArrayHeight,0,n.dataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):"heightmapDataArray"==r?void 0!==n.heightmapDataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.heightmapDataArrayFormat,n.heightmapDataArrayWidth,n.heightmapDataArrayHeight,0,n.heightmapDataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):void 0!==h&&h.width&&h.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},C=e=>{var a=e.vertices;e.preComputeNormalAssocs=!0,e.normalAssocs=[];for(var t=0;t<a.length;t+=3){for(var r=a[t+0],o=a[t+1],n=a[t+2],i=[],s=0;s<a.length;s+=3){var c=a[s+0],l=a[s+1],p=a[s+2];Math.hypot(r-c,o-l,n-p)<.001&&i.push(s)}e.normalAssocs.push(i)}},k=(e,a=!1,t=!1,r=!0,o=0,n=0,i=0)=>{for(var s,c,l,p,h,u,f,m,d,g,v=[],y=0;y<e.vertices.length;y+=9)s=e.vertices[y+0],c=e.vertices[y+1],l=e.vertices[y+2],p=e.vertices[y+3],h=e.vertices[y+4],u=e.vertices[y+5],f=e.vertices[y+6],m=e.vertices[y+7],d=e.vertices[y+8],g=ie([[s,c,l],[p,h,u],[f,m,d]],r,o,n,i),v.push(g);var b=t?1:-1;if(v.map(((a,t)=>{for(var r=0;r<3;r++)e.normals[18*t+6*r+0]=e.vertices[9*t+3*r+0],e.normals[18*t+6*r+1]=e.vertices[9*t+3*r+1],e.normals[18*t+6*r+2]=e.vertices[9*t+3*r+2],e.normals[18*t+6*r+3]=e.vertices[9*t+3*r+0]+(a[3]-a[0])*b,e.normals[18*t+6*r+4]=e.vertices[9*t+3*r+1]+(a[4]-a[1])*b,e.normals[18*t+6*r+5]=e.vertices[9*t+3*r+2]+(a[5]-a[2])*b,e.normalVecs[9*t+3*r+0]=e.normals[18*t+6*r+3]-e.normals[18*t+6*r+0],e.normalVecs[9*t+3*r+1]=e.normals[18*t+6*r+4]-e.normals[18*t+6*r+1],e.normalVecs[9*t+3*r+2]=e.normals[18*t+6*r+5]-e.normals[18*t+6*r+2]})),a){(void 0===e.normalAssocs||e.normalAssocs.length!=e.vertices.length/3|0)&&(console.log("generating normal assocs"),C(e));var x=structuredClone(e.normalVecs);for(y=0;y<e.normalVecs.length;y+=3){var R=y/3,E=[0,0,0];e.normalAssocs[R].forEach((e=>{0;for(var a=0;a<3;a++)E[a]+=x[e+a]}));for(var A=0;A<3;A++)e.normalVecs[y+A]=E[A]/=3,e.normals[2*y+A]=e.vertices[y+A],e.normals[2*y+A+3]=e.vertices[y+A]+E[A]}}},z=(e,a,t,n,i,s=0,c=0,l=0,p=0,h=0,u=!1,f=!0,m=0)=>{var d,g,v,y;if(n.heightMap&&Me.length){var b;if(n.equirectangularHeightmap){var x,E=e,M=a,T=t,_=Math.hypot(E,M,T);b=[S=(x=Math.atan2(E,T))/Math.PI/2,N=Math.acos(M/(Math.hypot(E,M,T)+1e-5))/Math.PI]}else b=[p,h];var P=4*((Te.width*b[0]|0)+(Te.height*Te.width*b[1]|0)),I=Me[P+0]/256,w=Me[P+1]/256,F=Me[P+2]/256,L=Math.min(n.maxHeightmap,(I+w+F)/3*n.heightMapIntensity/2);e+=s*L,a+=c*L,t+=l*L}e=(y=R(e,a*=-1,t,{roll:1e-4-n.roll,pitch:-n.pitch,yaw:n.yaw},!1))[0],a=y[1],t=y[2],n.isLight&&(e=(y=A(e,a,t,{roll:i.roll,pitch:i.pitch,yaw:-i.yaw},!1))[0],a=y[1],t=y[2]);var U=i.x,C=i.y,k=i.z;e+=n.x,a-=n.y,t+=n.z,"fps"==i.cameraMode.toLowerCase()?(e=(y=R(e+=U,a-=C,t+=k,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],t=y[2],U=0,C=0,k=0):(e=(y=R(e,a,t,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],t=y[2]);var z=!1;if(u){d=e+U,g=a-C,v=t+k;var S,B;_=Math.hypot(d,g,v);f?S=Math.atan2(d,v)/Math.PI:0==m?(x=Math.atan2(d,v)+Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)<=-1,S+=.5):(x=Math.atan2(d,v)-Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)>=1,S-=.5);var N=-(Math.acos(g/(_+1e-4))/Math.PI*2-1);return!z&&[i.width/2+S*i.width/2,i.height/2+N*i.height/2,_]}e+=U,a-=C,t-=k;var O=i.fov;return(v=t+(k/1e3*O+k))>0&&[d=i.width/2+e/v*O/2,g=i.height/2+a/v*O/2,v]},S=(e,a,t=!0,r=-1,o=!0,n=0)=>{if(-1==r&&(r=a.equirectangularPlugin),e.isLight)return[];var i,s,c,l,p,h=[],u=[];const f=(e,a,r=-1,o=9)=>{r!=a&&(r=a,h.push(a),A=e[a][0],M=e[a][1],l=p=-9,e.map(((t,r)=>{r!=a&&(T=e[r][0],_=e[r][1],(d=Math.atan2(_-M-1e-5,A-T))>=l&&d<=o&&(l=d,p=r))})),-9!=p&&(t&&u.push(...e[p]),f(e,p,r,l)))};var m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w=[],F=-1,L=1e6,U=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(Te.width=U.heightResource.videoWidth/2,Te.height=U.heightResource.videoHeight/2):(Te.width=U.heightResource.width/2,Te.height=U.heightResource.height/2),_e.drawImage(U.heightResource,0,0,Te.width,Te.height),Me=Te.width?_e.getImageData(0,0,Te.width,Te.height).data:[]);for(var C=0;C<e.vertices.length;C+=3){(!e.isLine||C%2)&&(e.isLine||!e.isParticle&&C%9)||(g=v=0,m=[]),i=e.vertices[C+0],s=e.vertices[C+1],c=e.vertices[C+2],y=C+0<e.normalVecs.length?e.normalVecs[C+0]:0,b=C+1<e.normalVecs.length?e.normalVecs[C+1]:0,x=C+2<e.normalVecs.length?e.normalVecs[C+2]:0;var k=2*(C/3|0);R=k+0<e.uvs.length?e.uvs[k+0]:0,E=k+1<e.uvs.length?e.uvs[k+1]:0;var S=z(i,s,c,e,a,y,b,x,R,E,r,o,n);S&&(m.push([S[0],S[1]]),g+=S[0],v+=S[1],(e.isLine&&C%9==3||!e.isLine&&(e.isParticle||C%9==6))&&(g/=3,v/=3,Math.hypot(g-F,v-L)>10&&(F=g,L=v,w.push(m))))}e.isParticle||e.isLine?(m=[],w.map(((e,a)=>{A=e[0][0],M=e[0][1],m.filter((e=>e[0]==A&&e[1]==M)).length||m.push([A,M])}))):(m=[],w.map(((e,a)=>{e.length>2&&(A=e[0][0],M=e[0][1],T=e[1][0],_=e[1][1],P=e[2][0],I=e[2][1],m.filter((e=>e[0]==A&&e[1]==M)).length||m.push([A,M]),m.filter((e=>e[0]==T&&e[1]==_)).length||m.push([T,_]),m.filter((e=>e[0]==P&&e[1]==I)).length||m.push([P,I]))})));var B,N=6e6,O=-1;if(m.map(((e,a)=>{e[1]<=N&&(O=a,N=e[1])})),m.length&&(f(m,O),t)){var V=ye(e.boundingColor);Ae.ctx.strokeStyle=`rgba(${256*V[0]},${256*V[1]},${256*V[2]},.5)`,Ae.ctx.globalAlpha=1,Ae.ctx.beginPath(),u.map(((e,a)=>{Ae.ctx.lineWidth=10;var t=u[a][0],r=u[a][1],i=u[B=(a+1)%u.length][0],s=u[B][1];o?(Ae.ctx.moveTo(t,r),Ae.ctx.lineTo(i,s)):0==n?t>=Ae.width/2-Ae.width/8&&t<Ae.width+Ae.width/8&&i>=Ae.width/2-Ae.width/8&&i<Ae.width+Ae.width/8&&(Ae.ctx.moveTo(t,r),Ae.ctx.lineTo(i,s)):t<=Ae.width/2+Ae.width/8&&t>-Ae.width/8&&i<=Ae.width/2+Ae.width/8&&i>-Ae.width/8&&(Ae.ctx.moveTo(t,r),Ae.ctx.lineTo(i,s))})),Ae.ctx.stroke()}return h.map((e=>[m[e][0],m[e][1]]))},B=(e,a,t,r,o)=>{for(var n,i=[],s=V(t),c=o?-1:1,l=0;l<e.length;l+=3)l%9||(n=ie([[e[l+0],e[l+1],e[l+2]],[e[l+3],e[l+4],e[l+5]],[e[l+6],e[l+7],e[l+8]]],s)),i[2*l+0]=e[l+0],i[2*l+1]=e[l+1],i[2*l+2]=e[l+2],i[2*l+3]=e[l+0]-(n[3]-n[0])*c,i[2*l+4]=e[l+1]-(n[4]-n[1])*c,i[2*l+5]=e[l+2]-(n[5]-n[2])*c;var p,h,u,f,m,d,g,v,y,b,x,R,E,A=structuredClone(i);for(l=0;l<i.length;l+=6){m=i[l+0],d=i[l+1],g=i[l+2],h=i[l+3],u=i[l+4],f=i[l+5],p=1;for(var M=0;M<i.length;M+=6)M!=l&&(v=i[M+0],y=i[M+1],b=i[M+2],x=i[M+3],R=i[M+4],E=i[M+5],Math.hypot(m-v,d-y,g-b)<.01&&(h+=x,u+=R,f+=E,p++));A[l+3]=h/=p,A[l+4]=u/=p,A[l+5]=f/=p}A.map(((e,a)=>i[a]=e));for(l=0;l<i.length;l+=6){for(var T=6;T--;)a[l+T]=i[l+T];for(T=3;T--;)r[l/2+T]=-(i[l+3+T]-i[l+T])*c}},N=async(e,a=[])=>{const t=e.gl;var r={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};await a.map((a=>{Object.keys(a).forEach(((t,o)=>{switch(t.toLowerCase()){case"lighting":if("ambientlight"===a[t].type.toLowerCase())if(void 0===a[t]?.enabled||a[t].enabled){var n={name:a[t].type,value:void 0===a[t].value?e.ambientLight:a[t].value};r.optionalLighting.push(n)}break;case"uniform":switch(a[t].type.toLowerCase()){case"custom":if(void 0===a[t]?.enabled||a[t].enabled){var i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,uniformName:void 0===a[t].name?"":a[t].name,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?0:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,dataType:void 0===a[t].dataType?"uniform1f":a[t].dataType,vertDeclaration:void 0===a[t].vertDeclaration?"":a[t].vertDeclaration,vertCode:void 0===a[t].vertCode?"":a[t].vertCode,fragDeclaration:void 0===a[t].fragDeclaration?"":a[t].fragDeclaration,fragCode:void 0===a[t].fragCode?"":a[t].fragCode};r.optionalUniforms.push(i)}break;case"fog":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,loc:"",value:void 0===a[t].value?.5:a[t].value,color:void 0===a[t].color?8947848:a[t].color,dataType:"uniform1f",vertDeclaration:"",vertCode:"",fragDeclaration:"",fragCode:""};e.clearColor=i.color,e.hasFog=!0,r.optionalUniforms.push(i)}break;case"reflection":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:" \n                  ",fragDeclaration:"\n                    uniform float reflection;\n                    uniform float refFlatShading;\n                    uniform float refOmitEquirectangular;\n                    uniform float refFlipRefs;\n                    uniform sampler2D reflectionMap;\n                  ",fragCode:"\n                    //light.rgb *= .5;\n                    //light.rgb += .05;\n                    float refP1, refP2;\n                    if(refOmitEquirectangular != 1.0){\n                      vec3 reflectionPos = R_rpy(nV, vec3(0.0,\n                                                      -camOri.y, -camOri.z));\n                      float px = reflectionPos.x;\n                      float py = reflectionPos.y;\n                      float pz = reflectionPos.z;\n                      refP1 = -atan(px, pz) / M_PI / 4.0;\n                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refFlipRefs == 1.0) refP2 = 1.0 - refP2;\n                    } else {\n                      refP1 = vUv.x;\n                      refP2 = vUv.y;\n                    }\n                    \n                    vec2 refCoords = vec2(1.0 - refP1 * 2.0, refP2);\n                    vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 1.0);\n                    mixColor = merge(mixColor, refCol);\n                    baseColorIp = 1.0 - reflection; //min(1.0, 2.0 - reflection);\n                    //light += reflection / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"refraction":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,angleOfRefraction:void 0===a[t].angleOfRefraction?1:a[t].angleOfRefraction,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,flatShadingUniform:"refractionFlatShading",dataType:"uniform1f",vertDeclaration:"\n                    attribute vec3 nVecRefraction;\n                    varying vec3 nVrefraction;\n                  ",vertCode:"\n                    vec3 nVrefraction = nVecRefraction;\n                  ",fragDeclaration:"\n                    uniform float refraction;\n                    uniform float refractionFlatShading;\n                    uniform float refractionOmitEquirectangular;\n                    uniform float refractionFlipRefs;\n                    uniform float angleOfRefraction;\n                    uniform sampler2D refractionMap;\n                    varying vec3 nVrefraction;\n                  ",fragCode:"\n                    float refractionP1, refractionP2;\n                    float refractionP1a, refractionP2a;\n                    float refractionP1b, refractionP2b;\n                    if(refractionOmitEquirectangular != 1.0){\n\n                      vec3 refractionPos = R_rpy(nV, vec3(0.0,-camOri.y, -camOri.z));\n\n                      float px = refractionPos.x;\n                      float py = refractionPos.y;\n                      float pz = refractionPos.z;\n                      refractionP1a = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2a = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2a = 1.0 - refractionP2a;\n\n                      refractionPos = R_rpy(nVrefraction, vec3(0.0,-camOri.y, -camOri.z));\n                      px = refractionPos.x;\n                      py = refractionPos.y;\n                      pz = refractionPos.z;\n                      refractionP1b = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2b = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2b = 1.0 - refractionP2b;\n\n                      //refractionP1a *= 0.0; //angleOfRefraction;\n                      //refractionP2a *= 1.0; //angleOfRefraction;\n                      //refractionP1 = (refractionP1a + refractionP1b) / 2.0;\n                      //refractionP2 = (refractionP2a + refractionP2b) / 2.0;\n\n                      refractionP1 = refractionP1b;\n                      refractionP2 = refractionP2b;\n\n                    } else {\n                      refractionP1a = vUv.x;\n                      refractionP2a = vUv.y;\n                    }\n                    \n                    vec2 refractionCoords = vec2(1.0 - refractionP1 * 2.0, refractionP2);\n                    vec4 refractionCol = vec4(texture2D(refractionMap, vec2(refractionCoords.x, refractionCoords.y)).rgb * 1.25, refraction / 1.0);\n                    mixColor2 = merge(mixColor2, refractionCol);\n                    baseColorIp2 = 1.0 - refraction;\n                    //light += refraction / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"phong":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,loc:"",value:void 0===a[t].value?.3:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[t].theta?.5:a[t].theta,dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:"\n                    hasPhong = 1.0;\n                  ",fragDeclaration:"\n                    uniform float phong;\n                    uniform float phongTheta;\n                    uniform float phongFlatShading;\n                  ",fragCode:"\n                    if(isLight == 0.0 &&\n                       isSprite == 0.0 &&\n                       isParticle == 0.0 &&\n                       isLine == 0.0){\n                      //light.rgb *= .5;\n                      float phongP1, phongP2;\n                      float px, py, pz;\n                      if(phongFlatShading != 0.0){\n                        px = nVec.x;\n                        py = nVec.y;\n                        pz = nVec.z;\n                      }else{\n                        vec3 phongPos = R_rpy(nV, vec3(camOri.x, 0.0, 0.0));\n                        px = phongPos.x;\n                        py = phongPos.y;\n                        pz = phongPos.z;\n                      }\n\n                      phongP1 = atan(px, pz) + phongTheta;\n                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)));\n                      \n                      //if(refFlipRefs == 1.0) phongP2 = M_PI - phongP2;\n\n                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong +\n                      pow(pow((1.0+cos(phongP1 + M_PI)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong;\n                      light = vec4(light.rgb + fact, 1.0) * 15.0;\n                    }\n                  "};r.optionalUniforms.push(i)}}}}))}));let o={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){t.enable(t.DEPTH_TEST),t.cullFace(t.BACK),e.alpha&&(t.blendFunc(t.SRC_ALPHA,t.ONE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST));let a="";r.optionalUniforms.map((e=>{a+="\n"+e.vertDeclaration+"\n"}));let n="";r.optionalUniforms.map((e=>{n+="\n"+e.vertCode+"\n"}));let s="";r.optionalUniforms.map((e=>{s+="\n"+e.fragDeclaration+"\n"}));let c="";r.optionalUniforms.map((e=>{c+="\n"+e.fragCode+"\n"})),o.vert=`\n      precision highp float;\n      #define M_PI 3.14159265358979323\n      attribute vec2 uv;\n      ${a}\n      \n      uniform float t;\n      uniform vec3 color;\n      uniform float factor;\n      uniform float flatShading;\n      uniform float ambientLight;\n      uniform float plugin;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      uniform int rotationMode;\n      uniform float omitSplitCheck;\n      uniform float splitCheckPass;\n      uniform float pointSize;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float cameraMode;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float penumbraPass;\n      uniform float fov;\n      uniform float equirectangular;\n      uniform float maxHeightmap;\n      uniform float equirectangularHeightmap;\n      uniform float renderNormals;\n      uniform vec2 resolution;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform sampler2D heightMap;\n      attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec3 normalVec;\n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      \n      vec3 pFunc(vec3 pt, float cosa, float sina,\n                          float cosb, float sinb,\n                          float cosc, float sinc){\n        float xx, xy, xz, yx, yy, yz, zx, zy, zz;\n        xx = cosa*cosb;\n        xy = cosa*sinb*sinc - sina*cosc;\n        xz = cosa*sinb*cosc + sina*sinc;\n        yx = sina*cosb;\n        yy = sina*sinb*sinc + cosa*cosc;\n        yz = sina*sinb*cosc - cosa*sinc;\n        zx = -sinb;\n        zy = cosb*sinc;\n        zz = cosb*cosc;\n        return vec3(xx*pt.x + xy*pt.y + xz*pt.z,\n                    yx*pt.x + yy*pt.y + yz*pt.z,\n                    zx*pt.x + zy*pt.y + zz*pt.z);\n      }\n      vec3 Quat(vec3 pos, vec3 rot, int isGeo){\n        \n        if(isLine != 0.0) return pos;\n        float cosa, sina, cosb, sinb, cosc, sinc;\n        vec3 ret = vec3(pos.x, pos.y, pos.z);\n        if(rotationMode == 0 || isGeo == 0){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 1 && isGeo == 1){\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 2 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 3 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        return ret;\n      }\n      \n      vec3 R(vec3 pos, vec3 rot, int isGeo){\n        if(isLine != 0.0) return pos;\n        \n        float p, d;\n        if(rotationMode == 0 || isGeo == 0) {\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 1 && isGeo == 1) {\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 2 && isGeo == 1) {\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n        }\n        return pos;\n      }\n      \n      void main(){\n        \n        hasPhong = 0.0;\n        \n        float cx, cy, cz;\n        \n        if(renderNormals == 1.0){\n          cx = normal.x;\n          cy = normal.y;\n          cz = normal.z;\n        }else{\n          cx = position.x;\n          cy = position.y;\n          cz = position.z;\n        }\n        \n        if(useHeightMap != 0.0 && renderNormals == 0.0){\n          nVeci = normalVec;\n          vec4 h;\n          float lum;\n\n          if(equirectangularHeightmap != 0.0){\n            float p;\n            float p2;\n            vec3 cpos = vec3(cx, cy, cz);\n            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);\n            float p1;\n            p1 = p / M_PI / 2.0;\n            p2 = flatShading == 1.0 ?\n                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :\n                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n            uvi = vec2(p1, p2);\n          } else {\n            uvi = uv;\n          }\n\n            \n          h = texture2D( heightMap, uvi);\n          lum = min(maxHeightmap, ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0);\n          cx += normalVec.x * lum;\n          cy += normalVec.y * lum;\n          cz += normalVec.z * lum;\n\n          \n        }else{\n          uvi = uv / 2.0;\n          uvi = vec2(uvi.x, .5 - uvi.y);\n          nVeci = normalVec;\n        }\n        \n        fPosi = vec3(cx, cy, cz);\n        \n        // camera rotation\n        \n        vec3 geo, pos;\n        float cpx = camPos.x;\n        float cpy = camPos.y;\n        float cpz = camPos.z;\n        \n        if(cameraMode == 1.0){  // 'FPS' mode\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos,  vec3(0.0, camOri.y, 0.0), 0);\n            pos = Quat(pos,  vec3(0.0, 0.0, camOri.z), 0);\n            pos = Quat(pos,  vec3(camOri.x, 0.0, 0.0), 0);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = Quat(vec3(cx, cy, cz), vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n          }\n          cpx = 0.0;\n          cpy = 0.0;\n          cpz = 0.0;\n          fPos = pos;\n        }else{\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos = Quat(pos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            \n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }\n          fPos = pos;\n        }\n        \n        ${n}\n        \n        float camz = cpz / 1e3 * fov;\n        \n        float X, Y;\n        float Z = pos.z + camz + geo.z;\n        if((isLine != 0.0 || isParticle != 0.0) &&\n          penumbraPass != 0.0) Z += .001;\n        if(isLine != 0.0){\n          X = position.x / resolution.x * fov;\n          Y = position.y / resolution.y * fov;\n          Z = position.z;\n          gl_Position = vec4(X, Y, Z/100000.0, 1.0);\n          depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n          skip = 0.0;\n          vUv = uv;\n        }else{\n          if( plugin ==  1.0 ){   // equirectangular post-processing plugin\n            X = pos.x + cpx + geo.x;\n            Y = pos.y + cpy + geo.y;\n            Z = pos.z + cpz + geo.z;\n            float dist = sqrt(X*X + Y*Y + Z*Z);\n            float p1;\n            if(omitSplitCheck == 0.0){\n              if(splitCheckPass == 0.0){\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 <= -0.75 ? 1.0 : 0.0;\n                p1 += .5;\n              }else{\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 >= 0.75 ? 1.0 : 0.0;\n                p1 -= .5;\n              }\n            }else{\n              skip = 0.0;\n              p1 = atan(X, Z) / M_PI;\n            }\n            if(skip == 0.0){\n              float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;\n              gl_PointSize = 100.0 * pointSize / dist;\n              gl_Position = vec4(p1, p2, dist/100000.0, 1.0);\n              vUv = uv;\n            }\n          } else {  // default projection\n            X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;\n            Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;\n            if(Z > 0.0) {\n              gl_PointSize = 100.0 * pointSize / Z;\n              gl_Position = vec4(X, Y, Z/100000.0, 1.0);\n              depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n              skip = 0.0;\n              vUv = uv;\n            }else{\n              skip = 1.0;\n            }\n          }\n        }\n      }\n    `,o.frag=`\n      #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n      #else\n        precision mediump float;\n      #endif\n      #define M_PI 3.14159265358979323\n      ${s}\n      uniform float t;\n      uniform float factor;\n      uniform vec2 resolution;\n      uniform float plugin;\n      uniform float flatShading;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float cameraMode;\n      uniform vec4 pointLightPos[16];\n      uniform vec4 pointLightCol[16];\n      uniform int pointLightCount;\n      uniform float ambientLight;\n      uniform float renderNormals;\n      uniform float equirectangular;\n      uniform float equirectangularHeightmap;\n      uniform float colorMix;\n      //uniform float penumbraPass;\n      uniform vec3 color;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform float maxHeightmap;\n      uniform sampler2D heightMap;\n      uniform sampler2D baseTexture;\n      uniform sampler2D supplementalTexture;\n      uniform float supplementalTextureMix;\n      uniform float alpha;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      \n        // fog //\n      uniform vec3 fogColor;\n      uniform float fog;\n        /////////\n        \n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      vec3 rgeoPos;\n      float rheightMapIntensity;\n      float rmaxHeightmap;\n\n      vec4 merge (vec4 col1, vec4 col2){\n        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);\n      }\n      \n      vec2 Coords(float flatShading, vec3 nV) {\n        vec2 ret;\n        if(equirectangular == 1.0){\n          float p;\n          float p2;\n          vec3 cpos = fPosi;\n          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n          float p1;\n          p1 = p / M_PI / 2.0;\n          p2 = flatShading == 1.0 ?\n                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n          ret = vec2(p1, p2);\n        }else{\n          ret = vUv;\n        }\n        return ret;\n      }\n\n      vec3 R_ypr(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_yrp(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_rpy(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec4 GetPointLight(){\n        \n        float ret = 0.0;\n        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);\n        for(int i=0; i < 16; i++){\n          //if(i >= pointLightCount) break;\n          vec3 lpos = pointLightPos[i].xyz;\n          lpos.x -= rgeoPos.x; //- camPos.x;\n          lpos.y -= rgeoPos.y; //- camPos.y;\n          lpos.z -= rgeoPos.z; //- camPos.z;\n          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));\n\n          float mag = pointLightPos[i].w;\n          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +\n          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 20.0;\n          \n          rgba.r += ret * pointLightCol[i].r;\n          rgba.g += ret * pointLightCol[i].g;\n          rgba.b += ret * pointLightCol[i].b;\n        }\n        \n        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);\n      }\n\n      void main() {\n\n        rgeoPos = geoPos / factor;\n        rheightMapIntensity = heightMapIntensity / factor;\n        rmaxHeightmap = maxHeightmap / factor;\n\n\n        if(isParticle != 0.0 || isLine != 0.0){\n          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));\n        }else{\n          float mixColorIp = colorMix;\n          float mixColorIp2 = 1.0;\n          float baseColorIp = 1.0 - mixColorIp;\n          float baseColorIp2 = 1.0 - mixColorIp2;\n          vec4 mixColor = vec4(color.rgb, mixColorIp);\n          vec4 mixColor2 = vec4(color.rgb, mixColorIp2);\n          vec4 light = hasPhong == 1.0 ? GetPointLight() :\n                vec4(ambientLight, ambientLight, ambientLight, 1.0);\n          float colorMag = 1.0;\n          if(skip != 1.0){\n            if(renderNormals == 1.0){\n              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }else{\n              float p;\n              vec3 nV, nVi;\n              if(useHeightMap != 0.0){\n                \n                float rad = .02;\n                float rad2 = -.25;\n                vec2 cr1, cr2, cr3;\n                float lum1, lum2, lum3;\n                for(float j=0.0; j<3.0; j+=1.0){\n                  \n                  float tx, ty;\n                  p = M_PI * 2.0 / 3.0 * j;\n                  tx = -sin(p) * rad;\n                  ty = -cos(p) * rad;\n                \n                  vec2 hcoords;\n                  if(equirectangularHeightmap == 1.0){\n                    float p;\n                    float p2;\n                    vec3 cpos = fPosi;\n                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n                    float p1;\n                    p1 = p / M_PI / 2.0;\n                    p2 = flatShading == 1.0 ?\n                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n                    tx += p1;\n                    ty += p2;\n                    hcoords = vec2(tx, ty);\n                  }else{\n                    hcoords = vUv + vec2(tx, ty);\n                  }\n                  \n                  vec4 htexel = texture2D( heightMap, hcoords);\n                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;\n                  if(j == 0.0) {\n                    lum1 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 1.0) {\n                    lum2 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 2.0) {\n                    lum3 = lum;\n                    cr2 = hcoords;\n                  }\n                }\n\n                float a1 = cr1.x;\n                float a2 = cr1.y;\n                float a3 = (lum1 - 0.5) * rad2;\n                \n                float b1 = cr2.x - a1;\n                float b2 = cr2.y - a2;\n                float b3 = (lum2 - 0.5) * rad2 - a3;\n                float c1 = cr3.x - cr2.x;\n                float c2 = cr3.y - cr2.y;\n                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;\n                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * min(maxHeightmap / 5.0, (1.0 + heightMapIntensity) / 2.0);\n                nV = normalize( nVec + anorm);\n                nVi = normalize( nVeci + anorm);\n              }else{\n                nV = nVec;\n                nVi = nVeci;\n              }\n              \n              \n              ${c}\n              vec2 coords = Coords(0.0, nVi);\n              vec4 texel = texture2D( baseTexture, coords);\n              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));\n              float fv;\n              if(isSprite != 0.0 || isLight != 0.0){\n                if(fog != 0.0){\n                  vec4 preFog = vec4(texel.rgb * 3.0, texel.a);\n                  fv = min(1.0, depth * fog) * min(alpha * 2.0, 1.0);\n                  gl_FragColor = merge(vec4(preFog.rgb, (1.0 - fv)), vec4(fogColor.rgb, 0.0));\n                }else{\n                  gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);\n                }\n              }else{\n                \n                texel.a = baseColorIp / 2.0;\n                vec4 col = merge(mixColor, texel);\n                col.a = 1.0;\n                if(baseColorIp2 != 0.0){\n                  mixColor2.a = baseColorIp2;\n                  col = merge(mixColor2, col); // refractions\n                }\n                col.rgb *= light.rgb;\n                \n                \n                if(fog != 0.0){\n                  vec4 preFog = vec4(col.rgb * colorMag, 1.0);\n                  fv = min(1.0, depth * fog);\n                  gl_FragColor = merge(vec4(preFog.rgb, 1.0 - fv), vec4(fogColor.rgb, fv));\n                }else{\n                  gl_FragColor = vec4(col.rgb * colorMag, 1.0);\n                }\n              }\n            }\n          }\n        }\n      }\n    `;const h=t.createShader(t.VERTEX_SHADER);t.shaderSource(h,o.vert),t.compileShader(h);const u=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(u,o.frag),t.compileShader(u),o.ConnectGeometry=(a,n=!1)=>{var s=a.involveCache,c=structuredClone(r);o.datasets.push(c),c.program=t.createProgram(),t.attachShader(c.program,h),t.attachShader(c.program,u),t.linkProgram(c.program),a.shader=o;var f=a.map,m=a.heightMap;if(a.datasetIdx=o.datasets.length-1,t.getProgramParameter(c.program,t.LINK_STATUS)){if(t.useProgram(c.program),t.bindBuffer(t.ARRAY_BUFFER,a.vertex_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=t.getAttribLocation(c.program,"position"),t.vertexAttribPointer(c.locPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locPosition),t.bindBuffer(t.ARRAY_BUFFER,a.uv_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=t.getAttribLocation(c.program,"uv"),t.vertexAttribPointer(c.locUv,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locUv),t.bindBuffer(t.ARRAY_BUFFER,a.normal_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=t.getAttribLocation(c.program,"normal"),t.vertexAttribPointer(c.locNormal,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormal),t.bindBuffer(t.ARRAY_BUFFER,a.normalVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=t.getAttribLocation(c.program,"normalVec"),t.vertexAttribPointer(c.locNormalVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormalVec),!n){if(a.isLight||c.optionalUniforms.map((async e=>{switch(e.name){case"fog":break;case"reflection":if(n=e.map){let a,c=(a=n.split("."))[a.length-1].toLowerCase();switch(e.refTexture=t.createTexture(),c){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE1),U(t,e.video,e.refTexture,e.textureMode,-1,{url:n}),p.textures.push({url:n,resource:e.video,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";var r=new Image;o.datasets.push({texture:e.refTexture,iURL:n}),t.uniform1f(e.locRefFlipRefs,e.flipReflections),t.bindTexture(t.TEXTURE_2D,e.refTexture),r.onload=()=>{t.activeTexture(t.TEXTURE1),U(t,r,e.refTexture,e.textureMode,-1,{url:n})},e.image=r,p.textures.push({url:n,resource:r,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE1),e.locRefOmitEquirectangular=t.getUniformLocation(c.program,"refOmitEquirectangular"),t.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefFlipRefs=t.getUniformLocation(c.program,"refFlipRefs"),t.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=t.getUniformLocation(c.program,"reflectionMap"),t.bindTexture(t.TEXTURE_2D,e.refTexture),t.uniform1i(e.locRefTexture,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e.refTexture);break;case"refraction":var n;if(n=e.map){var h,u,f,m;e.refractionVecs=[];for(var g=0;g<a.normalVecs.length;g+=3){for(var v=a.vertices[g+0],y=a.vertices[g+1],b=a.vertices[g+2],x=a.normalVecs[g+0],R=a.normalVecs[g+1],E=a.normalVecs[g+2],A=6e6,M=0;6e6==A&&M<a.vertices.length;M+=9)if(6e6==A){var T=[];h=a.vertices[M+0],u=a.vertices[M+1],f=a.vertices[M+2],T.push(h,u,f),h=a.vertices[M+3],u=a.vertices[M+4],f=a.vertices[M+5],T.push(h,u,f),h=a.vertices[M+6],u=a.vertices[M+7],f=a.vertices[M+8],T.push(h,u,f),(m=ee(v-.01*x,y-.01*R,b-.01*E,v-1e4*x,y-1e4*R,b-1e4*E,T,!0))&&(d=Math.hypot(m[0][0]-v,m[0][1]-y,m[0][2]-b))<A&&(M,A=d)}3*(g%9/3|0),e.refractionVecs.push(a.normalVecs[g+0]),e.refractionVecs.push(a.normalVecs[g+1]),e.refractionVecs.push(a.normalVecs[g+2])}let c;e.refractionVecs=new Float32Array(e.refractionVecs),e.refractionVec_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bufferData(t.ARRAY_BUFFER,e.refractionVecs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.refractionVecIndices=new Uint32Array(Array(e.refractionVecs.length/3).fill().map(((e,a)=>a))),e.RefractionVec_Index_Buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.refractionVecIndices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer);let _=(c=n.split("."))[c.length-1].toLowerCase();switch(e.refractionTexture=t.createTexture(),_){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refractionTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE5),U(t,e.video,e.refractionTexture,e.textureMode,-1,e),p.textures.push({url:n,resource:e.video,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";r=new Image;o.datasets.push({texture:e.refractionTexture,iURL:n}),t.activeTexture(t.TEXTURE5),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractionlections),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),r.onload=()=>{U(t,r,e.refractionTexture,e.textureMode,-1,e)},p.textures.push({url:n,resource:r,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE5),t.uniform1i(e.locRefractionTexture,5),c.locRefractionlVec=t.getAttribLocation(c.program,"nVecRefraction"),t.vertexAttribPointer(c.locRefractionVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locRefractionVec),e.locRefractionOmitEquirectangular=t.getUniformLocation(c.program,"refractionOmitEquirectangular"),t.uniform1f(e.locRefractionOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefractionFlipRefs=t.getUniformLocation(c.program,"refractionFlipRefs"),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractions),e.locRefractionTexture=t.getUniformLocation(c.program,"refractionMap"),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),t.uniform1i(e.locRefractionTexture,5),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,e.refractionTexture);break;case"phong":e.locPhongTheta=t.getUniformLocation(c.program,e.theta),t.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=t.getUniformLocation(c.program,e.flatShadingUniform),t.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=t.getUniformLocation(c.program,e.name),t[e.dataType](e.loc,e.value)})),c.locColor=t.getUniformLocation(c.program,"color"),t.uniform3f(c.locColor,...be(a.color)),("particles"==a.shapeType||a.isParticle||"lines"==a.shapeType||a.isLine)&&(c.locPointSize=t.getUniformLocation(c.program,"pointSize"),t.uniform1f(c.locPointSize,a.size)),c.locColorMix=t.getUniformLocation(c.program,"colorMix"),t.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=t.getUniformLocation(c.program,"isSprite"),t.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=t.getUniformLocation(c.program,"cameraMode"),t.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=t.getUniformLocation(c.program,"supplementalTextureMix"),t.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locFog=t.getUniformLocation(c.program,"fog"),c.locFogColor=t.getUniformLocation(c.program,"fogColor"),c.locIsLight=t.getUniformLocation(c.program,"isLight"),t.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=t.getUniformLocation(c.program,"isParticle"),t.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locIsLine=t.getUniformLocation(c.program,"isLine"),t.uniform1f(c.locIsLine,a.isLine?1:0),c.locPenumbraPass=t.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=t.getUniformLocation(c.program,"alpha"),t.uniform1f(c.locAlpha,a.alpha),c.locPointLights=t.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=t.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=t.getUniformLocation(c.program,"pointLightCount"),t.uniform1i(c.locPointLightCount,0),c.locResolution=t.getUniformLocation(c.program,"resolution"),t.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=t.getUniformLocation(c.program,"equirectangular"),t.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=t.getUniformLocation(c.program,"t"),t.uniform1f(c.locT,0),c.locAmbientLight=t.getUniformLocation(c.program,"ambientLight"),t.uniform1f(c.locAmbientLight,e.ambientLight),c.locRotationMode=t.getUniformLocation(c.program,"rotationMode"),t.uniform1i(c.locRotationMode,a.rotationMode),c.texture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),c.locTexture=t.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=t.createTexture(),c.locHeightMap=t.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=t.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=t.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=t.getUniformLocation(c.program,"heightMapIntensity"),c.locMaxHeightmap=t.getUniformLocation(c.program,"maxHeightmap"),t.activeTexture(t.TEXTURE0)),c.supplementalTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=t.getUniformLocation(c.program,"supplementalTexture"),f)if(he(f))a.textureMode="dataArray",a.mapIsDataArray=!0,U(t,"",c.texture,a.textureMode,0,a);else{let e;switch(c.iURL=f,(e=f.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",s&&(l=p.textures.filter((e=>e.url==c.iURL))).length?(console.log("found video in cache... using it"),c.resource=l[0].resource,c.texture=l[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",(()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed})),c.resource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()}))),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},p.textures.push({url:f,resource:c.resource,texture:c.texture}),fetch(f).then((e=>e.blob())).then((e=>{c.resource.src=URL.createObjectURL(e)})));break;default:a.textureMode="image";var g=new Image;a.image=g,p.textures.push({url:f,resource:g,texture:c.texture}),g.onload=async()=>{t.activeTexture(t.TEXTURE0),U(t,g,c.texture,a.textureMode,-1,{map:f})},fetch(f).then((e=>e.blob())).then((e=>{g.src=URL.createObjectURL(e)}))}}if(t.useProgram(c.program),t.activeTexture(t.TEXTURE0),t.uniform1i(c.locTexture,0),t.bindTexture(t.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=m;else if(m)if(he(m))a.heightTextureMode="heightmapDataArray",a.heightmapIsDataArray=!0,U(t,"",c.texture,a.heightTextureMode,0,{map:m});else{let e;switch(c.heightMapURL=m,(e=m.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",s&&(l=p.textures.filter((e=>e.url==c.heightMapURL))).length?(console.log("found video in cache... using it"),c.heightResource=l[0].resource,c.heightTexture=l[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",(()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed})),c.heightResource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()}))),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},p.textures.push({url:m,resource:c.heightResource,texture:c.heightTexture}),fetch(m).then((e=>e.blob())).then((e=>{c.heightResource.src=URL.createObjectURL(e)})));break;default:a.heightTextureMode="heightImage";var v=new Image;c.heightResource=v,p.textures.push({url:m,resource:v,texture:c.heightTexture}),v.onload=async()=>{t.useProgram(c.program),t.activeTexture(t.TEXTURE4),t.uniform1i(c.locHeightMap,4),U(t,v,c.heightTexture,a.heightTextureMode,-1,{heightMapURL:m}),t.activeTexture(t.TEXTURE0)},fetch(m).then((e=>e.blob())).then((e=>{v.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),c.locCamPos=t.getUniformLocation(c.program,"camPos"),c.locCamOri=t.getUniformLocation(c.program,"camOri"),c.locGeoPos=t.getUniformLocation(c.program,"geoPos"),c.locGeoOri=t.getUniformLocation(c.program,"geoOri"),c.locFov=t.getUniformLocation(c.program,"fov"),c.locRenderNormals=t.getUniformLocation(c.program,"renderNormals"),t.uniform3f(c.locCamPos,e.x,e.y,e.z),t.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),t.uniform3f(c.locGeoPos,e.x,e.y,e.z),t.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),t.uniform1f(c.locFov,e.fov),t.uniform1f(c.locRenderNormals,0)}}else{var y=t.getProgramInfoLog(c.program),b=t.getShaderInfoLog(h),x=t.getShaderInfoLog(u);console.error(`bad shader :( ${y}`),console.error(`vShader info : ${b}`,o.vert),console.error(`fShader info : ${x}`,o.frag)}}}return o},O=async(e,a={})=>{var t=!0,r=[],o={size:1,alpha:.8,penumbra:.5,shapeType:"lines",color:16777215};Object.keys(e).forEach(((a,t)=>{switch(a.toLowerCase()){case"shapetype":default:break;case"x":case"y":case"z":case"roll":case"pitch":case"yaw":o[a]=e[a]}})),Object.keys(a).forEach(((e,r)=>{switch(e.toLowerCase()){case"shapetype":break;case"closepaths":t=a[e];break;default:o[e]=a[e]}}));const n=(e,a,t,o,n,i)=>{for(var s,c,l,p,h,u,f=!0,m=r,d=0;f&&d<m.length;d+=6)s=m[d+0],c=m[d+1],l=m[d+2],p=m[d+3],h=m[d+4],u=m[d+5],(s==e&&c==a&&l==t&&p==o&&h==n&&u==i||s==o&&c==n&&l==i&&p==e&&h==a&&u==t)&&(f=!1);return f};for(var i,s=e.vertices,c=0;c<s.length;c+=9){var l,p,h,u,f,m,d,g,v;l=-s[c+0],p=-s[c+1],h=-s[c+2],u=-s[c+3],f=-s[c+4],m=-s[c+5],d=-s[c+6],g=-s[c+7],v=-s[c+8],i=[],n(l,p,h,u,f,m)&&i.push(l,p,h,u,f,m),n(u,f,m,d,g,v)&&i.push(u,f,m,d,g,v),t&&n(d,g,v,l,p,h)&&i.push(d,g,v,l,p,h),r.push(...i)}var y=[];for(c=0;c<r.length;c+=3)y.push([r[c+0],r[c+1],r[c+2]]);o.geometryData=y;var b={shape:null};return await w(e.renderer,o).then((e=>{b.shape=e})),b},V=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},D=(e,a,t,r,o,n,i=!1,s="")=>{var c,l,p,h,u,f=[],m=[],d=e,g=[],v=`${s}_${r}`,y=V(s);if("obj"===s)u=Y(0,1,o,d,a,v);else u=Y(r+(y?1:0),1,o,d,a,v);for(u.map((e=>{e.verts.map((e=>{e[0]*=t,e[1]*=t,e[2]*=t})),i||4==e.verts.length?(f.push(e.verts[2],e.verts[1],e.verts[0],e.verts[0],e.verts[3],e.verts[2]),void 0!==e.uvs&&e.uvs.length&&m.push(e.uvs[2],e.uvs[1],e.uvs[0],e.uvs[0],e.uvs[3],e.uvs[2])):(f.push(...e.verts),void 0!==e.uvs&&e.uvs.length&&m.push(...e.uvs))})),l=0;l<f.length;l++){var b;p=[f[3*(c=l/3|0)+2],f[3*c+1],f[3*c+0]],l%3||(b=ie(p,y),n||(b[3]=b[0]+(b[0]-b[3]),b[4]=b[1]+(b[1]-b[4]),b[5]=b[2]+(b[2]-b[5]))),h=n?f.length-l-1:l,g.push({position:f[h],normal:[...f[h],f[h][0]+(b[3]-b[0]),f[h][1]+(b[4]-b[1]),f[h][2]+(b[5]-b[2])],texCoord:m[h]})}return{geometry:g}},Y=(e,a,t,r,o,n="")=>{var i,s,c,l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w,F,L,U,C,k,z,S,B,N,O,V,D,Y,X,H,q,G,W,j,$,K,Z,Q,J,ee,ae,te,re,oe,ne,ie,se,ce,le,pe,he,ue,fe,me,de,ge,ve,ye=!1;if(!ye)for(var be=e;be--;)i=r,s=o,r=[],o=[],i.map(((e,a)=>{switch(u=e[c=0][0],f=e[c][1],m=e[c][2],s.length&&s[a].length>c&&(ve=s[a],F=ve[c][0],L=ve[c][1]),d=e[c=1][0],g=e[c][1],v=e[c][2],s.length&&s[a].length>c&&(U=ve[c][0],C=ve[c][1]),y=e[c=2][0],b=e[c][1],x=e[c][2],s.length&&s[a].length>c&&(k=ve[c][0],z=ve[c][1]),e.length>3&&(R=e[c=3][0],E=e[c][1],A=e[c][2],s.length&&s[a].length>c&&(S=ve[c][0],B=ve[c][1]),e.length>4&&(M=e[c=4][0],T=e[c][1],_=e[c][2],s.length&&s[a].length>c&&(N=ve[c][0],O=ve[c][1]),e.length>5&&(P=e[c=5][0],I=e[c][1],w=e[c][2],s.length&&s[a].length>c&&(V=ve[c][0],D=ve[c][1])))),Y=(u+d)/2,X=(f+g)/2,H=(m+v)/2,q=(d+y)/2,G=(g+b)/2,W=(v+x)/2,void 0!==F&&(ee=(F+U)/2,ae=(L+C)/2,te=(U+k)/2,re=(C+z)/2),fe=[],me=[],e.length){case 3:j=(y+u)/2,$=(b+f)/2,K=(x+m)/2,void 0!==F&&(oe=(k+F)/2,ne=(z+L)/2,l=F,p=L,me.push([l,p]),l=ee,p=ae,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=U,p=C,me.push([l,p]),l=te,p=re,me.push([l,p]),o.push(me),(me=[]).push([l=oe,p=ne]),l=te,p=re,me.push([l,p]),l=k,p=z,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=te,p=re,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me)),l=u,p=f,h=m,fe.push([l,p,h]),l=Y,p=X,h=H,fe.push([l,p,h]),l=j,p=$,h=K,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,fe.push([l,p,h]),l=q,p=G,h=W,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=j,p=$,h=K]),l=q,p=G,h=W,fe.push([l,p,h]),l=y,p=b,h=x,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=q,p=G,h=W,fe.push([l,p,h]),l=j,p=$,h=K,fe.push([l,p,h]),r.push(fe);break;case 4:j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+u)/2,Q=(E+f)/2,J=(A+m)/2,void 0!==F&&(oe=(k+S)/2,ne=(z+B)/2,ie=(S+F)/2,se=(B+L)/2,de=(F+U+k+S)/4,ge=(L+C+z+B)/4,l=F,p=L,me.push([l,p]),l=ee,p=ae,me.push([l,p]),l=de,p=ge,me.push([l,p]),l=ie,p=se,me.push([l,p]),o.push(me),(me=[]).push([l=ee,p=ae]),l=U,p=C,me.push([l,p]),l=te,p=re,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=de,p=ge]),l=te,p=re,me.push([l,p]),l=k,p=z,me.push([l,p]),l=oe,p=ne,me.push([l,p]),o.push(me),(me=[]).push([l=ie,p=se]),l=de,p=ge,me.push([l,p]),l=oe,p=ne,me.push([l,p]),l=S,p=B,me.push([l,p]),o.push(me)),ce=(u+d+y+R)/4,le=(f+g+b+E)/4,pe=(m+v+x+A)/4,l=u,p=f,h=m,fe.push([l,p,h]),l=Y,p=X,h=H,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),l=Z,p=Q,h=J,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,fe.push([l,p,h]),l=q,p=G,h=W,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=ce,p=le,h=pe]),l=q,p=G,h=W,fe.push([l,p,h]),l=y,p=b,h=x,fe.push([l,p,h]),l=j,p=$,h=K,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=Z,p=Q,h=J]),l=ce,p=le,h=pe,fe.push([l,p,h]),l=j,p=$,h=K,fe.push([l,p,h]),l=R,p=E,h=A,fe.push([l,p,h]),r.push(fe);break;case 5:ce=(u+d+y+R+M)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+A+_)/5,void 0!==F&&(de=(F+U+k+S+N)/5,ge=(L+C+z+B+O)/5,oe=(k+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+F)/2,(O+L)/2,l=F,p=L,me.push([l,p]),l=U,p=C,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=U,p=C]),l=k,p=z,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=k,p=z]),l=S,p=B,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=S,p=B]),l=N,p=O,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=N,p=O]),l=F,p=L,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),me=[]),j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+M)/2,Q=(E+T)/2,J=(A+_)/2,(M+u)/2,(T+f)/2,(_+m)/2,l=u,p=f,h=m,fe.push([l,p,h]),l=d,p=g,h=v,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=y,p=b,h=x]),l=R,p=E,h=A,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=R,p=E,h=A]),l=M,p=T,h=_,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=M,p=T,h=_]),l=u,p=f,h=m,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),fe=[];break;case 6:ce=(u+d+y+R+M)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+A+_)/5,void 0!==F&&(de=(F+U+k+S+N+V)/6,ge=(L+C+z+B+O+D)/6,oe=(k+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+V)/2,(O+D)/2,(V+F)/2,(D+L)/2,l=F,p=L,me.push([l,p]),l=U,p=C,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=U,p=C]),l=k,p=z,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=k,p=z]),l=S,p=B,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=S,p=B]),l=N,p=O,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=N,p=O]),l=V,p=D,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),(me=[]).push([l=V,p=D]),l=F,p=L,me.push([l,p]),l=de,p=ge,me.push([l,p]),o.push(me),me=[]),j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+M)/2,Q=(E+T)/2,J=(A+_)/2,(M+P)/2,(T+I)/2,(_+w)/2,(P+u)/2,(I+f)/2,(w+m)/2,(fe=[]).push([l=u,p=f,h=m]),l=d,p=g,h=v,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=y,p=b,h=x]),l=R,p=E,h=A,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=R,p=E,h=A]),l=M,p=T,h=_,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=M,p=T,h=_]),l=P,p=I,h=w,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),(fe=[]).push([l=P,p=I,h=w]),l=u,p=f,h=m,fe.push([l,p,h]),l=ce,p=le,h=pe,fe.push([l,p,h]),r.push(fe),fe=[]}}));if(t){var xe;he=t,ue=1-t;for(be=2;be--;)(be?r:o).map((e=>{e.map((e=>{l=e[0],p=e[1],h=be?e[2]:0,xe=Math.hypot(l,p,h),l/=xe,p/=xe,h/=xe,e[0]=l*=he+xe*ue,e[1]=p*=he+xe*ue,be&&(e[2]=h*=he+xe*ue)}))}))}return r.map(((e,a)=>({verts:e,uvs:o[a]})))},X=(e,a,t,r,o)=>{let i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=Array(r).fill().map((e=>(i=n()-.5,s=n()-.5,c=n()-.5,[i,s,c])));for(let e=50;e--;)x.map(((e,a)=>{i=e[0],s=e[1],c=e[2],x.map(((e,t)=>{t!=a&&(u=e[0],f=e[1],m=e[2],g=1+(Math.hypot(i-u,s-f,c-m)*(3+r/80)*3)**3,i+=9*(i-u)/g,s+=9*(s-f)/g,c+=9*(c-m)/g)})),g=Math.hypot(i,s,c),e[0]=i/g,e[1]=s/g,e[2]=c/g}));return d=6e6,x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(v=l-u,y=p-f,b=h-m),g<d&&(d=g))}))})),v=[],x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(l-u,p-f,h-m),g<2*d&&(v.filter((e=>e[0]==u&&e[1]==f&&e[2]==m&&e[3]==l&&e[4]==p&&e[5]==h)).length||v.push([l*o,p*o,h*o,u*o,f*o,m*o])))}))})),x.map((r=>{r[0]*=o/1.3333,r[1]*=o/1.3333,r[2]*=o/1.3333,r[0]+=e,r[1]+=a,r[2]+=t})),[e,a,t,o,x,v]},H=(e=1,a=0,t,n,i=0,s=!1,c="cylinder")=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w=[],F=[],L=0;L<t;L++)for(var U=L,C=.5,k=0;k<n;k++){l=r(2*Math.PI/n*k)*C,p=1/t*U-.5,h=o(2*Math.PI/n*k)*C,u=r(2*Math.PI/n*(k+1))*C,f=1/t*U-.5,m=o(2*Math.PI/n*(k+1))*C,d=r(2*Math.PI/n*(k+1))*C,g=1/t*(U+1)-.5,v=o(2*Math.PI/n*(k+1))*C,y=r(2*Math.PI/n*k)*C,b=1/t*(U+1)-.5,x=o(2*Math.PI/n*k)*C;var z=Math.atan2(l,h),S=Math.atan2(u,m),B=Math.atan2(d,v),N=Math.atan2(y,x);Math.abs(z-S)>Math.PI&&(z-=2*Math.PI,N-=2*Math.PI),R=(z+Math.PI)/Math.PI/2,E=p+.5,A=(S+Math.PI)/Math.PI/2,M=f+.5,T=(B+Math.PI)/Math.PI/2,_=g+.5,P=(N+Math.PI)/Math.PI/2,I=b+.5,w.push([[l,p,h],[u,f,m],[d,g,v],[y,b,x]]),F.push([[R,E],[A,M],[T,_],[P,I]])}return D(w,F,e,a,i,s,!0,c)},q=async(e=1,a=0,t=0,n=!1,i="torus",s,c)=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w,F,L,U,C=[],k=[],z=4*s,S=1/6,B=2/6,N=0;N<z;N++)for(var O=N+.5,V=0;V<c;V++){l=r(L=2*Math.PI/c*(V-1))*S+B,p=o(L)*S,0,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,U=Math.hypot(l,0),h=r(L)*U,u=p,f=o(L)*U,l=r(L=2*Math.PI/c*V)*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,U=Math.hypot(l,0),m=r(L)*U,d=p,g=o(L)*U,l=r(L=2*Math.PI/c*V)*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,U=Math.hypot(l,0),v=r(L)*U,y=p,b=o(L)*U,l=r(L=2*Math.PI/c*(V-1))*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,U=Math.hypot(l,0),x=r(L)*U,R=p,E=o(L)*U;var Y=Math.atan2(h,f),X=Math.atan2(m,g),H=Math.atan2(v,b),q=Math.atan2(x,E);Math.abs(Y-H)>Math.PI&&(H+=2*Math.PI,q+=2*Math.PI),A=(Y+Math.PI)/Math.PI/2,M=u+.5,T=(X+Math.PI)/Math.PI/2,_=d+.5,P=(H+Math.PI)/Math.PI/2,I=y+.5,w=(q+Math.PI)/Math.PI/2,F=R+.5,C.push([[h,u,f],[x,R,E],[v,y,b],[m,d,g]]),k.push([[A,M],[T,_],[P,I],[w,F]])}return D(C,k,e,a,t,n,!0,i)},G=async(e=1,a=0,t,n,i=0,s=!1,c="torus knot")=>{var l,p,h,u,f,m,d,g,v=[],y=[];y=[],d=[],n*=4,t*=2;for(var b=1/3,x=0;x<2*n;x++)for(var R=0;R<t+1;R++)l=1+r(f=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*x)*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+r(m),u=Math.hypot(p,h),p=r(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*x,u=Math.hypot(l,h),l=r(f)*u,h=o(f)*u,y.push([l,p,h]),l=1+r(f=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*(x+1))*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+r(m),u=Math.hypot(p,h),p=r(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*(x+1),u=Math.hypot(l,h),l=r(f)*u,h=o(f)*u,d.push([l,p,h]);y.forEach(((a,r)=>{if(r%(t+1)!=t){var o=(r+1)%y.length,n=y[r][0]*e/3.2,i=y[r][1]*e/3.2,s=y[r][2]*e/3.2,c=d[r][0]*e/3.2,l=d[r][1]*e/3.2,p=d[r][2]*e/3.2,h=d[o][0]*e/3.2,u=d[o][1]*e/3.2,f=d[o][2]*e/3.2,m=y[o][0]*e/3.2,g=y[o][1]*e/3.2,b=y[o][2]*e/3.2;v.push([[n,i,s],[c,l,p],[h,u,f],[m,g,b]])}}));var E,A,M=v,T=[];for(R=0;R<M.length;R++){y=[];for(var _=M[R].length;_--;){switch(_){case 0:E=0,A=0;break;case 1:E=1,A=0;break;case 2:E=1,A=1;break;case 3:E=0,A=.5;break;case 4:E=0,A=1}y.push([E,A])}T.push(y)}return D(v,T,1,a,i,s,!0,c)},W=async(e=1,a=0,t=0,n=!1,i="tetrahedron")=>{var s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];y=[];let R=1/1.4142/1.25;for(g=0;g<3;g++)s=1*r(p=2*Math.PI/3*g)/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]);for(x.push(y),v=3;v--;)(y=[]).push([s=0,c=0,l=-R]),s=1*r(p=2*Math.PI/3*v)/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]),s=1*r(p=2*Math.PI/3*(v-1))/1.25,c=1*o(p)/1.25,l=R,y.push([s,c,l]),x.push(y);f=m=d=b=0,x.map((e=>{e.map((e=>{f+=e[0],m+=e[1],d+=e[2],b++}))})),f/=b,m/=b,d/=b,x.map((e=>{e.map((e=>{e[0]-=f,e[1]-=m,e[2]-=d}))}));var E=x,A=[];for(g=0;g<E.length;g++){y=[];for(var M=E[g].length;M--;){switch(M){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}y.push([h,u])}A.push(y)}return D(E,A,e,a-1,t,n,!1,i)},j=async(e=1,a=0,t=0,n=!1,i="octahedron")=>{var s,c,l,p,h,u,f,m,d,g=[];for(m=8;m--;)d=[],s=0,c=0,m<4?(l=.8,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*m)/1.25,c=1*o(p)/1.25,l=0,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*(m+1))/1.25,c=1*o(p)/1.25):(l=-.8,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*m)/1.25,c=1*o(p)/1.25,l=0,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*(m-1))/1.25,c=1*o(p)/1.25),l=0,d.push([s,c,l]),g.push(d);var v=g,y=[];for(f=0;f<v.length;f++){d=[];for(var b=v[f].length;b--;){switch(b){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}d.push([h,u])}y.push(d)}return D(v,y,e,a-1,t,n,!1,i)},$=async(e=1,a=0,t=0,r=!1,o="icosahedron")=>{var n,i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];for(u=[[-(h=.5+5**.5/2),-1,0],[h,-1,0],[h,1,0],[-h,1,0]],p=3;p--;x.push(i))for(i=[],n=4;n--;)i.push([u[n][p],u[n][(p+1)%3],u[n][(p+2)%3]]);x.map((a=>{a.map((a=>{a[0]*=1/2.25*e,a[1]*=1/2.25*e,a[2]*=1/2.25*e}))})),f=JSON.parse(JSON.stringify(x)),l=[],u=[],[[[0,3],[1,0],[2,2]],[[1,3],[1,0],[0,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[1,0],[1,3],[0,2]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[2,1],[2,2],[1,0]],[[1,1],[2,2],[2,1]],[[0,0],[2,2],[1,1]],[[1,1],[2,1],[0,1]],[[0,1],[2,1],[0,2]],[[2,3],[1,2],[2,0]],[[2,3],[0,3],[0,0]],[[2,3],[2,0],[1,3]],[[2,3],[0,0],[1,2]],[[0,1],[2,0],[1,2]],[[1,1],[1,2],[0,0]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]]].map(((e,a)=>{m=e[0][0],d=e[1][0],g=e[2][0],v=e[0][1],y=e[1][1],b=e[2][1],u.push([f[g][b],f[d][y],f[m][v]])})),l.push(...u);var R=l,E=[];for(n=0;n<R.length;n++){u=[];for(var A=R[n].length;A--;){switch(A){case 0:s=0,c=0;break;case 1:s=1,c=0;break;case 2:s=1,c=1;break;case 3:s=0,c=.5;break;case 4:s=0,c=1}u.push([s,c])}E.push(u)}return D(R,E,1,a-1,t,r,!1,o)},K=async(e=1,a=0,t=0,n=!1,i="dodecahedron")=>{var s,c,l,p,h,u,f,m,d,g,v=[],y=[];let b=-6e6;for(g=5;g--;)s=r(u=2*Math.PI/5*g+Math.PI/5),c=o(u),l=0,c>b&&(b=c),y.push([s,c,l]);y=y.map((e=>(s=e[0],c=e[1]-=b,l=e[2],x(s,c,l,{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0})))),(h=structuredClone(y)).map((e=>{var a=Math.atan2(e[0],e[1])+Math.PI,t=Math.hypot(e[0],e[1]);e[0]=r(a)*t,e[1]=o(a)*t})),v.push(y,h),b=-6e6,v.map((e=>{e.map((e=>{s=e[0],c=e[1],(l=e[2])>b&&(b=l)}))})),p=Math.hypot(v[0][0][0]-v[0][1][0],v[0][0][1]-v[0][1][1],v[0][0][2]-v[0][1][2]),v.map((e=>{e.map((e=>{e[2]-=b+p/2}))})),(h=structuredClone(v)).map((e=>{e.map((e=>{var a=Math.atan2(e[0],e[2])+Math.PI,t=Math.hypot(e[0],e[2]);e[0]=r(a)*t,e[2]=o(a)*t}))})),v.push(...h),(h=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),(E=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),v.push(...h,...E);var E=v.map(((e,a)=>e.map(((a,t)=>{var r=e.length-t-1;return[e[r][0],e[r][1],e[r][2]]})))),A=[];for(g=0;g<E.length;g++){y=[];for(var M=E[g].length;M--;){switch(M){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y.push([m,d])}A.push(y)}return D(E,A,e/Math.max(1,2-t)/1.5,a,t,n,!1,i)},Z=(e=1,a=0,t=0,n=!1,i="cube")=>{var s,c,l,p,h,u,f,m,d=Math.PI,g=[];for(h=6;h--;g.push(l))for(l=[],u=4;u--;)h<3?l.push([(c=[r(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+0)%3]*(p=2**.5/2),c[(h+1)%3]*p,c[(h+2)%3]*p]):l.push([(c=[r(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+2)%3]*(p=-(2**.5)/2),c[(h+1)%3]*p,c[(h+0)%3]*p]);var v=[];for(h=0;h<g.length;h++){c=[];for(var y=g[h].length;y--;){switch(y){case 0:f=0,m=0;break;case 1:f=1,m=0;break;case 2:f=1,m=1;break;case 3:f=0,m=1}c.push([f,m])}v.push(c)}return D(g,v,e,a,t,n,!0,i)},Q=async(e=1,a=0,t=0,r=!1,o="rectangle")=>{Math.PI;return D([[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]]],[[[0,0],[1,0],[1,1],[0,1]]],e/1.5,Math.max("sprite"==o?0:2,a),"sprite"==o||"point light"==o?0:t,r,!0,o)},J=(e,a=0)=>!(a>300)&&(2==e||J(e/2,a+1)),ee=(e,a,t,n,i,s,c,l=!1)=>{let p,h,u,f,m,d,g,v,y,b=(e,a,t,r,o,n,i,s)=>(d=((i-o)*(a-n)-(s-n)*(e-o))/(g=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&d<=1&&(v=((t-e)*(a-n)-(r-a)*(e-o))/g)>=0&&v<=1?[e+d*(t-e),a+d*(r-a)]:0,x=(e,a,t,n)=>{let i=Math,s=i.atan2,c=i.hypot;p=r(y=s(p,h)+e)*(f=c(p,h)),h=o(y)*f,p=r(y=s(p,u)+t)*(f=c(p,u)),u=o(y)*f,h=r(y=s(h,u)+a)*(f=c(h,u)),u=o(y)*f,n&&(p+=oX,h+=oY,u+=oZ)},R=e=>{switch(e){case 0:x(0,0,Math.PI/2);break;case 1:x(0,Math.PI/2,0);break;case 2:x(Math.PI/2,0,Math.PI/2)}},E=0,A=0,M=0;c.map((e=>{E+=e[0],A+=e[1],M+=e[2]})),E/=c.length,A/=c.length,M/=c.length;let T=c[2][0]-c[1][0],_=c[2][1]-c[1][1],P=c[2][2]-c[1][2],I=c[1][0]-c[0][0],w=c[1][1]-c[0][1],F=c[1][2]-c[0][2],L=[_*F-P*w,P*I-T*F,T*w-_*I];f=Math.hypot(...L)+.001;L=L.map((e=>e/f*1));let U=E,C=A,k=M,z=1;if(l){let r=Math.hypot(U-e,C-a,k-t);z=Math.hypot(e-(E+L[0]/99),a-(A+L[1]/99),t-(M+L[2]/99))>r?-1:1}let S=E+(L[0]*=z),B=A+(L[1]*=z),N=M+(L[2]*=z),O=Math.atan2(S-U,N-k),V=-(Math.acos((B-C)/(Math.hypot(S-U,B-C,N-k)+.001))+Math.PI/2),D=!1,Y=[!1,!1,!1];p=e,h=a,u=t,x(0,-V,-O);let X=p,H=h,q=u;for(let e=3;e--;)!1===D&&(p=X,h=H,u=q,R(e),U=p,C=h,k=u=5,p=n,h=i,u=s,x(0,-V,-O),R(e),S=p,B=h,N=u,c.map(((a,t)=>{if(!1===D){let a=t;p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);let r=p,o=h;a=(t+1)%c.length,p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);(m=b(U,C,S,B,r,o,p,h))&&(Y[e]=m)}})));if(3==Y.filter((e=>!1!==e)).length){let e=Y[1][0],a=Y[0][1],t=Y[0][0],r=!0;E=0,A=0,M=0,c.map(((e,a)=>{E+=e[0],A+=e[1],M+=e[2]})),E/=c.length,A/=c.length,M/=c.length,p=E,h=A,u=M,x(0,-V,-O),U=p,C=h,k=u,S=e,B=a,N=t,c.map(((e,a)=>{if(r){let e=a;p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);let t=p,o=h;e=(a+1)%c.length,p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);b(U,C,S,B,t,o,p,h)&&(r=!1)}})),r&&(p=e,h=a,u=t,x(0,V,0),x(0,0,O),D=[[p,h,u],[L[0],L[1],L[2]]])}return D},ae=async(e,a)=>{var t,r=[],o=a.omitShape;(a.omitShape=!0,a.geometryData.map((async t=>{var o,n,i,s,c,l,p=t[0][0],h=t[0][1],u=t[0][2],f=t[1][0],m=t[1][1],d=t[1][2];"horizontal"!=a.alignment&&(Math.abs(f-p)>Math.abs(m-h)||"vertical"==a.alignment)?(o=p,n=(h+m)/2,i=(u+d)/2,s=f,c=(h+m)/2,l=(u+d)/2):(o=(p+f)/2,n=h,i=(u+d)/2,s=(p+f)/2,c=m,l=(u+d)/2),a.geometryData=[[p,h,u],[o,n,i],[s,c,l],[f,m,d]],await te(e,a).then((e=>{r.push(...e.curve)}))})),o)||(a.shapeType="lines",a.geometryData=r,w(e,a).then((e=>{t=e})),r=t);return r},te=async(e,a)=>{var t=[],r=10;void 0!==a&&Object.keys(a).forEach(((e,t)=>{if("steps"===e.toLowerCase())r=Math.floor(a[e])}));var o,n,i,s=structuredClone(a.geometryData);o=s[0][0]-(s[1][0]-s[0][0]),n=s[0][1]-(s[1][1]-s[0][1]),i=s[0][2]-(s[1][2]-s[0][2]),s[0][0]=o,s[0][1]=n,s[0][2]=i;var c=s.length-1;o=s[c][0]+(s[c][0]-s[c-1][0]),n=s[c][1]+(s[c][1]-s[c-1][1]),i=s[c][2]+(s[c][2]-s[c-1][2]),s[c][0]=o,s[c][1]=n,s[c][2]=i,s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,p=s[c][0],h=s[c][1],u=s[c][2],f=s[l][0],m=s[l][1],d=s[l][2],g=(o+p)/2,v=(n+h)/2,y=(i+u)/2,b=(p+f)/2,x=(h+m)/2,R=(u+d)/2;t.push([g,v,y]),a==s.length-3&&t.push([b,x,R]);for(var E=0;E<r+1;E++);}}));var l,p=[];return s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,h=s[c][0],u=s[c][1],f=s[c][2],m=(o+h)/2,d=(n+u)/2,g=(i+f)/2,v=(h+s[l][0])/2,y=(u+s[l][1])/2,b=(f+s[l][2])/2;t.push([m,d,g]);for(var x=m,R=d,E=g,A=0;A<r+1;A++){if(A){var M=ne(m+(h-m)/r*A,d+(u-d)/r*A,h+(v-h)/r*A,u+(y-u)/r*A,m+(h-m)/r*(A+1),d+(u-d)/r*(A+1),h+(v-h)/r*(A+1),u+(y-u)/r*(A+1));A<r&&(M?(p.push([x,R,E],[...M,0]),x=M[0],R=M[1],E=0):(p.push([x,R,E],[v,y,b]),x=v,R=y,E=b)),A>=r&&p.push([x,R,E],[v,y,0])}}}})),a.omitShape?{curve:p,midPoints:t,controlPoints:s}:(a.shapeType="lines",a.geometryData=p,w(e,a).then((async e=>l=e)),{curve:p,shape:l,midPoints:t,controlPoints:s})},re=(e,a)=>{let t=Math.hypot(...e)+1e-5,r=Math.hypot(...a)+1e-5;e[0]/=t,e[1]/=t,e[2]/=t,a[0]/=r,a[1]/=r,a[2]/=r;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2];return[-(-e[0]-2*a[0]*o)*t,-(-e[1]-2*a[1]*o)*t,-(-e[2]-2*a[2]*o)*t]},oe=(e,a,t)=>{var r,o,n,i,s,c,l,p=0;return t.map((e=>{e[0],e[1],p++})),p,p,r=e,o=a,1e6,1e6,p=0,t.map(((e,a)=>{n=t[l=a][0],i=t[l][1],l=(a+1)%t.length,s=t[l][0],c=t[l][1],ne(r,o,1e6,1e6,n,i,s,c)&&p++})),1==p},ne=(e,a,t,r,o,n,i,s)=>{var c,l,p;return(c=((i-o)*(a-n)-(s-n)*(e-o))/(l=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&c<=1&&(p=((t-e)*(a-n)-(r-a)*(e-o))/l)>=0&&p<=1&&[e+c*(t-e),a+c*(r-a)]},ie=(e,a=!1,t=0,r=0,o=0)=>{var n,i,s=0,c=0,l=0;e.map((e=>{s+=e[0],c+=e[1],l+=e[2]})),s/=e.length,c/=e.length,l/=e.length;var p=e[2][0]-e[1][0],h=e[2][1]-e[1][1],u=e[2][2]-e[1][2],f=e[1][0]-e[0][0],m=e[1][1]-e[0][1],d=e[1][2]-e[0][2];n=[h*d-u*m,u*f-p*d,p*m-h*f],i=Math.hypot(...n)+1e-4;n=n.map((e=>e/i*1));var g=s,v=c,y=l,b=1;if(a){var x=Math.hypot(g-t,v-r,y-o);b=Math.hypot(t-(s+n[0]/99),r-(c+n[1]/99),o-(l+n[2]/99))>x?-1:1}return[g,v,y,s+(n[0]*=b),c+(n[1]*=b),l+(n[2]*=b)]},se=async(a,t)=>{a.grav=.01,a.mspeed=1,a.rspeed=1,a.cameraMode="fps",a.crosshairMap="",a.showCrosshair=!0,a.crosshairSize=1,a.lastInteraction=0,a.hasTraction=!0,a.focusRequiredForMouse=!0,a.flyMode=!1,a.useKeys=!0,a.crosshairSel=0,a.crosshairAlpha=.6,a.useFPSControls=!0;var n=Array(4).fill().map(((a,t)=>`${e}/resources/crosshairs/crosshair${t+1}.png`));void 0!==t&&Object.keys(t).forEach(((e,r)=>{switch(e.toLowerCase()){case"mspeed":a.mspeed=+t[e];break;case"rspeed":a.rspeed=+t[e];break;case"grav":a.grav=+t[e];break;case"crosshairsel":a.crosshairSel=+t[e];break;case"crosshairsize":a.crosshairSize=+t[e];break;case"flymode":a.flyMode=!!t[e];break;case"usekeys":a.useKeys=!!t[e];break;case"crosshairmap":a.crosshairMap=t[e];break;case"crosshairalpha":a.crosshairAlpha=+t[e];break;case"showcrosshair":a.showCrosshair=!!t[e];break;case"focusrequiredformouse":a.focusRequiredForMouse=!!t[e]}}));if(a.crosshairImages=Array(n.length).fill(),a.crosshairImages.map((async(e,t)=>{a.crosshairImages[t]={img:new Image,loaded:!1},a.crosshairImages[t].img.onload=()=>{a.crosshairImages[t].loaded=!0},await fetch(n[t]).then((e=>e.blob())).then((e=>{a.crosshairImages[t].img.src=URL.createObjectURL(e)}))})),a.crosshairMap&&(a.crosshairSel=n.length,a.crosshairImages.push({img:new Image,loaded:!1}),a.crosshairImages[a.crosshairImages.length-1].img.onload=()=>{a.crosshairImages[a.crosshairImages.length-1].loaded=!0},await fetch(a.crosshairMap).then((e=>e.blob())).then((e=>{a.crosshairImages[a.crosshairImages.length-1].img.src=URL.createObjectURL(e)}))),a.useKeys){var i=.1*a.mspeed,s=.005*a.rspeed,c=0,l=0,p=0,h=0,u=0,f=1;a.keys=Array(256).fill().map(((e,a)=>!1)),a.keyTimers=Array(256).fill(0),a.keyTimerInterval=.2,window.addEventListener("keydown",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!0,a.lastInteraction=a.t)})),window.addEventListener("keyup",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!1,a.lastInteraction=a.t)})),window.addEventListener("mousedown",(e=>{(a.lastInteraction=a.t,0===e.button)&&(!0,document.querySelectorAll(".genericPopup").length||"CANVAS"!=document.activeElement.nodeName||a.c.requestPointerLock({unadjustedMovement:!0}))})),window.addEventListener("mouseup",(e=>{a.lastInteraction=a.t,0===e.button&&!1})),window.addEventListener("mousemove",(e=>{if(a.lastInteraction=a.t,document.pointerLockElement==a.c||!a.focusRequiredForMouse){var t=a.c.getBoundingClientRect();(e.pageX-t.left)/a.c.clientWidth*a.c.width,(e.pageY-t.top)/a.c.clientHeight*a.c.height,c-=e.movementX*s,l+=e.movementY*s}})),a.doKeys=async()=>{if(i=.1*a.mspeed,s=.005*a.rspeed,a.yaw+=c,a.pitch+=l,a.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,a.pitch)),c/=1.66,l/=1.66,a.x+=p,a.y+=h,a.z+=u,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&(p/=1.2,h/=1.2,u/=1.2),a.flyMode&&"CANVAS"==document.activeElement.nodeName){var e=-a.yaw+Math.PI,t=a.pitch;switch(a.mouseButton){case 1:p-=r(e)*r(t)*i*f,h+=o(t)*i*f,u-=o(e)*r(t)*i*f;break;case 2:p+=r(e)*r(t)*i*f,h-=o(t)*i*f,u+=o(e)*r(t)*i*f}}f=1,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&a.keys.map(((e,t)=>{if(a.keys[t])switch(t){case 16:f=3;break;case 37:c+=12*s;break;case 38:l-=12*s;break;case 39:c-=12*s;break;case 40:l+=12*s;break;case 87:var n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p+=r(n)*r(m)*i*f,h-=o(m)*i*f,u+=o(n)*r(m)*i*f):(p+=r(n)*i*f,u+=o(n)*i*f);break;case 65:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=r(n)*i*f,u+=o(n)*i*f;break;case 83:n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p-=r(n)*r(m)*i*f,h+=o(m)*i*f,u-=o(n)*r(m)*i*f):(p-=r(n)*i*f,u-=o(n)*i*f);break;case 68:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=-r(n)*i*f,u+=-o(n)*i*f}}))}}},ce=(e,a)=>{const t=async()=>{Ae.margin=e.margin,Ae.rsz(),Ae.width=e.width,Ae.height=e.height,Ae.c.width=e.c.width,Ae.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a]();if(["alphaQueue","lineQueue","particleQueue"].forEach((a=>{if(e[a].length){var t,r=[];switch(e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,i=a.y+e.y,s=a.z+e.z;t=x(n,i,s,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),r.push({idx:o,z:Math.hypot(e.x+t[0],e.y+t[1],e.z+t[2])})})),e.cameraMode){case"fps":r.sort(((e,a)=>a.z-e.z));break;case"fps":r.sort(((e,a)=>e.z-a.z))}e[a].map((async(t,o)=>{var n=e[a][r[o].idx].geometry,i=n.vertices,s=n.size;n.size=e[a][r[o].idx].size,n.vertices=e[a][r[o].idx].vertices,n.x=e[a][r[o].idx].x,n.y=e[a][r[o].idx].y,n.z=e[a][r[o].idx].z,n.roll=e[a][r[o].idx].roll,n.pitch=e[a][r[o].idx].pitch,n.yaw=e[a][r[o].idx].yaw;for(var c=n.penumbra,l=1+((n.isLine||n.isParticle)&&c?1:0);l--;)e.Draw(n,!0,(n.isParticle||n.isLine)&&c&&!l);n.vertices=i,n.size=s})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e[a]=[]})),e.t+=1/60,requestAnimationFrame(t),"fps"==e.cameraMode&&(e.useKeys&&e.doKeys&&await e.doKeys(),e.showCrosshair&&e.crosshairImages[e.crosshairSel].loaded)){var r=200*e.crosshairSize;Ae.ctx.globalAlpha=e.crosshairAlpha,Ae.ctx.drawImage(e.crosshairImages[e.crosshairSel].img,Ae.width/2-r/2,Ae.height/2-r/2,r,r),Ae.ctx.globalAlpha=1}};window.addEventListener("load",(()=>{e.ready=!0,t()}))},le=(e,a,t)=>pe(e,a,t),pe=(e,a,t)=>{let r=e/255,o=a/255,n=t/255,i=Math.min(r,o,n),s=Math.max(r,o,n),c=s,l=s-i,p=s?l/s:0,h=Math.min(e,a,t),u=Math.max(e,a,t),f=0;for(l&&(e>=a&&e>=t&&(f=(a-t)/(u-h)),a>=e&&a>=t&&(f=2+(t-e)/(u-h)),t>=a&&t>=e&&(f=4+(e-a)/(u-h))),f*=60;f<0;)f+=360;for(;f>=360;)f-=360;return[f,p,c]},he=e=>void 0!==e.length&&void 0!==e.forEach,ue=(e,a,t)=>fe(e,a,t),fe=(e,a,t)=>{let r=de(e,a,t);return ve(...r)},me=(e,a,t)=>de(e,a,t),de=(e,a,t)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let r,o,n,i=t*a,s=i*(1-Math.abs(e/60%2-1)),c=t-i;return e>=0&&e<60&&(r=i,o=s,n=0),e>=60&&e<120&&(r=s,o=i,n=0),e>=120&&e<180&&(r=0,o=i,n=s),e>=180&&e<240&&(r=0,o=s,n=i),e>=240&&e<300&&(r=s,o=0,n=i),e>=300&&e<360&&(r=i,o=0,n=s),[255*(r+c),255*(o+c),255*(n+c)]},ge=(e,a,t)=>ve(e,a,t),ve=(e,a,t)=>{let r="0123456789abcdef",o="";return o+=r[e/16|0],o+=r[e-16*(e/16|0)|0],o+=r[a/16|0],o+=r[a-16*(a/16|0)|0],o+=r[t/16|0],o+=r[t-16*(t/16|0)|0],Number("0x"+o)},ye=e=>be(e),be=e=>[e/256**3-(e/256**3|0),e/65536-(e/65536|0),e/256-(e/256|0)],xe=e=>{var a=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map((t=>{a.push({name:t,val:e.getParameter(e[t])})}));var t=document.createElement("div");t.style.position="fixed",t.style.zIndex=1e5,t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.background="#0008",t.style.padding="20px",t.style.width="600px",t.style.height="350px",t.style.border="1px solid #fff4",t.style.borderRadius="5px",t.style.fontFamily="monospace",t.style.fontSize="20px",t.style.color="#fff";var r=document.createElement("div");r.style.fontSize="24px",r.style.color="#0f8c",r.innerHTML="rendering context parameters<br><br>",t.appendChild(r);var o=document.createElement("div");o.style.minWidth="100%",o.style.height="250px",o.style.background="#333",o.style.border="1px solid #fff4",o.style.overflowY="auto",o.style.wordWrap="break-word",o.style.color="#888",o.style.fontSize="10px",t.appendChild(o);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="📋 copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(o),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout((()=>{n.innerHTML="📋 copy"}),1e3)},t.appendChild(n);var i=document.createElement("button");i.onclick=()=>t.remove(),i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="close",t.appendChild(i),o.innerHTML=JSON.stringify(a),document.body.appendChild(t)},Re={push:async(e,a)=>{console.log("push"),e.dataArray.items.push(a)},pop:async(e,a)=>{console.log("pop")},insert:async(e,a)=>{console.log("insert")},slice:async(e,a)=>{console.log("slice")},test:(e,a,t,n,i)=>{var s,c,l,p,h,u=a.length**.5|0,f=0,m=u;u+=1,s=n/2,c=i/2;var d,g,v,y=!1;if(e.dataArray.items.length){y=!1;do{for(var b=Math.hypot(n,i),x=0;!y&&x<b;x+=1*u|0){for(var R=3;!y&&R--;)if(!y&&(p=s+r(l=2*Math.PI/3*R+f/3+16*e.t)*x-u/2|0,h=c+o(l)*x/(16/9)-u/2|0,p>=0&&p+u<n&&h>=0&&h+u<i)){var E=[[p,h],[p+u,h],[p+u,h+u],[p,h+u]];v=!1,e.dataArray.items.forEach(((e,a)=>{if(!v){var t=[[e.posx,e.posy],[e.posx+e.width,e.posy],[e.posx+e.width,e.posy+e.width],[e.posx,e.posy+e.width]];E.forEach((e=>{oe(e[0],e[1],t)&&(v=!0)})),t.forEach((e=>{oe(e[0],e[1],E)&&(v=!0)}))}})),v||y||(y=!0,d=p,g=h)}f++}}while(f<1e4&&!y)}else y=!0,d=0|s,g=0|c;e.dataArray.items.push({array:a,posx:d,posy:g,width:u}),a.forEach(((e,a)=>{var r=4*(d+a%m+(g+a/m|0)*n|0)|0;t[r+0]=0|e[0],t[r+1]=0|e[1],t[r+2]=0|e[2],t[r+3]=255}));var A=-6e6,M=-6e6,T=6e6,_=6e6;return e.dataArray.items.forEach(((e,a)=>{e.posx<T&&(T=e.posx),e.posx>A&&(A=e.posx),e.posy<_&&(_=e.posy),e.posy>M&&(M=e.posy)})),[A,M]}},Ee=e=>a.GenHash(e);var Ae;(Ae=await h({context:{mode:"2d",margin:0}})).c.style.background="#0000",Ae.c.style.zIndex=10;var Me,Te=document.createElement("canvas"),_e=Te.getContext("2d",{willReadFrequently:!0});export{h as Renderer,w as LoadGeometry,N as BasicShader,f as DestroyRenderer,u as ResizeRenderer,m as DestroyShape,ce as AnimationLoop,W as Tetrahedron,Z as Cube,j as Octahedron,$ as Icosahedron,K as Dodecahedron,H as Cylinder,Re as ShapeArray,q as Torus,P as DownloadCustomShape,M as LoadAnimationFromZip,T as DrawAnimation,G as TorusKnot,Q as Rectangle,b as Q,x as R,R as R_ypr,E as R_pyr,A as R_rpy,C as ComputeNormalAssocs,k as SyncNormals,ne as Intersects,oe as PointInPoly2D,ee as PointInPoly3D,O as ShapeToLines,S as ShowBounding,z as GetShaderCoord,re as Reflect,ie as Normal,te as BSpline,ae as CurveTo,L as ImageToPo2,y as LoadOBJ,J as IsPowerOf2,le as RGBToHSV,ue as HSVToHex,pe as HSVFromRGB,fe as HexFromHSV,me as HSVToRGB,de as RGBFromHSV,ge as HexFromRGB,ve as RGBToHex,ye as RGBFromHex,be as HexToRGB,X as GeoSphere,e as ModuleBase,se as LoadFPSControls,Ae as Overlay,Ee as GenHash,he as IsArray};