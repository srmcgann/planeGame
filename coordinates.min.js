const e="https://srmcgann.github.io/Coordinates";import*as a from"https://srmcgann.github.io/GenHash/hash.js";const r=document.createElement("script");await r.setAttribute("src",e+"/zip.js"),await document.body.appendChild(r);const t=Math.sin,o=Math.cos,n=Math.random;var i=!1;const s=document.createElement("canvas"),c=s.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1});new Image;var l;const p={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},h=async e=>{var a=0,r=0,n=0,i=1920,s=1080,c=0,l=0,p=0,h=2e3,u=!0,f=10,m=!1,d=.2,g=!1,v=0,y="default",b=!1,x=0,R="",E={mode:"webgl2",options:{alpha:!0,antialias:!1,desynchronized:!0,premultipliedAlpha:!1}},A=[],M=[0,0,0],T={data:[],items:[]};void 0!==e&&Object.keys(e).forEach(((t,o)=>{switch(t.toLowerCase()){case"plugins":e[t].map((e=>{if("post processing"===e.type.toLowerCase())if(void 0===e.enabled||e.enabled){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map((e=>e.toLowerCase())):[]};A.push(a)}}));break;case"width":i=e[t];break;case"height":s=e[t];break;case"alpha":g=e[t];break;case"x":a=e[t];break;case"y":r=e[t];break;case"z":n=e[t];break;case"roll":c=e[t];break;case"pitch":l=e[t];break;case"yaw":p=e[t];break;case"fov":h=e[t];break;case"fog":e[t];break;case"fogcolor":M=e[t];break;case"clearcolor":v=e[t];break;case"attachtobody":u=!!e[t];break;case"exportgpuspecs":m=!!e[t];break;case"margin":f=e[t];break;case"cameramode":y=e[t];break;case"ambientlight":d=e[t];break;case"showcrosshair":b=!!e[t];break;case"dataarray":T=e[t];break;case"crosshairsel":x=e[t];break;case"crosshairmap":R=e[t];break;case"context":E.mode=e[t].mode,E.options=e[t].options}}));const _=document.createElement("canvas"),P=_.getContext(E.mode,E.options);_.width=i,_.height=s,_.tabIndex=0,_.style.outline="none";const I=E.mode;if("2d"!=E.mode&&(console.log(`GLSL version: ${P.getParameter(P.SHADING_LANGUAGE_VERSION)}`),P.pixelStorei(P.UNPACK_ALIGNMENT,1)),m&&Re(P),"2d"===E.mode);else P.viewport(0,0,_.width,_.height);var w,F;u&&(_.style.display="block",_.style.position="absolute",_.style.left="50vw",_.style.top="50vh",_.style.transform="translate(-50%, -50%)",document.body.appendChild(_)),window.addEventListener("resize",w=e=>{var a,r=F.margin,t=document.body,o=0!==_.width?_.height/_.width:1;t.clientHeight/t.clientWidth>o?(_.style.width=(a=t.clientWidth)-2*r+"px",_.style.height=a*o-2*r+"px"):(_.style.height=(a=t.clientHeight)-2*r+"px",_.style.width=a/o-2*r+"px")}),F={c:_,ctx:P,contextType:I,t:0,alpha:g,width:i,height:s,x:a,y:r,z:n,roll:c,pitch:l,yaw:p,fov:h,ready:!1,ambientLight:d,clearColor:v,pointLights:[],pointLightCols:[],dataArray:T,alphaQueue:[],particleQueue:[],lineQueue:[],active:!0,cameraMode:y,showCrosshair:b,crosshairSel:x,crosshairMap:R,pageX:undefined,pageY:undefined,mouseX:undefined,mouseY:undefined,mouseButton:undefined,rsz:w,margin:f,optionalPlugins:A,fogColor:M},w(),F["2d"==I?"ctx":"gl"]=P;var L=F;L.Clear=()=>{if("2d"===I)_.width=L.c.width;else P.clearColor(...xe(L.clearColor),1),P.clear(P.COLOR_BUFFER_BIT),P.clear(P.DEPTH_BUFFER_BIT)};return L.Draw=(e,a=!1,r=!1)=>{var n,i,s=e.shader.datasets[e.datasetIdx],c=s.program;if(L.optionalPlugins.map((e=>{if("post processing"===e.name)if("equirectangular"===e.value)e.enabled&&(n=!0,L.equirectangularPlugin=!0,i=!(-1==e.params.indexOf("omitsplitcheck")));else n=!1,L.equirectangularPlugin=!1})),void 0!==e?.shader)if(!a&&(e.isSprite||e.isLight&&e.showSource)){switch(e.shapeType){case"sprite":case"point light":l="alphaQueue"}L[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...L[l]]}else{if(!a&&(e.isLine||e.isParticle)){var l;switch(e.shapeType){case"particles":l="particleQueue";break;case"lines":l="lineQueue"}L[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...L[l]]}P.useProgram(c);for(var p=0;p<(n&&!i?2:1);p++){if(P.uniform1i(s.locRotationMode,e.rotationMode),L.locPlugin=P.getUniformLocation(s.program,"plugin"),L.locOmitSplitCheck=P.getUniformLocation(s.program,"omitSplitCheck"),L.locSplitCheckPass=P.getUniformLocation(s.program,"splitCheckPass"),P.uniform1f(L.locPlugin,n?1:0),P.uniform1f(L.locOmitSplitCheck,i?1:0),P.uniform1f(L.locSplitCheckPass,p),e.showBounding)S(e,L,e.showBounding,n,i,p);if("particles"==e.shapeType||e.isParticle||"lines"==e.shapeType||e.isLine){if(L.ctx.blendFunc(P.ONE,P.SRC_ALPHA),L.ctx.enable(P.BLEND),P.uniform1f(s.locPointSize,e.size*(r?3:1)),"lines"==e.shapeType&&P.lineWidth(e.size*(r?3:1)),P.uniform1f(s.locIsParticle,e.isParticle),P.uniform1f(s.locIsLine,e.isLine),P.uniform1f(s.locPenumbraPass,e.penumbraPass?1:0),P.uniform1f(s.locT,L.t),P.uniform1f(s.locColorMix,e.colorMix),P.uniform1f(s.locIsSprite,e.isSprite),P.uniform1f(s.locIsLight,e.isLight),P.uniform1f(s.locCameraMode,"fps"==L.cameraMode.toLowerCase()?1:0),P.uniform1f(s.locAlpha,Math.min(1,Math.max(0,r?e.alpha*e.penumbra:e.alpha))),P.uniform3f(s.locColor,...xe(e.color)),P.uniform1f(s.locAmbientLight,_/8),P.uniform2f(s.locResolution,L.width,L.height),P.uniform3f(s.locCamPos,L.x,L.y,L.z),P.uniform3f(s.locCamOri,L.roll,L.pitch,L.yaw),P.uniform3f(s.locGeoPos,e.x,e.y,e.z),P.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(s.locFov,L.fov),P.uniform1f(s.locEquirectangular,e.equirectangular?1:0),P.uniform1f(s.locRenderNormals,0),e?.vertices?.length){var h,u,f,m,d,g,v,y,b,x;if(e.isLine){m=[];for(var R=L.fov,E=e.size*(r?4:1)/50,A=0;A<e.vertices.length;A+=6)I=e.vertices[A+0],w=e.vertices[A+1],F=e.vertices[A+2],U=e.vertices[A+3],k=e.vertices[A+4],B=e.vertices[A+5],g=z(I,w,F,e,L),v=z(U,k,B,e,L),(g[2]>-200&&v[0]>-200||n)&&(d=Math.atan2(v[0]-g[0],v[1]-g[1])+Math.PI/2,g[0]-=L.width/2,g[1]-=L.height/2,v[0]-=L.width/2,v[1]-=L.height/2,g[0]/=R/2,g[1]/=R/2,v[0]/=R/2,v[1]/=R/2,x=g[2],y=g[0]+t(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]-t(d)*E/x,b=g[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-t(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]-t(d)*E/x,b=v[1]-o(d)*E/x,m.push(y,-b,x),x=v[2],y=v[0]+t(d)*E/x,b=v[1]+o(d)*E/x,m.push(y,-b,x),x=g[2],y=g[0]+t(d)*E/x,b=g[1]+o(d)*E/x,m.push(y,-b,x));m=new Float32Array(m),u=P.createBuffer(),P.bindBuffer(P.ARRAY_BUFFER,u),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,null),f=new Uint32Array(Array(m.length/3).fill().map(((e,a)=>a))),h=P.createBuffer(),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),P.bufferData(P.ELEMENT_ARRAY_BUFFER,f,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null)}else m=e.vertices,h=e.Vertex_Index_Buffer,u=e.vertex_buffer,f=e.vIndices;P.bindBuffer(P.ARRAY_BUFFER,u),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),P.bufferData(P.ELEMENT_ARRAY_BUFFER,f,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,u),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),s.locPosition=P.getAttribLocation(s.program,"position"),P.vertexAttribPointer(s.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locPosition),e.isLine?P.drawElements(P.TRIANGLES,m.length/3|0,P.UNSIGNED_INT,0):P.drawElements(P.POINTS,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)}if(L.ctx.blendFunc(P.ONE,P.ZERO),L.ctx.disable(P.BLEND),r)return}else{switch(P.activeTexture(P.TEXTURE0),e.textureMode){case"video":case"dataArray":C(P,s.resource,s.texture,e.textureMode,L.t,e);break;case"canvas":P.activeTexture(P.TEXTURE2),C(P,e.canvasTexture,s.texture,e.textureMode,L.t,e);break;case"image":e.rebindTextures&&C(P,e.image,s.texture,e.textureMode,L.t,e)}void 0!==e.canvasTexture&&(P.activeTexture(P.TEXTURE2),C(P,e.canvasTexture,s.supplementalTexture,"canvas",L.t,e),P.uniform1i(s.locSupplementalTexture,2),P.uniform1f(s.locSupplementalTextureMix,e.canvasTextureMix)),P.activeTexture(P.TEXTURE0),P.uniform1i(s.locTexture,s.texture),P.bindTexture(P.TEXTURE_2D,s.texture),e.heightMap?(P.activeTexture(P.TEXTURE4),P.uniform1i(s.locHeightMap,4),C(P,s.heightResource,s.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,L.t,e),P.uniform1i(s.locHeightTexture,s.heightTexture),P.uniform1f(s.locUseHeightMap,1),P.uniform1f(s.locHeightMapIntensity,e.heightMapIntensity),P.uniform1f(s.locMaxHeightmap,e.maxHeightmap),P.uniform1f(s.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),P.bindTexture(P.TEXTURE_2D,s.heightTexture),P.activeTexture(P.TEXTURE0)):P.uniform1f(s.locUseHeightMap,0),P.uniform1i(s.locPointLightCount,L.pointLights.length);var M=[],T=[];L.pointLights.map((e=>{M.push(e.x,e.y,e.z,e.lum);xe(e.color);T.push(...xe(e.color),1)})),M.length&&(P.uniform4fv(s.locPointLights,M),P.uniform4fv(s.locPointLightCols,T));var _=L.ambientLight;if(s.optionalLighting.map((e=>{if("ambientLight"===e.name)_=e.value})),P.useProgram(c),L.hasFog||(P.uniform1f(s.locFog,0),P.uniform3f(s.locFogColor,...L.fogColor)),s.optionalUniforms.map((a=>{if("object"==typeof a?.loc)switch(P[a.dataType](a.loc,a.value),P.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"fog":P.uniform1f(s.locFog,a.value),P.uniform3f(s.locFogColor,...xe(a.color));break;case"reflection":P.activeTexture(P.TEXTURE1),"image"==a.textureMode&&e.rebindTextures&&C(P,a.image,a.refTexture,a.textureMode,L.t,a),"video"==a.textureMode&&C(P,a.video,a.refTexture,a.textureMode,L.t,a),P.activeTexture(P.TEXTURE1),P.uniform1i(a.locRefTexture,1),P.bindTexture(P.TEXTURE_2D,a.refTexture),P.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"refraction":P.activeTexture(P.TEXTURE5),"video"==a.textureMode&&C(P,a.video,a.refractionTexture,a.textureMode,L.t,a),P.activeTexture(P.TEXTURE5),P.uniform1i(a.locRefractionTexture,5),P.bindTexture(P.TEXTURE_2D,a.refractionTexture),P.uniform1f(a.locRefractionOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0),a.locAngleOfRefraction=P.getUniformLocation(s.program,"angleOfRefraction"),P.uniform1f(a.locAngleOfRefraction,a.angleOfRefraction),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bufferData(P.ARRAY_BUFFER,a.refractionVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,a.refractionVecIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.vertexAttribPointer(s.locRefractionlVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locRefractionlVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null);break;case"phong":a.locPhongTheta=P.getUniformLocation(s.program,"phongTheta"),P.uniform1f(a.locPhongTheta,a.theta+Math.PI);break;case"custom":if(a.uniformName){a.locCustomUniform=P.getUniformLocation(s.program,a.uniformName);var r=a.value;ue(r)?P[a.dataType](a.locCustomUniform,...a.value):P[a.dataType](a.locCustomUniform,a.value)}}})),P.uniform1f(s.locT,L.t),P.uniform1f(s.locIsParticle,e.isParticle),P.uniform1f(s.locIsLine,e.isLine),P.uniform1f(s.locPenumbraPass,0),P.uniform1f(s.locColorMix,e.colorMix),P.uniform1f(s.locIsSprite,e.isSprite),P.uniform1f(s.locIsLight,e.isLight),P.uniform1f(s.locCameraMode,"fps"==L.cameraMode.toLowerCase()?1:0),P.uniform1f(s.locAlpha,e.alpha),P.uniform3f(s.locColor,...xe(e.color)),P.uniform1f(s.locAmbientLight,_/8),P.uniform2f(s.locResolution,L.width,L.height),P.uniform3f(s.locCamPos,L.x,L.y,L.z),P.uniform3f(s.locCamOri,L.roll,L.pitch,L.yaw),P.uniform3f(s.locGeoPos,e.x,e.y,e.z),P.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(s.locFov,L.fov),P.uniform1f(s.locEquirectangular,e.equirectangular?1:0),P.uniform1f(s.locRenderNormals,0),P.bindBuffer(P.ARRAY_BUFFER,e.uv_buffer),P.bufferData(P.ARRAY_BUFFER,e.uvs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.uvIndices,P.STATIC_DRAW),P.vertexAttribPointer(s.locUv,2,P.FLOAT,!1,0,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null),e?.normalVecs.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bufferData(P.ARRAY_BUFFER,e.normalVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),s.locNormalVec=P.getAttribLocation(s.program,"normalVec"),P.vertexAttribPointer(s.locNormalVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locNormalVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)),e?.vertices?.length){if(P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),n){for(A=0;A<e.vertices;A+=9){var I=e.vertices[A+0],w=e.vertices[A+1],F=e.vertices[A+2],U=e.vertices[A+3],k=e.vertices[A+4],B=e.vertices[A+5];e.vertices[A+6],e.vertices[A+7],e.vertices[A+8]}P.bufferData(P.ARRAY_BUFFER,[],P.STATIC_DRAW)}else P.bufferData(P.ARRAY_BUFFER,e.vertices,P.STATIC_DRAW);P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.vIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),s.locPosition=P.getAttribLocation(s.program,"position"),P.vertexAttribPointer(s.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locPosition),P.drawElements(e.wireframe?P.LINE_STRIP:P.TRIANGLES,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)}P.uniform1f(s.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bufferData(P.ARRAY_BUFFER,e.normals,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),P.vertexAttribPointer(s.locNormal,3,P.FLOAT,!1,0,0),s.locNormal=P.getAttribLocation(s.program,"normal"),P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bufferData(P.ARRAY_BUFFER,e.normals,P.STATIC_DRAW),P.enableVertexAttribArray(s.locNormal),P.drawElements(P.LINES,e.normals.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null))}}}e.rebindTextures=!1},L.nullShader=await N(L,[{uniform:{type:"phong",value:0}}]),L.alphaShader=await N(L,[]),window.addEventListener("mousemove",(e=>{var a=L.c.getBoundingClientRect();L.mouseX=(e.pageX-a.left)/L.c.clientWidth*L.width,L.mouseY=(e.pageY-a.top)/L.c.clientHeight*L.height})),window.addEventListener("mousedown",(e=>{L.mouseButton=e.buttons})),window.addEventListener("mouseup",(e=>{L.mouseButton=-1})),L},u=(e,a,r)=>{if(e.width=a,e.height=r,e.c.width=a,e.c.height=r,e.rsz(),"2d"===e.ctx.mode);else e.ctx.viewport(0,0,e.c.width,e.c.height)},f=e=>{e.c.remove(),e.active=!1},m=e=>{if("point light"===e.shapeType)e.renderer.pointLights=e.renderer.pointLights.filter(((a,r)=>r!=e.pointLightID)),e.renderer.pointLights.map(((e,a)=>e.pointLightID=a))},g=(e,a,r,t,o,n)=>{var i;e.split("\n").forEach((e=>{var n=e.split(" ");switch(n[0]){case"v":n.shift(),a.push(n.map((e=>+e)));break;case"vt":n.shift(),t.push(n.map((e=>+e)));break;case"vn":n.shift(),r.push(n.map((e=>+e)));break;case"f":n.shift(),o.push(n.map((e=>e)))}})),o.map((e=>{var o,s,c,l=[],p=[],h=[],u=!1;if(e.map((e=>{var n=e.split("/");switch(n.length){case 1:o=n[0],l.push(a[o-1]);break;case 2:o=n[0],s=n[1],l.push(a[o-1]),p.push(t[s-1]),!0;break;case 3:o=n[0],s=n[1],c=n[2],l.push(a[o-1]),p.push(t[s-1]),h.push(r[c-1]),u=!0}})),void 0!==l[0]){var f=l[0][0],m=l[0][1],d=l[0][2],g=l[1][0],v=l[1][1],y=l[1][2],b=l[2][0],x=l[2][1],R=l[2][2];if(u)var E=h[0][0],A=h[0][1],M=h[0][2],T=h[1][0],_=h[1][1],P=h[1][2],I=h[2][0],w=h[2][1],F=h[2][2];if(4==l.length){var L=l[3][0],C=l[3][1],U=l[3][2];if(u)var k=h[3][0],z=h[3][1],S=h[3][2]}}switch(l.length){case 3:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+A,d+M],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F])})),h=i,n.vertices.push(...l[0],...l[1],...l[2]),p.length&&void 0!==p[0]&&n.uvs.push(...p[0],...p[1],...p[2]),h.length&&void 0!==h[0]&&n.normals.push(...h[0],...h[1],...h[2]);break;case 4:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+A,d+M],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F],[L,C,U,L+k,C+z,U+S])})),h=i,n.vertices.push(...l[0],...l[1],...l[2],...l[2],...l[3],...l[0]),p.length&&n.uvs.push(...p[0],...p[1],...p[2],...p[2],...p[3],...p[0]),h.length&&n.normals.push(...h[0],...h[1],...h[2],...h[2],...h[3],...h[0])}var B=n.normals.length-7;n.normals[B+3],n.normals[B+0],n.normals[B+4],n.normals[B+1],n.normals[B+5],n.normals[B+2]}))},v=(e,a=0,r=0,t=0,o=0,n=0,i=0)=>{for(var s=0;s<e.uvs.length;s+=2)e.uvs[s+1]=1-e.uvs[s+1];for(s=0;s<e.normals.length;s+=3)e.normals[s+1]=e.normals[s+1];for(s=0;s<e.vertices.length;s+=3){var c=[e.vertices[s+0],e.vertices[s+1],e.vertices[s+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.vertices[s+0]=c[0],e.vertices[s+1]=c[1],e.vertices[s+2]=c[2];for(var l=2;l--;){var p=l?2*s:2*s+3;c=[e.normals[p+0],e.normals[p+1],e.normals[p+2]];c=E(...c,{roll:o,pitch:n,yaw:i}),e.normals[p+0]=c[0],e.normals[p+1]=c[1],e.normals[p+2]=c[2]}}},y=async(e,a,r,t,o,n,i,s,c=!0,h=!0)=>{var u={vertices:[],normals:[],uvs:[]};if(h&&(l=p.objFiles.filter((a=>a.url==e))).length)u=l[0].ret;else{var f=[],m=[],d=[],y=[];await fetch(e).then((e=>e.text())).then((e=>{g(e,f,m,d,y,u)})),p.objFiles=[...structuredClone(p.objFiles),{url:e,ret:u}]}return v(u,r,t,o,n,i,s),u},b=(e,a,r,t,o=700)=>[t.width/2+e/r*o,t.height/2+a/r*o],x=(e,a,r,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=t(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,e=t(s=h(e,r)+m)*(c=p(e,r)),r=o(s)*c,a=t(s=h(a,r)+f)*(c=p(a,r)),r=o(s)*c,i)&&(e+=n.x,a+=n.y,r+=n.z);return[e,a,r]},R=(e,a,r,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=t(s=h(e,r)+m)*(c=p(e,r)),r=o(s)*c,a=t(s=h(a,r)+f)*(c=p(a,r)),r=o(s)*c,e=t(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,r+=n.z);return[e,a,r]},E=(e,a,r,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(a=t(s=h(a,r)+f)*(c=p(a,r)),r=o(s)*c,e=t(s=h(e,r)+m)*(c=p(e,r)),r=o(s)*c,e=t(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,r+=n.z);return[e,a,r]},A=(e,a,r,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=t(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,a=t(s=h(a,r)+f)*(c=p(a,r)),r=o(s)*c,e=t(s=h(e,r)+m)*(c=p(e,r)),r=o(s)*c,i)&&(e+=n.x,a+=n.y,r+=n.z);return[e,a,r]},M=(e,a,r)=>{var t=[],o=a.name,n={loaded:!1,curFrame:0,geometries:[],dir:1};return fetch(a.url).then((e=>e.blob())).then((i=>{new zip.ZipReader(new zip.BlobReader(i)).getEntries().then((i=>{var s=i.length;t=Array(s).fill().map((e=>({data:{}}))),i.forEach((async(i,c)=>{(await i.getData(await new zip.BlobWriter)).text().then((i=>{do{0}while("PK"==i.substr(0,2));if("custom shape"!=a.shapeType&&"lines"!=a.shapeType||(i=JSON.parse(i)),t[c].data=i,c==s-1){n.loaded=!0;var l=new zip.ZipWriter(new zip.BlobWriter);t.forEach(((t,i)=>{var c=(""+(i+1)).padStart(4,"0");i%1||!("lines"!=a.shapeType&&"custom shape"!=a.shapeType||void 0!==t.data.vertices&&t.data.vertices.length)||(a.geometryData=t.data,a.name=`${o?o+"_":""}frame${c}.json`,a.isFromZip=!0,w(e,a).then((async e=>{n.geometries[i/1|0]=e,await r.ConnectGeometry(e);for(var t=[],o=[],c=[],p=[],h=0;h<e.vertices.length;h++)t.push(Math.round(1e3*e.vertices[h])/1e3);for(h=0;h<e.uvs.length;h++)p.push(Math.round(1e3*e.uvs[h])/1e3);for(h=0;h<e.normals.length;h+=3)o.push(Math.round(1e3*e.normals[h+0])/1e3),o.push(Math.round(1e3*e.normals[h+1])/1e3),o.push(Math.round(1e3*e.normals[h+2])/1e3);for(h=0;h<e.normalVecs.length;h++)c.push(Math.round(1e3*e.normalVecs[h])/1e3);var u={vertices:t,uvs:p,normals:o,normalVecs:c},f=new zip.TextReader(JSON.stringify(u)),m=(""+(i+1)).padStart(4,"0");l.add(`frame_${m}.json`,f),i==s-1&&a.downloadShape&&await I(await l.close(),"animation.zip")})))}))}}))}))}))})),n},T=(e,a,r)=>{var t=e.t,o=0,n=0,i=0,s=0,c=0,l=0,p="reverse",h=1;if(void 0!==r&&Object.keys(r).forEach(((e,a)=>{switch(e.toLowerCase()){case"x":o=+r[e];break;case"y":n=+r[e];break;case"z":i=+r[e];break;case"roll":s=+r[e];break;case"pitch":c=+r[e];break;case"yaw":l=+r[e];break;case"loopmode":p=r[e];break;case"animationspeed":h=1/+r[e]|0}})),void 0!==a&&a.loaded&&a.geometries.length){for(var u=1;u--;){if(!h||(60*t|0)%h||(a.curFrame+=a.dir),a.curFrame>=a.geometries.length-("cycle"==p?0:1))if("cycle"===p)a.curFrame=0;else a.dir=-1;if(a.curFrame<("cycle"==p?0:1))if("cycle"===p)a.curFrame=a.geometries.length-1;else a.dir=1}var f=a.geometries[a.curFrame];void 0!==f&&void 0!==f.vertices&&f.vertices.length&&(f.x=o,f.y=n,f.z=i,f.roll=s,f.pitch=c,f.yaw=l,e.Draw(f))}},_=e=>{var a="",r=[],t=[],o=[],n=[];if(e?.vertices){r=e.vertices;for(var i=0,s=[],c=0;c<r.length;c+=3){var l=-Math.round(1e4*r[c+0])/1e4,p=Math.round(1e4*r[c+1])/1e4,h=Math.round(1e4*r[c+2])/1e4;a+=`v ${l} ${p} ${h}\n`,s.push(c/3),3==++i&&(i=0,n.push(s),s=[])}}if(e?.normalVecs){o=e.normalVecs;var u=e.resolved?1:-1;for(c=0;c<o.length;c+=3){var f=Math.round(1e4*o[c+0])/1e4*u,m=-Math.round(1e4*o[c+1])/1e4*u,d=-Math.round(1e4*o[c+2])/1e4*u;a+=`vn ${f} ${m} ${d}\n`}}if(e?.uvs){t=e.uvs;for(c=0;c<t.length;c+=2){var g=Math.round(1e4*t[c+0])/1e4,v=Math.round(1e4*t[c+1])/1e4;a+=`vt ${g} ${v}\n`}}return n.forEach(((e,r)=>{var t=r/1|0;a+=`f ${3*t+1}/${2*t+1}/${3*t+1} ${3*t+2}/${2*t+2}/${3*t+2} ${3*t+3}/${2*t+3}/${3*t+3}\n`})),a},P=e=>{if(e.preComputeNormalAssocs){console.log("downloading custom shape, detected preComputeNormalAssocs");var a=[]}for(var r=[],t=[],o=[],n=[],i=0;i<e.vertices.length;i++)r.push(Math.round(1e3*e.vertices[i])/1e3);for(i=0;i<e.uvs.length;i++)n.push(Math.round(1e3*e.uvs[i])/1e3);for(i=0;i<e.normals.length;i++)t.push(Math.round(1e3*e.normals[i])/1e3);for(i=0;i<e.normalVecs.length;i++)o.push(Math.round(1e3*e.normalVecs[i])/1e3);if(e.preComputeNormalAssocs)for(i=0;i<e.normalAssocs.length;i++)a.push(e.normalAssocs[i]);if(e.preComputeNormalAssocs)var s={vertices:r,uvs:n,normals:t,normalVecs:o,normalAssocs:a};else s={vertices:r,uvs:n,normals:t,normalVecs:o};var c=document.createElement("a");c.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s)),e.name||e.name,c.download=e.name+".json",c.click()},I=(e,a="downloaded_file")=>{var r=document.createElement("a");r.href=window.URL.createObjectURL(e),r.download=a,r.click(),window.URL.revokeObjectURL(e)},w=async(a,r)=>{var t,o,n,i,s,c,h,u,f,m,d,b,x,R,A,M,T,I,w,F,L;const C=a.gl;var U,k,z,S=!1,N=!1,O=!1,V=!1,D=0,X=0,H=0,ee=!1,ae=!1,oe=!1,ne=0,ie=0,se=0,ce=1,le=1,pe=1,he=1,ue=1,fe=0,me=0,de=!1,ge=16,ve=40,ye="",be="",xe=1,Re=!1,Ee=0,Ae=0,Me=3355443,Te=.1,_e=!1,Pe=-1,Ie=0,we=-1,Fe=!1,Le=!1,Ce=!1,Ue="",ke=!1,ze="",Se=1,Be=6e6,Ne=!1,Oe=-1,Ve=!0,De=8978210,Ye=!1,Xe=0,He=0,qe=0,Ge=0,We=!1,je=0,$e=1,Ke=!0,Ze="image",Qe=!1,Je=!1,ea=!1,aa=512,ra=512,ta=C.RGBA,oa=!1,na=512,ia=512,sa=C.RGBA,ca=1,la=1,pa=[],ha=[],ua={};Object.keys(r).forEach(((e,a)=>{if("showsource"===e.toLowerCase())Qe=!!r[e]})),Object.keys(r).forEach(((a,l)=>{switch(a.toLowerCase()){case"x":D=r[a];break;case"y":X=r[a];break;case"z":H=r[a];break;case"roll":ne=r[a];break;case"pitch":ie=r[a];break;case"yaw":se=r[a];break;case"shapetype":switch(A=r[a].toLowerCase()){case"sprite":Ue=`${e}/resources/sprite.png`;break;case"point light":Ue=Qe?`${e}/resources/stars/star.png`:""}break;case"size":xe=r[a];break;case"subs":Ee=r[a];break;case"equirectangular":Pe=!!r[a];break;case"equirectangularheightmap":we=!!r[a];break;case"flipnormals":Le=!!r[a];break;case"shownormals":Ce=!!r[a];break;case"sphereize":Ae=r[a];break;case"rotationmode":Ie=r[a];break;case"rebindtextures":de=!!r[a];break;case"flipx":ee=r[a];break;case"flipy":ae=r[a];break;case"flipz":oe=r[a];break;case"objx":t=r[a];break;case"objy":o=r[a];break;case"objz":n=r[a];break;case"objroll":i=r[a];break;case"objpitch":s=r[a];break;case"objyaw":c=r[a];break;case"scaleuvx":he=r[a];break;case"scaleuvy":ue=r[a];break;case"offsetuvx":fe=r[a];break;case"offsetuvy":me=r[a];break;case"scalex":ce=r[a];break;case"scaley":le=r[a];break;case"scalez":pe=r[a];break;case"wireframe":We=!!r[a];break;case"name":be=r[a];break;case"color":Me=r[a];break;case"colormix":Te=r[a];break;case"mapisdataarray":ea=!!r[a];break;case"dataarraywidth":aa=+r[a];break;case"dataarrayheight":ra=+r[a];break;case"dataarrayformat":ta=r[a];break;case"heightmapisdataarray":oa=!!r[a];break;case"heightmapdataarraywidth":na=+r[a];break;case"heightmapdataarrayheight":ia=+r[a];break;case"heightpamdataarrayformat":sa=r[a];break;case"exportshape":S=!!r[a];break;case"downloadshape":N=!!r[a];break;case"exportasobj":O=!!r[a];break;case"downloadasobj":V=!!r[a];break;case"penumbra":je=r[a];break;case"url":ye=r[a];break;case"map":Ue=r[a];break;case"heightmap":ze=r[a];break;case"heightmapintensity":Se=r[a];break;case"maxheightmap":Be=+r[a];break;case"heightmapiscanvas":Ne=!!r[a];break;case"rows":ge=r[a];break;case"cols":ve=r[a];break;case"disabledepthtest":Je=r[a];break;case"canvastexturemix":Oe=r[a];break;case"canvastexture":F=r[a],Ze="canvas";break;case"involvecache":Ke=!!r[a];break;case"muted":Ve=!!r[a];break;case"lum":ca=r[a];break;case"alpha":la=r[a];break;case"geometrydata":pa=r[a];break;case"precomputenormalassocs":Fe=!!r[a];break;case"texcoords":ha=r[a];break;case"boundingcolor":De=r[a];break;case"showbounding":Ye=!!r[a];break;case"issprite":Xe=r[a]?1:0;break;case"islight":He=r[a]?1:0;break;case"isparticle":qe=r[a]?1:0;break;case"isline":Ge=r[a]?1:0;break;case"playbackspeed":$e=r[a];break;case"averagenormals":Re=!!r[a];break;default:ua[a]=r[a]}})),void 0===t&&(t=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0!==r.canvasTexture?(-1==Oe&&(Oe=1),k=r.canvasTexture,delete r.canvasTexture):Oe=0,r.heightMapIsCanvas&&(z=r.heightMap,delete r.heightMap),r=structuredClone(r),void 0!==k&&(r.canvasTexture=k),void 0!==z&&(r.heightMap=z);var fa,ma,da=[],ga=[],va=[],ya=[],ba=!1;if(-1!=A.indexOf("custom shape")||ye&&"lines"==A)fa=ye,ma=`${A} ${be} (${ye})`;else if(ma=`${A}_${Ee}`,Ee<5&&ma)switch(ma){case"cylinder_0":case"cylinder_1":case"cylinder_2":case"cylinder_3":case"torus_0":case"torus knot_0":case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"tetrahedron_5":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"octahedron_5":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"cube_5":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"dodecahedron_5":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"icosahedron_5":if(Ae<0&&(Ae/=-1!=ma.indexOf("tetrahedron")?3:1,Ae/=-1!=ma.indexOf("octahedron")?2:1,Ae/=-1!=ma.indexOf("cube")?1.5:1),"torus_0"!=ma||16==ge&&40==ve||"torus_0"==ma&&16==ge&&40==ve||"torus knot_0"==ma&&16==ge&&40==ve)if(_e=!0,fa=`${ye=`${e}/new%20shapes/`}${ma}.json?3`,Ke&&(l=p.geometry.filter((e=>e.url==fa))).length)console.log(`found geometry (${ma}) in cache... using it`),void 0!==(xa=l[0].data).normalAssocs&&(L=xa.normalAssocs),va=new Float32Array(xa.vertices),ga=new Float32Array(xa.normals),ya=new Float32Array(xa.normalVecs),da=new Float32Array(xa.uvs),ba=!0,_e=!0;else await fetch(fa).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),va=e.vertices,ga=e.normals,ya=e.normalVecs.map((e=>-e)),da=e.uvs,p.geometry.push({data:structuredClone(e),url:fa})})),_e=!0}if(!_e)switch(A){case"custom shape":case"lines":if("lines"==A){if(!ye)break;Ge=!0}var xa;if(void 0===pa.vertices&&Ke&&(l=p.customShapes.filter((e=>e.url==ye))).length)console.log("found custom shape in cache... using it"),void 0!==(xa=l[0].data).normalAssocs&&(L=xa.normalAssocs),va=xa.vertices,ga=xa.normals,ya=xa.normalVecs,da=xa.uvs,_e=!0,ba=!0;_e||(void 0!==pa.vertices&&pa.vertices.length?(void 0!==pa.normalAssocs&&(L=pa.normalAssocs),va=pa.vertices,ga=pa.normals,ya=pa.normalVecs,da=pa.uvs,_e=!0):await fetch(fa).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(L=e.normalAssocs),va=e.vertices,ga=e.normals,ya=e.normalVecs,da=e.uvs,_e=!0,p.customShapes.push({data:structuredClone(e),url:ye})})))}if(_e)switch(A){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==Pe&&(Pe=!0),-1==we&&(we=!0)}else switch(A){case"tetrahedron":Ae/=Ae<0?3:1,-1==Pe&&(Pe=!0),-1==we&&(we=!0),(U=await j(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"octahedron":Ae/=Ae<0?2:1,-1==Pe&&(Pe=!0),-1==we&&(we=!0),(U=await $(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"icosahedron":-1==Pe&&(Pe=!0),-1==we&&(we=!0),(U=await K(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"torus":(U=await G(xe,Ee,Ae,Le,A,ge,ve)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"torus knot":(U=await W(xe,Ee,ge,ve,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"cylinder":(U=await q(xe,Ee,ge,ve,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"dynamic":(U=await Y(pa,ha,xe,Ee+1,Ae,Le,!!pa.filter((e=>4==e.length)).length,A)).geometry.map((e=>{va.push(...e.position),Le?ga.push(...e.normal.map((e=>-1*e))):ga.push(...e.normal),void 0!==e.texCoord&&e.texCoord.length&&da.push(...e.texCoord)}));break;case"lines":Ge=1,pa.map((e=>{va.push(...e)}));break;case"bspline":Ge=1,r.omitShape=!0,await te(a,r).then((e=>{e.curve.map((e=>{va.push(...e)}))}));break;case"curveto":Ge=1,r.omitShape=!0,await re(a,r).then((e=>{e.map((e=>{va.push(...e)}))}));break;case"cube":Ae/=Ae<0?1.5:1,(U=await Q(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"rectangle":(U=await J(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"sprite":Xe=!0,(U=await J(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"particles":qe=1,pa.map((e=>{va.push(...e)}));break;case"point light":He=!0,(U=Qe?await J(Math.max(xe,.5),Ee+1,Ae,Le,A):{geometry:[]}).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}));break;case"obj":if(pa.length){var Ra={vertices:[],normals:[],uvs:[]};g(pa,[],[],[],[],Ra),v(Ra),va=Ra.vertices,ga=Ra.normals,da=Ra.uvs,_e=!0}else U=await y(ye,0,0,0,0,0,0,0,c,!1),va=U.vertices,ga=U.normals,da=U.uvs;break;case"dodecahedron":-1==Pe&&(Pe=!0),-1==we&&(we=!0),(U=await Z(xe,Ee,Ae,Le,A)).geometry.map((e=>{va.push(...e.position),ga.push(...e.normal),da.push(...e.texCoord)}))}if(0!=fe||0!=me)for(var Ea=0;Ea<da.length;Ea+=2)da[Ea+0]+=fe,da[Ea+1]+=me;if(1!=he||1!=ue)for(Ea=0;Ea<da.length;Ea+=2)da[Ea+0]*=he,da[Ea+1]*=ue;if("lines"!=A&&"particles"!=A&&!qe&&"custom shape"!=A&&"obj"!=A&&"dynamic"!=A||1!=ce||1!=le||1!=pe){var Aa=Ae,Ma=1-Ae,Ta=-6e6;for(Ea=0;Ea<va.length;Ea+=3){var _a=va[Ea+0],Pa=va[Ea+1],Ia=va[Ea+2];(Fa=Math.hypot(_a,Pa,Ia))>Ta&&(Ta=Fa)}var wa=-6e6;for(Ea=0;Ea<va.length;Ea+=3){var Fa;_a=va[Ea+0]/Ta,Pa=va[Ea+1]/Ta,Ia=va[Ea+2]/Ta;_a/=Fa=Math.hypot(_a,Pa,Ia)+1e-4,Pa/=Fa,Ia/=Fa,_a*=Aa+Fa*Ma,Pa*=Aa+Fa*Ma,Ia*=Aa+Fa*Ma,va[Ea+0]=_a,va[Ea+1]=Pa,va[Ea+2]=Ia,(Fa=Math.hypot(_a,Pa,Ia))>wa&&(wa=Fa)}for(Ea=0;Ea<va.length;Ea+=3){va[Ea+0]/=wa,va[Ea+1]/=wa,va[Ea+2]/=wa,va[Ea+0]*=xe*ce,va[Ea+1]*=xe*le,va[Ea+2]*=xe*pe;var La=ga[2*Ea+0],Ca=ga[2*Ea+1],Ua=ga[2*Ea+2];ga[2*Ea+0]+=va[Ea+0]-La,ga[2*Ea+1]+=va[Ea+1]-Ca,ga[2*Ea+2]+=va[Ea+2]-Ua,ga[2*Ea+3]+=va[Ea+0]-La,ga[2*Ea+4]+=va[Ea+1]-Ca,ga[2*Ea+5]+=va[Ea+2]-Ua}}if(Re&&B(va,ga,A,ya,Le),"dynamic"==A||Fe){L=[];for(Ea=0;Ea<va.length;Ea+=3){for(var ka=va[Ea+0],za=va[Ea+1],Sa=va[Ea+2],Ba=[],Na=0;Na<va.length;Na+=3){var Oa=va[Na+0],Va=va[Na+1],Da=va[Na+2];Math.hypot(ka-Oa,za-Va,Sa-Da)<.001&&Ba.push(Na)}L.push(Ba)}}if(("custom shape"==A||"obj"==A)&&(s||i||c||t||o||n))for(Ea=0;Ea<va.length;Ea+=3){D=va[Ea+0],X=va[Ea+1],H=va[Ea+2];var Ya=E(D,X,H,{roll:i,pitch:s,yaw:c});if(va[Ea+0]=Ya[0]+t,va[Ea+1]=Ya[1]+o,va[Ea+2]=Ya[2]+n,ga.length){for(var Xa=2;Xa--;){D=ga[2*Ea+0+3*Xa],X=ga[2*Ea+1+3*Xa],H=ga[2*Ea+2+3*Xa];Ya=E(D,X,H,{roll:i,pitch:s,yaw:c});ga[2*Ea+0+3*Xa]=Ya[0]+t,ga[2*Ea+1+3*Xa]=Ya[1]+o,ga[2*Ea+2+3*Xa]=Ya[2]+n}D=ya[Ea+0],X=ya[Ea+1],H=ya[Ea+2];Ya=E(D,X,H,{roll:i,pitch:s,yaw:c});ya[Ea+0]=Ya[0],ya[Ea+1]=Ya[1],ya[Ea+2]=Ya[2]}}if(!(_e||"custom shape"==A||qe||Ge||Re||ba&&_e)){ya=[];for(Ea=0;Ea<ga.length;Ea+=6){let e=ga[Ea+3]-ga[Ea+0],a=ga[Ea+4]-ga[Ea+1],r=ga[Ea+5]-ga[Ea+2];ya.push(e,a,r)}}if(ee)for(Ea=0;Ea<va.length;Ea+=3)va[Ea+1]*=-1;if(ae)for(Ea=0;Ea<va.length;Ea+=3)va[Ea+1]*=-1;if(oe)for(Ea=0;Ea<va.length;Ea+=3)va[Ea+1]*=-1;if(Le&&!Re){for(Ea=0;Ea<ga.length;Ea+=6)ga[Ea+3]=ga[Ea+0]-(ga[Ea+3]-ga[Ea+0]),ga[Ea+4]=ga[Ea+1]-(ga[Ea+4]-ga[Ea+1]),ga[Ea+5]=ga[Ea+2]-(ga[Ea+5]-ga[Ea+2]);for(Ea=0;Ea<ya.length;Ea+=3)ya[Ea+0]*=-1,ya[Ea+1]*=-1,ya[Ea+2]*=-1}if(S){(qa=document.createElement("div")).style.position="fixed",qa.style.zIndex=1e5,qa.style.left="50%",qa.style.top="50%",qa.style.transform="translate(-50%, -50%)",qa.style.background="#0008",qa.style.padding="20px",qa.style.width="600px",qa.style.height="350px",qa.style.border="1px solid #fff4",qa.style.borderRadius="5px",qa.style.fontFamily="monospace",qa.style.fontSize="20px",qa.style.color="#fff",(Ga=document.createElement("div")).style.fontSize="24px",Ga.style.color="#0f8c",Ga.innerHTML=`Export Coordinates File -> ${A} `+(r?.name?`(${r.name})`:"")+"<br><br>",qa.appendChild(Ga),(Wa=document.createElement("div")).style.minWidth="100%",Wa.style.height="250px",Wa.style.background="#333",Wa.style.border="1px solid #fff4",Wa.style.overflowY="auto",Wa.style.wordWrap="break-word",Wa.style.color="#888",Wa.style.fontSize="10px",qa.appendChild(Wa),(ja=document.createElement("button")).style.border="none",ja.style.padding="3px",ja.style.cursor="pointer",ja.fontSize="20px",ja.style.borderRadius="10px",ja.style.margin="10px",ja.style.minWidth="100px",ja.innerHTML="ðŸ“‹ copy",ja.title="copy shape data to clipboard",ja.onclick=()=>{var e=document.createRange();e.selectNode(Wa),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),ja.innerHTML="COPIED!",setTimeout((()=>{ja.innerHTML="ðŸ“‹ copy"}),1e3)},qa.appendChild(ja),($a=document.createElement("button")).onclick=()=>qa.remove(),$a.style.border="none",$a.style.padding="3px",$a.style.cursor="pointer",$a.fontSize="20px",$a.style.borderRadius="10px",$a.style.margin="10px",$a.style.background="#faa",$a.style.minWidth="100px",$a.innerHTML="close",qa.appendChild($a);var Ha={vertices:[],normals:[],normalVecs:[],uvs:[]};va.map((e=>Ha.vertices.push(Math.round(1e3*e)/1e3))),ua.preComputeNormalAssocs&&(Ha.normalAssocs=[],ua.normalAssocs.map((e=>Ha.vertices.push(e))));for(Ea=0;Ea<ga.length;Ea+=6){ka=ga[Ea+0],za=ga[Ea+1],Sa=ga[Ea+2],Oa=Le?ga[Ea+0]-(ga[Ea+3]-ga[Ea+0]):ga[Ea+3],Va=Le?ga[Ea+1]-(ga[Ea+4]-ga[Ea+1]):ga[Ea+4],Da=Le?ga[Ea+2]-(ga[Ea+5]-ga[Ea+2]):ga[Ea+5];ka=Math.round(1e3*ka)/1e3,za=Math.round(1e3*za)/1e3,Sa=Math.round(1e3*Sa)/1e3,Oa=Math.round(1e3*Oa)/1e3,Va=Math.round(1e3*Va)/1e3,Da=Math.round(1e3*Da)/1e3,Ha.normals.push(ka,za,Sa,Oa,Va,Da)}for(Ea=0;Ea<ya.length;Ea++)Ha.normalVecs.push((Le?11:1)*Math.round(1e3*ya[Ea])/1e3);da.map((e=>Ha.uvs.push(Math.round(1e3*e)/1e3))),Wa.innerHTML=JSON.stringify(Ha),document.body.appendChild(qa)}if(O){var qa,Ga,Wa,ja,$a;(qa=document.createElement("div")).style.position="fixed",qa.style.zIndex=1e5,qa.style.left="50%",qa.style.top="50%",qa.style.transform="translate(-50%, -50%)",qa.style.background="#0008",qa.style.padding="20px",qa.style.width="600px",qa.style.height="350px",qa.style.border="1px solid #fff4",qa.style.borderRadius="5px",qa.style.fontFamily="monospace",qa.style.fontSize="20px",qa.style.color="#fff",(Ga=document.createElement("div")).style.fontSize="24px",Ga.style.color="#0f8c",Ga.innerHTML=`Export OBJ File -> ${A} `+(r?.name?`(${r.name})`:"")+"<br><br>",qa.appendChild(Ga),(Wa=document.createElement("div")).style.minWidth="100%",Wa.style.height="250px",Wa.style.background="#333",Wa.style.border="1px solid #fff4",Wa.style.overflowY="auto",Wa.style.wordWrap="break-word",Wa.style.color="#888",Wa.style.fontSize="10px",qa.appendChild(Wa),(ja=document.createElement("button")).style.border="none",ja.style.padding="3px",ja.style.cursor="pointer",ja.fontSize="20px",ja.style.borderRadius="10px",ja.style.margin="10px",ja.style.minWidth="100px",ja.innerHTML="ðŸ“‹ copy",ja.title="copy shape data to clipboard",ja.onclick=()=>{var e=document.createRange();e.selectNode(Wa),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),ja.innerHTML="COPIED!",setTimeout((()=>{ja.innerHTML="ðŸ“‹ copy"}),1e3)},qa.appendChild(ja),($a=document.createElement("button")).onclick=()=>qa.remove(),$a.style.border="none",$a.style.padding="3px",$a.style.cursor="pointer",$a.fontSize="20px",$a.style.borderRadius="10px",$a.style.margin="10px",$a.style.background="#faa",$a.style.minWidth="100px",$a.innerHTML="close",qa.appendChild($a);var Ka=_({vertices:va,normalVecs:ya,uvs:da,shapeType:A,averageNormals:Re});Ka=Ka.replaceAll("\n","<br>"),Wa.innerHTML=Ka,document.body.appendChild(qa)}ba||(va=new Float32Array(va),ga=new Float32Array(ga),ya=new Float32Array(ya),da=new Float32Array(da)),h=C.createBuffer(),C.bindBuffer(C.ARRAY_BUFFER,h),C.bufferData(C.ARRAY_BUFFER,va,C.STATIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,null),M=new Uint32Array(Array(va.length/3).fill().map(((e,a)=>a))),u=C.createBuffer(),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,u),C.bufferData(C.ELEMENT_ARRAY_BUFFER,M,C.STATIC_DRAW),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,null),d=C.createBuffer(),C.bindBuffer(C.ARRAY_BUFFER,d),C.bufferData(C.ARRAY_BUFFER,ya,C.STATIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,null),I=new Uint32Array(Array(ya.length/3).fill().map(((e,a)=>a))),b=C.createBuffer(),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,b),C.bufferData(C.ELEMENT_ARRAY_BUFFER,I,C.STATIC_DRAW),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,null),f=C.createBuffer(),C.bindBuffer(C.ARRAY_BUFFER,f),C.bufferData(C.ARRAY_BUFFER,ga,C.STATIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,null),T=new Uint32Array(Array(ga.length/3).fill().map(((e,a)=>a))),m=C.createBuffer(),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,m),C.bufferData(C.ELEMENT_ARRAY_BUFFER,T,C.STATIC_DRAW),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,null),x=C.createBuffer(),C.bindBuffer(C.ARRAY_BUFFER,x),C.bufferData(C.ARRAY_BUFFER,da,C.STATIC_DRAW),C.bindBuffer(C.ARRAY_BUFFER,null),w=new Uint32Array(Array(da.length/2).fill().map(((e,a)=>a))),R=C.createBuffer(),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,R),C.bufferData(C.ELEMENT_ARRAY_BUFFER,w,C.STATIC_DRAW),C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,null),-1==Pe&&(Pe=!1),-1==we&&(we=!1);var Za={x:D,y:X,z:H,rows:ge,cols:ve,roll:ne,pitch:ie,yaw:se,color:Me,colorMix:Te,size:xe,subs:Ee,name:be,url:ye,averageNormals:Re,showNormals:Ce,exportShape:S,downloadShape:N,shapeType:qe?"particles":Ge?"lines":A,normalAssocs:L,sphereize:Ae,equirectangular:Pe,flipNormals:Le,vertices:va,normals:ga,normalVecs:ya,uvs:da,vertex_buffer:h,Vertex_Index_Buffer:u,normal_buffer:f,Normal_Index_Buffer:m,muted:Ve,normalVec_buffer:d,NormalVec_Index_Buffer:b,nVecIndices:I,uv_buffer:x,UV_Index_Buffer:R,vIndices:M,nIndices:T,uvIndices:w,map:Ue,video:undefined,textureMode:Ze,isSprite:Xe,isLight:He,playbackSpeed:$e,disableDepthTest:Je,lum:ca,alpha:la,involveCache:Ke,renderer:a,isParticle:qe,isLine:Ge,penumbra:je,wireframe:We,canvasTexture:F,canvasTextureMix:Oe,showBounding:Ye,boundingColor:De,heightMap:ze,heightMapIntensity:Se,heightMapIsCanvas:Ne,equirectangularHeightmap:we,flipX:ee,flipY:ae,flipZ:oe,isFromZip:ke,rotationMode:Ie,mapIsDataArray:ea,dataArrayFormat:ta,maxHeightmap:Be,dataArrayWidth:aa,dataArrayHeight:ra,preComputeNormalAssocs:Fe,heightmapIsDataArray:oa,heightmapDataArrayFormat:sa,heightmapDataArrayWidth:na,heightmapDataArrayHeight:ia,rebindTextures:de,exportAsOBJ:O,downloadAsOBJ:V,resolved:_e};return Object.keys(Za).forEach(((e,a)=>{ua[e]=Za[e]})),"particles"==ua.shapeType||qe||"lines"==ua.shapeType||Ge?await a.alphaShader.ConnectGeometry(ua):("point light"!=A&&"sprite"!=A||(void 0===r.color&&(ua.color=11184810),"point light"==A&&(ua.pointLightID=a.pointLights.length,a.pointLights.push(ua))),await a.nullShader.ConnectGeometry(ua)),ua.downloadShape&&P(ua),ua.downloadAsOBJ&&(e=>{console.log(`downloading '${e.name?e.name:e.shapeType}' as OBJ file`);var a=document.createElement("a");a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(_(e)),a.download=(e.name?e.name:e.shapeType)+".obj",a.click()})(ua),ua},F=async(e="",a=!1,r=(()=>{}),t=400,o=300)=>{var n=document.createElement("div");n.className="genericPopup",n.style.position="fixed",n.style.zIndex=1e5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.background="#0008",n.style.padding="20px",n.style.width=`${t}px`,n.style.height=`${o}px`,n.style.border="1px solid #fff4",n.style.borderRadius="5px",n.style.fontFamily="monospace",n.style.fontSize="20px",n.style.color="#fff";var i=document.createElement("div");if(i.style.fontSize="24px",i.style.color="#0f8c",i.innerHTML=e,n.appendChild(i),a){var s=document.createElement("button");s.onclick=()=>{r(),n.remove()},s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="SURE!",n.appendChild(s)}var c=document.createElement("button");c.onclick=()=>n.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",n.appendChild(c),document.body.appendChild(n)},L=e=>{let a=e;if(!ee(e.width)||!ee(e.height)){let r,t,o=document.createElement("canvas"),n=o.getContext("2d",{imageSmoothingEnabled:!0}),i=8,s=0,c=6e6,l=Math.hypot(e.width,e.height);for(let e=0;e<16;e++)(r=Math.abs(s-l))<c&&(c=r,s=i*2**e,t=e);s-=i*2**(t-1),o.width=s,o.height=s,n.drawImage(e,0,0,o.width,o.height),a=new Image,a=o}return a},C=(e,a,r,t="image",o=-1,n={},i=!0)=>{let h;switch(t){case"canvas":case"heightImage":h=a;break;case"dataArray":h=n.map,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"heightmapDataArray":h=n.heightMap,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"video":i&&(l=p.texImages.filter((e=>e.url==n.map&&-1!=o&&e.tVal==o))).length?(console.log("found video texture in cache... using it"),h=l[0].texImage):(h=(e=>{if(void 0!==e){let a,r;if(s.width!=e.videoWidth||s.height!=e.videoHeight?(a=e.videoWidth,r=e.videoHeight):(a=s.width,r=s.height),!ee(a)||!ee(r)){let e,t,o=8,n=0,i=6e6,s=Math.hypot(a,r);for(let a=0;a<12;a++)(e=Math.abs(n-s))<i&&(i=e,n=o*2**a,t=a);n-=o*2**(t-1),n=Math.min(512,n),a=n/1,r=n/1}s.width==a&&s.width==r||(s.width=a,s.height=r),c.drawImage(e,0,0,a,r)}else s.width=1,s.height=1;return s})(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}));break;case"image":i&&(l=p.texImages.filter((e=>e.url==n.map))).length?(console.log("found image texture in cache... using it"),h=l[0].texImage):(h=L(a),-1==o&&p.texImages.push({url:n.map,tval:o,texImage:h}))}e.bindTexture(e.TEXTURE_2D,r),"dataArray"==t?void 0!==n.dataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.dataArrayFormat,n.dataArrayWidth,n.dataArrayHeight,0,n.dataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):"heightmapDataArray"==t?void 0!==n.heightmapDataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.heightmapDataArrayFormat,n.heightmapDataArrayWidth,n.heightmapDataArrayHeight,0,n.heightmapDataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(h)):void 0!==h&&h.width&&h.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},U=e=>{var a=e.vertices;e.preComputeNormalAssocs=!0,e.normalAssocs=[];for(var r=0;r<a.length;r+=3){for(var t=a[r+0],o=a[r+1],n=a[r+2],i=[],s=0;s<a.length;s+=3){var c=a[s+0],l=a[s+1],p=a[s+2];Math.hypot(t-c,o-l,n-p)<.001&&i.push(s)}e.normalAssocs.push(i)}},k=(e,a=!1,r=!1,t=!0,o=0,n=0,i=0)=>{for(var s,c,l,p,h,u,f,m,d,g,v=[],y=0;y<e.vertices.length;y+=9)s=e.vertices[y+0],c=e.vertices[y+1],l=e.vertices[y+2],p=e.vertices[y+3],h=e.vertices[y+4],u=e.vertices[y+5],f=e.vertices[y+6],m=e.vertices[y+7],d=e.vertices[y+8],g=se([[s,c,l],[p,h,u],[f,m,d]],t,o,n,i),v.push(g);var b=r?1:-1;if(v.map(((a,r)=>{for(var t=0;t<3;t++)e.normals[18*r+6*t+0]=e.vertices[9*r+3*t+0],e.normals[18*r+6*t+1]=e.vertices[9*r+3*t+1],e.normals[18*r+6*t+2]=e.vertices[9*r+3*t+2],e.normals[18*r+6*t+3]=e.vertices[9*r+3*t+0]+(a[3]-a[0])*b,e.normals[18*r+6*t+4]=e.vertices[9*r+3*t+1]+(a[4]-a[1])*b,e.normals[18*r+6*t+5]=e.vertices[9*r+3*t+2]+(a[5]-a[2])*b,e.normalVecs[9*r+3*t+0]=e.normals[18*r+6*t+3]-e.normals[18*r+6*t+0],e.normalVecs[9*r+3*t+1]=e.normals[18*r+6*t+4]-e.normals[18*r+6*t+1],e.normalVecs[9*r+3*t+2]=e.normals[18*r+6*t+5]-e.normals[18*r+6*t+2]})),a){(void 0===e.normalAssocs||e.normalAssocs.length!=e.vertices.length/3|0)&&(console.log("generating normal assocs"),U(e));var x=structuredClone(e.normalVecs);for(y=0;y<e.normalVecs.length;y+=3){var R=y/3,E=[0,0,0];e.normalAssocs[R].forEach((e=>{0;for(var a=0;a<3;a++)E[a]+=x[e+a]}));for(var A=0;A<3;A++)e.normalVecs[y+A]=E[A]/=3,e.normals[2*y+A]=e.vertices[y+A],e.normals[2*y+A+3]=e.vertices[y+A]+E[A]}}},z=(e,a,r,n,i,s=0,c=0,l=0,p=0,h=0,u=!1,f=!0,m=0)=>{var d,g,v,y;if(a*=-1,n.heightMap&&_e.length){var b;if(n.equirectangularHeightmap){var x,E=e,M=a,T=r,_=Math.hypot(E,M,T);b=[S=(x=Math.atan2(E,T))/Math.PI/2,N=Math.acos(M/(Math.hypot(E,M,T)+1e-5))/Math.PI]}else b=[p,h];var P=4*((Pe.width*b[0]|0)+(Pe.height*Pe.width*b[1]|0)),I=_e[P+0]/256,w=_e[P+1]/256,F=_e[P+2]/256,L=Math.min(n.maxHeightmap,(I+w+F)/3*n.heightMapIntensity/2);e+=s*L,a+=c*L,r+=l*L}e=(y=R(e,a*=-1,r,{roll:1e-4-n.roll,pitch:-n.pitch,yaw:n.yaw},!1))[0],a=y[1],r=y[2],n.isLight&&(e=(y=A(e,a,r,{roll:i.roll,pitch:i.pitch,yaw:-i.yaw},!1))[0],a=y[1],r=y[2]);var C=i.x,U=-i.y,k=i.z;e+=n.x,a+=n.y,r+=n.z,"fps"==i.cameraMode.toLowerCase()?(e=(y=R(e+=C,a+=U,r+=k,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],r=y[2],C=0,U=0,k=0):(e=(y=R(e,a,r,{roll:-i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=y[1],r=y[2]);var z=!1;if(u){d=e+C,g=a-U,v=r+k;var S,B;_=Math.hypot(d,g,v);f?S=Math.atan2(d,v)/Math.PI:0==m?(x=Math.atan2(d,v)+Math.PI/2,B=Math.hypot(d,v),d=t(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)<=-1,S+=.5):(x=Math.atan2(d,v)-Math.PI/2,B=Math.hypot(d,v),d=t(x)*B,v=o(x)*B,z=(S=(Math.atan2(d,v)/Math.PI+2)%2-1)>=1,S-=.5);var N=-(Math.acos(g/(_+1e-4))/Math.PI*2-1);return!z&&[i.width/2+S*i.width/2,i.height/2+N*i.height/2,_]}e+=C,a-=U,r-=k;var O=i.fov;return(v=r+(k/1e3*O+k))>0&&[d=i.width/2+e/v*O/2,g=i.height/2+a/v*O/2,v]},S=(e,a,r=!0,t=-1,o=!0,n=0)=>{if(-1==t&&(t=a.equirectangularPlugin),e.isLight)return[];var i,s,c,l,p,h=[],u=[];const f=(e,a,t=-1,o=9)=>{t!=a&&(t=a,h.push(a),A=e[a][0],M=e[a][1],l=p=-9,e.map(((r,t)=>{t!=a&&(T=e[t][0],_=e[t][1],(d=Math.atan2(_-M-1e-5,A-T))>=l&&d<=o&&(l=d,p=t))})),-9!=p&&(r&&u.push(...e[p]),f(e,p,t,l)))};var m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w=[],F=-1,L=1e6,C=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(Pe.width=C.heightResource.videoWidth/2,Pe.height=C.heightResource.videoHeight/2):(Pe.width=C.heightResource.width/2,Pe.height=C.heightResource.height/2),Ie.drawImage(C.heightResource,0,0,Pe.width,Pe.height),_e=Pe.width?Ie.getImageData(0,0,Pe.width,Pe.height).data:[]);for(var U=0;U<e.vertices.length;U+=3){(!e.isLine||U%2)&&(e.isLine||!e.isParticle&&U%9)||(g=v=0,m=[]),i=e.vertices[U+0],s=e.vertices[U+1],c=e.vertices[U+2],y=U+0<e.normalVecs.length?e.normalVecs[U+0]:0,b=U+1<e.normalVecs.length?e.normalVecs[U+1]:0,x=U+2<e.normalVecs.length?e.normalVecs[U+2]:0;var k=2*(U/3|0);R=k+0<e.uvs.length?e.uvs[k+0]:0,E=k+1<e.uvs.length?e.uvs[k+1]:0;var S=z(i,s,c,e,a,y,b,x,R,E,t,o,n);S&&(m.push([S[0],S[1]]),g+=S[0],v+=S[1],(e.isLine&&U%9==3||!e.isLine&&(e.isParticle||U%9==6))&&(g/=3,v/=3,Math.hypot(g-F,v-L)>10&&(F=g,L=v,w.push(m))))}e.isParticle||e.isLine?(m=[],w.map(((e,a)=>{A=e[0][0],M=e[0][1],m.filter((e=>e[0]==A&&e[1]==M)).length||m.push([A,M])}))):(m=[],w.map(((e,a)=>{e.length>2&&(A=e[0][0],M=e[0][1],T=e[1][0],_=e[1][1],P=e[2][0],I=e[2][1],m.filter((e=>e[0]==A&&e[1]==M)).length||m.push([A,M]),m.filter((e=>e[0]==T&&e[1]==_)).length||m.push([T,_]),m.filter((e=>e[0]==P&&e[1]==I)).length||m.push([P,I]))})));var B,N=6e6,O=-1;if(m.map(((e,a)=>{e[1]<=N&&(O=a,N=e[1])})),m.length&&(f(m,O),r)){var V=be(e.boundingColor);Te.ctx.strokeStyle=`rgba(${256*V[0]},${256*V[1]},${256*V[2]},.5)`,Te.ctx.globalAlpha=1,Te.ctx.beginPath(),u.map(((e,a)=>{Te.ctx.lineWidth=10;var r=u[a][0],t=u[a][1],i=u[B=(a+1)%u.length][0],s=u[B][1];o?(Te.ctx.moveTo(r,t),Te.ctx.lineTo(i,s)):0==n?r>=Te.width/2-Te.width/8&&r<Te.width+Te.width/8&&i>=Te.width/2-Te.width/8&&i<Te.width+Te.width/8&&(Te.ctx.moveTo(r,t),Te.ctx.lineTo(i,s)):r<=Te.width/2+Te.width/8&&r>-Te.width/8&&i<=Te.width/2+Te.width/8&&i>-Te.width/8&&(Te.ctx.moveTo(r,t),Te.ctx.lineTo(i,s))})),Te.ctx.stroke()}return h.map((e=>[m[e][0],m[e][1]]))},B=(e,a,r,t,o)=>{for(var n,i=[],s=D(r),c=o?-1:1,l=0;l<e.length;l+=3)l%9||(n=se([[e[l+0],e[l+1],e[l+2]],[e[l+3],e[l+4],e[l+5]],[e[l+6],e[l+7],e[l+8]]],s)),i[2*l+0]=e[l+0],i[2*l+1]=e[l+1],i[2*l+2]=e[l+2],i[2*l+3]=e[l+0]-(n[3]-n[0])*c,i[2*l+4]=e[l+1]-(n[4]-n[1])*c,i[2*l+5]=e[l+2]-(n[5]-n[2])*c;var p,h,u,f,m,d,g,v,y,b,x,R,E,A=structuredClone(i);for(l=0;l<i.length;l+=6){m=i[l+0],d=i[l+1],g=i[l+2],h=i[l+3],u=i[l+4],f=i[l+5],p=1;for(var M=0;M<i.length;M+=6)M!=l&&(v=i[M+0],y=i[M+1],b=i[M+2],x=i[M+3],R=i[M+4],E=i[M+5],Math.hypot(m-v,d-y,g-b)<.01&&(h+=x,u+=R,f+=E,p++));A[l+3]=h/=p,A[l+4]=u/=p,A[l+5]=f/=p}A.map(((e,a)=>i[a]=e));var T="cylinder"==r||"torus"==r||"torus knot"==r?-1:1;for(l=0;l<i.length;l+=6)for(var _=3;_--;)a[l+2*_]=i[l+2*_],a[l+2*_+1]=i[l+2*_]-(i[l+2*_]+i[l+2*_+1])*c,t[l/2+_]=(i[l+3+_]-i[l+_])*c*T},N=async(e,a=[])=>{const r=e.gl;var t={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};await a.map((a=>{Object.keys(a).forEach(((r,o)=>{switch(r.toLowerCase()){case"lighting":if("ambientlight"===a[r].type.toLowerCase())if(void 0===a[r]?.enabled||a[r].enabled){var n={name:a[r].type,value:void 0===a[r].value?e.ambientLight:a[r].value};t.optionalLighting.push(n)}break;case"uniform":switch(a[r].type.toLowerCase()){case"custom":if(void 0===a[r]?.enabled||a[r].enabled){var i={name:a[r].type,playbackSpeed:void 0===a[r].playbackSpeed?1:a[r].playbackSpeed,uniformName:void 0===a[r].name?"":a[r].name,involveCache:void 0===a[r].involveCache||a[r].involveCache,muted:void 0===a[r].muted||a[r].muted,map:a[r].map,loc:"",value:void 0===a[r].value?0:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flipReflections:void 0===a[r].flipReflections?0:a[r].flipReflections,flipRefractions:void 0===a[r].flipRefractions?0:a[r].flipRefractions,dataType:void 0===a[r].dataType?"uniform1f":a[r].dataType,vertDeclaration:void 0===a[r].vertDeclaration?"":a[r].vertDeclaration,vertCode:void 0===a[r].vertCode?"":a[r].vertCode,fragDeclaration:void 0===a[r].fragDeclaration?"":a[r].fragDeclaration,fragCode:void 0===a[r].fragCode?"":a[r].fragCode};t.optionalUniforms.push(i)}break;case"fog":if(void 0===a[r]?.enabled||a[r].enabled){i={name:a[r].type,loc:"",value:void 0===a[r].value?.5:a[r].value,color:void 0===a[r].color?8947848:a[r].color,dataType:"uniform1f",vertDeclaration:"",vertCode:"",fragDeclaration:"",fragCode:""};e.clearColor=i.color,e.hasFog=!0,t.optionalUniforms.push(i)}break;case"reflection":if(void 0===a[r]?.enabled||a[r].enabled){i={name:a[r].type,playbackSpeed:void 0===a[r].playbackSpeed?1:a[r].playbackSpeed,involveCache:void 0===a[r].involveCache||a[r].involveCache,muted:void 0===a[r].muted||a[r].muted,map:a[r].map,loc:"",value:void 0===a[r].value?.5:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flipReflections:void 0===a[r].flipReflections?0:a[r].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:" \n                  ",fragDeclaration:"\n                    uniform float reflection;\n                    uniform float refFlatShading;\n                    uniform float refOmitEquirectangular;\n                    uniform float refFlipRefs;\n                    uniform sampler2D reflectionMap;\n                  ",fragCode:"\n                    //light.rgb *= .5;\n                    //light.rgb += .05;\n                    float refP1, refP2;\n                    if(refOmitEquirectangular != 1.0){\n                      vec3 reflectionPos = R_rpy(nV, vec3(0.0,\n                                                      -camOri.y, -camOri.z));\n                      float px = reflectionPos.x;\n                      float py = reflectionPos.y;\n                      float pz = reflectionPos.z;\n                      refP1 = -atan(px, pz) / M_PI / 4.0;\n                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refFlipRefs == 1.0) refP2 = 1.0 - refP2;\n                    } else {\n                      refP1 = vUv.x;\n                      refP2 = vUv.y;\n                    }\n                    \n                    vec2 refCoords = vec2(1.0 - refP1 * 2.0, refP2);\n                    vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 1.0);\n                    mixColor = merge(mixColor, refCol);\n                    baseColorIp = 1.0 - reflection; //min(1.0, 2.0 - reflection);\n                    //light += reflection / 4.0;\n                  "};t.optionalUniforms.push(i)}break;case"refraction":if(void 0===a[r]?.enabled||a[r].enabled){i={name:a[r].type,playbackSpeed:void 0===a[r].playbackSpeed?1:a[r].playbackSpeed,involveCache:void 0===a[r].involveCache||a[r].involveCache,angleOfRefraction:void 0===a[r].angleOfRefraction?1:a[r].angleOfRefraction,muted:void 0===a[r].muted||a[r].muted,map:a[r].map,loc:"",value:void 0===a[r].value?.5:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flipRefractions:void 0===a[r].flipRefractions?0:a[r].flipRefractions,flatShadingUniform:"refractionFlatShading",dataType:"uniform1f",vertDeclaration:"\n                    attribute vec3 nVecRefraction;\n                    varying vec3 nVrefraction;\n                  ",vertCode:"\n                    vec3 nVrefraction = nVecRefraction;\n                  ",fragDeclaration:"\n                    uniform float refraction;\n                    uniform float refractionFlatShading;\n                    uniform float refractionOmitEquirectangular;\n                    uniform float refractionFlipRefs;\n                    uniform float angleOfRefraction;\n                    uniform sampler2D refractionMap;\n                    varying vec3 nVrefraction;\n                  ",fragCode:"\n                    float refractionP1, refractionP2;\n                    float refractionP1a, refractionP2a;\n                    float refractionP1b, refractionP2b;\n                    if(refractionOmitEquirectangular != 1.0){\n\n                      vec3 refractionPos = R_rpy(nV, vec3(0.0,-camOri.y, -camOri.z));\n\n                      float px = refractionPos.x;\n                      float py = refractionPos.y;\n                      float pz = refractionPos.z;\n                      refractionP1a = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2a = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2a = 1.0 - refractionP2a;\n\n                      refractionPos = R_rpy(nVrefraction, vec3(0.0,-camOri.y, -camOri.z));\n                      px = refractionPos.x;\n                      py = refractionPos.y;\n                      pz = refractionPos.z;\n                      refractionP1b = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2b = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2b = 1.0 - refractionP2b;\n\n                      //refractionP1a *= 0.0; //angleOfRefraction;\n                      //refractionP2a *= 1.0; //angleOfRefraction;\n                      //refractionP1 = (refractionP1a + refractionP1b) / 2.0;\n                      //refractionP2 = (refractionP2a + refractionP2b) / 2.0;\n\n                      refractionP1 = refractionP1b;\n                      refractionP2 = refractionP2b;\n\n                    } else {\n                      refractionP1a = vUv.x;\n                      refractionP2a = vUv.y;\n                    }\n                    \n                    vec2 refractionCoords = vec2(1.0 - refractionP1 * 2.0, refractionP2);\n                    vec4 refractionCol = vec4(texture2D(refractionMap, vec2(refractionCoords.x, refractionCoords.y)).rgb * 1.25, refraction / 1.0);\n                    mixColor2 = merge(mixColor2, refractionCol);\n                    baseColorIp2 = 1.0 - refraction;\n                    //light += refraction / 4.0;\n                  "};t.optionalUniforms.push(i)}break;case"phong":if(void 0===a[r]?.enabled||a[r].enabled){i={name:a[r].type,loc:"",value:void 0===a[r].value?.3:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[r].theta?.5:a[r].theta,dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:"\n                    hasPhong = 1.0;\n                  ",fragDeclaration:"\n                    uniform float phong;\n                    uniform float phongTheta;\n                    uniform float phongFlatShading;\n                  ",fragCode:"\n                    if(isLight == 0.0 &&\n                       isSprite == 0.0 &&\n                       isParticle == 0.0 &&\n                       isLine == 0.0){\n                      //light.rgb *= .5;\n                      float phongP1, phongP2;\n                      float px, py, pz;\n                      if(phongFlatShading != 0.0){\n                        px = nVec.x;\n                        py = nVec.y;\n                        pz = nVec.z;\n                      }else{\n                        vec3 phongPos = R_rpy(nV, vec3(camOri.x, 0.0, 0.0));\n                        px = phongPos.x;\n                        py = phongPos.y;\n                        pz = phongPos.z;\n                      }\n\n                      phongP1 = atan(px, pz) + phongTheta;\n                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)))-.2;\n                      \n                      //if(refFlipRefs == 1.0) phongP2 = M_PI - phongP2;\n\n                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong +\n                      pow(pow((1.0+cos(phongP1 + M_PI)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong;\n                      light = vec4(light.rgb + fact, 1.0) * 15.0;\n                    }\n                  "};t.optionalUniforms.push(i)}}}}))}));let o={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){r.enable(r.DEPTH_TEST),r.cullFace(r.BACK),e.alpha&&(r.blendFunc(r.SRC_ALPHA,r.ONE),r.enable(r.BLEND),r.disable(r.DEPTH_TEST));let a="";t.optionalUniforms.map((e=>{a+="\n"+e.vertDeclaration+"\n"}));let n="";t.optionalUniforms.map((e=>{n+="\n"+e.vertCode+"\n"}));let s="";t.optionalUniforms.map((e=>{s+="\n"+e.fragDeclaration+"\n"}));let c="";t.optionalUniforms.map((e=>{c+="\n"+e.fragCode+"\n"})),o.vert=`\n      precision highp float;\n      #define M_PI 3.14159265358979323\n      attribute vec2 uv;\n      ${a}\n      \n      uniform float t;\n      uniform vec3 color;\n      uniform float factor;\n      uniform float flatShading;\n      uniform float ambientLight;\n      uniform float plugin;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      uniform int rotationMode;\n      uniform float omitSplitCheck;\n      uniform float splitCheckPass;\n      uniform float pointSize;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float cameraMode;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float penumbraPass;\n      uniform float fov;\n      uniform float equirectangular;\n      uniform float maxHeightmap;\n      uniform float equirectangularHeightmap;\n      uniform float renderNormals;\n      uniform vec2 resolution;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform sampler2D heightMap;\n      attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec3 normalVec;\n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      \n      vec3 pFunc(vec3 pt, float cosa, float sina,\n                          float cosb, float sinb,\n                          float cosc, float sinc){\n        float xx, xy, xz, yx, yy, yz, zx, zy, zz;\n        xx = cosa*cosb;\n        xy = cosa*sinb*sinc - sina*cosc;\n        xz = cosa*sinb*cosc + sina*sinc;\n        yx = sina*cosb;\n        yy = sina*sinb*sinc + cosa*cosc;\n        yz = sina*sinb*cosc - cosa*sinc;\n        zx = -sinb;\n        zy = cosb*sinc;\n        zz = cosb*cosc;\n        return vec3(xx*pt.x + xy*pt.y + xz*pt.z,\n                    yx*pt.x + yy*pt.y + yz*pt.z,\n                    zx*pt.x + zy*pt.y + zz*pt.z);\n      }\n      vec3 Quat(vec3 pos, vec3 rot, int isGeo){\n        \n        if(isLine != 0.0) return pos;\n        float cosa, sina, cosb, sinb, cosc, sinc;\n        vec3 ret = vec3(pos.x, pos.y, pos.z);\n        if(rotationMode == 0 || isGeo == 0){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 1 && isGeo == 1){\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 2 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 3 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        return ret;\n      }\n      \n      vec3 R(vec3 pos, vec3 rot, int isGeo){\n        if(isLine != 0.0) return pos;\n        \n        float p, d;\n        if(rotationMode == 0 || isGeo == 0) {\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 1 && isGeo == 1) {\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 2 && isGeo == 1) {\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n        }\n        return pos;\n      }\n      \n      void main(){\n        \n        hasPhong = 0.0;\n        \n        float cx, cy, cz;\n        \n        if(renderNormals == 1.0){\n          cx = normal.x;\n          cy = normal.y;\n          cz = normal.z;\n        }else{\n          cx = position.x;\n          cy = position.y;\n          cz = position.z;\n        }\n        \n        if(useHeightMap != 0.0 && renderNormals == 0.0){\n          nVeci = normalVec;\n          vec4 h;\n          float lum;\n\n          if(equirectangularHeightmap != 0.0){\n            float p;\n            float p2;\n            vec3 cpos = vec3(cx, cy, cz);\n            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);\n            float p1;\n            p1 = p / M_PI / 2.0;\n            p2 = flatShading == 1.0 ?\n                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :\n                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n            uvi = vec2(p1, p2);\n          } else {\n            uvi = uv;\n          }\n\n            \n          h = texture2D( heightMap, uvi);\n          lum = min(maxHeightmap, ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0);\n          cx += normalVec.x * lum;\n          cy += normalVec.y * lum;\n          cz += normalVec.z * lum;\n\n          \n        }else{\n          uvi = uv / 2.0;\n          uvi = vec2(uvi.x, .5 - uvi.y);\n          nVeci = normalVec;\n        }\n        \n        fPosi = vec3(cx, cy, cz);\n        \n        // camera rotation\n        \n        vec3 geo, pos;\n        float cpx = camPos.x;\n        float cpy = camPos.y;\n        float cpz = camPos.z;\n        \n        if(cameraMode == 1.0){  // 'FPS' mode\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos,  vec3(0.0, camOri.y, 0.0), 0);\n            pos = Quat(pos,  vec3(0.0, 0.0, camOri.z), 0);\n            pos = Quat(pos,  vec3(camOri.x, 0.0, 0.0), 0);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = Quat(vec3(cx, cy, cz), vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n          }\n          cpx = 0.0;\n          cpy = 0.0;\n          cpz = 0.0;\n          fPos = pos;\n        }else{\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos = Quat(pos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            \n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }\n          fPos = pos;\n        }\n        \n        ${n}\n        \n        float camz = cpz / 1e3 * fov;\n        \n        float X, Y;\n        float Z = pos.z + camz + geo.z;\n        if((isLine != 0.0 || isParticle != 0.0) &&\n          penumbraPass != 0.0) Z += .001;\n        if(isLine != 0.0){\n          X = position.x / resolution.x * fov;\n          Y = position.y / resolution.y * fov;\n          Z = position.z;\n          gl_Position = vec4(X, Y, Z/100000.0, 1.0);\n          depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n          skip = 0.0;\n          vUv = uv;\n        }else{\n          if( plugin ==  1.0 ){   // equirectangular post-processing plugin\n            X = pos.x + cpx + geo.x;\n            Y = pos.y + cpy + geo.y;\n            Z = pos.z + cpz + geo.z;\n            float dist = sqrt(X*X + Y*Y + Z*Z);\n            float p1;\n            if(omitSplitCheck == 0.0){\n              if(splitCheckPass == 0.0){\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 <= -0.75 ? 1.0 : 0.0;\n                p1 += .5;\n              }else{\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 >= 0.75 ? 1.0 : 0.0;\n                p1 -= .5;\n              }\n            }else{\n              skip = 0.0;\n              p1 = atan(X, Z) / M_PI;\n            }\n            if(skip == 0.0){\n              float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;\n              gl_PointSize = 100.0 * pointSize / dist;\n              gl_Position = vec4(p1, p2, dist/100000.0, 1.0);\n              vUv = uv;\n            }\n          } else {  // default projection\n            X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;\n            Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;\n            if(Z > 0.0) {\n              gl_PointSize = 100.0 * pointSize / Z;\n              gl_Position = vec4(X, Y, Z/100000.0, 1.0);\n              depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n              skip = 0.0;\n              vUv = uv;\n            }else{\n              skip = 1.0;\n            }\n          }\n        }\n      }\n    `,o.frag=`\n      #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n      #else\n        precision mediump float;\n      #endif\n      #define M_PI 3.14159265358979323\n      ${s}\n      uniform float t;\n      uniform float factor;\n      uniform vec2 resolution;\n      uniform float plugin;\n      uniform float flatShading;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float cameraMode;\n      uniform vec4 pointLightPos[16];\n      uniform vec4 pointLightCol[16];\n      uniform int pointLightCount;\n      uniform float ambientLight;\n      uniform float renderNormals;\n      uniform float equirectangular;\n      uniform float equirectangularHeightmap;\n      uniform float colorMix;\n      //uniform float penumbraPass;\n      uniform vec3 color;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform float maxHeightmap;\n      uniform sampler2D heightMap;\n      uniform sampler2D baseTexture;\n      uniform sampler2D supplementalTexture;\n      uniform float supplementalTextureMix;\n      uniform float alpha;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      \n        // fog //\n      uniform vec3 fogColor;\n      uniform float fog;\n        /////////\n        \n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      vec3 rgeoPos;\n      float rheightMapIntensity;\n      float rmaxHeightmap;\n\n      vec4 merge (vec4 col1, vec4 col2){\n        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);\n      }\n      \n      vec2 Coords(float flatShading, vec3 nV) {\n        vec2 ret;\n        if(equirectangular == 1.0){\n          float p;\n          float p2;\n          vec3 cpos = fPosi;\n          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n          float p1;\n          p1 = p / M_PI / 2.0;\n          p2 = flatShading == 1.0 ?\n                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n          ret = vec2(p1, p2);\n        }else{\n          ret = vUv;\n        }\n        return ret;\n      }\n\n      vec3 R_ypr(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_yrp(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_rpy(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec4 GetPointLight(){\n        \n        float ret = 0.0;\n        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);\n        for(int i=0; i < 16; i++){\n          //if(i >= pointLightCount) break;\n          vec3 lpos = pointLightPos[i].xyz;\n          lpos.x -= rgeoPos.x; //- camPos.x;\n          lpos.y -= rgeoPos.y; //- camPos.y;\n          lpos.z -= rgeoPos.z; //- camPos.z;\n          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));\n\n          float mag = pointLightPos[i].w;\n          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +\n          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 20.0;\n          \n          rgba.r += ret * pointLightCol[i].r;\n          rgba.g += ret * pointLightCol[i].g;\n          rgba.b += ret * pointLightCol[i].b;\n        }\n        \n        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);\n      }\n\n      void main() {\n\n        rgeoPos = geoPos / factor;\n        rheightMapIntensity = heightMapIntensity / factor;\n        rmaxHeightmap = maxHeightmap / factor;\n\n\n        if(isParticle != 0.0 || isLine != 0.0){\n          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));\n        }else{\n          float mixColorIp = colorMix;\n          float mixColorIp2 = 1.0;\n          float baseColorIp = 1.0 - mixColorIp;\n          float baseColorIp2 = 1.0 - mixColorIp2;\n          vec4 mixColor = vec4(color.rgb, mixColorIp);\n          vec4 mixColor2 = vec4(color.rgb, mixColorIp2);\n          vec4 light = hasPhong == 1.0 ? GetPointLight() :\n                vec4(ambientLight, ambientLight, ambientLight, 1.0);\n          float colorMag = 1.0;\n          if(skip != 1.0){\n            if(renderNormals == 1.0){\n              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }else{\n              float p;\n              vec3 nV, nVi;\n              if(useHeightMap != 0.0){\n                \n                float rad = .02;\n                float rad2 = -.25;\n                vec2 cr1, cr2, cr3;\n                float lum1, lum2, lum3;\n                for(float j=0.0; j<3.0; j+=1.0){\n                  \n                  float tx, ty;\n                  p = M_PI * 2.0 / 3.0 * j;\n                  tx = -sin(p) * rad;\n                  ty = -cos(p) * rad;\n                \n                  vec2 hcoords;\n                  if(equirectangularHeightmap == 1.0){\n                    float p;\n                    float p2;\n                    vec3 cpos = fPosi;\n                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n                    float p1;\n                    p1 = p / M_PI / 2.0;\n                    p2 = flatShading == 1.0 ?\n                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n                    tx += p1;\n                    ty += p2;\n                    hcoords = vec2(tx, ty);\n                  }else{\n                    hcoords = vUv + vec2(tx, ty);\n                  }\n                  \n                  vec4 htexel = texture2D( heightMap, hcoords);\n                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;\n                  if(j == 0.0) {\n                    lum1 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 1.0) {\n                    lum2 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 2.0) {\n                    lum3 = lum;\n                    cr2 = hcoords;\n                  }\n                }\n\n                float a1 = cr1.x;\n                float a2 = cr1.y;\n                float a3 = (lum1 - 0.5) * rad2;\n                \n                float b1 = cr2.x - a1;\n                float b2 = cr2.y - a2;\n                float b3 = (lum2 - 0.5) * rad2 - a3;\n                float c1 = cr3.x - cr2.x;\n                float c2 = cr3.y - cr2.y;\n                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;\n                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * min(maxHeightmap / 5.0, (1.0 + heightMapIntensity) / 2.0);\n                nV = normalize( nVec + anorm);\n                nVi = normalize( nVeci + anorm);\n              }else{\n                nV = nVec;\n                nVi = nVeci;\n              }\n              \n              \n              ${c}\n              vec2 coords = Coords(0.0, nVi);\n              vec4 texel = texture2D( baseTexture, coords);\n              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));\n              float fv;\n              if(isSprite != 0.0 || isLight != 0.0){\n                if(fog != 0.0){\n                  vec4 preFog = vec4(texel.rgb * 3.0, texel.a);\n                  fv = min(1.0, depth * fog) * min(alpha * 2.0, 1.0);\n                  gl_FragColor = merge(vec4(preFog.rgb, (1.0 - fv)), vec4(fogColor.rgb, 0.0));\n                }else{\n                  gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);\n                }\n              }else{\n                \n                texel.a = baseColorIp / 2.0;\n                vec4 col = merge(mixColor, texel);\n                col.a = 1.0;\n                if(baseColorIp2 != 0.0){\n                  mixColor2.a = baseColorIp2;\n                  col = merge(mixColor2, col); // refractions\n                }\n                col.rgb *= light.rgb;\n                \n                \n                if(fog != 0.0){\n                  vec4 preFog = vec4(col.rgb * colorMag, 1.0);\n                  fv = min(1.0, depth * fog);\n                  gl_FragColor = merge(vec4(preFog.rgb, 1.0 - fv), vec4(fogColor.rgb, fv));\n                }else{\n                  gl_FragColor = vec4(col.rgb * colorMag, 1.0);\n                }\n              }\n            }\n          }\n        }\n      }\n    `;const h=r.createShader(r.VERTEX_SHADER);r.shaderSource(h,o.vert),r.compileShader(h);const u=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(u,o.frag),r.compileShader(u),o.ConnectGeometry=(a,n=!1)=>{var s=a.involveCache,c=structuredClone(t);o.datasets.push(c),c.program=r.createProgram(),r.attachShader(c.program,h),r.attachShader(c.program,u),r.linkProgram(c.program),a.shader=o;var f=a.map,m=a.heightMap;if(a.datasetIdx=o.datasets.length-1,r.getProgramParameter(c.program,r.LINK_STATUS)){if(r.useProgram(c.program),r.bindBuffer(r.ARRAY_BUFFER,a.vertex_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=r.getAttribLocation(c.program,"position"),r.vertexAttribPointer(c.locPosition,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(c.locPosition),r.bindBuffer(r.ARRAY_BUFFER,a.uv_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=r.getAttribLocation(c.program,"uv"),r.vertexAttribPointer(c.locUv,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(c.locUv),r.bindBuffer(r.ARRAY_BUFFER,a.normal_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=r.getAttribLocation(c.program,"normal"),r.vertexAttribPointer(c.locNormal,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(c.locNormal),r.bindBuffer(r.ARRAY_BUFFER,a.normalVec_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=r.getAttribLocation(c.program,"normalVec"),r.vertexAttribPointer(c.locNormalVec,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(c.locNormalVec),!n){if(a.isLight||c.optionalUniforms.map((async e=>{switch(e.name){case"fog":break;case"reflection":if(n=e.map){let a,c=(a=n.split("."))[a.length-1].toLowerCase();switch(e.refTexture=r.createTexture(),c){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},r.activeTexture(r.TEXTURE1),C(r,e.video,e.refTexture,e.textureMode,-1,{url:n}),p.textures.push({url:n,resource:e.video,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";var t=new Image;o.datasets.push({texture:e.refTexture,iURL:n}),r.uniform1f(e.locRefFlipRefs,e.flipReflections),r.bindTexture(r.TEXTURE_2D,e.refTexture),t.onload=()=>{r.activeTexture(r.TEXTURE1),C(r,t,e.refTexture,e.textureMode,-1,{url:n})},e.image=t,p.textures.push({url:n,resource:t,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((e=>{t.src=URL.createObjectURL(e)}))}}r.useProgram(c.program),r.activeTexture(r.TEXTURE1),e.locRefOmitEquirectangular=r.getUniformLocation(c.program,"refOmitEquirectangular"),r.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefFlipRefs=r.getUniformLocation(c.program,"refFlipRefs"),r.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=r.getUniformLocation(c.program,"reflectionMap"),r.bindTexture(r.TEXTURE_2D,e.refTexture),r.uniform1i(e.locRefTexture,1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,e.refTexture);break;case"refraction":var n;if(n=e.map){var h,u,f,m;e.refractionVecs=[];for(var g=0;g<a.normalVecs.length;g+=3){for(var v=a.vertices[g+0],y=a.vertices[g+1],b=a.vertices[g+2],x=a.normalVecs[g+0],R=a.normalVecs[g+1],E=a.normalVecs[g+2],A=6e6,M=0;6e6==A&&M<a.vertices.length;M+=9)if(6e6==A){var T=[];h=a.vertices[M+0],u=a.vertices[M+1],f=a.vertices[M+2],T.push(h,u,f),h=a.vertices[M+3],u=a.vertices[M+4],f=a.vertices[M+5],T.push(h,u,f),h=a.vertices[M+6],u=a.vertices[M+7],f=a.vertices[M+8],T.push(h,u,f),(m=ae(v-.01*x,y-.01*R,b-.01*E,v-1e4*x,y-1e4*R,b-1e4*E,T,!0))&&(d=Math.hypot(m[0][0]-v,m[0][1]-y,m[0][2]-b))<A&&(M,A=d)}3*(g%9/3|0),e.refractionVecs.push(a.normalVecs[g+0]),e.refractionVecs.push(a.normalVecs[g+1]),e.refractionVecs.push(a.normalVecs[g+2])}let c;e.refractionVecs=new Float32Array(e.refractionVecs),e.refractionVec_buffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,e.refractionVec_buffer),r.bufferData(r.ARRAY_BUFFER,e.refractionVecs,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),e.refractionVecIndices=new Uint32Array(Array(e.refractionVecs.length/3).fill().map(((e,a)=>a))),e.RefractionVec_Index_Buffer=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,e.refractionVecIndices,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,e.refractionVec_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer);let _=(c=n.split("."))[c.length-1].toLowerCase();switch(e.refractionTexture=r.createTexture(),_){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=p.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refractionTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,F("play audio OK?",!0,(()=>{p.textures.filter((e=>e.url==n))[0].resource.muted=!1,p.textures.filter((e=>e.url==n))[0].resource.currentTime=0,p.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},r.activeTexture(r.TEXTURE5),C(r,e.video,e.refractionTexture,e.textureMode,-1,e),p.textures.push({url:n,resource:e.video,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";t=new Image;o.datasets.push({texture:e.refractionTexture,iURL:n}),r.activeTexture(r.TEXTURE5),r.uniform1f(e.locRefractionFlipRefs,e.flipRefractionlections),r.bindTexture(r.TEXTURE_2D,e.refractionTexture),t.onload=()=>{C(r,t,e.refractionTexture,e.textureMode,-1,e)},p.textures.push({url:n,resource:t,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((e=>{t.src=URL.createObjectURL(e)}))}}r.useProgram(c.program),r.activeTexture(r.TEXTURE5),r.uniform1i(e.locRefractionTexture,5),c.locRefractionlVec=r.getAttribLocation(c.program,"nVecRefraction"),r.vertexAttribPointer(c.locRefractionVec,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(c.locRefractionVec),e.locRefractionOmitEquirectangular=r.getUniformLocation(c.program,"refractionOmitEquirectangular"),r.uniform1f(e.locRefractionOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefractionFlipRefs=r.getUniformLocation(c.program,"refractionFlipRefs"),r.uniform1f(e.locRefractionFlipRefs,e.flipRefractions),e.locRefractionTexture=r.getUniformLocation(c.program,"refractionMap"),r.bindTexture(r.TEXTURE_2D,e.refractionTexture),r.uniform1i(e.locRefractionTexture,5),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,e.refractionTexture);break;case"phong":e.locPhongTheta=r.getUniformLocation(c.program,e.theta),r.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=r.getUniformLocation(c.program,e.flatShadingUniform),r.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=r.getUniformLocation(c.program,e.name),r[e.dataType](e.loc,e.value)})),c.locColor=r.getUniformLocation(c.program,"color"),r.uniform3f(c.locColor,...xe(a.color)),("particles"==a.shapeType||a.isParticle||"lines"==a.shapeType||a.isLine)&&(c.locPointSize=r.getUniformLocation(c.program,"pointSize"),r.uniform1f(c.locPointSize,a.size)),c.locColorMix=r.getUniformLocation(c.program,"colorMix"),r.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=r.getUniformLocation(c.program,"isSprite"),r.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=r.getUniformLocation(c.program,"cameraMode"),r.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=r.getUniformLocation(c.program,"supplementalTextureMix"),r.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locFog=r.getUniformLocation(c.program,"fog"),c.locFogColor=r.getUniformLocation(c.program,"fogColor"),c.locIsLight=r.getUniformLocation(c.program,"isLight"),r.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=r.getUniformLocation(c.program,"isParticle"),r.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locIsLine=r.getUniformLocation(c.program,"isLine"),r.uniform1f(c.locIsLine,a.isLine?1:0),c.locPenumbraPass=r.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=r.getUniformLocation(c.program,"alpha"),r.uniform1f(c.locAlpha,a.alpha),c.locPointLights=r.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=r.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=r.getUniformLocation(c.program,"pointLightCount"),r.uniform1i(c.locPointLightCount,0),c.locResolution=r.getUniformLocation(c.program,"resolution"),r.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=r.getUniformLocation(c.program,"equirectangular"),r.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=r.getUniformLocation(c.program,"t"),r.uniform1f(c.locT,0),c.locAmbientLight=r.getUniformLocation(c.program,"ambientLight"),r.uniform1f(c.locAmbientLight,e.ambientLight),c.locRotationMode=r.getUniformLocation(c.program,"rotationMode"),r.uniform1i(c.locRotationMode,a.rotationMode),c.texture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,c.texture),c.locTexture=r.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=r.createTexture(),c.locHeightMap=r.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=r.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=r.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=r.getUniformLocation(c.program,"heightMapIntensity"),c.locMaxHeightmap=r.getUniformLocation(c.program,"maxHeightmap"),r.activeTexture(r.TEXTURE0)),c.supplementalTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=r.getUniformLocation(c.program,"supplementalTexture"),f)if(ue(f))a.textureMode="dataArray",a.mapIsDataArray=!0,C(r,"",c.texture,a.textureMode,0,a);else{let e;switch(c.iURL=f,(e=f.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",s&&(l=p.textures.filter((e=>e.url==c.iURL))).length?(console.log("found video in cache... using it"),c.resource=l[0].resource,c.texture=l[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",(()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed})),c.resource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()}))),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},p.textures.push({url:f,resource:c.resource,texture:c.texture}),fetch(f).then((e=>e.blob())).then((e=>{c.resource.src=URL.createObjectURL(e)})));break;default:a.textureMode="image";var g=new Image;a.image=g,p.textures.push({url:f,resource:g,texture:c.texture}),g.onload=async()=>{r.activeTexture(r.TEXTURE0),C(r,g,c.texture,a.textureMode,-1,{map:f})},fetch(f).then((e=>e.blob())).then((e=>{g.src=URL.createObjectURL(e)}))}}if(r.useProgram(c.program),r.activeTexture(r.TEXTURE0),r.uniform1i(c.locTexture,0),r.bindTexture(r.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=m;else if(m)if(ue(m))a.heightTextureMode="heightmapDataArray",a.heightmapIsDataArray=!0,C(r,"",c.texture,a.heightTextureMode,0,{map:m});else{let e;switch(c.heightMapURL=m,(e=m.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",s&&(l=p.textures.filter((e=>e.url==c.heightMapURL))).length?(console.log("found video in cache... using it"),c.heightResource=l[0].resource,c.heightTexture=l[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",(()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed})),c.heightResource.loop=!0,a.muted||i||(i=!0,F("play audio OK?",!0,(()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()}))),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},p.textures.push({url:m,resource:c.heightResource,texture:c.heightTexture}),fetch(m).then((e=>e.blob())).then((e=>{c.heightResource.src=URL.createObjectURL(e)})));break;default:a.heightTextureMode="heightImage";var v=new Image;c.heightResource=v,p.textures.push({url:m,resource:v,texture:c.heightTexture}),v.onload=async()=>{r.useProgram(c.program),r.activeTexture(r.TEXTURE4),r.uniform1i(c.locHeightMap,4),C(r,v,c.heightTexture,a.heightTextureMode,-1,{heightMapURL:m}),r.activeTexture(r.TEXTURE0)},fetch(m).then((e=>e.blob())).then((e=>{v.src=URL.createObjectURL(e)}))}}r.useProgram(c.program),c.locCamPos=r.getUniformLocation(c.program,"camPos"),c.locCamOri=r.getUniformLocation(c.program,"camOri"),c.locGeoPos=r.getUniformLocation(c.program,"geoPos"),c.locGeoOri=r.getUniformLocation(c.program,"geoOri"),c.locFov=r.getUniformLocation(c.program,"fov"),c.locRenderNormals=r.getUniformLocation(c.program,"renderNormals"),r.uniform3f(c.locCamPos,e.x,e.y,e.z),r.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),r.uniform3f(c.locGeoPos,e.x,e.y,e.z),r.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),r.uniform1f(c.locFov,e.fov),r.uniform1f(c.locRenderNormals,0)}}else{var y=r.getProgramInfoLog(c.program),b=r.getShaderInfoLog(h),x=r.getShaderInfoLog(u);console.error(`bad shader :( ${y}`),console.error(`vShader info : ${b}`,o.vert),console.error(`fShader info : ${x}`,o.frag)}}}return o},O=async(e,a,r={})=>{var t={vertices:[],normals:[],normalVecs:[],uvs:[]},o=e.vertices.length,n=e.vertices,i=e.normals,s=e.uvs,c=e.normalVecs;o=e.vertices.length;a.map(((e,a)=>{for(var r=e[0],o=e[1],l=e[2],p=0;p<n.length;p+=3)t.vertices.push(r+n[p+0],o+n[p+1],l+n[p+2]),i&&t.normals.push(r+i[2*p+0],o+i[2*p+1],l+i[2*p+2]),i&&t.normals.push(r+i[2*p+3],o+i[2*p+4],l+i[2*p+5]),s&&t.uvs.push(s[p/3*2+0],r+s[p/3*2+1]),c&&t.normalVecs.push(c[p+0],c[p+1],c[p+2])}));var l,p={},h=e.shapeType;return e.canvasTexture&&e.canvasTexture,["x","y","z","rows","cols","size","url","roll","pitch","yaw","color","colorMix","showNormals","exportShape","downloadShape","normalAssocs","equirectangular","flipNormals","textureMode","isSprite","isLight","playbackSpeed","disableDepthTest","lum","alpha","involveCache","isParticle","isLine","penumbra","wireframe","canvasTextureMix","showBounding","boundingColor","heightMap","heightMapIntensity","heightMapIsCanvas","equirectangularHeightmap","isFromZip","rotationMode","mapIsDataArray","dataArrayFormat","maxHeightmap","dataArrayWidth","dataArrayHeight","preComputeNormalAssocs","heightmapIsDataArray","heightmapDataArrayFormat","heightmapDataArrayWidth","heightmapDataArrayHeight","rebindTextures","exportAsOBJ","downloadAsOBJ","resolved","map","video","muted"].forEach((a=>{p[a]=e[a]})),p.name=e.name+"_array",Object.keys(r).forEach(((e,a)=>{p[e]=r[e]})),e.canvasTexture&&(p.canvasTexture=e.canvasTexture),p.shapeType="custom shape",p.geometryData=t,await w(e.renderer,p).then((async a=>{for(var r=0;r<a.vertices.length;r+=o)for(var t=0;t<o;t+=3){var n=(r+t)/3*2;a.uvs[n+0]=e.uvs[n%e.uvs.length+0],a.uvs[n+1]=e.uvs[n%e.uvs.length+1]}a.shapeType=h,l={shape:a,stride:o}})),l},V=async(e,a={})=>{var r=!0,t=[],o={size:1,alpha:.8,penumbra:.5,shapeType:"lines",color:16777215};Object.keys(e).forEach(((a,r)=>{switch(a.toLowerCase()){case"shapetype":default:break;case"x":case"y":case"z":case"roll":case"pitch":case"yaw":o[a]=e[a]}})),Object.keys(a).forEach(((e,t)=>{switch(e.toLowerCase()){case"shapetype":break;case"closepaths":r=a[e];break;default:o[e]=a[e]}}));const n=(e,a,r,o,n,i)=>{for(var s,c,l,p,h,u,f=!0,m=t,d=0;f&&d<m.length;d+=6)s=m[d+0],c=m[d+1],l=m[d+2],p=m[d+3],h=m[d+4],u=m[d+5],(s==e&&c==a&&l==r&&p==o&&h==n&&u==i||s==o&&c==n&&l==i&&p==e&&h==a&&u==r)&&(f=!1);return f};for(var i,s=e.vertices,c=0;c<s.length;c+=9){var l,p,h,u,f,m,d,g,v;l=-s[c+0],p=-s[c+1],h=-s[c+2],u=-s[c+3],f=-s[c+4],m=-s[c+5],d=-s[c+6],g=-s[c+7],v=-s[c+8],i=[],n(l,p,h,u,f,m)&&i.push(l,p,h,u,f,m),n(u,f,m,d,g,v)&&i.push(u,f,m,d,g,v),r&&n(d,g,v,l,p,h)&&i.push(d,g,v,l,p,h),t.push(...i)}var y=[];for(c=0;c<t.length;c+=3)y.push([t[c+0],t[c+1],t[c+2]]);o.geometryData=y;var b={shape:null};return await w(e.renderer,o).then((e=>{b.shape=e})),b},D=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},Y=(e,a,r,t,o,n,i=!1,s="")=>{var c,l,p,h,u,f=[],m=[],d=e,g=[],v=`${s}_${t}`,y=D(s);if("obj"===s)u=X(0,1,o,d,a,v);else u=X(t+(y?1:0),1,o,d,a,v);for(u.map(((e,a)=>{var t=e.verts;//!flipNormals ? shape[shape.length-vidx-1].verts : v.verts
t.map((e=>{e[0]*=r,e[1]*=r,e[2]*=r})),i||4==t.length?(f.push(t[2],t[1],t[0],t[0],t[3],t[2]),void 0!==e.uvs&&e.uvs.length&&m.push(e.uvs[2],e.uvs[1],e.uvs[0],e.uvs[0],e.uvs[3],e.uvs[2])):(f.push(...t),void 0!==e.uvs&&e.uvs.length&&m.push(...e.uvs))})),l=0;l<f.length;l++){var b;p=[f[3*(c=l/3|0)+2],f[3*c+1],f[3*c+0]],l%3||(b=se(p,!1),n&&(b[3]=b[0]-(b[0]-b[3]),b[4]=b[1]-(b[1]-b[4]),b[5]=b[2]-(b[2]-b[5]))),h=n?f.length-l-1:l,g.push({position:f[h],normal:[...f[h],f[h][0]-(b[3]-b[0]),f[h][1]-(b[4]-b[1]),f[h][2]-(b[5]-b[2])],texCoord:m[h]})}return{geometry:g}},X=(e,a,r,t,o,n="")=>{var i,s,c,l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w,F,L,C,U,k,z,S,B,N,O,V,D,Y,X,H,q,G,W,j,$,K,Z,Q,J,ee,ae,re,te,oe,ne,ie,se,ce,le,pe,he,ue,fe,me,de,ge=!1;if(!ge)for(var ve=e;ve--;)i=t,s=o,t=[],o=[],i.map(((e,a)=>{switch(u=e[c=0][0],f=e[c][1],m=e[c][2],s.length&&s[a].length>c&&(de=s[a],F=de[c][0],L=de[c][1]),d=e[c=1][0],g=e[c][1],v=e[c][2],s.length&&s[a].length>c&&(C=de[c][0],U=de[c][1]),y=e[c=2][0],b=e[c][1],x=e[c][2],s.length&&s[a].length>c&&(k=de[c][0],z=de[c][1]),e.length>3&&(R=e[c=3][0],E=e[c][1],A=e[c][2],s.length&&s[a].length>c&&(S=de[c][0],B=de[c][1]),e.length>4&&(M=e[c=4][0],T=e[c][1],_=e[c][2],s.length&&s[a].length>c&&(N=de[c][0],O=de[c][1]),e.length>5&&(P=e[c=5][0],I=e[c][1],w=e[c][2],s.length&&s[a].length>c&&(V=de[c][0],D=de[c][1])))),Y=(u+d)/2,X=(f+g)/2,H=(m+v)/2,q=(d+y)/2,G=(g+b)/2,W=(v+x)/2,void 0!==F&&(ee=(F+C)/2,ae=(L+U)/2,re=(C+k)/2,te=(U+z)/2),he=[],ue=[],e.length){case 3:j=(y+u)/2,$=(b+f)/2,K=(x+m)/2,void 0!==F&&(oe=(k+F)/2,ne=(z+L)/2,l=F,p=L,ue.push([l,p]),l=ee,p=ae,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=C,p=U,ue.push([l,p]),l=re,p=te,ue.push([l,p]),o.push(ue),(ue=[]).push([l=oe,p=ne]),l=re,p=te,ue.push([l,p]),l=k,p=z,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=re,p=te,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue)),l=u,p=f,h=m,he.push([l,p,h]),l=Y,p=X,h=H,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),t.push(he),(he=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,he.push([l,p,h]),l=q,p=G,h=W,he.push([l,p,h]),t.push(he),(he=[]).push([l=j,p=$,h=K]),l=q,p=G,h=W,he.push([l,p,h]),l=y,p=b,h=x,he.push([l,p,h]),t.push(he),(he=[]).push([l=Y,p=X,h=H]),l=q,p=G,h=W,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),t.push(he);break;case 4:j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+u)/2,Q=(E+f)/2,J=(A+m)/2,void 0!==F&&(oe=(k+S)/2,ne=(z+B)/2,ie=(S+F)/2,se=(B+L)/2,fe=(F+C+k+S)/4,me=(L+U+z+B)/4,l=F,p=L,ue.push([l,p]),l=ee,p=ae,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),l=ie,p=se,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=C,p=U,ue.push([l,p]),l=re,p=te,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=fe,p=me]),l=re,p=te,ue.push([l,p]),l=k,p=z,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ie,p=se]),l=fe,p=me,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),l=S,p=B,ue.push([l,p]),o.push(ue)),ce=(u+d+y+R)/4,le=(f+g+b+E)/4,pe=(m+v+x+A)/4,l=u,p=f,h=m,he.push([l,p,h]),l=Y,p=X,h=H,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),l=Z,p=Q,h=J,he.push([l,p,h]),t.push(he),(he=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,he.push([l,p,h]),l=q,p=G,h=W,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=ce,p=le,h=pe]),l=q,p=G,h=W,he.push([l,p,h]),l=y,p=b,h=x,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),t.push(he),(he=[]).push([l=Z,p=Q,h=J]),l=ce,p=le,h=pe,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),l=R,p=E,h=A,he.push([l,p,h]),t.push(he);break;case 5:ce=(u+d+y+R+M)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+A+_)/5,void 0!==F&&(fe=(F+C+k+S+N)/5,me=(L+U+z+B+O)/5,oe=(k+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+F)/2,(O+L)/2,l=F,p=L,ue.push([l,p]),l=C,p=U,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=C,p=U]),l=k,p=z,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=k,p=z]),l=S,p=B,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=S,p=B]),l=N,p=O,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=N,p=O]),l=F,p=L,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),ue=[]),j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+M)/2,Q=(E+T)/2,J=(A+_)/2,(M+u)/2,(T+f)/2,(_+m)/2,l=u,p=f,h=m,he.push([l,p,h]),l=d,p=g,h=v,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=y,p=b,h=x]),l=R,p=E,h=A,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=R,p=E,h=A]),l=M,p=T,h=_,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=M,p=T,h=_]),l=u,p=f,h=m,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),he=[];break;case 6:ce=(u+d+y+R+M)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+A+_)/5,void 0!==F&&(fe=(F+C+k+S+N+V)/6,me=(L+U+z+B+O+D)/6,oe=(k+S)/2,ne=(z+B)/2,ie=(S+N)/2,se=(B+O)/2,(N+V)/2,(O+D)/2,(V+F)/2,(D+L)/2,l=F,p=L,ue.push([l,p]),l=C,p=U,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=C,p=U]),l=k,p=z,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=k,p=z]),l=S,p=B,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=S,p=B]),l=N,p=O,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=N,p=O]),l=V,p=D,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=V,p=D]),l=F,p=L,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),ue=[]),j=(y+R)/2,$=(b+E)/2,K=(x+A)/2,Z=(R+M)/2,Q=(E+T)/2,J=(A+_)/2,(M+P)/2,(T+I)/2,(_+w)/2,(P+u)/2,(I+f)/2,(w+m)/2,(he=[]).push([l=u,p=f,h=m]),l=d,p=g,h=v,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=y,p=b,h=x]),l=R,p=E,h=A,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=R,p=E,h=A]),l=M,p=T,h=_,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=M,p=T,h=_]),l=P,p=I,h=w,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),(he=[]).push([l=P,p=I,h=w]),l=u,p=f,h=m,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),t.push(he),he=[]}}));return t.map(((e,a)=>({verts:e,uvs:o[a]})))},H=(e,a,r,t,o)=>{let i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=Array(t).fill().map((e=>(i=n()-.5,s=n()-.5,c=n()-.5,[i,s,c])));for(let e=50;e--;)x.map(((e,a)=>{i=e[0],s=e[1],c=e[2],x.map(((e,r)=>{r!=a&&(u=e[0],f=e[1],m=e[2],g=1+(Math.hypot(i-u,s-f,c-m)*(3+t/80)*3)**3,i+=9*(i-u)/g,s+=9*(s-f)/g,c+=9*(c-m)/g)})),g=Math.hypot(i,s,c),e[0]=i/g,e[1]=s/g,e[2]=c/g}));return d=6e6,x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,r)=>{u=e[0],f=e[1],m=e[2],a!=r&&(g=Math.hypot(v=l-u,y=p-f,b=h-m),g<d&&(d=g))}))})),v=[],x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,r)=>{u=e[0],f=e[1],m=e[2],a!=r&&(g=Math.hypot(l-u,p-f,h-m),g<2*d&&(v.filter((e=>e[0]==u&&e[1]==f&&e[2]==m&&e[3]==l&&e[4]==p&&e[5]==h)).length||v.push([l*o,p*o,h*o,u*o,f*o,m*o])))}))})),x.map((t=>{t[0]*=o/1.3333,t[1]*=o/1.3333,t[2]*=o/1.3333,t[0]+=e,t[1]+=a,t[2]+=r})),[e,a,r,o,x,v]},q=(e=1,a=0,r,n,i=0,s=!1,c="cylinder")=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w=[],F=[],L=0;L<r;L++)for(var C=L,U=.5,k=0;k<n;k++){l=t(2*Math.PI/n*k)*U,p=1/r*C-.5,h=o(2*Math.PI/n*k)*U,u=t(2*Math.PI/n*(k+1))*U,f=1/r*C-.5,m=o(2*Math.PI/n*(k+1))*U,d=t(2*Math.PI/n*(k+1))*U,g=1/r*(C+1)-.5,v=o(2*Math.PI/n*(k+1))*U,y=t(2*Math.PI/n*k)*U,b=1/r*(C+1)-.5,x=o(2*Math.PI/n*k)*U;var z=Math.atan2(l,h),S=Math.atan2(u,m),B=Math.atan2(d,v),N=Math.atan2(y,x);Math.abs(z-S)>Math.PI&&(z-=2*Math.PI,N-=2*Math.PI),R=(z+Math.PI)/Math.PI/2,E=p+.5,A=(S+Math.PI)/Math.PI/2,M=f+.5,T=(B+Math.PI)/Math.PI/2,_=g+.5,P=(N+Math.PI)/Math.PI/2,I=b+.5,w.push([[l,p,h],[u,f,m],[d,g,v],[y,b,x]]),F.push([[R,E],[A,M],[T,_],[P,I]])}return Y(w,F,1,a,i,s,!0,c)},G=async(e=1,a=0,r=0,n=!1,i="torus",s,c)=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,A,M,T,_,P,I,w,F,L,C,U=[],k=[],z=4*s,S=1/6,B=2/6,N=0;N<z;N++)for(var O=N+.5,V=0;V<c;V++){l=t(L=2*Math.PI/c*(V-1))*S+B,p=o(L)*S,0,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,C=Math.hypot(l,0),h=t(L)*C,u=p,f=o(L)*C,l=t(L=2*Math.PI/c*V)*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,C=Math.hypot(l,0),m=t(L)*C,d=p,g=o(L)*C,l=t(L=2*Math.PI/c*V)*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,C=Math.hypot(l,0),v=t(L)*C,y=p,b=o(L)*C,l=t(L=2*Math.PI/c*(V-1))*S+B,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,C=Math.hypot(l,0),x=t(L)*C,R=p,E=o(L)*C;var D=Math.atan2(h,f),X=Math.atan2(m,g),H=Math.atan2(v,b),q=Math.atan2(x,E);Math.abs(D-H)>Math.PI&&(H+=2*Math.PI,q+=2*Math.PI),A=(D+Math.PI)/Math.PI/2,M=u+.5,T=(X+Math.PI)/Math.PI/2,_=d+.5,P=(H+Math.PI)/Math.PI/2,I=y+.5,w=(q+Math.PI)/Math.PI/2,F=R+.5,U.push([[h,u,f],[x,R,E],[v,y,b],[m,d,g]]),k.push([[A,M],[T,_],[P,I],[w,F]])}return Y(U,k,e,a,r,n,!0,i)},W=async(e=1,a=0,r,n,i=0,s=!1,c="torus knot")=>{var l,p,h,u,f,m,d,g,v=[],y=[];y=[],d=[],n*=4,r*=2;for(var b=1/3,x=0;x<2*n;x++)for(var R=0;R<r+1;R++)l=1+t(f=2*Math.PI/r*R)/4+t(m=2*Math.PI*1.5/n*x)*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+t(m),u=Math.hypot(p,h),p=t(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*x,u=Math.hypot(l,h),l=t(f)*u,h=o(f)*u,y.push([l,p,h]),l=1+t(f=2*Math.PI/r*R)/4+t(m=2*Math.PI*1.5/n*(x+1))*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+t(m),u=Math.hypot(p,h),p=t(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*(x+1),u=Math.hypot(l,h),l=t(f)*u,h=o(f)*u,d.push([l,p,h]);y.forEach(((a,t)=>{if(t%(r+1)!=r){var o=(t+1)%y.length,n=y[t][0]*e/3.2,i=y[t][1]*e/3.2,s=y[t][2]*e/3.2,c=d[t][0]*e/3.2,l=d[t][1]*e/3.2,p=d[t][2]*e/3.2,h=d[o][0]*e/3.2,u=d[o][1]*e/3.2,f=d[o][2]*e/3.2,m=y[o][0]*e/3.2,g=y[o][1]*e/3.2,b=y[o][2]*e/3.2;v.push([[n,i,s],[c,l,p],[h,u,f],[m,g,b]])}}));var E,A,M=v,T=[];for(R=0;R<M.length;R++){y=[];for(var _=M[R].length;_--;){switch(_){case 0:E=0,A=0;break;case 1:E=1,A=0;break;case 2:E=1,A=1;break;case 3:E=0,A=.5;break;case 4:E=0,A=1}y.push([E,A])}T.push(y)}return Y(v,T,1,a,i,s,!0,c)},j=async(e=1,a=0,r=0,n=!1,i="tetrahedron")=>{var s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];y=[];let R=1/1.4142/1.75;for(g=0;g<3;g++)s=1*t(p=2*Math.PI/3*g)/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]);for(x.push(y),v=3;v--;)(y=[]).push([s=0,c=0,l=-R]),s=1*t(p=2*Math.PI/3*v)/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]),s=1*t(p=2*Math.PI/3*(v-1))/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]),x.push(y);f=m=d=b=0,x.map((e=>{e.map((e=>{f+=e[0],m+=e[1],d+=e[2],b++}))})),f/=b,m/=b,d/=b,x.map((e=>{e.map((e=>{e[0]-=f,e[1]-=m,e[2]-=d}))}));var E=x,A=[];for(g=0;g<E.length;g++){y=[];for(var M=E[g].length;M--;){switch(M){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}y.push([h,u])}A.push(y)}return Y(E,A,1,a,r,n,!1,i)},$=async(e=1,a=0,r=0,n=!1,i="octahedron")=>{var s,c,l,p,h,u,f,m,d,g=[];for(m=8;m--;)d=[],s=0,c=0,m<4?(l=.5,d.push([s,c,l]),s=1*t(p=2*Math.PI/4*m)/2,c=1*o(p)/2,l=0,d.push([s,c,l]),s=1*t(p=2*Math.PI/4*(m+1))/2,c=1*o(p)/2):(l=-.5,d.push([s,c,l]),s=1*t(p=2*Math.PI/4*m)/2,c=1*o(p)/2,l=0,d.push([s,c,l]),s=1*t(p=2*Math.PI/4*(m-1))/2,c=1*o(p)/2),l=0,d.push([s,c,l]),g.push(d);var v=g,y=[];for(f=0;f<v.length;f++){d=[];for(var b=v[f].length;b--;){switch(b){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}d.push([h,u])}y.push(d)}return Y(v,y,1,a,r,n,!1,i)},K=async(e=1,a=0,r=0,t=!1,o="icosahedron")=>{var n,i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];for(u=[[-(h=.5+5**.5/2),-1,0],[h,-1,0],[h,1,0],[-h,1,0]],p=3;p--;x.push(i))for(i=[],n=4;n--;)i.push([u[n][p],u[n][(p+1)%3],u[n][(p+2)%3]]);x.map((a=>{a.map((a=>{a[0]*=1/2.25*e*.7,a[1]*=1/2.25*e*.7,a[2]*=1/2.25*e*.7}))})),f=JSON.parse(JSON.stringify(x)),l=[],u=[],[[[0,3],[1,0],[2,2]],[[1,3],[1,0],[0,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[1,0],[1,3],[0,2]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[2,1],[2,2],[1,0]],[[1,1],[2,2],[2,1]],[[0,0],[2,2],[1,1]],[[1,1],[2,1],[0,1]],[[0,1],[2,1],[0,2]],[[2,3],[1,2],[2,0]],[[2,3],[0,3],[0,0]],[[2,3],[2,0],[1,3]],[[2,3],[0,0],[1,2]],[[0,1],[2,0],[1,2]],[[1,1],[1,2],[0,0]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]]].map(((e,a)=>{m=e[0][0],d=e[1][0],g=e[2][0],v=e[0][1],y=e[1][1],b=e[2][1],u.push([f[g][b],f[d][y],f[m][v]])})),l.push(...u);var R=l,E=[];for(n=0;n<R.length;n++){u=[];for(var A=R[n].length;A--;){switch(A){case 0:s=0,c=0;break;case 1:s=1,c=0;break;case 2:s=1,c=1;break;case 3:s=0,c=.5;break;case 4:s=0,c=1}u.push([s,c])}E.push(u)}return Y(R,E,1,a,r,t,!1,o)},Z=async(e=1,a=0,r=0,n=!1,i="dodecahedron")=>{var s,c,l,p,h,u,f,m,d,g,v=[],y=[];let b=-6e6;for(g=5;g--;)s=t(u=2*Math.PI/5*g+Math.PI/5),c=o(u),l=0,c>b&&(b=c),y.push([s,c,l]);y=y.map((e=>(s=e[0],c=e[1]-=b,l=e[2],x(s,c,l,{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0})))),(h=structuredClone(y)).map((e=>{var a=Math.atan2(e[0],e[1])+Math.PI,r=Math.hypot(e[0],e[1]);e[0]=t(a)*r,e[1]=o(a)*r})),v.push(y,h),b=-6e6,v.map((e=>{e.map((e=>{s=e[0],c=e[1],(l=e[2])>b&&(b=l)}))})),p=Math.hypot(v[0][0][0]-v[0][1][0],v[0][0][1]-v[0][1][1],v[0][0][2]-v[0][1][2]),v.map((e=>{e.map((e=>{e[2]-=b+p/2}))})),(h=structuredClone(v)).map((e=>{e.map((e=>{var a=Math.atan2(e[0],e[2])+Math.PI,r=Math.hypot(e[0],e[2]);e[0]=t(a)*r,e[2]=o(a)*r}))})),v.push(...h),(h=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),(E=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=R(s,c,l,{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),v.push(...h,...E);var E=v.map(((e,a)=>e.map(((a,r)=>{var t=r;return[e[t][0],e[t][1],e[t][2]]})))),A=[];for(g=0;g<E.length;g++){y=[];for(var M=E[g].length;M--;){switch(M){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y.push([m,d])}A.push(y)}return Y(E,A,e/Math.max(1,2-r)/1.5,a,r,n,!1,i)},Q=(e=1,a=0,r=0,n=!1,i="cube")=>{var s,c,l,p,h,u,f,m,d=Math.PI,g=[];for(h=6;h--;g.push(l))for(l=[],u=4;u--;)h<3?l.push([(c=[t(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+0)%3]*(p=2**.5/2),c[(h+1)%3]*p,c[(h+2)%3]*p]):l.push([(c=[t(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+2)%3]*(p=-(2**.5)/2),c[(h+1)%3]*p,c[(h+0)%3]*p]);var v=[];for(h=0;h<g.length;h++){c=[];for(var y=g[h].length;y--;){switch(y){case 0:f=0,m=0;break;case 1:f=1,m=0;break;case 2:f=1,m=1;break;case 3:f=0,m=1}c.push([f,m])}v.push(c)}return Y(g,v,e,a,r,n,!0,i)},J=async(e=1,a=0,r=0,t=!1,o="rectangle")=>{Math.PI;return Y([[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]]],[[[0,0],[1,0],[1,1],[0,1]]],e/1.5,Math.max("sprite"==o?0:2,a),"sprite"==o||"point light"==o?0:r,t,!0,o)},ee=(e,a=0)=>!(a>300)&&(2==e||ee(e/2,a+1)),ae=(e,a,r,n,i,s,c,l=!1)=>{let p,h,u,f,m,d,g,v,y,b=(e,a,r,t,o,n,i,s)=>(d=((i-o)*(a-n)-(s-n)*(e-o))/(g=(s-n)*(r-e)-(i-o)*(t-a)))>=0&&d<=1&&(v=((r-e)*(a-n)-(t-a)*(e-o))/g)>=0&&v<=1?[e+d*(r-e),a+d*(t-a)]:0,x=(e,a,r,n)=>{let i=Math,s=i.atan2,c=i.hypot;p=t(y=s(p,h)+e)*(f=c(p,h)),h=o(y)*f,p=t(y=s(p,u)+r)*(f=c(p,u)),u=o(y)*f,h=t(y=s(h,u)+a)*(f=c(h,u)),u=o(y)*f,n&&(p+=oX,h+=oY,u+=oZ)},R=e=>{switch(e){case 0:x(0,0,Math.PI/2);break;case 1:x(0,Math.PI/2,0);break;case 2:x(Math.PI/2,0,Math.PI/2)}},E=0,A=0,M=0;c.map((e=>{E+=e[0],A+=e[1],M+=e[2]})),E/=c.length,A/=c.length,M/=c.length;let T=c[2][0]-c[1][0],_=c[2][1]-c[1][1],P=c[2][2]-c[1][2],I=c[1][0]-c[0][0],w=c[1][1]-c[0][1],F=c[1][2]-c[0][2],L=[_*F-P*w,P*I-T*F,T*w-_*I];f=Math.hypot(...L)+.001;L=L.map((e=>e/f*1));let C=E,U=A,k=M,z=1;if(l){let t=Math.hypot(C-e,U-a,k-r);z=Math.hypot(e-(E+L[0]/99),a-(A+L[1]/99),r-(M+L[2]/99))>t?-1:1}let S=E+(L[0]*=z),B=A+(L[1]*=z),N=M+(L[2]*=z),O=Math.atan2(S-C,N-k),V=-(Math.acos((B-U)/(Math.hypot(S-C,B-U,N-k)+.001))+Math.PI/2),D=!1,Y=[!1,!1,!1];p=e,h=a,u=r,x(0,-V,-O);let X=p,H=h,q=u;for(let e=3;e--;)!1===D&&(p=X,h=H,u=q,R(e),C=p,U=h,k=u=5,p=n,h=i,u=s,x(0,-V,-O),R(e),S=p,B=h,N=u,c.map(((a,r)=>{if(!1===D){let a=r;p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);let t=p,o=h;a=(r+1)%c.length,p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);(m=b(C,U,S,B,t,o,p,h))&&(Y[e]=m)}})));if(3==Y.filter((e=>!1!==e)).length){let e=Y[1][0],a=Y[0][1],r=Y[0][0],t=!0;E=0,A=0,M=0,c.map(((e,a)=>{E+=e[0],A+=e[1],M+=e[2]})),E/=c.length,A/=c.length,M/=c.length,p=E,h=A,u=M,x(0,-V,-O),C=p,U=h,k=u,S=e,B=a,N=r,c.map(((e,a)=>{if(t){let e=a;p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);let r=p,o=h;e=(a+1)%c.length,p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);b(C,U,S,B,r,o,p,h)&&(t=!1)}})),t&&(p=e,h=a,u=r,x(0,V,0),x(0,0,O),D=[[p,h,u],[L[0],L[1],L[2]]])}return D},re=async(e,a)=>{var r,t=[],o=a.omitShape;(a.omitShape=!0,a.geometryData.map((async r=>{var o,n,i,s,c,l,p=r[0][0],h=r[0][1],u=r[0][2],f=r[1][0],m=r[1][1],d=r[1][2];"horizontal"!=a.alignment&&(Math.abs(f-p)>Math.abs(m-h)||"vertical"==a.alignment)?(o=p,n=(h+m)/2,i=(u+d)/2,s=f,c=(h+m)/2,l=(u+d)/2):(o=(p+f)/2,n=h,i=(u+d)/2,s=(p+f)/2,c=m,l=(u+d)/2),a.geometryData=[[p,h,u],[o,n,i],[s,c,l],[f,m,d]],await te(e,a).then((e=>{t.push(...e.curve)}))})),o)||(a.shapeType="lines",a.geometryData=t,w(e,a).then((e=>{r=e})),t=r);return t},te=async(e,a)=>{var r=[],t=10;void 0!==a&&Object.keys(a).forEach(((e,r)=>{if("steps"===e.toLowerCase())t=Math.floor(a[e])}));var o,n,i,s=structuredClone(a.geometryData);o=s[0][0]-(s[1][0]-s[0][0]),n=s[0][1]-(s[1][1]-s[0][1]),i=s[0][2]-(s[1][2]-s[0][2]),s[0][0]=o,s[0][1]=n,s[0][2]=i;var c=s.length-1;o=s[c][0]+(s[c][0]-s[c-1][0]),n=s[c][1]+(s[c][1]-s[c-1][1]),i=s[c][2]+(s[c][2]-s[c-1][2]),s[c][0]=o,s[c][1]=n,s[c][2]=i,s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,p=s[c][0],h=s[c][1],u=s[c][2],f=s[l][0],m=s[l][1],d=s[l][2],g=(o+p)/2,v=(n+h)/2,y=(i+u)/2,b=(p+f)/2,x=(h+m)/2,R=(u+d)/2;r.push([g,v,y]),a==s.length-3&&r.push([b,x,R]);for(var E=0;E<t+1;E++);}}));var l,p=[];return s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,h=s[c][0],u=s[c][1],f=s[c][2],m=(o+h)/2,d=(n+u)/2,g=(i+f)/2,v=(h+s[l][0])/2,y=(u+s[l][1])/2,b=(f+s[l][2])/2;r.push([m,d,g]);for(var x=m,R=d,E=g,A=0;A<t+1;A++){if(A){var M=ie(m+(h-m)/t*A,d+(u-d)/t*A,h+(v-h)/t*A,u+(y-u)/t*A,m+(h-m)/t*(A+1),d+(u-d)/t*(A+1),h+(v-h)/t*(A+1),u+(y-u)/t*(A+1));A<t&&(M?(p.push([x,R,E],[...M,0]),x=M[0],R=M[1],E=0):(p.push([x,R,E],[v,y,b]),x=v,R=y,E=b)),A>=t&&p.push([x,R,E],[v,y,0])}}}})),a.omitShape?{curve:p,midPoints:r,controlPoints:s}:(a.shapeType="lines",a.geometryData=p,w(e,a).then((async e=>l=e)),{curve:p,shape:l,midPoints:r,controlPoints:s})},oe=(e,a)=>{let r=Math.hypot(...e)+1e-5,t=Math.hypot(...a)+1e-5;e[0]/=r,e[1]/=r,e[2]/=r,a[0]/=t,a[1]/=t,a[2]/=t;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2];return[-(-e[0]-2*a[0]*o)*r,-(-e[1]-2*a[1]*o)*r,-(-e[2]-2*a[2]*o)*r]},ne=(e,a,r)=>{var t,o,n,i,s,c,l,p=0;return r.map((e=>{e[0],e[1],p++})),p,p,t=e,o=a,1e6,1e6,p=0,r.map(((e,a)=>{n=r[l=a][0],i=r[l][1],l=(a+1)%r.length,s=r[l][0],c=r[l][1],ie(t,o,1e6,1e6,n,i,s,c)&&p++})),1==p},ie=(e,a,r,t,o,n,i,s)=>{var c,l,p;return(c=((i-o)*(a-n)-(s-n)*(e-o))/(l=(s-n)*(r-e)-(i-o)*(t-a)))>=0&&c<=1&&(p=((r-e)*(a-n)-(t-a)*(e-o))/l)>=0&&p<=1&&[e+c*(r-e),a+c*(t-a)]},se=(e,a=!1,r=0,t=0,o=0)=>{var n,i,s=0,c=0,l=0;e.map((e=>{s+=e[0],c+=e[1],l+=e[2]})),s/=e.length,c/=e.length,l/=e.length;var p=e[2][0]-e[1][0],h=e[2][1]-e[1][1],u=e[2][2]-e[1][2],f=e[1][0]-e[0][0],m=e[1][1]-e[0][1],d=e[1][2]-e[0][2];n=[h*d-u*m,u*f-p*d,p*m-h*f],i=Math.hypot(...n)+1e-4;n=n.map((e=>e/i*1));var g=s,v=c,y=l,b=1;if(a){var x=Math.hypot(g-r,v-t,y-o);b=Math.hypot(r-(s+n[0]/99),t-(c+n[1]/99),o-(l+n[2]/99))>x?-1:1}return[g,v,y,s+(n[0]*=b),c+(n[1]*=b),l+(n[2]*=b)]},ce=async(a,r)=>{a.grav=.01,a.mspeed=1,a.rspeed=1,a.cameraMode="fps",a.crosshairMap="",a.showCrosshair=!0,a.crosshairSize=1,a.lastInteraction=0,a.hasTraction=!0,a.focusRequiredForMouse=!0,a.flyMode=!1,a.useKeys=!0,a.crosshairSel=0,a.crosshairAlpha=.6,a.useFPSControls=!0;var n=Array(4).fill().map(((a,r)=>`${e}/resources/crosshairs/crosshair${r+1}.png`));void 0!==r&&Object.keys(r).forEach(((e,t)=>{switch(e.toLowerCase()){case"mspeed":a.mspeed=+r[e];break;case"rspeed":a.rspeed=+r[e];break;case"grav":a.grav=+r[e];break;case"crosshairsel":a.crosshairSel=+r[e];break;case"crosshairsize":a.crosshairSize=+r[e];break;case"flymode":a.flyMode=!!r[e];break;case"usekeys":a.useKeys=!!r[e];break;case"crosshairmap":a.crosshairMap=r[e];break;case"crosshairalpha":a.crosshairAlpha=+r[e];break;case"showcrosshair":a.showCrosshair=!!r[e];break;case"focusrequiredformouse":a.focusRequiredForMouse=!!r[e]}}));if(a.crosshairImages=Array(n.length).fill(),a.crosshairImages.map((async(e,r)=>{a.crosshairImages[r]={img:new Image,loaded:!1},a.crosshairImages[r].img.onload=()=>{a.crosshairImages[r].loaded=!0},await fetch(n[r]).then((e=>e.blob())).then((e=>{a.crosshairImages[r].img.src=URL.createObjectURL(e)}))})),a.crosshairMap&&(a.crosshairSel=n.length,a.crosshairImages.push({img:new Image,loaded:!1}),a.crosshairImages[a.crosshairImages.length-1].img.onload=()=>{a.crosshairImages[a.crosshairImages.length-1].loaded=!0},await fetch(a.crosshairMap).then((e=>e.blob())).then((e=>{a.crosshairImages[a.crosshairImages.length-1].img.src=URL.createObjectURL(e)}))),a.useKeys){var i=.1*a.mspeed,s=.005*a.rspeed,c=0,l=0,p=0,h=0,u=0,f=1;a.keys=Array(256).fill().map(((e,a)=>!1)),a.keyTimers=Array(256).fill(0),a.keyTimerInterval=.2,window.addEventListener("keydown",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!0,a.lastInteraction=a.t)})),window.addEventListener("keyup",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!1,a.lastInteraction=a.t)})),window.addEventListener("mousedown",(e=>{(a.lastInteraction=a.t,0===e.button)&&(!0,document.querySelectorAll(".genericPopup").length||"CANVAS"!=document.activeElement.nodeName||a.c.requestPointerLock({unadjustedMovement:!0}))})),window.addEventListener("mouseup",(e=>{a.lastInteraction=a.t,0===e.button&&!1})),window.addEventListener("mousemove",(e=>{if(a.lastInteraction=a.t,document.pointerLockElement==a.c||!a.focusRequiredForMouse){var r=a.c.getBoundingClientRect();(e.pageX-r.left)/a.c.clientWidth*a.c.width,(e.pageY-r.top)/a.c.clientHeight*a.c.height,c-=e.movementX*s,l+=e.movementY*s}})),a.doKeys=async()=>{if(i=.1*a.mspeed,s=.005*a.rspeed,a.yaw+=c,a.pitch+=l,a.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,a.pitch)),c/=1.66,l/=1.66,a.x+=p,a.y+=h,a.z+=u,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&(p/=1.2,h/=1.2,u/=1.2),a.flyMode&&"CANVAS"==document.activeElement.nodeName){var e=-a.yaw+Math.PI,r=a.pitch;switch(a.mouseButton){case 1:p-=t(e)*t(r)*i*f,h+=o(r)*i*f,u-=o(e)*t(r)*i*f;break;case 2:p+=t(e)*t(r)*i*f,h-=o(r)*i*f,u+=o(e)*t(r)*i*f}}f=1,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&a.keys.map(((e,r)=>{if(a.keys[r])switch(r){case 16:f=3;break;case 37:c+=12*s;break;case 38:l-=12*s;break;case 39:c-=12*s;break;case 40:l+=12*s;break;case 87:var n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p+=t(n)*t(m)*i*f,h-=o(m)*i*f,u+=o(n)*t(m)*i*f):(p+=t(n)*i*f,u+=o(n)*i*f);break;case 65:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=t(n)*i*f,u+=o(n)*i*f;break;case 83:n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p-=t(n)*t(m)*i*f,h+=o(m)*i*f,u-=o(n)*t(m)*i*f):(p-=t(n)*i*f,u-=o(n)*i*f);break;case 68:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=-t(n)*i*f,u+=-o(n)*i*f}}))}}},le=(e,a)=>{const r=async()=>{Te.margin=e.margin,Te.rsz(),Te.width=e.width,Te.height=e.height,Te.c.width=e.c.width,Te.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a]();if(["alphaQueue","lineQueue","particleQueue"].forEach((a=>{if(e[a].length){var r,t=[];switch(e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,i=a.y+e.y,s=a.z+e.z;r=x(n,i,s,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),t.push({idx:o,z:Math.hypot(e.x+r[0],e.y+r[1],e.z+r[2])})})),e.cameraMode){case"fps":t.sort(((e,a)=>a.z-e.z));break;case"fps":t.sort(((e,a)=>e.z-a.z))}e[a].map((async(r,o)=>{var n=e[a][t[o].idx].geometry,i=n.vertices,s=n.size;n.size=e[a][t[o].idx].size,n.vertices=e[a][t[o].idx].vertices,n.x=e[a][t[o].idx].x,n.y=e[a][t[o].idx].y,n.z=e[a][t[o].idx].z,n.roll=e[a][t[o].idx].roll,n.pitch=e[a][t[o].idx].pitch,n.yaw=e[a][t[o].idx].yaw;for(var c=n.penumbra,l=1+((n.isLine||n.isParticle)&&c?1:0);l--;)e.Draw(n,!0,(n.isParticle||n.isLine)&&c&&!l);n.vertices=i,n.size=s})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e[a]=[]})),e.t+=1/60,requestAnimationFrame(r),"fps"==e.cameraMode&&(e.useKeys&&e.doKeys&&await e.doKeys(),e.showCrosshair&&e.crosshairImages[e.crosshairSel].loaded)){var t=200*e.crosshairSize;Te.ctx.globalAlpha=e.crosshairAlpha,Te.ctx.drawImage(e.crosshairImages[e.crosshairSel].img,Te.width/2-t/2,Te.height/2-t/2,t,t),Te.ctx.globalAlpha=1}};window.addEventListener("load",(()=>{e.ready=!0,r()}))},pe=(e,a,r)=>he(e,a,r),he=(e,a,r)=>{let t=e/255,o=a/255,n=r/255,i=Math.min(t,o,n),s=Math.max(t,o,n),c=s,l=s-i,p=s?l/s:0,h=Math.min(e,a,r),u=Math.max(e,a,r),f=0;for(l&&(e>=a&&e>=r&&(f=(a-r)/(u-h)),a>=e&&a>=r&&(f=2+(r-e)/(u-h)),r>=a&&r>=e&&(f=4+(e-a)/(u-h))),f*=60;f<0;)f+=360;for(;f>=360;)f-=360;return[f,p,c]},ue=e=>void 0!==e.length&&void 0!==e.forEach,fe=(e,a,r)=>me(e,a,r),me=(e,a,r)=>{let t=ge(e,a,r);return ye(...t)},de=(e,a,r)=>ge(e,a,r),ge=(e,a,r)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let t,o,n,i=r*a,s=i*(1-Math.abs(e/60%2-1)),c=r-i;return e>=0&&e<60&&(t=i,o=s,n=0),e>=60&&e<120&&(t=s,o=i,n=0),e>=120&&e<180&&(t=0,o=i,n=s),e>=180&&e<240&&(t=0,o=s,n=i),e>=240&&e<300&&(t=s,o=0,n=i),e>=300&&e<360&&(t=i,o=0,n=s),[255*(t+c),255*(o+c),255*(n+c)]},ve=(e,a,r)=>ye(e,a,r),ye=(e,a,r)=>{let t="0123456789abcdef",o="";return o+=t[e/16|0],o+=t[e-16*(e/16|0)|0],o+=t[a/16|0],o+=t[a-16*(a/16|0)|0],o+=t[r/16|0],o+=t[r-16*(r/16|0)|0],Number("0x"+o)},be=e=>xe(e),xe=e=>[e/256**3-(e/256**3|0),e/65536-(e/65536|0),e/256-(e/256|0)],Re=e=>{var a=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map((r=>{a.push({name:r,val:e.getParameter(e[r])})}));var r=document.createElement("div");r.style.position="fixed",r.style.zIndex=1e5,r.style.left="50%",r.style.top="50%",r.style.transform="translate(-50%, -50%)",r.style.background="#0008",r.style.padding="20px",r.style.width="600px",r.style.height="350px",r.style.border="1px solid #fff4",r.style.borderRadius="5px",r.style.fontFamily="monospace",r.style.fontSize="20px",r.style.color="#fff";var t=document.createElement("div");t.style.fontSize="24px",t.style.color="#0f8c",t.innerHTML="rendering context parameters<br><br>",r.appendChild(t);var o=document.createElement("div");o.style.minWidth="100%",o.style.height="250px",o.style.background="#333",o.style.border="1px solid #fff4",o.style.overflowY="auto",o.style.wordWrap="break-word",o.style.color="#888",o.style.fontSize="10px",r.appendChild(o);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="ðŸ“‹ copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(o),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout((()=>{n.innerHTML="ðŸ“‹ copy"}),1e3)},r.appendChild(n);var i=document.createElement("button");i.onclick=()=>r.remove(),i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="close",r.appendChild(i),o.innerHTML=JSON.stringify(a),document.body.appendChild(r)},Ee=e=>{var a=Math.sin,r=Math.cos,t=r(e[0]),o=a(e[0]),n=r(e[1]),i=a(e[1]),s=r(e[2]),c=a(e[2]);return[t*n+(t*i*c-o*s)+(t*i*s+o*c),o*n+(o*i*c+t*s)+(o*i*s-t*c),-i+n*c+n*s]},Ae={push:async(e,a)=>{console.log("push"),e.dataArray.items.push(a)},pop:async(e,a)=>{console.log("pop")},insert:async(e,a)=>{console.log("insert")},slice:async(e,a)=>{console.log("slice")},test:(e,a,r,n,i)=>{var s,c,l,p,h,u=a.length**.5|0,f=0,m=u;u+=1,s=n/2,c=i/2;var d,g,v,y=!1;if(e.dataArray.items.length){y=!1;do{for(var b=Math.hypot(n,i),x=0;!y&&x<b;x+=1*u|0){for(var R=3;!y&&R--;)if(!y&&(p=s+t(l=2*Math.PI/3*R+f/3+16*e.t)*x-u/2|0,h=c+o(l)*x/(16/9)-u/2|0,p>=0&&p+u<n&&h>=0&&h+u<i)){var E=[[p,h],[p+u,h],[p+u,h+u],[p,h+u]];v=!1,e.dataArray.items.forEach(((e,a)=>{if(!v){var r=[[e.posx,e.posy],[e.posx+e.width,e.posy],[e.posx+e.width,e.posy+e.width],[e.posx,e.posy+e.width]];E.forEach((e=>{ne(e[0],e[1],r)&&(v=!0)})),r.forEach((e=>{ne(e[0],e[1],E)&&(v=!0)}))}})),v||y||(y=!0,d=p,g=h)}f++}}while(f<1e4&&!y)}else y=!0,d=0|s,g=0|c;e.dataArray.items.push({array:a,posx:d,posy:g,width:u}),a.forEach(((e,a)=>{var t=4*(d+a%m+(g+a/m|0)*n|0)|0;r[t+0]=0|e[0],r[t+1]=0|e[1],r[t+2]=0|e[2],r[t+3]=255}));var A=-6e6,M=-6e6,T=6e6,_=6e6;return e.dataArray.items.forEach(((e,a)=>{e.posx<T&&(T=e.posx),e.posx>A&&(A=e.posx),e.posy<_&&(_=e.posy),e.posy>M&&(M=e.posy)})),[A,M]}},Me=e=>a.GenHash(e);var Te;(Te=await h({context:{mode:"2d",margin:0}})).c.style.background="#0000",Te.c.style.zIndex=10;var _e,Pe=document.createElement("canvas"),Ie=Pe.getContext("2d",{willReadFrequently:!0});export{h as Renderer,w as LoadGeometry,N as BasicShader,f as DestroyRenderer,u as ResizeRenderer,m as DestroyShape,le as AnimationLoop,j as Tetrahedron,Q as Cube,$ as Octahedron,K as Icosahedron,Z as Dodecahedron,q as Cylinder,Ae as ShapeArray,O as ShapeFromArray,G as Torus,P as DownloadCustomShape,M as LoadAnimationFromZip,T as DrawAnimation,W as TorusKnot,J as Rectangle,b as Q,x as R,R as R_ypr,E as R_pyr,A as R_rpy,U as ComputeNormalAssocs,k as SyncNormals,ie as Intersects,ne as PointInPoly2D,ae as PointInPoly3D,V as ShapeToLines,S as ShowBounding,z as GetShaderCoord,oe as Reflect,se as Normal,te as BSpline,Ee as Quat,re as CurveTo,L as ImageToPo2,y as LoadOBJ,ee as IsPowerOf2,pe as RGBToHSV,fe as HSVToHex,he as HSVFromRGB,me as HexFromHSV,de as HSVToRGB,ge as RGBFromHSV,ve as HexFromRGB,ye as RGBToHex,be as RGBFromHex,xe as HexToRGB,H as GeoSphere,e as ModuleBase,ce as LoadFPSControls,Te as Overlay,Me as GenHash,ue as IsArray};