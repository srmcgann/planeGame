const e="https://srmcgann.github.io/Coordinates";import*as a from"https://srmcgann.github.io/GenHash/hash.js";const t=document.createElement("script");await t.setAttribute("src",e+"/zip.js"),await document.body.appendChild(t);const r=Math.sin,o=Math.cos,n=Math.random;var i=!1;const s=document.createElement("canvas"),c=s.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1});new Image;var l;const h={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},u=async e=>{var a=0,t=0,n=0,i=1920,s=1080,c=0,l=0,p=0,h=2e3,u=!0,f=10,m=!1,d=.2,g=!1,v=0,y="default",b=!1,x=0,R="",E={mode:"webgl2",options:{alpha:!0,antialias:!1,desynchronized:!0,premultipliedAlpha:!1}},M=[],A=[0,0,0],T={data:[],items:[]};void 0!==e&&Object.keys(e).forEach(((r,o)=>{switch(r.toLowerCase()){case"plugins":e[r].map((e=>{if("post processing"===e.type.toLowerCase())if(void 0===e.enabled||e.enabled){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map((e=>e.toLowerCase())):[]};M.push(a)}}));break;case"width":i=e[r];break;case"height":s=e[r];break;case"alpha":g=e[r];break;case"x":a=e[r];break;case"y":t=e[r];break;case"z":n=e[r];break;case"roll":c=e[r];break;case"pitch":l=e[r];break;case"yaw":p=e[r];break;case"fov":h=e[r];break;case"fog":e[r];break;case"fogcolor":A=e[r];break;case"clearcolor":v=e[r];break;case"attachtobody":u=!!e[r];break;case"exportgpuspecs":m=!!e[r];break;case"margin":f=e[r];break;case"cameramode":y=e[r];break;case"ambientlight":d=e[r];break;case"showcrosshair":b=!!e[r];break;case"dataarray":T=e[r];break;case"crosshairsel":x=e[r];break;case"crosshairmap":R=e[r];break;case"context":E.mode=e[r].mode,E.options=e[r].options}}));const _=document.createElement("canvas"),P=_.getContext(E.mode,E.options);_.width=i,_.height=s,_.tabIndex=0,_.style.outline="none";const I=E.mode;if("2d"!=E.mode&&(console.log(`GLSL version: ${P.getParameter(P.SHADING_LANGUAGE_VERSION)}`),P.pixelStorei(P.UNPACK_ALIGNMENT,1)),m&&Pe(P),"2d"===E.mode);else P.viewport(0,0,_.width,_.height);var w,F;u&&(_.style.display="block",_.style.position="absolute",_.style.left="50vw",_.style.top="50vh",_.style.transform="translate(-50%, -50%)",document.body.appendChild(_)),window.addEventListener("resize",w=e=>{var a,t=F.margin,r=document.body,o=0!==_.width?_.height/_.width:1;r.clientHeight/r.clientWidth>o?(_.style.width=(a=r.clientWidth)-2*t+"px",_.style.height=a*o-2*t+"px"):(_.style.height=(a=r.clientHeight)-2*t+"px",_.style.width=a/o-2*t+"px")}),F={c:_,ctx:P,contextType:I,t:0,alpha:g,width:i,height:s,x:a,y:t,z:n,roll:c,pitch:l,yaw:p,fov:h,ready:!1,ambientLight:d,clearColor:v,pointLights:[],pointLightCols:[],dataArray:T,alphaQueue:[],particleQueue:[],lineQueue:[],active:!0,cameraMode:y,showCrosshair:b,crosshairSel:x,crosshairMap:R,pageX:undefined,pageY:undefined,mouseX:undefined,mouseY:undefined,mouseButton:undefined,rsz:w,margin:f,optionalPlugins:M,fogColor:A},w(),F["2d"==I?"ctx":"gl"]=P;var L=F;L.Clear=()=>{if("2d"===I)_.width=L.c.width;else P.clearColor(..._e(L.clearColor),1),P.clear(P.COLOR_BUFFER_BIT),P.clear(P.DEPTH_BUFFER_BIT)};return L.Draw=(e,a=!1,t=!1)=>{var n,i,s=e.shader.datasets[e.datasetIdx],c=s.program;if(1==e.alpha||e.isLine||e.isParticle||e.isLight||e.isSprite?P.disable(P.CULL_FACE):(P.blendFunc(P.SRC_ALPHA,P.ONE),P.enable(P.BLEND),P.enable(P.CULL_FACE),1==e.alpha&&(P.disable(P.DEPTH_TEST),P.cullFace(P.FRONT))),L.optionalPlugins.map((e=>{if("post processing"===e.name)if("equirectangular"===e.value)e.enabled&&(n=!0,L.equirectangularPlugin=!0,i=!(-1==e.params.indexOf("omitsplitcheck")));else n=!1,L.equirectangularPlugin=!1})),void 0!==e?.shader)if(!a&&(e.isSprite||e.isLight&&e.showSource)){switch(e.shapeType){case"sprite":case"point light":l="alphaQueue"}L[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...L[l]]}else{if(!a&&(e.isLine||e.isParticle)){var l;switch(e.shapeType){case"particles":l="particleQueue";break;case"lines":l="lineQueue"}L[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:structuredClone(e.vertices),geometry:e},...L[l]]}e.isShapeArray&&D(e),P.useProgram(c),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,e.flatShading?P.NEAREST:P.LINEAR);for(var p=0;p<(n&&!i?2:1);p++){if(P.uniform1i(s.locRotationMode,e.rotationMode),L.locPlugin=P.getUniformLocation(s.program,"plugin"),L.locOmitSplitCheck=P.getUniformLocation(s.program,"omitSplitCheck"),L.locSplitCheckPass=P.getUniformLocation(s.program,"splitCheckPass"),P.uniform1f(L.locPlugin,n?1:0),P.uniform1f(L.locOmitSplitCheck,i?1:0),P.uniform1f(L.locSplitCheckPass,p),e.showBounding)B(e,L,e.showBounding,n,i,p);if("particles"==e.shapeType||e.isParticle||"lines"==e.shapeType||e.isLine){if(L.ctx.blendFunc(P.ONE,P.SRC_ALPHA),L.ctx.enable(P.BLEND),P.uniform1f(s.locPointSize,e.size*(t?3:1)),"lines"==e.shapeType&&P.lineWidth(e.size*(t?3:1)),P.uniform1f(s.locIsParticle,e.isParticle),P.uniform1f(s.locIsLine,e.isLine),P.uniform1f(s.locPenumbraPass,e.penumbraPass?1:0),P.uniform1f(s.locT,L.t),P.uniform1f(s.locColorMix,e.colorMix),P.uniform1f(s.locIsSprite,e.isSprite),P.uniform1f(s.locIsLight,e.isLight),P.uniform1f(s.locCameraMode,"fps"==L.cameraMode.toLowerCase()?1:0),P.uniform1f(s.locAlpha,Math.min(1,Math.max(0,t?e.alpha*e.penumbra:e.alpha))),P.uniform3f(s.locColor,..._e(e.color)),P.uniform1f(s.locAmbientLight,z/8),P.uniform2f(s.locResolution,L.width,L.height),P.uniform3f(s.locCamPos,L.x,L.y,L.z),P.uniform3f(s.locCamOri,L.roll,L.pitch,L.yaw),P.uniform3f(s.locGeoPos,e.x,e.y,e.z),P.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(s.locFov,L.fov),P.uniform1f(s.locEquirectangular,e.equirectangular?1:0),P.uniform1f(s.locRenderNormals,0),e?.vertices?.length){var h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_;if(e.isLine){m=[];for(var I=L.fov,w=e.size*(t?4:1)/50,F=0;F<e.vertices.length;F+=6)R=e.vertices[F+0],E=e.vertices[F+1],M=e.vertices[F+2],A=e.vertices[F+3],T=e.vertices[F+4],_=e.vertices[F+5],g=N(R,E,M,e,L),v=N(A,T,_,e,L),(g[2]>-200&&v[0]>-200||n)&&(d=Math.atan2(v[0]-g[0],v[1]-g[1])+Math.PI/2,g[0]-=L.width/2,g[1]-=L.height/2,v[0]-=L.width/2,v[1]-=L.height/2,g[0]/=I/2,g[1]/=I/2,v[0]/=I/2,v[1]/=I/2,x=g[2],y=g[0]+r(d)*w/x,b=g[1]+o(d)*w/x,m.push(y,-b,x),x=g[2],y=g[0]-r(d)*w/x,b=g[1]-o(d)*w/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*w/x,b=v[1]-o(d)*w/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*w/x,b=v[1]-o(d)*w/x,m.push(y,-b,x),x=v[2],y=v[0]+r(d)*w/x,b=v[1]+o(d)*w/x,m.push(y,-b,x),x=g[2],y=g[0]+r(d)*w/x,b=g[1]+o(d)*w/x,m.push(y,-b,x));m=new Float32Array(m),u=P.createBuffer(),P.bindBuffer(P.ARRAY_BUFFER,u),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,null),f=new Uint32Array(Array(m.length/3).fill().map(((e,a)=>a))),h=P.createBuffer(),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),P.bufferData(P.ELEMENT_ARRAY_BUFFER,f,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null)}else m=e.vertices,h=e.Vertex_Index_Buffer,u=e.vertex_buffer,f=e.vIndices;P.bindBuffer(P.ARRAY_BUFFER,u),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),P.bufferData(P.ELEMENT_ARRAY_BUFFER,f,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,u),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,h),s.locPosition=P.getAttribLocation(s.program,"position"),P.vertexAttribPointer(s.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locPosition),e.isLine?P.drawElements(P.TRIANGLES,m.length/3|0,P.UNSIGNED_INT,0):P.drawElements(P.POINTS,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)}if(L.ctx.blendFunc(P.ONE,P.ZERO),L.ctx.disable(P.BLEND),t)return}else{switch(P.activeTexture(P.TEXTURE0),e.textureMode){case"video":case"dataArray":U(P,s.resource,s.texture,e.textureMode,L.t,e);break;case"canvas":P.activeTexture(P.TEXTURE2),U(P,e.canvasTexture,s.texture,e.textureMode,L.t,e);break;case"image":e.rebindTextures&&U(P,e.image,s.texture,e.textureMode,L.t,e)}void 0!==e.canvasTexture&&(P.activeTexture(P.TEXTURE2),U(P,e.canvasTexture,s.supplementalTexture,"canvas",L.t,e),P.uniform1i(s.locSupplementalTexture,2),P.uniform1f(s.locSupplementalTextureMix,e.canvasTextureMix)),P.activeTexture(P.TEXTURE0),P.uniform1i(s.locTexture,s.texture),P.bindTexture(P.TEXTURE_2D,s.texture),e.heightMap?(P.activeTexture(P.TEXTURE4),P.uniform1i(s.locHeightMap,4),U(P,s.heightResource,s.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,L.t,e),P.uniform1i(s.locHeightTexture,s.heightTexture),P.uniform1f(s.locUseHeightMap,1),P.uniform1f(s.locHeightMapIntensity,e.heightMapIntensity),P.uniform1f(s.locMaxHeightmap,e.maxHeightmap),P.uniform1f(s.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),P.bindTexture(P.TEXTURE_2D,s.heightTexture),P.activeTexture(P.TEXTURE0)):P.uniform1f(s.locUseHeightMap,0),P.uniform1i(s.locPointLightCount,L.pointLights.length);var C=[],k=[];L.pointLights.map((e=>{C.push(e.x,e.y,e.z,e.lum);_e(e.color);k.push(..._e(e.color),1)})),C.length&&(P.uniform4fv(s.locPointLights,C),P.uniform4fv(s.locPointLightCols,k));var z=L.ambientLight;s.optionalLighting.map((e=>{if("ambientLight"===e.name)z=e.value})),P.useProgram(c),L.hasFog||(P.uniform1f(s.locFog,0),P.uniform3f(s.locFogColor,...L.fogColor)),s.optionalUniforms.map((a=>{if("object"==typeof a?.loc)switch("uniform4f"==a.dataType?P[a.dataType](a.loc,...a.value):P[a.dataType](a.loc,a.value),P.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"fog":P.uniform1f(s.locFog,a.value),P.uniform3f(s.locFogColor,..._e(a.color));break;case"reflection":P.activeTexture(P.TEXTURE1),"image"==a.textureMode&&e.rebindTextures&&U(P,a.image,a.refTexture,a.textureMode,L.t,a),"video"==a.textureMode&&U(P,a.video,a.refTexture,a.textureMode,L.t,a),P.activeTexture(P.TEXTURE1),P.uniform1i(a.locRefTexture,1),P.bindTexture(P.TEXTURE_2D,a.refTexture),P.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"refraction":P.activeTexture(P.TEXTURE5),"video"==a.textureMode&&U(P,a.video,a.refractionTexture,a.textureMode,L.t,a),P.activeTexture(P.TEXTURE5),P.uniform1i(a.locRefractionTexture,5),P.bindTexture(P.TEXTURE_2D,a.refractionTexture),P.uniform1f(a.locRefractionOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0),a.locAngleOfRefraction=P.getUniformLocation(s.program,"angleOfRefraction"),P.uniform1f(a.locAngleOfRefraction,a.angleOfRefraction),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bufferData(P.ARRAY_BUFFER,a.refractionVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,a.refractionVecIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.vertexAttribPointer(s.locRefractionlVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locRefractionlVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null);break;case"phong":a.locPhongTheta=P.getUniformLocation(s.program,"phongTheta"),P.uniform1f(a.locPhongTheta,a.theta+Math.PI);break;case"custom":if(a.uniformName){a.locCustomUniform=P.getUniformLocation(s.program,a.uniformName);var t=a.value;ye(t)?P[a.dataType](a.locCustomUniform,...a.value):P[a.dataType](a.locCustomUniform,a.value)}}})),P.uniform1f(s.locT,L.t),P.uniform1f(s.locIsParticle,e.isParticle),P.uniform1f(s.locIsLine,e.isLine),P.uniform1f(s.locPenumbraPass,0),P.uniform1f(s.locColorMix,e.colorMix),P.uniform1f(s.locIsSprite,e.isSprite),P.uniform1f(s.locIsLight,e.isLight),P.uniform1f(s.locCameraMode,"fps"==L.cameraMode.toLowerCase()?1:0),P.uniform1f(s.locAlpha,e.alpha),P.uniform3f(s.locColor,..._e(e.color)),P.uniform1f(s.locAmbientLight,z/8),P.uniform2f(s.locResolution,L.width,L.height),P.uniform3f(s.locCamPos,L.x,L.y,L.z),P.uniform3f(s.locCamOri,L.roll,L.pitch,L.yaw),P.uniform3f(s.locGeoPos,e.x,e.y,e.z),P.uniform3f(s.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(s.locFov,L.fov),P.uniform1f(s.locEquirectangular,e.equirectangular?1:0),P.uniform1f(s.locRenderNormals,0),P.bindBuffer(P.ARRAY_BUFFER,e.uv_buffer),P.bufferData(P.ARRAY_BUFFER,e.uvs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.uvIndices,P.STATIC_DRAW),P.vertexAttribPointer(s.locUv,2,P.FLOAT,!1,0,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null),e?.normalVecs.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bufferData(P.ARRAY_BUFFER,e.normalVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),s.locNormalVec=P.getAttribLocation(s.program,"normalVec"),P.vertexAttribPointer(s.locNormalVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locNormalVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)),e?.vertices?.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.vIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),P.bufferData(P.ARRAY_BUFFER,e.vertices,P.STATIC_DRAW),P.vertexAttribPointer(s.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(s.locPosition),s.locNormal=P.getAttribLocation(s.program,"position"),P.drawElements(e.wireframe?P.LINE_STRIP:P.TRIANGLES,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)),P.uniform1f(s.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),P.vertexAttribPointer(s.locNormal,3,P.FLOAT,!1,0,0),s.locNormal=P.getAttribLocation(s.program,"normal"),P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bufferData(P.ARRAY_BUFFER,e.normals,P.STATIC_DRAW),P.enableVertexAttribArray(s.locNormal),P.drawElements(P.LINES,e.normals.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null))}}}e.rebindTextures=!1},L.nullShader=await V(L,[{uniform:{type:"phong",value:0}}]),L.alphaShader=await V(L,[]),window.addEventListener("mousemove",(e=>{var a=L.c.getBoundingClientRect();L.mouseX=(e.pageX-a.left)/L.c.clientWidth*L.width,L.mouseY=(e.pageY-a.top)/L.c.clientHeight*L.height})),window.addEventListener("mousedown",(e=>{L.mouseButton=e.buttons})),window.addEventListener("mouseup",(e=>{L.mouseButton=-1})),L},f=(e,a,t)=>{if(e.width=a,e.height=t,e.c.width=a,e.c.height=t,e.rsz(),"2d"===e.ctx.mode);else e.ctx.viewport(0,0,e.c.width,e.c.height)},m=e=>{e.c.remove(),e.active=!1},g=e=>{if("point light"===e.shapeType)e.renderer.pointLights=e.renderer.pointLights.filter(((a,t)=>t!=e.pointLightID)),e.renderer.pointLights.map(((e,a)=>e.pointLightID=a))},v=(e,a,t,r,o,n)=>{var i;e.split("\n").forEach((e=>{var n=e.split(" ");switch(n[0]){case"v":n.shift(),a.push(n.map((e=>+e)));break;case"vt":n.shift(),r.push(n.map((e=>+e)));break;case"vn":n.shift(),t.push(n.map((e=>+e)));break;case"f":n.shift(),o.push(n.map((e=>e)))}})),o.map((e=>{var o,s,c,l=[],p=[],h=[],u=!1;if(e.map((e=>{var n=e.split("/");switch(n.length){case 1:o=n[0],l.push(a[o-1]);break;case 2:o=n[0],s=n[1],l.push(a[o-1]),p.push(r[s-1]),!0;break;case 3:o=n[0],s=n[1],c=n[2],l.push(a[o-1]),p.push(r[s-1]),h.push(t[c-1]),u=!0}})),void 0!==l[0]){var f=l[0][0],m=l[0][1],d=l[0][2],g=l[1][0],v=l[1][1],y=l[1][2],b=l[2][0],x=l[2][1],R=l[2][2];if(u)var E=h[0][0],M=h[0][1],A=h[0][2],T=h[1][0],_=h[1][1],P=h[1][2],I=h[2][0],w=h[2][1],F=h[2][2];if(4==l.length){var L=l[3][0],C=l[3][1],k=l[3][2];if(u)var U=h[3][0],z=h[3][1],S=h[3][2]}}switch(l.length){case 3:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+M,d+A],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F])})),h=i,n.vertices.push(...l[0],...l[1],...l[2]),p.length&&void 0!==p[0]&&n.uvs.push(...p[0],...p[1],...p[2]),h.length&&void 0!==h[0]&&n.normals.push(...h[0],...h[1],...h[2]);break;case 4:i=[],h.map(((e,a)=>{i.push([f,m,d,f+E,m+M,d+A],[g,v,y,g+T,v+_,y+P],[b,x,R,b+I,x+w,R+F],[L,C,k,L+U,C+z,k+S])})),h=i,n.vertices.push(...l[0],...l[1],...l[2],...l[2],...l[3],...l[0]),p.length&&n.uvs.push(...p[0],...p[1],...p[2],...p[2],...p[3],...p[0]),h.length&&n.normals.push(...h[0],...h[1],...h[2],...h[2],...h[3],...h[0])}var N=n.normals.length-7;n.normals[N+3],n.normals[N+0],n.normals[N+4],n.normals[N+1],n.normals[N+5],n.normals[N+2]}))},y=(e,a=0,t=0,r=0,o=0,n=0,i=0)=>{for(var s=0;s<e.uvs.length;s+=2)e.uvs[s+1]=1-e.uvs[s+1];for(s=0;s<e.normals.length;s+=3)e.normals[s+1]=e.normals[s+1];for(s=0;s<e.vertices.length;s+=3){var c=[e.vertices[s+0],e.vertices[s+1],e.vertices[s+2]];c=M(...c,{roll:o,pitch:n,yaw:i}),e.vertices[s+0]=c[0],e.vertices[s+1]=c[1],e.vertices[s+2]=c[2];for(var l=2;l--;){var p=l?2*s:2*s+3;c=[e.normals[p+0],e.normals[p+1],e.normals[p+2]];c=M(...c,{roll:o,pitch:n,yaw:i}),e.normals[p+0]=c[0],e.normals[p+1]=c[1],e.normals[p+2]=c[2]}}},b=async(e,a,t,r,o,n,i,s,c=!0,p=!0)=>{var u={vertices:[],normals:[],uvs:[]};if(p&&(l=h.objFiles.filter((a=>a.url==e))).length)u=l[0].ret;else{var f=[],m=[],d=[],g=[];await fetch(e).then((e=>e.text())).then((e=>{v(e,f,m,d,g,u)})),h.objFiles=[...structuredClone(h.objFiles),{url:e,ret:u}]}return y(u,t,r,o,n,i,s),u},x=(e,a,t,r,o=700)=>[r.width/2+e/t*o,r.height/2+a/t*o],R=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},E=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},M=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},A=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},T=(e,a,t,n,i=!1)=>{var s,c,l=Math,p=l.hypot,h=l.atan2,u=n.roll,f=n.pitch,m=n.yaw;(e=r(s=h(e,a)+u)*(c=p(e,a)),a=o(s)*c,e=r(s=h(e,t)+m)*(c=p(e,t)),t=o(s)*c,a=r(s=h(a,t)+f)*(c=p(a,t)),t=o(s)*c,i)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},_=(e,a,t)=>{var r=[],o=a.name,n={loaded:!1,curFrame:0,geometries:[],dir:1};return fetch(a.url).then((e=>e.blob())).then((i=>{new zip.ZipReader(new zip.BlobReader(i)).getEntries().then((i=>{var s=i.length;r=Array(s).fill().map((e=>({data:{}}))),i.forEach((async(i,c)=>{(await i.getData(await new zip.BlobWriter)).text().then((i=>{do{0}while("PK"==i.substr(0,2));if("custom shape"!=a.shapeType&&"lines"!=a.shapeType||(i=JSON.parse(i)),r[c].data=i,c==s-1){n.loaded=!0;var l=new zip.ZipWriter(new zip.BlobWriter);r.forEach(((r,i)=>{var c=(""+(i+1)).padStart(4,"0");i%1||!("lines"!=a.shapeType&&"custom shape"!=a.shapeType||void 0!==r.data.vertices&&r.data.vertices.length)||(a.geometryData=r.data,a.name=`${o?o+"_":""}frame${c}.json`,a.isFromZip=!0,L(e,a).then((async e=>{n.geometries[i/1|0]=e,await t.ConnectGeometry(e);for(var r=[],o=[],c=[],p=[],h=0;h<e.vertices.length;h++)r.push(Math.round(1e3*e.vertices[h])/1e3);for(h=0;h<e.uvs.length;h++)p.push(Math.round(1e3*e.uvs[h])/1e3);for(h=0;h<e.normals.length;h+=3)o.push(Math.round(1e3*e.normals[h+0])/1e3),o.push(Math.round(1e3*e.normals[h+1])/1e3),o.push(Math.round(1e3*e.normals[h+2])/1e3);for(h=0;h<e.normalVecs.length;h++)c.push(Math.round(1e3*e.normalVecs[h])/1e3);var u={vertices:r,uvs:p,normals:o,normalVecs:c},f=new zip.TextReader(JSON.stringify(u)),m=(""+(i+1)).padStart(4,"0");l.add(`frame_${m}.json`,f),i==s-1&&a.downloadShape&&await F(await l.close(),"animation.zip")})))}))}}))}))}))})),n},P=(e,a,t)=>{var r=e.t,o=0,n=0,i=0,s=0,c=0,l=0,p="reverse",h=1;if(void 0!==t&&Object.keys(t).forEach(((e,a)=>{switch(e.toLowerCase()){case"x":o=+t[e];break;case"y":n=+t[e];break;case"z":i=+t[e];break;case"roll":s=+t[e];break;case"pitch":c=+t[e];break;case"yaw":l=+t[e];break;case"loopmode":p=t[e];break;case"animationspeed":h=1/+t[e]|0}})),void 0!==a&&a.loaded&&a.geometries.length){for(var u=1;u--;){if(!h||(60*r|0)%h||(a.curFrame+=a.dir),a.curFrame>=a.geometries.length-("cycle"==p?0:1))if("cycle"===p)a.curFrame=0;else a.dir=-1;if(a.curFrame<("cycle"==p?0:1))if("cycle"===p)a.curFrame=a.geometries.length-1;else a.dir=1}var f=a.geometries[a.curFrame];void 0!==f&&void 0!==f.vertices&&f.vertices.length&&(f.x=o,f.y=n,f.z=i,f.roll=s,f.pitch=c,f.yaw=l,e.Draw(f))}},I=e=>{var a="",t=[],r=[],o=[],n=[];if(e?.vertices){t=e.vertices;for(var i=0,s=[],c=0;c<t.length;c+=3){var l=-Math.round(1e4*t[c+0])/1e4,p=Math.round(1e4*t[c+1])/1e4,h=Math.round(1e4*t[c+2])/1e4;a+=`v ${l} ${p} ${h}\n`,s.push(c/3),3==++i&&(i=0,n.push(s),s=[])}}if(e?.normalVecs){o=e.normalVecs;var u=e.resolved?1:-1;for(c=0;c<o.length;c+=3){var f=Math.round(1e4*o[c+0])/1e4*u,m=-Math.round(1e4*o[c+1])/1e4*u,d=-Math.round(1e4*o[c+2])/1e4*u;a+=`vn ${f} ${m} ${d}\n`}}if(e?.uvs){r=e.uvs;for(c=0;c<r.length;c+=2){var g=Math.round(1e4*r[c+0])/1e4,v=Math.round(1e4*r[c+1])/1e4;a+=`vt ${g} ${v}\n`}}return n.forEach(((e,t)=>{var r=t/1|0;a+=`f ${3*r+1}/${2*r+1}/${3*r+1} ${3*r+2}/${2*r+2}/${3*r+2} ${3*r+3}/${2*r+3}/${3*r+3}\n`})),a},w=e=>{if(e.preComputeNormalAssocs){console.log("downloading custom shape, detected preComputeNormalAssocs");var a=[]}for(var t=[],r=[],o=[],n=[],i=0;i<e.vertices.length;i++)t.push(Math.round(1e3*e.vertices[i])/1e3);if(e.equirectangular){var s,c,l,p,h,u;for(i=0;i<e.vertices.length;i+=3)p=e.vertices[i+0],h=e.vertices[i+1],u=e.vertices[i+2],s=Math.hypot(p,h,u)+1e-4,c=Math.atan2(p,u)/Math.PI/2,l=Math.acos(h/s)/Math.PI,c=Math.round(1e3*c)/1e3,l=Math.round(1e3*l)/1e3,n.push(c,l)}else for(i=0;i<e.uvs.length;i++)n.push(Math.round(1e3*e.uvs[i])/1e3);for(i=0;i<e.normals.length;i++)r.push(Math.round(1e3*e.normals[i])/1e3);for(i=0;i<e.normalVecs.length;i++)o.push(Math.round(1e3*e.normalVecs[i])/1e3);if(e.preComputeNormalAssocs)for(i=0;i<e.normalAssocs.length;i++)a.push(e.normalAssocs[i]);if(e.preComputeNormalAssocs)var f={vertices:t,uvs:n,normals:r,normalVecs:o,normalAssocs:a};else f={vertices:t,uvs:n,normals:r,normalVecs:o};var m=document.createElement("a");m.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(f)),e.name||e.name,m.download=(e.name?e.name:e.shapeType)+".json",m.click()},F=(e,a="downloaded_file")=>{var t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download=a,t.click(),window.URL.revokeObjectURL(e)},L=async(a,t)=>{var r,o,n,i,s,c,u,f,m,d,g,x,R,E,A,T,_,P,F,L,C;const k=a.gl;var U,z,S,N=!1,B=!1,V=!1,D=!1,Y=0,X=0,H=0,G=!1,W=!1,re=!1,oe=0,se=0,ce=0,le=1,pe=1,he=1,ue=1,fe=1,me=0,de=0,ge=!1,ve=16,ye=40,be="",xe="",Re=1,Ee=!1,Me=0,Ae=0,Te=3355443,_e=.1,Pe=!1,Ie=-1,we=0,Fe=-1,Le=!1,Ce=!1,ke=!1,Ue="",ze=!1,Se="",Ne=1,Be=6e6,Oe=!1,Ve=-1,De=!0,Ye=8978210,Xe=!1,He=0,qe=0,Ge=0,We=0,je=!1,$e=0,Ke=1,Ze=!0,Qe="image",Je=!1,ea=!1,aa=!1,ta=512,ra=512,oa=k.RGBA,na=!1,ia=512,sa=512,ca=k.RGBA,la=1,pa=1,ha=[],ua=[],fa={};Object.keys(t).forEach(((e,a)=>{if("showsource"===e.toLowerCase())Je=!!t[e]})),Object.keys(t).forEach(((a,l)=>{switch(a.toLowerCase()){case"x":Y=t[a];break;case"y":X=t[a];break;case"z":H=t[a];break;case"roll":oe=t[a];break;case"pitch":se=t[a];break;case"yaw":ce=t[a];break;case"shapetype":switch(A=t[a].toLowerCase()){case"sprite":Ue=`${e}/resources/sprite.png`;break;case"point light":Ue=Je?`${e}/resources/stars/star.png`:""}break;case"size":Re=t[a];break;case"subs":Me=t[a];break;case"equirectangular":Ie=!!t[a];break;case"equirectangularheightmap":Fe=!!t[a];break;case"flipnormals":Ce=!!t[a];break;case"shownormals":ke=!!t[a];break;case"sphereize":Ae=t[a];break;case"rotationmode":we=t[a];break;case"rebindtextures":ge=!!t[a];break;case"flipx":G=t[a];break;case"flipy":W=t[a];break;case"flipz":re=t[a];break;case"objx":r=t[a];break;case"objy":o=t[a];break;case"objz":n=t[a];break;case"objroll":i=t[a];break;case"objpitch":s=t[a];break;case"objyaw":c=t[a];break;case"scaleuvx":ue=t[a];break;case"scaleuvy":fe=t[a];break;case"offsetuvx":me=t[a];break;case"offsetuvy":de=t[a];break;case"scalex":le=t[a];break;case"scaley":pe=t[a];break;case"scalez":he=t[a];break;case"wireframe":je=!!t[a];break;case"name":xe=t[a];break;case"color":Te=t[a];break;case"colormix":_e=t[a];break;case"mapisdataarray":aa=!!t[a];break;case"dataarraywidth":ta=+t[a];break;case"dataarrayheight":ra=+t[a];break;case"dataarrayformat":oa=t[a];break;case"heightmapisdataarray":na=!!t[a];break;case"heightmapdataarraywidth":ia=+t[a];break;case"heightmapdataarrayheight":sa=+t[a];break;case"heightpamdataarrayformat":ca=t[a];break;case"exportshape":N=!!t[a];break;case"downloadshape":B=!!t[a];break;case"exportasobj":V=!!t[a];break;case"downloadasobj":D=!!t[a];break;case"penumbra":$e=t[a];break;case"url":be=t[a];break;case"map":Ue=t[a];break;case"heightmap":Se=t[a];break;case"heightmapintensity":Ne=t[a];break;case"maxheightmap":Be=+t[a];break;case"heightmapiscanvas":Oe=!!t[a];break;case"rows":ve=t[a];break;case"cols":ye=t[a];break;case"disabledepthtest":ea=t[a];break;case"canvastexturemix":Ve=t[a];break;case"canvastexture":L=t[a],Qe="canvas";break;case"involvecache":Ze=!!t[a];break;case"muted":De=!!t[a];break;case"lum":la=t[a];break;case"alpha":pa=t[a];break;case"geometrydata":ha=t[a];break;case"precomputenormalassocs":Le=!!t[a];break;case"texcoords":ua=t[a];break;case"boundingcolor":Ye=t[a];break;case"showbounding":Xe=!!t[a];break;case"issprite":He=t[a]?1:0;break;case"islight":qe=t[a]?1:0;break;case"isparticle":Ge=t[a]?1:0;break;case"isline":We=t[a]?1:0;break;case"playbackspeed":Ke=t[a];break;case"averagenormals":Ee=!!t[a];break;default:fa[a]=t[a]}})),void 0===r&&(r=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0!==t.canvasTexture?(-1==Ve&&(Ve=1),z=t.canvasTexture,delete t.canvasTexture):Ve=0,t.heightMapIsCanvas&&(S=t.heightMap,delete t.heightMap),t=structuredClone(t),void 0!==z&&(t.canvasTexture=z),void 0!==S&&(t.heightMap=S);var ma,da,ga=[],va=[],ya=[],ba=[],xa=!1;if(-1!=A.indexOf("custom shape")||be&&"lines"==A)ma=be,da=`${A} ${xe} (${be})`;else if(da=`${A}_${Me}`,Me<5&&da)switch(da){case"cylinder_0":case"cylinder_1":case"cylinder_2":case"cylinder_3":case"torus_0":case"torus knot_0":case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"tetrahedron_5":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"octahedron_5":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"cube_5":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"dodecahedron_5":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"icosahedron_5":if(Ae<0&&(Ae/=-1!=da.indexOf("tetrahedron")?3:1,Ae/=-1!=da.indexOf("octahedron")?2:1,Ae/=-1!=da.indexOf("cube")?1.5:1),"torus_0"!=da||16==ve&&40==ye||"torus_0"==da&&16==ve&&40==ye||"torus knot_0"==da&&16==ve&&40==ye)if(Pe=!0,ma=`${be=`${e}/new%20shapes/`}${da}.json?4`,Ze&&(l=h.geometry.filter((e=>e.url==ma))).length)console.log(`found geometry (${da}) in cache... using it`),void 0!==(Ra=l[0].data).normalAssocs&&(C=Ra.normalAssocs),ya=new Float32Array(Ra.vertices),va=new Float32Array(Ra.normals),ba=new Float32Array(Ra.normalVecs),ga=new Float32Array(Ra.uvs),xa=!0,Pe=!0;else await fetch(ma).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(C=e.normalAssocs),ya=e.vertices,va=e.normals,ba=e.normalVecs.map((e=>-e)),ga=e.uvs,h.geometry.push({data:structuredClone(e),url:ma})})),Pe=!0}if(!Pe)switch(A){case"custom shape":case"lines":if("lines"==A){if(!be)break;We=!0}var Ra;if(void 0===ha.vertices&&Ze&&(l=h.customShapes.filter((e=>e.url==be))).length)console.log("found custom shape in cache... using it"),void 0!==(Ra=l[0].data).normalAssocs&&(C=Ra.normalAssocs),ya=Ra.vertices,va=Ra.normals,ba=Ra.normalVecs,ga=Ra.uvs,Pe=!0,xa=!0;Pe||(void 0!==ha.vertices&&ha.vertices.length?(void 0!==ha.normalAssocs&&(C=ha.normalAssocs),ya=ha.vertices,va=ha.normals,ba=ha.normalVecs,ga=ha.uvs,Pe=!0):await fetch(ma).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(C=e.normalAssocs),ya=e.vertices,va=e.normals,ba=e.normalVecs,ga=e.uvs,Pe=!0,h.customShapes.push({data:structuredClone(e),url:be})})))}if(Pe)switch(A){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==Ie&&(Ie=!0),-1==Fe&&(Fe=!0)}else switch(A){case"tetrahedron":Ae/=Ae<0?3:1,-1==Ie&&(Ie=!0),-1==Fe&&(Fe=!0),(U=await Z(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"octahedron":Ae/=Ae<0?2:1,-1==Ie&&(Ie=!0),-1==Fe&&(Fe=!0),(U=await Q(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"icosahedron":-1==Ie&&(Ie=!0),-1==Fe&&(Fe=!0),(U=await J(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"torus":(U=await $(Re,Me,Ae,Ce,A,ve,ye)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"torus knot":(U=await K(Re,Me,ve,ye,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"cylinder":(U=await j(Re,Me,ve,ye,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"dynamic":(U=await q(ha,ua,Re,Me+1,Ae,Ce,!!ha.filter((e=>4==e.length)).length,A)).geometry.map((e=>{ya.push(...e.position),Ce?va.push(...e.normal.map((e=>-1*e))):va.push(...e.normal),void 0!==e.texCoord&&e.texCoord.length&&ga.push(...e.texCoord)}));break;case"lines":We=1,ha.map((e=>{ya.push(...e)}));break;case"bspline":We=1,t.omitShape=!0,await ie(a,t).then((e=>{e.curve.map((e=>{ya.push(...e)}))}));break;case"curveto":We=1,t.omitShape=!0,await ne(a,t).then((e=>{e.map((e=>{ya.push(...e)}))}));break;case"cube":Ae/=Ae<0?1.5:1,(U=await ae(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"rectangle":(U=await te(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"sprite":He=!0,(U=await te(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"particles":Ge=1,ha.map((e=>{ya.push(...e)}));break;case"point light":qe=!0,(U=Je?await te(Math.max(Re,.5),Me+1,Ae,Ce,A):{geometry:[]}).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}));break;case"obj":if(ha.length){var Ea={vertices:[],normals:[],uvs:[]};v(ha,[],[],[],[],Ea),y(Ea),ya=Ea.vertices,va=Ea.normals,ga=Ea.uvs,Pe=!0}else U=await b(be,0,0,0,0,0,0,0,!0,!0),ya=U.vertices,va=U.normals,ga=U.uvs;break;case"dodecahedron":-1==Ie&&(Ie=!0),-1==Fe&&(Fe=!0),(U=await ee(Re,Me,Ae,Ce,A)).geometry.map((e=>{ya.push(...e.position),va.push(...e.normal),ga.push(...e.texCoord)}))}if(0!=me||0!=de)for(var Ma=0;Ma<ga.length;Ma+=2)ga[Ma+0]+=me,ga[Ma+1]+=de;if(1!=ue||1!=fe)for(Ma=0;Ma<ga.length;Ma+=2)ga[Ma+0]*=ue,ga[Ma+1]*=fe;if("lines"!=A&&"particles"!=A&&!Ge&&"custom shape"!=A&&"obj"!=A&&"dynamic"!=A||1!=le||1!=pe||1!=he){var Aa=Ae,Ta=1-Ae,_a=-6e6;for(Ma=0;Ma<ya.length;Ma+=3){var Pa=ya[Ma+0],Ia=ya[Ma+1],wa=ya[Ma+2];(La=Math.hypot(Pa,Ia,wa))>_a&&(_a=La)}var Fa=-6e6;for(Ma=0;Ma<ya.length;Ma+=3){var La;Pa=ya[Ma+0]/_a,Ia=ya[Ma+1]/_a,wa=ya[Ma+2]/_a;Pa/=La=Math.hypot(Pa,Ia,wa)+1e-4,Ia/=La,wa/=La,Pa*=Aa+La*Ta,Ia*=Aa+La*Ta,wa*=Aa+La*Ta,ya[Ma+0]=Pa,ya[Ma+1]=Ia,ya[Ma+2]=wa,(La=Math.hypot(Pa,Ia,wa))>Fa&&(Fa=La)}for(Ma=0;Ma<ya.length;Ma+=3){ya[Ma+0]/=Fa,ya[Ma+1]/=Fa,ya[Ma+2]/=Fa,ya[Ma+0]*=Re*le,ya[Ma+1]*=Re*pe,ya[Ma+2]*=Re*he;var Ca=va[2*Ma+0],ka=va[2*Ma+1],Ua=va[2*Ma+2];va[2*Ma+0]+=ya[Ma+0]-Ca,va[2*Ma+1]+=ya[Ma+1]-ka,va[2*Ma+2]+=ya[Ma+2]-Ua,va[2*Ma+3]+=ya[Ma+0]-Ca,va[2*Ma+4]+=ya[Ma+1]-ka,va[2*Ma+5]+=ya[Ma+2]-Ua}}if(Ee&&O(ya,va,A,ba,Ce),"dynamic"==A||Le){C=[];for(Ma=0;Ma<ya.length;Ma+=3){for(var za=ya[Ma+0],Sa=ya[Ma+1],Na=ya[Ma+2],Ba=[],Oa=0;Oa<ya.length;Oa+=3){var Va=ya[Oa+0],Da=ya[Oa+1],Ya=ya[Oa+2];Math.hypot(za-Va,Sa-Da,Na-Ya)<.001&&Ba.push(Oa)}C.push(Ba)}}if(("custom shape"==A||"obj"==A)&&(s||i||c||r||o||n))for(Ma=0;Ma<ya.length;Ma+=3){Y=ya[Ma+0],X=ya[Ma+1],H=ya[Ma+2];var Xa=M(Y,X,H,{roll:i,pitch:s,yaw:c});if(ya[Ma+0]=Xa[0]+r,ya[Ma+1]=Xa[1]+o,ya[Ma+2]=Xa[2]+n,va.length){for(var Ha=2;Ha--;){Y=va[2*Ma+0+3*Ha],X=va[2*Ma+1+3*Ha],H=va[2*Ma+2+3*Ha];Xa=M(Y,X,H,{roll:i,pitch:s,yaw:c});va[2*Ma+0+3*Ha]=Xa[0]+r,va[2*Ma+1+3*Ha]=Xa[1]+o,va[2*Ma+2+3*Ha]=Xa[2]+n}Y=ba[Ma+0],X=ba[Ma+1],H=ba[Ma+2];Xa=M(Y,X,H,{roll:i,pitch:s,yaw:c});ba[Ma+0]=Xa[0],ba[Ma+1]=Xa[1],ba[Ma+2]=Xa[2]}}if(!(Pe||"custom shape"==A||Ge||We||Ee||xa&&Pe)){ba=[];for(Ma=0;Ma<va.length;Ma+=6){let e=va[Ma+3]-va[Ma+0],a=va[Ma+4]-va[Ma+1],t=va[Ma+5]-va[Ma+2];ba.push(e,a,t)}}if(G)for(Ma=0;Ma<ya.length;Ma+=3)ya[Ma+1]*=-1;if(W)for(Ma=0;Ma<ya.length;Ma+=3)ya[Ma+1]*=-1;if(re)for(Ma=0;Ma<ya.length;Ma+=3)ya[Ma+1]*=-1;if(Ce&&!Ee){for(Ma=0;Ma<va.length;Ma+=6)va[Ma+3]=va[Ma+0]-(va[Ma+3]-va[Ma+0]),va[Ma+4]=va[Ma+1]-(va[Ma+4]-va[Ma+1]),va[Ma+5]=va[Ma+2]-(va[Ma+5]-va[Ma+2]);for(Ma=0;Ma<ba.length;Ma+=3)ba[Ma+0]*=-1,ba[Ma+1]*=-1,ba[Ma+2]*=-1}if(N){(Ga=document.createElement("div")).style.position="fixed",Ga.style.zIndex=1e5,Ga.style.left="50%",Ga.style.top="50%",Ga.style.transform="translate(-50%, -50%)",Ga.style.background="#0008",Ga.style.padding="20px",Ga.style.width="600px",Ga.style.height="350px",Ga.style.border="1px solid #fff4",Ga.style.borderRadius="5px",Ga.style.fontFamily="monospace",Ga.style.fontSize="20px",Ga.style.color="#fff",(Wa=document.createElement("div")).style.fontSize="24px",Wa.style.color="#0f8c",Wa.innerHTML=`Export Coordinates File -> ${A} `+(t?.name?`(${t.name})`:"")+"<br><br>",Ga.appendChild(Wa),(ja=document.createElement("div")).style.minWidth="100%",ja.style.height="250px",ja.style.background="#333",ja.style.border="1px solid #fff4",ja.style.overflowY="auto",ja.style.wordWrap="break-word",ja.style.color="#888",ja.style.fontSize="10px",Ga.appendChild(ja),($a=document.createElement("button")).style.border="none",$a.style.padding="3px",$a.style.cursor="pointer",$a.fontSize="20px",$a.style.borderRadius="10px",$a.style.margin="10px",$a.style.minWidth="100px",$a.innerHTML="ðŸ“‹ copy",$a.title="copy shape data to clipboard",$a.onclick=()=>{var e=document.createRange();e.selectNode(ja),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),$a.innerHTML="COPIED!",setTimeout((()=>{$a.innerHTML="ðŸ“‹ copy"}),1e3)},Ga.appendChild($a),(Ka=document.createElement("button")).onclick=()=>Ga.remove(),Ka.style.border="none",Ka.style.padding="3px",Ka.style.cursor="pointer",Ka.fontSize="20px",Ka.style.borderRadius="10px",Ka.style.margin="10px",Ka.style.background="#faa",Ka.style.minWidth="100px",Ka.innerHTML="close",Ga.appendChild(Ka);var qa={vertices:[],normals:[],normalVecs:[],uvs:[]};ya.map((e=>qa.vertices.push(Math.round(1e3*e)/1e3))),fa.preComputeNormalAssocs&&(qa.normalAssocs=[],fa.normalAssocs.map((e=>qa.vertices.push(e))));for(Ma=0;Ma<va.length;Ma+=6){za=va[Ma+0],Sa=va[Ma+1],Na=va[Ma+2],Va=Ce?va[Ma+0]-(va[Ma+3]-va[Ma+0]):va[Ma+3],Da=Ce?va[Ma+1]-(va[Ma+4]-va[Ma+1]):va[Ma+4],Ya=Ce?va[Ma+2]-(va[Ma+5]-va[Ma+2]):va[Ma+5];za=Math.round(1e3*za)/1e3,Sa=Math.round(1e3*Sa)/1e3,Na=Math.round(1e3*Na)/1e3,Va=Math.round(1e3*Va)/1e3,Da=Math.round(1e3*Da)/1e3,Ya=Math.round(1e3*Ya)/1e3,qa.normals.push(za,Sa,Na,Va,Da,Ya)}for(Ma=0;Ma<ba.length;Ma++)qa.normalVecs.push((Ce?11:1)*Math.round(1e3*ba[Ma])/1e3);if(fa.equirectangular)for(Ma=0;Ma<fa.vertices.length;Ma+=3)hvx=fa.vertices[Ma+0],hvy=fa.vertices[Ma+1],hvz=fa.vertices[Ma+2],La=Math.hypot(hvx,hvy,hvz)+1e-4,p=Math.atan2(hvx,hvz),p1=p/Math.PI/2,p2=Math.acos(hvy/La)/Math.PI,p1=Math.round(1e3*p1)/1e3,p2=Math.round(1e3*p2)/1e3,ga.push(p1,p2);else ga.map((e=>qa.uvs.push(Math.round(1e3*e)/1e3)));ja.innerHTML=JSON.stringify(qa),document.body.appendChild(Ga)}if(V){var Ga,Wa,ja,$a,Ka;(Ga=document.createElement("div")).style.position="fixed",Ga.style.zIndex=1e5,Ga.style.left="50%",Ga.style.top="50%",Ga.style.transform="translate(-50%, -50%)",Ga.style.background="#0008",Ga.style.padding="20px",Ga.style.width="600px",Ga.style.height="350px",Ga.style.border="1px solid #fff4",Ga.style.borderRadius="5px",Ga.style.fontFamily="monospace",Ga.style.fontSize="20px",Ga.style.color="#fff",(Wa=document.createElement("div")).style.fontSize="24px",Wa.style.color="#0f8c",Wa.innerHTML=`Export OBJ File -> ${A} `+(t?.name?`(${t.name})`:"")+"<br><br>",Ga.appendChild(Wa),(ja=document.createElement("div")).style.minWidth="100%",ja.style.height="250px",ja.style.background="#333",ja.style.border="1px solid #fff4",ja.style.overflowY="auto",ja.style.wordWrap="break-word",ja.style.color="#888",ja.style.fontSize="10px",Ga.appendChild(ja),($a=document.createElement("button")).style.border="none",$a.style.padding="3px",$a.style.cursor="pointer",$a.fontSize="20px",$a.style.borderRadius="10px",$a.style.margin="10px",$a.style.minWidth="100px",$a.innerHTML="ðŸ“‹ copy",$a.title="copy shape data to clipboard",$a.onclick=()=>{var e=document.createRange();e.selectNode(ja),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),$a.innerHTML="COPIED!",setTimeout((()=>{$a.innerHTML="ðŸ“‹ copy"}),1e3)},Ga.appendChild($a),(Ka=document.createElement("button")).onclick=()=>Ga.remove(),Ka.style.border="none",Ka.style.padding="3px",Ka.style.cursor="pointer",Ka.fontSize="20px",Ka.style.borderRadius="10px",Ka.style.margin="10px",Ka.style.background="#faa",Ka.style.minWidth="100px",Ka.innerHTML="close",Ga.appendChild(Ka);var Za=I({vertices:ya,normalVecs:ba,uvs:ga,shapeType:A,averageNormals:Ee});Za=Za.replaceAll("\n","<br>"),ja.innerHTML=Za,document.body.appendChild(Ga)}xa||(ya=new Float32Array(ya),va=new Float32Array(va),ba=new Float32Array(ba),ga=new Float32Array(ga)),u=k.createBuffer(),k.bindBuffer(k.ARRAY_BUFFER,u),k.bufferData(k.ARRAY_BUFFER,ya,k.STATIC_DRAW),k.bindBuffer(k.ARRAY_BUFFER,null),T=new Uint32Array(Array(ya.length/3).fill().map(((e,a)=>a))),f=k.createBuffer(),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,f),k.bufferData(k.ELEMENT_ARRAY_BUFFER,T,k.STATIC_DRAW),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null),g=k.createBuffer(),k.bindBuffer(k.ARRAY_BUFFER,g),k.bufferData(k.ARRAY_BUFFER,ba,k.STATIC_DRAW),k.bindBuffer(k.ARRAY_BUFFER,null),P=new Uint32Array(Array(ba.length/3).fill().map(((e,a)=>a))),x=k.createBuffer(),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,x),k.bufferData(k.ELEMENT_ARRAY_BUFFER,P,k.STATIC_DRAW),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null),m=k.createBuffer(),k.bindBuffer(k.ARRAY_BUFFER,m),k.bufferData(k.ARRAY_BUFFER,va,k.STATIC_DRAW),k.bindBuffer(k.ARRAY_BUFFER,null),_=new Uint32Array(Array(va.length/3).fill().map(((e,a)=>a))),d=k.createBuffer(),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,d),k.bufferData(k.ELEMENT_ARRAY_BUFFER,_,k.STATIC_DRAW),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null),R=k.createBuffer(),k.bindBuffer(k.ARRAY_BUFFER,R),k.bufferData(k.ARRAY_BUFFER,ga,k.STATIC_DRAW),k.bindBuffer(k.ARRAY_BUFFER,null),F=new Uint32Array(Array(ga.length/2).fill().map(((e,a)=>a))),E=k.createBuffer(),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,E),k.bufferData(k.ELEMENT_ARRAY_BUFFER,F,k.STATIC_DRAW),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null),-1==Ie&&(Ie=!1),-1==Fe&&(Fe=!1);var Qa={x:Y,y:X,z:H,rows:ve,cols:ye,roll:oe,pitch:se,yaw:ce,color:Te,colorMix:_e,size:Re,subs:Me,name:xe,url:be,averageNormals:Ee,showNormals:ke,exportShape:N,downloadShape:B,shapeType:Ge?"particles":We?"lines":A,normalAssocs:C,sphereize:Ae,equirectangular:Ie,flipNormals:Ce,vertices:ya,normals:va,normalVecs:ba,uvs:ga,vertex_buffer:u,Vertex_Index_Buffer:f,normal_buffer:m,Normal_Index_Buffer:d,muted:De,normalVec_buffer:g,NormalVec_Index_Buffer:x,nVecIndices:P,uv_buffer:R,UV_Index_Buffer:E,vIndices:T,nIndices:_,uvIndices:F,map:Ue,video:undefined,textureMode:Qe,isSprite:He,isLight:qe,playbackSpeed:Ke,disableDepthTest:ea,lum:la,alpha:pa,involveCache:Ze,renderer:a,isParticle:Ge,isLine:We,penumbra:$e,wireframe:je,canvasTexture:L,canvasTextureMix:Ve,showBounding:Xe,boundingColor:Ye,heightMap:Se,heightMapIntensity:Ne,heightMapIsCanvas:Oe,equirectangularHeightmap:Fe,flipX:G,flipY:W,flipZ:re,isFromZip:ze,rotationMode:we,mapIsDataArray:aa,dataArrayFormat:oa,maxHeightmap:Be,dataArrayWidth:ta,dataArrayHeight:ra,preComputeNormalAssocs:Le,heightmapIsDataArray:na,heightmapDataArrayFormat:ca,heightmapDataArrayWidth:ia,heightmapDataArrayHeight:sa,rebindTextures:ge,exportAsOBJ:V,downloadAsOBJ:D,resolved:Pe,isShapeArray:!1};return Object.keys(Qa).forEach(((e,a)=>{fa[e]=Qa[e]})),"particles"==fa.shapeType||Ge||"lines"==fa.shapeType||We?await a.alphaShader.ConnectGeometry(fa):("point light"!=A&&"sprite"!=A||(void 0===t.color&&(fa.color=11184810),"point light"==A&&(fa.pointLightID=a.pointLights.length,a.pointLights.push(fa))),await a.nullShader.ConnectGeometry(fa)),fa.downloadShape&&w(fa),fa.downloadAsOBJ&&(e=>{console.log(`downloading '${e.name?e.name:e.shapeType}' as OBJ file`);var a=document.createElement("a");a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(I(e)),a.download=(e.name?e.name:e.shapeType)+".obj",a.click()})(fa),fa},C=async(e="",a=!1,t=(()=>{}),r=400,o=300)=>{var n=document.createElement("div");n.className="genericPopup",n.style.position="fixed",n.style.zIndex=1e5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.background="#0008",n.style.padding="20px",n.style.width=`${r}px`,n.style.height=`${o}px`,n.style.border="1px solid #fff4",n.style.borderRadius="5px",n.style.fontFamily="monospace",n.style.fontSize="20px",n.style.color="#fff";var i=document.createElement("div");if(i.style.fontSize="24px",i.style.color="#0f8c",i.innerHTML=e,n.appendChild(i),a){var s=document.createElement("button");s.onclick=()=>{t(),n.remove()},s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="SURE!",n.appendChild(s)}var c=document.createElement("button");c.onclick=()=>n.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",n.appendChild(c),document.body.appendChild(n)},k=e=>{let a=e;if(!re(e.width)||!re(e.height)){let t,r,o=document.createElement("canvas"),n=o.getContext("2d",{imageSmoothingEnabled:!0}),i=8,s=0,c=6e6,l=Math.hypot(e.width,e.height);for(let e=0;e<16;e++)(t=Math.abs(s-l))<c&&(c=t,s=i*2**e,r=e);s-=i*2**(r-1),o.width=s,o.height=s,n.drawImage(e,0,0,o.width,o.height),a=new Image,a=o}return a},U=(e,a,t,r="image",o=-1,n={},i=!0)=>{let p;switch(r){case"canvas":case"heightImage":p=a;break;case"dataArray":p=n.map,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"heightmapDataArray":p=n.heightMap,e.pixelStorei(e.UNPACK_ALIGNMENT,1);break;case"video":i&&(l=h.texImages.filter((e=>e.url==n.map&&-1!=o&&e.tVal==o))).length?(console.log("found video texture in cache... using it"),p=l[0].texImage):(p=(e=>{if(void 0!==e){let a,t;if(s.width!=e.videoWidth||s.height!=e.videoHeight?(a=e.videoWidth,t=e.videoHeight):(a=s.width,t=s.height),!re(a)||!re(t)){let e,r,o=8,n=0,i=6e6,s=Math.hypot(a,t);for(let a=0;a<12;a++)(e=Math.abs(n-s))<i&&(i=e,n=o*2**a,r=a);n-=o*2**(r-1),n=Math.min(512,n),a=n/1,t=n/1}s.width==a&&s.width==t||(s.width=a,s.height=t),c.drawImage(e,0,0,a,t)}else s.width=1,s.height=1;return s})(a),-1==o&&h.texImages.push({url:n.map,tval:o,texImage:p}));break;case"image":i&&(l=h.texImages.filter((e=>e.url==n.map))).length?(console.log("found image texture in cache... using it"),p=l[0].texImage):(p=k(a),-1==o&&h.texImages.push({url:n.map,tval:o,texImage:p}))}e.bindTexture(e.TEXTURE_2D,t),"dataArray"==r?void 0!==n.dataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.dataArrayFormat,n.dataArrayWidth,n.dataArrayHeight,0,n.dataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(p)):"heightmapDataArray"==r?void 0!==n.heightmapDataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.heightmapDataArrayFormat,n.heightmapDataArrayWidth,n.heightmapDataArrayHeight,0,n.heightmapDataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(p)):void 0!==p&&p.width&&p.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,p),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),n.flatShading&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},z=e=>{var a=e.vertices;e.preComputeNormalAssocs=!0,e.normalAssocs=[];for(var t=0;t<a.length;t+=3){for(var r=a[t+0],o=a[t+1],n=a[t+2],i=[],s=0;s<a.length;s+=3){var c=a[s+0],l=a[s+1],p=a[s+2];Math.hypot(r-c,o-l,n-p)<.001&&i.push(s)}e.normalAssocs.push(i)}},S=(e,a=!1,t=!1,r=!0,o=0,n=0,i=0)=>{for(var s,c,l,p,h,u,f,m,d,g,v=[],y=0;y<e.vertices.length;y+=9)s=e.vertices[y+0],c=e.vertices[y+1],l=e.vertices[y+2],p=e.vertices[y+3],h=e.vertices[y+4],u=e.vertices[y+5],f=e.vertices[y+6],m=e.vertices[y+7],d=e.vertices[y+8],g=pe([[s,c,l],[p,h,u],[f,m,d]],r,o,n,i),v.push(g);var b=t?1:-1;if(v.map(((a,t)=>{for(var r=0;r<3;r++)e.normals[18*t+6*r+0]=e.vertices[9*t+3*r+0],e.normals[18*t+6*r+1]=e.vertices[9*t+3*r+1],e.normals[18*t+6*r+2]=e.vertices[9*t+3*r+2],e.normals[18*t+6*r+3]=e.vertices[9*t+3*r+0]+(a[3]-a[0])*b,e.normals[18*t+6*r+4]=e.vertices[9*t+3*r+1]+(a[4]-a[1])*b,e.normals[18*t+6*r+5]=e.vertices[9*t+3*r+2]+(a[5]-a[2])*b,e.normalVecs[9*t+3*r+0]=e.normals[18*t+6*r+3]-e.normals[18*t+6*r+0],e.normalVecs[9*t+3*r+1]=e.normals[18*t+6*r+4]-e.normals[18*t+6*r+1],e.normalVecs[9*t+3*r+2]=e.normals[18*t+6*r+5]-e.normals[18*t+6*r+2]})),a){(void 0===e.normalAssocs||e.normalAssocs.length!=e.vertices.length/3|0)&&(console.log("generating normal assocs"),z(e));var x=structuredClone(e.normalVecs);for(y=0;y<e.normalVecs.length;y+=3){var R=y/3,E=[0,0,0];e.normalAssocs[R].forEach((e=>{0;for(var a=0;a<3;a++)E[a]+=x[e+a]}));for(var M=0;M<3;M++)e.normalVecs[y+M]=E[M]/=3,e.normals[2*y+M]=e.vertices[y+M],e.normals[2*y+M+3]=e.vertices[y+M]+E[M]}}},N=(e,a,t,n,i,s=0,c=0,l=0,p=0,h=0,u=!1,f=!0,m=0)=>{var d,g,v,y;if(a*=-1,n.heightMap&&Ce.length){var b;if(n.equirectangularHeightmap){var x,R=e,M=a,_=t,P=Math.hypot(R,M,_);b=[N=(x=Math.atan2(R,_))/Math.PI/2,O=Math.acos(M/(Math.hypot(R,M,_)+1e-5))/Math.PI]}else b=[p,h];var I=4*((ke.width*b[0]|0)+(ke.height*ke.width*b[1]|0)),w=Ce[I+0]/256,F=Ce[I+1]/256,L=Ce[I+2]/256,C=Math.min(n.maxHeightmap,(w+F+L)/3*n.heightMapIntensity/2);e+=s*C,a+=c*C,t+=l*C}e=(y=T(e,a*=-1,t,{roll:1e-4-n.roll,pitch:n.pitch,yaw:-n.yaw},!1))[0],a=y[1],t=-y[2],n.isLight&&(e=(y=A(e,a,t,{roll:i.roll,pitch:i.pitch,yaw:-i.yaw},!1))[0],a=y[1],t=y[2]);var k=i.x,U=i.y,z=i.z;e+=-n.x,a+=n.y,t+=-n.z,"fps"==i.cameraMode.toLowerCase()?(e=-(y=E(e+=-k,a+=U,t+=-z,{roll:i.roll,pitch:-i.pitch,yaw:i.yaw},!1))[0],a=-y[1],t=-y[2],k=0,U=0,z=0):(e=-(y=T(e,a,t,{roll:-i.roll*(n.isParticle?-1:1),pitch:i.pitch,yaw:i.yaw*(n.isParticle?-1:1)},!1))[0]*(n.isParticle?-1:1),a=-y[1],t=-y[2]);var S=!1;if(u){d=e+k,g=a-U,v=t+z;var N,B;P=Math.hypot(d,g,v);f?N=Math.atan2(d,v)/Math.PI:0==m?(x=Math.atan2(d,v)+Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,S=(N=(Math.atan2(d,v)/Math.PI+2)%2-1)<=-1,N+=.5):(x=Math.atan2(d,v)-Math.PI/2,B=Math.hypot(d,v),d=r(x)*B,v=o(x)*B,S=(N=(Math.atan2(d,v)/Math.PI+2)%2-1)>=1,N-=.5);var O=-(Math.acos(g/(P+1e-4))/Math.PI*2-1);return!S&&[i.width/2+N*i.width/2,i.height/2+O*i.height/2,P]}e+=k,a-=U,t-=z;var V=i.fov;return(v=t+(z/1e3*V+z))>0&&[d=i.width/2+e/v*V/2,g=i.height/2+a/v*V/2,v]},B=(e,a,t=!0,r=-1,o=!0,n=0,i=10)=>{if(-1==r&&(r=a.equirectangularPlugin),e.isLight)return[];var s,c,l,p,h,u=[],f=[];const m=(e,a,r=-1,o=9)=>{r!=a&&(r=a,u.push(a),A=e[a][0],T=e[a][1],p=h=-9,e.map(((t,r)=>{r!=a&&(_=e[r][0],P=e[r][1],(g=Math.atan2(P-T-1e-5,A-_))>=p&&g<=o&&(p=g,h=r))})),-9!=h&&(t&&f.push(e[h]),m(e,h,r,p)))};var d,g,v,y,b,x,R,E,M,A,T,_,P,I,w,F=[],L=-1,C=1e6,k=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(ke.width=k.heightResource.videoWidth/2,ke.height=k.heightResource.videoHeight/2):(ke.width=k.heightResource.width/2,ke.height=k.heightResource.height/2),Ue.drawImage(k.heightResource,0,0,ke.width,ke.height),Ce=ke.width?Ue.getImageData(0,0,ke.width,ke.height).data:[]);for(var U=0;U<e.vertices.length;U+=3){(!e.isLine||U%2)&&(e.isLine||!e.isParticle&&U%9)||(v=y=0,d=[]),s=e.vertices[U+0],c=e.vertices[U+1],l=e.vertices[U+2],b=U+0<e.normalVecs.length?e.normalVecs[U+0]:0,x=U+1<e.normalVecs.length?e.normalVecs[U+1]:0,R=U+2<e.normalVecs.length?e.normalVecs[U+2]:0;var z=2*(U/3|0);E=z+0<e.uvs.length?e.uvs[z+0]:0,M=z+1<e.uvs.length?e.uvs[z+1]:0;var S=N(s,c,l,e,a,b,x,R,E,M,r,o,n);S&&(d.push([S[0],S[1]]),v+=S[0],y+=S[1],(e.isLine&&U%9==3||!e.isLine&&(e.isParticle||U%9==6))&&(v/=3,y/=3,Math.hypot(v-L,y-C)>2&&(L=v,C=y,F.push(d))))}e.isParticle||e.isLine?(d=[],F.map(((e,a)=>{A=e[0][0],T=e[0][1],d.filter((e=>e[0]==A&&e[1]==T)).length||d.push([A,T])}))):(d=[],F.map(((e,a)=>{e.length>2&&(A=e[0][0],T=e[0][1],_=e[1][0],P=e[1][1],I=e[2][0],w=e[2][1],d.filter((e=>e[0]==A&&e[1]==T)).length||d.push([A,T]),d.filter((e=>e[0]==_&&e[1]==P)).length||d.push([_,P]),d.filter((e=>e[0]==I&&e[1]==w)).length||d.push([I,w]))})));var B,O=6e6,V=-1;if(d.map(((e,a)=>{e[1]<=O&&(V=a,O=e[1])})),d.length&&(m(d,V),t)){var D=Te(e.boundingColor);Le.ctx.strokeStyle=`rgba(${256*D[0]},${256*D[1]},${256*D[2]},.5)`,Le.ctx.globalAlpha=1,Le.ctx.beginPath(),f.map(((e,a)=>{Le.ctx.lineWidth=i;var t=f[a][0],r=f[a][1],s=f[B=(a+1)%f.length][0],c=f[B][1];o?Le.ctx.lineTo(s,c):0==n?t>=Le.width/2-Le.width/8&&t<Le.width+Le.width/8&&s>=Le.width/2-Le.width/8&&s<Le.width+Le.width/8&&(Le.ctx.moveTo(t,r),Le.ctx.lineTo(s,c)):t<=Le.width/2+Le.width/8&&t>-Le.width/8&&s<=Le.width/2+Le.width/8&&s>-Le.width/8&&(Le.ctx.moveTo(t,r),Le.ctx.lineTo(s,c))})),Le.ctx.closePath(),Le.ctx.stroke()}return u.map((e=>[d[e][0],d[e][1]]))},O=(e,a,t,r,o)=>{for(var n,i=[],s=H(t),c=o?-1:1,l=0;l<e.length;l+=3)l%9||(n=pe([[e[l+0],e[l+1],e[l+2]],[e[l+3],e[l+4],e[l+5]],[e[l+6],e[l+7],e[l+8]]],s)),i[2*l+0]=e[l+0],i[2*l+1]=e[l+1],i[2*l+2]=e[l+2],i[2*l+3]=e[l+0]-(n[3]-n[0])*c,i[2*l+4]=e[l+1]-(n[4]-n[1])*c,i[2*l+5]=e[l+2]-(n[5]-n[2])*c;var p,h,u,f,m,d,g,v,y,b,x,R,E,M=structuredClone(i);for(l=0;l<i.length;l+=6){m=i[l+0],d=i[l+1],g=i[l+2],h=i[l+3],u=i[l+4],f=i[l+5],p=1;for(var A=0;A<i.length;A+=6)A!=l&&(v=i[A+0],y=i[A+1],b=i[A+2],x=i[A+3],R=i[A+4],E=i[A+5],Math.hypot(m-v,d-y,g-b)<.01&&(h+=x,u+=R,f+=E,p++));M[l+3]=h/=p,M[l+4]=u/=p,M[l+5]=f/=p}M.map(((e,a)=>i[a]=e));var T="cylinder"==t||"torus"==t||"torus knot"==t?-1:1;for(l=0;l<i.length;l+=6)for(var _=3;_--;)a[l+2*_]=i[l+2*_],a[l+2*_+1]=i[l+2*_]-(i[l+2*_]+i[l+2*_+1])*c,r[l/2+_]=(i[l+3+_]-i[l+_])*c*T},V=async(e,a=[])=>{const t=e.gl;var r={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};await a.map((a=>{Object.keys(a).forEach(((t,o)=>{switch(t.toLowerCase()){case"lighting":if("ambientlight"===a[t].type.toLowerCase())if(void 0===a[t]?.enabled||a[t].enabled){var n={name:a[t].type,value:void 0===a[t].value?e.ambientLight:a[t].value};r.optionalLighting.push(n)}break;case"uniform":switch(a[t].type.toLowerCase()){case"custom":if(void 0===a[t]?.enabled||a[t].enabled){var i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,uniformName:void 0===a[t].name?"":a[t].name,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?0:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,dataType:void 0===a[t].dataType?"uniform1f":a[t].dataType,vertDeclaration:void 0===a[t].vertDeclaration?"":a[t].vertDeclaration,vertCode:void 0===a[t].vertCode?"":a[t].vertCode,fragDeclaration:void 0===a[t].fragDeclaration?"":a[t].fragDeclaration,fragCode:void 0===a[t].fragCode?"":a[t].fragCode};r.optionalUniforms.push(i)}break;case"fog":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,loc:"",value:void 0===a[t].value?.5:a[t].value,color:void 0===a[t].color?8947848:a[t].color,dataType:"uniform1f",vertDeclaration:"",vertCode:"",fragDeclaration:"",fragCode:""};e.clearColor=i.color,e.hasFog=!0,r.optionalUniforms.push(i)}break;case"reflection":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:" \n                  ",fragDeclaration:"\n                    uniform float reflection;\n                    uniform float refFlatShading;\n                    uniform float refOmitEquirectangular;\n                    uniform float refFlipRefs;\n                    uniform sampler2D reflectionMap;\n                  ",fragCode:"\n                    //light.rgb *= .5;\n                    //light.rgb += .05;\n                    float refP1, refP2;\n                    if(refOmitEquirectangular != 1.0){\n                      vec3 reflectionPos = R_rpy(nV, vec3(0.0,\n                                                      -camOri.y, -camOri.z));\n                      float px = reflectionPos.x;\n                      float py = reflectionPos.y;\n                      float pz = reflectionPos.z;\n                      refP1 = -atan(px, pz) / M_PI / 4.0;\n                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refFlipRefs == 1.0) refP2 = 1.0 - refP2;\n                    } else {\n                      refP1 = vUv.x;\n                      refP2 = vUv.y;\n                    }\n                    \n                    vec2 refCoords = vec2(1.0 - refP1 * 2.0, refP2);\n                    vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 1.0);\n                    mixColor = merge(mixColor, refCol);\n                    baseColorIp = 1.0 - reflection; //min(1.0, 2.0 - reflection);\n                    //light += reflection / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"refraction":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,angleOfRefraction:void 0===a[t].angleOfRefraction?1:a[t].angleOfRefraction,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,flatShadingUniform:"refractionFlatShading",dataType:"uniform1f",vertDeclaration:"\n                    attribute vec3 nVecRefraction;\n                    varying vec3 nVrefraction;\n                  ",vertCode:"\n                    vec3 nVrefraction = nVecRefraction;\n                  ",fragDeclaration:"\n                    uniform float refraction;\n                    uniform float refractionFlatShading;\n                    uniform float refractionOmitEquirectangular;\n                    uniform float refractionFlipRefs;\n                    uniform float angleOfRefraction;\n                    uniform sampler2D refractionMap;\n                    varying vec3 nVrefraction;\n                  ",fragCode:"\n                    float refractionP1, refractionP2;\n                    float refractionP1a, refractionP2a;\n                    float refractionP1b, refractionP2b;\n                    if(refractionOmitEquirectangular != 1.0){\n\n                      vec3 refractionPos = R_rpy(nV, vec3(0.0,-camOri.y, -camOri.z));\n\n                      float px = refractionPos.x;\n                      float py = refractionPos.y;\n                      float pz = refractionPos.z;\n                      refractionP1a = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2a = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2a = 1.0 - refractionP2a;\n\n                      refractionPos = R_rpy(nVrefraction, vec3(0.0,-camOri.y, -camOri.z));\n                      px = refractionPos.x;\n                      py = refractionPos.y;\n                      pz = refractionPos.z;\n                      refractionP1b = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2b = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2b = 1.0 - refractionP2b;\n\n                      //refractionP1a *= 0.0; //angleOfRefraction;\n                      //refractionP2a *= 1.0; //angleOfRefraction;\n                      //refractionP1 = (refractionP1a + refractionP1b) / 2.0;\n                      //refractionP2 = (refractionP2a + refractionP2b) / 2.0;\n\n                      refractionP1 = refractionP1b;\n                      refractionP2 = refractionP2b;\n\n                    } else {\n                      refractionP1a = vUv.x;\n                      refractionP2a = vUv.y;\n                    }\n                    \n                    vec2 refractionCoords = vec2(1.0 - refractionP1 * 2.0, refractionP2);\n                    vec4 refractionCol = vec4(texture2D(refractionMap, vec2(refractionCoords.x, refractionCoords.y)).rgb * 1.25, refraction / 1.0);\n                    mixColor2 = merge(mixColor2, refractionCol);\n                    baseColorIp2 = 1.0 - refraction;\n                    //light += refraction / 4.0;\n                  "};r.optionalUniforms.push(i)}break;case"phong":if(void 0===a[t]?.enabled||a[t].enabled){i={name:a[t].type,loc:"",value:void 0===a[t].value?.3:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[t].theta?.5:a[t].theta,dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:"\n                    hasPhong = 1.0;\n                  ",fragDeclaration:"\n                    uniform float phong;\n                    uniform float phongTheta;\n                    uniform float phongFlatShading;\n                  ",fragCode:"\n                    if(isLight == 0.0 &&\n                       isSprite == 0.0 &&\n                       isParticle == 0.0 &&\n                       isLine == 0.0){\n                      //light.rgb *= .5;\n                      float phongP1, phongP2;\n                      float px, py, pz;\n                      if(phongFlatShading != 0.0){\n                        px = nVec.x;\n                        py = nVec.y;\n                        pz = nVec.z;\n                      }else{\n                        vec3 phongPos = R_rpy(nV, vec3(camOri.x, 0.0, 0.0));\n                        px = phongPos.x;\n                        py = phongPos.y;\n                        pz = phongPos.z;\n                      }\n\n                      phongP1 = atan(px, pz) + phongTheta;\n                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)))-.2;\n                      \n                      //if(refFlipRefs == 1.0) phongP2 = M_PI - phongP2;\n\n                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong +\n                      pow(pow((1.0+cos(phongP1 + M_PI)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong;\n                      light = vec4(light.rgb + fact, 1.0) * 15.0;\n                    }\n                  "};r.optionalUniforms.push(i)}}}}))}));let o={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){t.enable(t.DEPTH_TEST),t.cullFace(t.BACK),e.alpha&&(t.blendFunc(t.SRC_ALPHA,t.ONE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST));let a="";r.optionalUniforms.map((e=>{a+="\n"+e.vertDeclaration+"\n"}));let n="";r.optionalUniforms.map((e=>{n+="\n"+e.vertCode+"\n"}));let s="";r.optionalUniforms.map((e=>{s+="\n"+e.fragDeclaration+"\n"}));let c="";r.optionalUniforms.map((e=>{c+="\n"+e.fragCode+"\n"})),o.vert=`\n      precision highp float;\n      #define M_PI 3.14159265358979323\n      attribute vec2 uv;\n      ${a}\n      \n      uniform float t;\n      uniform vec3 color;\n      uniform float factor;\n      uniform float flatShading;\n      uniform float ambientLight;\n      uniform float plugin;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      uniform int rotationMode;\n      uniform float omitSplitCheck;\n      uniform float splitCheckPass;\n      uniform float pointSize;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float cameraMode;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float penumbraPass;\n      uniform float fov;\n      uniform float equirectangular;\n      uniform float maxHeightmap;\n      uniform float equirectangularHeightmap;\n      uniform float renderNormals;\n      uniform vec2 resolution;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform sampler2D heightMap;\n      attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec3 normalVec;\n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      \n      vec3 pFunc(vec3 pt, float cosa, float sina,\n                          float cosb, float sinb,\n                          float cosc, float sinc){\n        float xx, xy, xz, yx, yy, yz, zx, zy, zz;\n        xx = cosa*cosb;\n        xy = cosa*sinb*sinc - sina*cosc;\n        xz = cosa*sinb*cosc + sina*sinc;\n        yx = sina*cosb;\n        yy = sina*sinb*sinc + cosa*cosc;\n        yz = sina*sinb*cosc - cosa*sinc;\n        zx = -sinb;\n        zy = cosb*sinc;\n        zz = cosb*cosc;\n        return vec3(xx*pt.x + xy*pt.y + xz*pt.z,\n                    yx*pt.x + yy*pt.y + yz*pt.z,\n                    zx*pt.x + zy*pt.y + zz*pt.z);\n      }\n      vec3 Quat(vec3 pos, vec3 rot, int isGeo){\n        \n        if(isLine != 0.0) return pos;\n        float cosa, sina, cosb, sinb, cosc, sinc;\n        vec3 ret = vec3(pos.x, pos.y, pos.z);\n        if(rotationMode == 0 || isGeo == 0){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 1 && isGeo == 1){\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 2 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 3 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        return ret;\n      }\n      \n      vec3 R(vec3 pos, vec3 rot, int isGeo){\n        if(isLine != 0.0) return pos;\n        \n        float p, d;\n        if(rotationMode == 0 || isGeo == 0) {\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 1 && isGeo == 1) {\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 2 && isGeo == 1) {\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n        }\n        return pos;\n      }\n      \n      void main(){\n        \n        hasPhong = 0.0;\n        \n        float cx, cy, cz;\n        \n        if(renderNormals == 1.0){\n          cx = normal.x;\n          cy = normal.y;\n          cz = normal.z;\n        }else{\n          cx = position.x;\n          cy = position.y;\n          cz = position.z;\n        }\n        \n        if(useHeightMap != 0.0 && renderNormals == 0.0){\n          nVeci = normalVec;\n          vec4 h;\n          float lum;\n\n          if(equirectangularHeightmap != 0.0){\n            float p;\n            float p2;\n            vec3 cpos = vec3(cx, cy, cz);\n            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);\n            float p1;\n            p1 = p / M_PI / 2.0;\n            p2 = flatShading == 1.0 ?\n                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :\n                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n            uvi = vec2(p1, p2);\n          } else {\n            uvi = uv;\n          }\n\n            \n          h = texture2D( heightMap, uvi);\n          lum = min(maxHeightmap, ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0);\n          cx += normalVec.x * lum;\n          cy += normalVec.y * lum;\n          cz += normalVec.z * lum;\n\n          \n        }else{\n          uvi = uv / 2.0;\n          uvi = vec2(uvi.x, .5 - uvi.y);\n          nVeci = normalVec;\n        }\n        \n        fPosi = vec3(cx, cy, cz);\n        \n        // camera rotation\n        \n        vec3 geo, pos;\n        float cpx = camPos.x;\n        float cpy = camPos.y;\n        float cpz = camPos.z;\n        \n        if(cameraMode == 1.0){  // 'FPS' mode\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos,  vec3(0.0, camOri.y, 0.0), 0);\n            pos = Quat(pos,  vec3(0.0, 0.0, camOri.z), 0);\n            pos = Quat(pos,  vec3(camOri.x, 0.0, 0.0), 0);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = Quat(vec3(cx, cy, cz), vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n          }\n          cpx = 0.0;\n          cpy = 0.0;\n          cpz = 0.0;\n          fPos = pos;\n        }else{\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos = Quat(pos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            \n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }\n          fPos = pos;\n        }\n        \n        ${n}\n        \n        float camz = cpz / 1e3 * fov;\n        \n        float X, Y;\n        float Z = pos.z + camz + geo.z;\n        if((isLine != 0.0 || isParticle != 0.0) &&\n          penumbraPass != 0.0) Z += .001;\n        if(isLine != 0.0){\n          X = position.x / resolution.x * fov;\n          Y = position.y / resolution.y * fov;\n          Z = position.z;\n          gl_Position = vec4(X, Y, Z/10000.0, 1.0);\n          depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n          skip = 0.0;\n          vUv = uv;\n        }else{\n          if( plugin ==  1.0 ){   // equirectangular post-processing plugin\n            X = pos.x + cpx + geo.x;\n            Y = pos.y + cpy + geo.y;\n            Z = pos.z + cpz + geo.z;\n            float dist = sqrt(X*X + Y*Y + Z*Z);\n            float p1;\n            if(omitSplitCheck == 0.0){\n              if(splitCheckPass == 0.0){\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 <= -0.75 ? 1.0 : 0.0;\n                p1 += .5;\n              }else{\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 >= 0.75 ? 1.0 : 0.0;\n                p1 -= .5;\n              }\n            }else{\n              skip = 0.0;\n              p1 = atan(X, Z) / M_PI;\n            }\n            if(skip == 0.0){\n              float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;\n              gl_PointSize = 100.0 * pointSize / dist;\n              gl_Position = vec4(p1, p2, dist/10000.0, 1.0);\n              vUv = uv;\n            }\n          } else {  // default projection\n            X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;\n            Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;\n            if(Z > 0.0) {\n              gl_PointSize = 100.0 * pointSize / Z;\n              gl_Position = vec4(X, Y, Z/10000.0, 1.0);\n              depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n              skip = 0.0;\n              vUv = uv;\n            }else{\n              skip = 1.0;\n            }\n          }\n        }\n      }\n    `,o.frag=`\n      #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n      #else\n        precision mediump float;\n      #endif\n      #define M_PI 3.14159265358979323\n      ${s}\n      uniform float t;\n      uniform float factor;\n      uniform vec2 resolution;\n      uniform float plugin;\n      uniform float flatShading;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float cameraMode;\n      uniform vec4 pointLightPos[16];\n      uniform vec4 pointLightCol[16];\n      uniform int pointLightCount;\n      uniform float ambientLight;\n      uniform float renderNormals;\n      uniform float equirectangular;\n      uniform float equirectangularHeightmap;\n      uniform float colorMix;\n      //uniform float penumbraPass;\n      uniform vec3 color;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform float maxHeightmap;\n      uniform sampler2D heightMap;\n      uniform sampler2D baseTexture;\n      uniform sampler2D supplementalTexture;\n      uniform float supplementalTextureMix;\n      uniform float alpha;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      \n        // fog //\n      uniform vec3 fogColor;\n      uniform float fog;\n        /////////\n        \n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      vec3 rgeoPos;\n      float rheightMapIntensity;\n      float rmaxHeightmap;\n\n      vec4 merge (vec4 col1, vec4 col2){\n        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);\n      }\n      \n      vec2 Coords(float flatShading, vec3 nV) {\n        vec2 ret;\n        if(equirectangular == 1.0){\n          float p;\n          float p2;\n          vec3 cpos = fPosi;\n          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n          float p1;\n          p1 = p / M_PI / 2.0;\n          p2 = flatShading == 1.0 ?\n                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n          ret = vec2(p1, p2);\n        }else{\n          ret = vUv;\n        }\n        return ret;\n      }\n\n      vec3 R_ypr(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_yrp(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_rpy(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec4 GetPointLight(){\n        \n        float ret = 0.0;\n        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);\n        for(int i=0; i < 16; i++){\n          //if(i >= pointLightCount) break;\n          vec3 lpos = pointLightPos[i].xyz;\n          lpos.x -= rgeoPos.x; //- camPos.x;\n          lpos.y -= rgeoPos.y; //- camPos.y;\n          lpos.z -= rgeoPos.z; //- camPos.z;\n          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));\n\n          float mag = pointLightPos[i].w;\n          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +\n          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 20.0;\n          \n          rgba.r += ret * pointLightCol[i].r;\n          rgba.g += ret * pointLightCol[i].g;\n          rgba.b += ret * pointLightCol[i].b;\n        }\n        \n        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);\n      }\n\n      void main() {\n\n        rgeoPos = geoPos / factor;\n        rheightMapIntensity = heightMapIntensity / factor;\n        rmaxHeightmap = maxHeightmap / factor;\n\n\n        if(isParticle != 0.0 || isLine != 0.0){\n          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));\n        }else{\n          float mixColorIp = colorMix;\n          float mixColorIp2 = 1.0;\n          float baseColorIp = 1.0 - mixColorIp;\n          float baseColorIp2 = 1.0 - mixColorIp2;\n          vec4 mixColor = vec4(color.rgb, mixColorIp);\n          vec4 mixColor2 = vec4(color.rgb, mixColorIp2);\n          vec4 light = hasPhong == 1.0 ? GetPointLight() :\n                vec4(ambientLight, ambientLight, ambientLight, 1.0);\n          float colorMag = 1.0;\n          if(skip != 1.0){\n            if(renderNormals == 1.0){\n              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }else{\n              float p;\n              vec3 nV, nVi;\n              if(useHeightMap != 0.0){\n                \n                float rad = .02;\n                float rad2 = -.25;\n                vec2 cr1, cr2, cr3;\n                float lum1, lum2, lum3;\n                for(float j=0.0; j<3.0; j+=1.0){\n                  \n                  float tx, ty;\n                  p = M_PI * 2.0 / 3.0 * j;\n                  tx = -sin(p) * rad;\n                  ty = -cos(p) * rad;\n                \n                  vec2 hcoords;\n                  if(equirectangularHeightmap == 1.0){\n                    float p;\n                    float p2;\n                    vec3 cpos = fPosi;\n                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n                    float p1;\n                    p1 = p / M_PI / 2.0;\n                    p2 = flatShading == 1.0 ?\n                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n                    tx += p1;\n                    ty += p2;\n                    hcoords = vec2(tx, ty);\n                  }else{\n                    hcoords = vUv + vec2(tx, ty);\n                  }\n                  \n                  vec4 htexel = texture2D( heightMap, hcoords);\n                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;\n                  if(j == 0.0) {\n                    lum1 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 1.0) {\n                    lum2 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 2.0) {\n                    lum3 = lum;\n                    cr2 = hcoords;\n                  }\n                }\n\n                float a1 = cr1.x;\n                float a2 = cr1.y;\n                float a3 = (lum1 - 0.5) * rad2;\n                \n                float b1 = cr2.x - a1;\n                float b2 = cr2.y - a2;\n                float b3 = (lum2 - 0.5) * rad2 - a3;\n                float c1 = cr3.x - cr2.x;\n                float c2 = cr3.y - cr2.y;\n                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;\n                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * min(maxHeightmap / 5.0, (1.0 + heightMapIntensity) / 2.0);\n                nV = normalize( nVec + anorm);\n                nVi = normalize( nVeci + anorm);\n              }else{\n                nV = nVec;\n                nVi = nVeci;\n              }\n              \n              \n              ${c}\n              vec2 coords = Coords(0.0, nVi);\n              vec4 texel = texture2D( baseTexture, coords);\n              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));\n              float fv;\n              if(isSprite != 0.0 || isLight != 0.0){\n                if(fog != 0.0){\n                  vec4 preFog = vec4(texel.rgb * 3.0, texel.a);\n                  fv = min(1.0, depth * fog) * min(alpha * 2.0, 1.0);\n                  gl_FragColor = merge(vec4(preFog.rgb, (1.0 - fv)), vec4(fogColor.rgb, 0.0));\n                }else{\n                  gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);\n                }\n              }else{\n                \n                texel.a = baseColorIp / 2.0;\n                vec4 col = merge(mixColor, texel);\n                col.a = 1.0;\n                if(baseColorIp2 != 0.0){\n                  mixColor2.a = baseColorIp2;\n                  col = merge(mixColor2, col); // refractions\n                }\n                col.rgb *= light.rgb;\n                \n                \n                if(fog != 0.0){\n                  vec4 preFog = vec4(col.rgb * colorMag, 1.0);\n                  fv = min(1.0, depth * fog);\n                  gl_FragColor = merge(vec4(preFog.rgb, 1.0 - fv), vec4(fogColor.rgb, fv));\n                }else{\n                  gl_FragColor = vec4(col.rgb * colorMag, 1.0);\n                }\n              }\n            }\n          }\n        }\n      }\n    `;const p=t.createShader(t.VERTEX_SHADER);t.shaderSource(p,o.vert),t.compileShader(p);const u=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(u,o.frag),t.compileShader(u),o.ConnectGeometry=(a,n=!1)=>{var s=a.involveCache,c=structuredClone(r);o.datasets.push(c),c.program=t.createProgram(),t.attachShader(c.program,p),t.attachShader(c.program,u),t.linkProgram(c.program),a.shader=o;var f=a.map,m=a.heightMap;if(a.datasetIdx=o.datasets.length-1,t.getProgramParameter(c.program,t.LINK_STATUS)){if(t.useProgram(c.program),t.bindBuffer(t.ARRAY_BUFFER,a.vertex_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=t.getAttribLocation(c.program,"position"),t.vertexAttribPointer(c.locPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locPosition),t.bindBuffer(t.ARRAY_BUFFER,a.uv_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=t.getAttribLocation(c.program,"uv"),t.vertexAttribPointer(c.locUv,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locUv),t.bindBuffer(t.ARRAY_BUFFER,a.normal_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=t.getAttribLocation(c.program,"normal"),t.vertexAttribPointer(c.locNormal,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormal),t.bindBuffer(t.ARRAY_BUFFER,a.normalVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=t.getAttribLocation(c.program,"normalVec"),t.vertexAttribPointer(c.locNormalVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormalVec),!n){if(a.isLight||c.optionalUniforms.map((async e=>{switch(e.name){case"fog":break;case"reflection":if(n=e.map){let a,c=(a=n.split("."))[a.length-1].toLowerCase();switch(e.refTexture=t.createTexture(),c){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=h.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,C("play audio OK?",!0,(()=>{h.textures.filter((e=>e.url==n))[0].resource.muted=!1,h.textures.filter((e=>e.url==n))[0].resource.currentTime=0,h.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE1),U(t,e.video,e.refTexture,e.textureMode,-1,{url:n}),h.textures.push({url:n,resource:e.video,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";var r=new Image;o.datasets.push({texture:e.refTexture,iURL:n}),t.uniform1f(e.locRefFlipRefs,e.flipReflections),t.bindTexture(t.TEXTURE_2D,e.refTexture),r.onload=()=>{t.activeTexture(t.TEXTURE1),U(t,r,e.refTexture,e.textureMode,-1,{url:n})},e.image=r,h.textures.push({url:n,resource:r,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE1),e.locRefOmitEquirectangular=t.getUniformLocation(c.program,"refOmitEquirectangular"),t.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefFlipRefs=t.getUniformLocation(c.program,"refFlipRefs"),t.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=t.getUniformLocation(c.program,"reflectionMap"),t.bindTexture(t.TEXTURE_2D,e.refTexture),t.uniform1i(e.locRefTexture,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e.refTexture);break;case"refraction":var n;if(n=e.map){var p,u,f,m;e.refractionVecs=[];for(var g=0;g<a.normalVecs.length;g+=3){for(var v=a.vertices[g+0],y=a.vertices[g+1],b=a.vertices[g+2],x=a.normalVecs[g+0],R=a.normalVecs[g+1],E=a.normalVecs[g+2],M=6e6,A=0;6e6==M&&A<a.vertices.length;A+=9)if(6e6==M){var T=[];p=a.vertices[A+0],u=a.vertices[A+1],f=a.vertices[A+2],T.push(p,u,f),p=a.vertices[A+3],u=a.vertices[A+4],f=a.vertices[A+5],T.push(p,u,f),p=a.vertices[A+6],u=a.vertices[A+7],f=a.vertices[A+8],T.push(p,u,f),(m=oe(v-.01*x,y-.01*R,b-.01*E,v-1e4*x,y-1e4*R,b-1e4*E,T,!0))&&(d=Math.hypot(m[0][0]-v,m[0][1]-y,m[0][2]-b))<M&&(A,M=d)}3*(g%9/3|0),e.refractionVecs.push(a.normalVecs[g+0]),e.refractionVecs.push(a.normalVecs[g+1]),e.refractionVecs.push(a.normalVecs[g+2])}let c;e.refractionVecs=new Float32Array(e.refractionVecs),e.refractionVec_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bufferData(t.ARRAY_BUFFER,e.refractionVecs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.refractionVecIndices=new Uint32Array(Array(e.refractionVecs.length/3).fill().map(((e,a)=>a))),e.RefractionVec_Index_Buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.refractionVecIndices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer);let _=(c=n.split("."))[c.length-1].toLowerCase();switch(e.refractionTexture=t.createTexture(),_){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",s&&(l=h.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refractionTexture,iURL:n}),e.video.loop=!0,e.muted||i||(i=!0,C("play audio OK?",!0,(()=>{h.textures.filter((e=>e.url==n))[0].resource.muted=!1,h.textures.filter((e=>e.url==n))[0].resource.currentTime=0,h.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE5),U(t,e.video,e.refractionTexture,e.textureMode,-1,e),h.textures.push({url:n,resource:e.video,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";r=new Image;o.datasets.push({texture:e.refractionTexture,iURL:n}),t.activeTexture(t.TEXTURE5),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractionlections),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),r.onload=()=>{U(t,r,e.refractionTexture,e.textureMode,-1,e)},h.textures.push({url:n,resource:r,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE5),t.uniform1i(e.locRefractionTexture,5),c.locRefractionlVec=t.getAttribLocation(c.program,"nVecRefraction"),t.vertexAttribPointer(c.locRefractionVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locRefractionVec),e.locRefractionOmitEquirectangular=t.getUniformLocation(c.program,"refractionOmitEquirectangular"),t.uniform1f(e.locRefractionOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefractionFlipRefs=t.getUniformLocation(c.program,"refractionFlipRefs"),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractions),e.locRefractionTexture=t.getUniformLocation(c.program,"refractionMap"),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),t.uniform1i(e.locRefractionTexture,5),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,e.refractionTexture);break;case"phong":e.locPhongTheta=t.getUniformLocation(c.program,e.theta),t.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=t.getUniformLocation(c.program,e.flatShadingUniform),t.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=t.getUniformLocation(c.program,e.name),"uniform4f"==e.dataType?t[e.dataType](e.loc,...e.value):t[e.dataType](e.loc,e.value)})),c.locColor=t.getUniformLocation(c.program,"color"),t.uniform3f(c.locColor,..._e(a.color)),("particles"==a.shapeType||a.isParticle||"lines"==a.shapeType||a.isLine)&&(c.locPointSize=t.getUniformLocation(c.program,"pointSize"),t.uniform1f(c.locPointSize,a.size)),c.locColorMix=t.getUniformLocation(c.program,"colorMix"),t.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=t.getUniformLocation(c.program,"isSprite"),t.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=t.getUniformLocation(c.program,"cameraMode"),t.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=t.getUniformLocation(c.program,"supplementalTextureMix"),t.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locFog=t.getUniformLocation(c.program,"fog"),c.locFogColor=t.getUniformLocation(c.program,"fogColor"),c.locIsLight=t.getUniformLocation(c.program,"isLight"),t.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=t.getUniformLocation(c.program,"isParticle"),t.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locIsLine=t.getUniformLocation(c.program,"isLine"),t.uniform1f(c.locIsLine,a.isLine?1:0),c.locPenumbraPass=t.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=t.getUniformLocation(c.program,"alpha"),t.uniform1f(c.locAlpha,a.alpha),c.locPointLights=t.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=t.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=t.getUniformLocation(c.program,"pointLightCount"),t.uniform1i(c.locPointLightCount,0),c.locResolution=t.getUniformLocation(c.program,"resolution"),t.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=t.getUniformLocation(c.program,"equirectangular"),t.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=t.getUniformLocation(c.program,"t"),t.uniform1f(c.locT,0),c.locAmbientLight=t.getUniformLocation(c.program,"ambientLight"),t.uniform1f(c.locAmbientLight,e.ambientLight),c.locRotationMode=t.getUniformLocation(c.program,"rotationMode"),t.uniform1i(c.locRotationMode,a.rotationMode),c.texture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),c.locTexture=t.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=t.createTexture(),c.locHeightMap=t.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=t.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=t.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=t.getUniformLocation(c.program,"heightMapIntensity"),c.locMaxHeightmap=t.getUniformLocation(c.program,"maxHeightmap"),t.activeTexture(t.TEXTURE0)),c.supplementalTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=t.getUniformLocation(c.program,"supplementalTexture"),f)if(ye(f))a.textureMode="dataArray",a.mapIsDataArray=!0,U(t,"",c.texture,a.textureMode,0,a);else{let e;switch(c.iURL=f,(e=f.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",s&&(l=h.textures.filter((e=>e.url==c.iURL))).length?(console.log("found video in cache... using it"),c.resource=l[0].resource,c.texture=l[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",(()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed})),c.resource.loop=!0,a.muted||i||(i=!0,C("play audio OK?",!0,(()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()}))),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},h.textures.push({url:f,resource:c.resource,texture:c.texture}),fetch(f).then((e=>e.blob())).then((e=>{c.resource.src=URL.createObjectURL(e)})));break;default:a.textureMode="image";var g=new Image;a.image=g,h.textures.push({url:f,resource:g,texture:c.texture}),g.onload=async()=>{t.activeTexture(t.TEXTURE0),U(t,g,c.texture,a.textureMode,-1,{map:f})},fetch(f).then((e=>e.blob())).then((e=>{g.src=URL.createObjectURL(e)}))}}if(t.useProgram(c.program),t.activeTexture(t.TEXTURE0),t.uniform1i(c.locTexture,0),t.bindTexture(t.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=m;else if(m)if(ye(m))a.heightTextureMode="heightmapDataArray",a.heightmapIsDataArray=!0,U(t,"",c.texture,a.heightTextureMode,0,{map:m});else{let e;switch(c.heightMapURL=m,(e=m.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",s&&(l=h.textures.filter((e=>e.url==c.heightMapURL))).length?(console.log("found video in cache... using it"),c.heightResource=l[0].resource,c.heightTexture=l[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",(()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed})),c.heightResource.loop=!0,a.muted||i||(i=!0,C("play audio OK?",!0,(()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()}))),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},h.textures.push({url:m,resource:c.heightResource,texture:c.heightTexture}),fetch(m).then((e=>e.blob())).then((e=>{c.heightResource.src=URL.createObjectURL(e)})));break;default:a.heightTextureMode="heightImage";var v=new Image;c.heightResource=v,h.textures.push({url:m,resource:v,texture:c.heightTexture}),v.onload=async()=>{t.useProgram(c.program),t.activeTexture(t.TEXTURE4),t.uniform1i(c.locHeightMap,4),U(t,v,c.heightTexture,a.heightTextureMode,-1,{heightMapURL:m}),t.activeTexture(t.TEXTURE0)},fetch(m).then((e=>e.blob())).then((e=>{v.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),c.locCamPos=t.getUniformLocation(c.program,"camPos"),c.locCamOri=t.getUniformLocation(c.program,"camOri"),c.locGeoPos=t.getUniformLocation(c.program,"geoPos"),c.locGeoOri=t.getUniformLocation(c.program,"geoOri"),c.locFov=t.getUniformLocation(c.program,"fov"),c.locRenderNormals=t.getUniformLocation(c.program,"renderNormals"),t.uniform3f(c.locCamPos,e.x,e.y,e.z),t.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),t.uniform3f(c.locGeoPos,e.x,e.y,e.z),t.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),t.uniform1f(c.locFov,e.fov),t.uniform1f(c.locRenderNormals,0)}}else{var y=t.getProgramInfoLog(c.program),b=t.getShaderInfoLog(p),x=t.getShaderInfoLog(u);console.error(`bad shader :( ${y}`),console.error(`vShader info : ${b}`,o.vert),console.error(`fShader info : ${x}`,o.frag)}}}return o},D=e=>{for(var a,t,n,i,s,c,l,p,h=e.shapeData,u=(Array(h.length).fill().map((e=>structuredClone(window.Coord_shpArray_memo))),0);u<e.vertices.length;u+=e.stride){var f=u/e.stride;if(h[f].mx!=h[f].x||h[f].my!=h[f].y||h[f].mz!=h[f].z||h[f].mroll!=h[f].roll||h[f].mpitch!=h[f].pitch||h[f].myaw!=h[f].yaw){a=h[f].ox,t=h[f].oy,n=h[f].oz;for(var m=0;m<e.stride;m+=3)for(var d=2;d--;){var g;i=e[g=d?"vstate":"nvstate"][u+m+0]-a*d,s=e[g][u+m+1]-t*d,c=e[g][u+m+2]-n*d,l=Math.atan2(s,c)+h[f].pitch,p=Math.hypot(s,c),s=r(l)*p,c=o(l)*p,l=Math.atan2(i,s)+h[f].roll,p=Math.hypot(i,s),i=r(l)*p,s=o(l)*p,l=Math.atan2(i,c)+h[f].yaw,p=Math.hypot(i,c),i=r(l)*p,c=o(l)*p,e[g=d?"vertices":"normalVecs"][u+m+0]=i+(a+h[f].x)*d,e[g][u+m+1]=s+(t+h[f].y)*d,e[g][u+m+2]=c+(n+h[f].z)*d,e.showNormals&&(i=e.nstate[2*(u+m)+0+3*d]-a,s=e.nstate[2*(u+m)+1+3*d]-t,c=e.nstate[2*(u+m)+2+3*d]-n,l=Math.atan2(s,c)+h[f].pitch,p=Math.hypot(s,c),s=r(l)*p,c=o(l)*p,l=Math.atan2(i,c)+h[f].yaw,p=Math.hypot(i,c),i=r(l)*p,c=o(l)*p,l=Math.atan2(i,s)+h[f].roll,p=Math.hypot(i,s),i=r(l)*p,s=o(l)*p,e.normals[2*(u+m)+0+3*d]=i+a,e.normals[2*(u+m)+1+3*d]=s+t,e.normals[2*(u+m)+2+3*d]=c+n)}h[f].mx=h[f].x,h[f].my=h[f].y,h[f].mz=h[f].z,h[f].mroll=h[f].roll,h[f].mpitch=h[f].pitch,h[f].myaw=h[f].yaw}}},Y=async(e,a,t={})=>{var r={vertices:[],normals:[],normalVecs:[],uvs:[]},o=e.vertices.length,n=e.vertices,i=e.normals,s=e.uvs,c=e.normalVecs,l=(o=e.vertices.length,[]);a.map(((e,a)=>{for(var t=e[0],o=e[1],p=e[2],h=0;h<n.length;h+=3)r.vertices.push(t+n[h+0],o+n[h+1],p+n[h+2]),i&&r.normals.push(t+i[2*h+0],o+i[2*h+1],p+i[2*h+2]),i&&r.normals.push(t+i[2*h+3],o+i[2*h+4],p+i[2*h+5]),s&&r.uvs.push(s[h/3*2+0],t+s[h/3*2+1]),c&&r.normalVecs.push(c[h+0],c[h+1],c[h+2]);l.push({ox:t,oy:o,oz:p,x:0,y:0,z:0,roll:0,pitch:0,yaw:0,mx:t,my:o,mz:p,mroll:0,mpitch:0,myaw:0})})),void 0!==t?.shapeData&&(t.shapeData.forEach(((e,a)=>{Object.keys(e).forEach(((t,r)=>{l[a][t]=e[t]}))})),delete t.shapeData);var p,h=e.shapeType,u={shapeData:l};return e.canvasTexture&&e.canvasTexture,["x","y","z","rows","cols","size","url","roll","pitch","yaw","color","colorMix","showNormals","exportShape","downloadShape","normalAssocs","equirectangular","flipNormals","textureMode","isSprite","isLight","playbackSpeed","disableDepthTest","lum","alpha","involveCache","isParticle","isLine","penumbra","wireframe","canvasTextureMix","showBounding","boundingColor","heightMap","heightMapIntensity","heightMapIsCanvas","equirectangularHeightmap","isFromZip","rotationMode","mapIsDataArray","dataArrayFormat","maxHeightmap","dataArrayWidth","dataArrayHeight","preComputeNormalAssocs","heightmapIsDataArray","heightmapDataArrayFormat","heightmapDataArrayWidth","heightmapDataArrayHeight","rebindTextures","exportAsOBJ","downloadAsOBJ","resolved","map","video","muted"].forEach((a=>{u[a]=e[a]})),u.name=e.name,Object.keys(t).forEach(((e,a)=>{u[e]=t[e]})),e.canvasTexture&&(u.canvasTexture=e.canvasTexture),u.shapeType="custom shape",u.geometryData=r,await L(e.renderer,u).then((async a=>{for(var t=0;t<a.vertices.length;t+=o)for(var r=0;r<o;r+=3){var n=(t+r)/3*2;a.uvs[n+0]=e.uvs[n%e.uvs.length+0],a.uvs[n+1]=e.uvs[n%e.uvs.length+1]}a.vstate=structuredClone(a.vertices),a.nstate=structuredClone(a.normals),a.uvs=structuredClone(a.uvs),a.nvstate=structuredClone(a.normalVecs),a.shapeType=h,a.stride=o,a.isShapeArray=!0,p=a})),p},X=async(e,a={})=>{var t=!0,r=[],o={size:1,alpha:.8,penumbra:.5,shapeType:"lines",color:16777215};Object.keys(e).forEach(((a,t)=>{switch(a.toLowerCase()){case"shapetype":default:break;case"x":case"y":case"z":case"roll":case"pitch":case"yaw":o[a]=e[a]}})),Object.keys(a).forEach(((e,r)=>{switch(e.toLowerCase()){case"shapetype":break;case"closepaths":t=a[e];break;default:o[e]=a[e]}}));const n=(e,a,t,o,n,i)=>{for(var s,c,l,p,h,u,f=!0,m=r,d=0;f&&d<m.length;d+=6)s=m[d+0],c=m[d+1],l=m[d+2],p=m[d+3],h=m[d+4],u=m[d+5],(s==e&&c==a&&l==t&&p==o&&h==n&&u==i||s==o&&c==n&&l==i&&p==e&&h==a&&u==t)&&(f=!1);return f};for(var i,s=e.vertices,c=0;c<s.length;c+=9){var l,p,h,u,f,m,d,g,v;l=-s[c+0],p=-s[c+1],h=-s[c+2],u=-s[c+3],f=-s[c+4],m=-s[c+5],d=-s[c+6],g=-s[c+7],v=-s[c+8],i=[],n(l,p,h,u,f,m)&&i.push(l,p,h,u,f,m),n(u,f,m,d,g,v)&&i.push(u,f,m,d,g,v),t&&n(d,g,v,l,p,h)&&i.push(d,g,v,l,p,h),r.push(...i)}var y=[];for(c=0;c<r.length;c+=3)y.push([r[c+0],r[c+1],r[c+2]]);o.geometryData=y;var b={shape:null};return await L(e.renderer,o).then((e=>{b.shape=e})),b},H=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},q=(e,a,t,r,o,n,i=!1,s="")=>{var c,l,p,h,u,f=[],m=[],d=e,g=[],v=`${s}_${r}`,y=H(s);if("obj"===s)u=G(0,1,o,d,a,v);else u=G(r+(y?1:0),1,o,d,a,v);for(u.map(((e,a)=>{var r=e.verts;//!flipNormals ? shape[shape.length-vidx-1].verts : v.verts
r.map((e=>{e[0]*=t,e[1]*=t,e[2]*=t})),i||4==r.length?(f.push(r[2],r[1],r[0],r[0],r[3],r[2]),void 0!==e.uvs&&e.uvs.length&&m.push(e.uvs[2],e.uvs[1],e.uvs[0],e.uvs[0],e.uvs[3],e.uvs[2])):(f.push(...r),void 0!==e.uvs&&e.uvs.length&&m.push(...e.uvs))})),l=0;l<f.length;l++){var b;p=[f[3*(c=l/3|0)+2],f[3*c+1],f[3*c+0]],l%3||(b=pe(p,!1),n&&(b[3]=b[0]-(b[0]-b[3]),b[4]=b[1]-(b[1]-b[4]),b[5]=b[2]-(b[2]-b[5]))),h=n?f.length-l-1:l,g.push({position:f[h],normal:[...f[h],f[h][0]-(b[3]-b[0]),f[h][1]-(b[4]-b[1]),f[h][2]-(b[5]-b[2])],texCoord:m[h]})}return{geometry:g}},G=(e,a,t,r,o,n="")=>{var i,s,c,l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,w,F,L,C,k,U,z,S,N,B,O,V,D,Y,X,H,q,G,W,j,$,K,Z,Q,J,ee,ae,te,re,oe,ne,ie,se,ce,le,pe,he,ue,fe,me,de,ge=!1;if(!ge)for(var ve=e;ve--;)i=r,s=o,r=[],o=[],i.map(((e,a)=>{switch(u=e[c=0][0],f=e[c][1],m=e[c][2],s.length&&s[a].length>c&&(de=s[a],F=de[c][0],L=de[c][1]),d=e[c=1][0],g=e[c][1],v=e[c][2],s.length&&s[a].length>c&&(C=de[c][0],k=de[c][1]),y=e[c=2][0],b=e[c][1],x=e[c][2],s.length&&s[a].length>c&&(U=de[c][0],z=de[c][1]),e.length>3&&(R=e[c=3][0],E=e[c][1],M=e[c][2],s.length&&s[a].length>c&&(S=de[c][0],N=de[c][1]),e.length>4&&(A=e[c=4][0],T=e[c][1],_=e[c][2],s.length&&s[a].length>c&&(B=de[c][0],O=de[c][1]),e.length>5&&(P=e[c=5][0],I=e[c][1],w=e[c][2],s.length&&s[a].length>c&&(V=de[c][0],D=de[c][1])))),Y=(u+d)/2,X=(f+g)/2,H=(m+v)/2,q=(d+y)/2,G=(g+b)/2,W=(v+x)/2,void 0!==F&&(ee=(F+C)/2,ae=(L+k)/2,te=(C+U)/2,re=(k+z)/2),he=[],ue=[],e.length){case 3:j=(y+u)/2,$=(b+f)/2,K=(x+m)/2,void 0!==F&&(oe=(U+F)/2,ne=(z+L)/2,l=F,p=L,ue.push([l,p]),l=ee,p=ae,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=C,p=k,ue.push([l,p]),l=te,p=re,ue.push([l,p]),o.push(ue),(ue=[]).push([l=oe,p=ne]),l=te,p=re,ue.push([l,p]),l=U,p=z,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=te,p=re,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue)),l=u,p=f,h=m,he.push([l,p,h]),l=Y,p=X,h=H,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),r.push(he),(he=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,he.push([l,p,h]),l=q,p=G,h=W,he.push([l,p,h]),r.push(he),(he=[]).push([l=j,p=$,h=K]),l=q,p=G,h=W,he.push([l,p,h]),l=y,p=b,h=x,he.push([l,p,h]),r.push(he),(he=[]).push([l=Y,p=X,h=H]),l=q,p=G,h=W,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),r.push(he);break;case 4:j=(y+R)/2,$=(b+E)/2,K=(x+M)/2,Z=(R+u)/2,Q=(E+f)/2,J=(M+m)/2,void 0!==F&&(oe=(U+S)/2,ne=(z+N)/2,ie=(S+F)/2,se=(N+L)/2,fe=(F+C+U+S)/4,me=(L+k+z+N)/4,l=F,p=L,ue.push([l,p]),l=ee,p=ae,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),l=ie,p=se,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ee,p=ae]),l=C,p=k,ue.push([l,p]),l=te,p=re,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=fe,p=me]),l=te,p=re,ue.push([l,p]),l=U,p=z,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),o.push(ue),(ue=[]).push([l=ie,p=se]),l=fe,p=me,ue.push([l,p]),l=oe,p=ne,ue.push([l,p]),l=S,p=N,ue.push([l,p]),o.push(ue)),ce=(u+d+y+R)/4,le=(f+g+b+E)/4,pe=(m+v+x+M)/4,l=u,p=f,h=m,he.push([l,p,h]),l=Y,p=X,h=H,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),l=Z,p=Q,h=J,he.push([l,p,h]),r.push(he),(he=[]).push([l=Y,p=X,h=H]),l=d,p=g,h=v,he.push([l,p,h]),l=q,p=G,h=W,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=ce,p=le,h=pe]),l=q,p=G,h=W,he.push([l,p,h]),l=y,p=b,h=x,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),r.push(he),(he=[]).push([l=Z,p=Q,h=J]),l=ce,p=le,h=pe,he.push([l,p,h]),l=j,p=$,h=K,he.push([l,p,h]),l=R,p=E,h=M,he.push([l,p,h]),r.push(he);break;case 5:ce=(u+d+y+R+A)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+M+_)/5,void 0!==F&&(fe=(F+C+U+S+B)/5,me=(L+k+z+N+O)/5,oe=(U+S)/2,ne=(z+N)/2,ie=(S+B)/2,se=(N+O)/2,(B+F)/2,(O+L)/2,l=F,p=L,ue.push([l,p]),l=C,p=k,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=C,p=k]),l=U,p=z,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=U,p=z]),l=S,p=N,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=S,p=N]),l=B,p=O,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=B,p=O]),l=F,p=L,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),ue=[]),j=(y+R)/2,$=(b+E)/2,K=(x+M)/2,Z=(R+A)/2,Q=(E+T)/2,J=(M+_)/2,(A+u)/2,(T+f)/2,(_+m)/2,l=u,p=f,h=m,he.push([l,p,h]),l=d,p=g,h=v,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=y,p=b,h=x]),l=R,p=E,h=M,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=R,p=E,h=M]),l=A,p=T,h=_,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=A,p=T,h=_]),l=u,p=f,h=m,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),he=[];break;case 6:ce=(u+d+y+R+A)/5,le=(f+g+b+E+T)/5,pe=(m+v+x+M+_)/5,void 0!==F&&(fe=(F+C+U+S+B+V)/6,me=(L+k+z+N+O+D)/6,oe=(U+S)/2,ne=(z+N)/2,ie=(S+B)/2,se=(N+O)/2,(B+V)/2,(O+D)/2,(V+F)/2,(D+L)/2,l=F,p=L,ue.push([l,p]),l=C,p=k,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=C,p=k]),l=U,p=z,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=U,p=z]),l=S,p=N,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=S,p=N]),l=B,p=O,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=B,p=O]),l=V,p=D,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),(ue=[]).push([l=V,p=D]),l=F,p=L,ue.push([l,p]),l=fe,p=me,ue.push([l,p]),o.push(ue),ue=[]),j=(y+R)/2,$=(b+E)/2,K=(x+M)/2,Z=(R+A)/2,Q=(E+T)/2,J=(M+_)/2,(A+P)/2,(T+I)/2,(_+w)/2,(P+u)/2,(I+f)/2,(w+m)/2,(he=[]).push([l=u,p=f,h=m]),l=d,p=g,h=v,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=d,p=g,h=v]),l=y,p=b,h=x,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=y,p=b,h=x]),l=R,p=E,h=M,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=R,p=E,h=M]),l=A,p=T,h=_,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=A,p=T,h=_]),l=P,p=I,h=w,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),(he=[]).push([l=P,p=I,h=w]),l=u,p=f,h=m,he.push([l,p,h]),l=ce,p=le,h=pe,he.push([l,p,h]),r.push(he),he=[]}}));return r.map(((e,a)=>({verts:e,uvs:o[a]})))},W=(e,a,t,r,o)=>{let i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=Array(r).fill().map((e=>(i=n()-.5,s=n()-.5,c=n()-.5,[i,s,c])));for(let e=50;e--;)x.map(((e,a)=>{i=e[0],s=e[1],c=e[2],x.map(((e,t)=>{t!=a&&(u=e[0],f=e[1],m=e[2],g=1+(Math.hypot(i-u,s-f,c-m)*(3+r/80)*3)**3,i+=9*(i-u)/g,s+=9*(s-f)/g,c+=9*(c-m)/g)})),g=Math.hypot(i,s,c),e[0]=i/g,e[1]=s/g,e[2]=c/g}));return d=6e6,x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(v=l-u,y=p-f,b=h-m),g<d&&(d=g))}))})),v=[],x.map(((e,a)=>{l=e[0],p=e[1],h=e[2],x.map(((e,t)=>{u=e[0],f=e[1],m=e[2],a!=t&&(g=Math.hypot(l-u,p-f,h-m),g<2*d&&(v.filter((e=>e[0]==u&&e[1]==f&&e[2]==m&&e[3]==l&&e[4]==p&&e[5]==h)).length||v.push([l*o,p*o,h*o,u*o,f*o,m*o])))}))})),x.map((r=>{r[0]*=o/1.3333,r[1]*=o/1.3333,r[2]*=o/1.3333,r[0]+=e,r[1]+=a,r[2]+=t})),[e,a,t,o,x,v]},j=(e=1,a=0,t,n,i=0,s=!1,c="cylinder")=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,w=[],F=[],L=0;L<t;L++)for(var C=L,k=.5,U=0;U<n;U++){l=r(2*Math.PI/n*U)*k,p=1/t*C-.5,h=o(2*Math.PI/n*U)*k,u=r(2*Math.PI/n*(U+1))*k,f=1/t*C-.5,m=o(2*Math.PI/n*(U+1))*k,d=r(2*Math.PI/n*(U+1))*k,g=1/t*(C+1)-.5,v=o(2*Math.PI/n*(U+1))*k,y=r(2*Math.PI/n*U)*k,b=1/t*(C+1)-.5,x=o(2*Math.PI/n*U)*k;var z=Math.atan2(l,h),S=Math.atan2(u,m),N=Math.atan2(d,v),B=Math.atan2(y,x);Math.abs(z-S)>Math.PI&&(z-=2*Math.PI,B-=2*Math.PI),R=(z+Math.PI)/Math.PI/2,E=p+.5,M=(S+Math.PI)/Math.PI/2,A=f+.5,T=(N+Math.PI)/Math.PI/2,_=g+.5,P=(B+Math.PI)/Math.PI/2,I=b+.5,w.push([[l,p,h],[u,f,m],[d,g,v],[y,b,x]]),F.push([[R,E],[M,A],[T,_],[P,I]])}return q(w,F,1,a,i,s,!0,c)},$=async(e=1,a=0,t=0,n=!1,i="torus",s,c)=>{for(var l,p,h,u,f,m,d,g,v,y,b,x,R,E,M,A,T,_,P,I,w,F,L,C,k=[],U=[],z=4*s,S=1/6,N=2/6,B=0;B<z;B++)for(var O=B+.5,V=0;V<c;V++){l=r(L=2*Math.PI/c*(V-1))*S+N,p=o(L)*S,0,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,C=Math.hypot(l,0),h=r(L)*C,u=p,f=o(L)*C,l=r(L=2*Math.PI/c*V)*S+N,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*O+Math.PI/2,C=Math.hypot(l,0),m=r(L)*C,d=p,g=o(L)*C,l=r(L=2*Math.PI/c*V)*S+N,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,C=Math.hypot(l,0),v=r(L)*C,y=p,b=o(L)*C,l=r(L=2*Math.PI/c*(V-1))*S+N,p=o(L)*S,L=Math.atan2(l,0)+2*Math.PI/z*(O+1)+Math.PI/2,C=Math.hypot(l,0),x=r(L)*C,R=p,E=o(L)*C;var D=Math.atan2(h,f),Y=Math.atan2(m,g),X=Math.atan2(v,b),H=Math.atan2(x,E);Math.abs(D-X)>Math.PI&&(X+=2*Math.PI,H+=2*Math.PI),M=(D+Math.PI)/Math.PI/2,A=u+.5,T=(Y+Math.PI)/Math.PI/2,_=d+.5,P=(X+Math.PI)/Math.PI/2,I=y+.5,w=(H+Math.PI)/Math.PI/2,F=R+.5,k.push([[h,u,f],[x,R,E],[v,y,b],[m,d,g]]),U.push([[M,A],[T,_],[P,I],[w,F]])}return q(k,U,e,a,t,n,!0,i)},K=async(e=1,a=0,t,n,i=0,s=!1,c="torus knot")=>{var l,p,h,u,f,m,d,g,v=[],y=[];y=[],d=[],n*=4,t*=2;for(var b=1/3,x=0;x<2*n;x++)for(var R=0;R<t+1;R++)l=1+r(f=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*x)*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+r(m),u=Math.hypot(p,h),p=r(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*x,u=Math.hypot(l,h),l=r(f)*u,h=o(f)*u,y.push([l,p,h]),l=1+r(f=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*(x+1))*b,p=o(f)/4,h=0,g=Math.atan2(p,h)+r(m),u=Math.hypot(p,h),p=r(g)*u+o(m)*b*2,h=o(g)*u,f=Math.atan2(l,h)+2*Math.PI/n*(x+1),u=Math.hypot(l,h),l=r(f)*u,h=o(f)*u,d.push([l,p,h]);y.forEach(((a,r)=>{if(r%(t+1)!=t){var o=(r+1)%y.length,n=y[r][0]*e/3.2,i=y[r][1]*e/3.2,s=y[r][2]*e/3.2,c=d[r][0]*e/3.2,l=d[r][1]*e/3.2,p=d[r][2]*e/3.2,h=d[o][0]*e/3.2,u=d[o][1]*e/3.2,f=d[o][2]*e/3.2,m=y[o][0]*e/3.2,g=y[o][1]*e/3.2,b=y[o][2]*e/3.2;v.push([[n,i,s],[c,l,p],[h,u,f],[m,g,b]])}}));var E,M,A=v,T=[];for(R=0;R<A.length;R++){y=[];for(var _=A[R].length;_--;){switch(_){case 0:E=0,M=0;break;case 1:E=1,M=0;break;case 2:E=1,M=1;break;case 3:E=0,M=.5;break;case 4:E=0,M=1}y.push([E,M])}T.push(y)}return q(v,T,1,a,i,s,!0,c)},Z=async(e=1,a=0,t=0,n=!1,i="tetrahedron")=>{var s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];y=[];let R=1/1.4142/1.75;for(g=0;g<3;g++)s=1*r(p=2*Math.PI/3*g)/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]);for(x.push(y),v=3;v--;)(y=[]).push([s=0,c=0,l=-R]),s=1*r(p=2*Math.PI/3*v)/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]),s=1*r(p=2*Math.PI/3*(v-1))/1.75,c=1*o(p)/1.75,l=R,y.push([s,c,l]),x.push(y);f=m=d=b=0,x.map((e=>{e.map((e=>{f+=e[0],m+=e[1],d+=e[2],b++}))})),f/=b,m/=b,d/=b,x.map((e=>{e.map((e=>{e[0]-=f,e[1]-=m,e[2]-=d}))}));var E=x,M=[];for(g=0;g<E.length;g++){y=[];for(var A=E[g].length;A--;){switch(A){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}y.push([h,u])}M.push(y)}return q(E,M,1,a,t,n,!1,i)},Q=async(e=1,a=0,t=0,n=!1,i="octahedron")=>{var s,c,l,p,h,u,f,m,d,g=[];for(m=8;m--;)d=[],s=0,c=0,m<4?(l=.5,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*m)/2,c=1*o(p)/2,l=0,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*(m+1))/2,c=1*o(p)/2):(l=-.5,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*m)/2,c=1*o(p)/2,l=0,d.push([s,c,l]),s=1*r(p=2*Math.PI/4*(m-1))/2,c=1*o(p)/2),l=0,d.push([s,c,l]),g.push(d);var v=g,y=[];for(f=0;f<v.length;f++){d=[];for(var b=v[f].length;b--;){switch(b){case 0:h=0,u=0;break;case 1:h=1,u=0;break;case 2:h=1,u=1;break;case 3:h=0,u=.5;break;case 4:h=0,u=1}d.push([h,u])}y.push(d)}return q(v,y,1,a,t,n,!1,i)},J=async(e=1,a=0,t=0,r=!1,o="icosahedron")=>{var n,i,s,c,l,p,h,u,f,m,d,g,v,y,b,x=[];for(u=[[-(h=.5+5**.5/2),-1,0],[h,-1,0],[h,1,0],[-h,1,0]],p=3;p--;x.push(i))for(i=[],n=4;n--;)i.push([u[n][p],u[n][(p+1)%3],u[n][(p+2)%3]]);x.map((a=>{a.map((a=>{a[0]*=1/2.25*e*.7,a[1]*=1/2.25*e*.7,a[2]*=1/2.25*e*.7}))})),f=JSON.parse(JSON.stringify(x)),l=[],u=[],[[[0,3],[1,0],[2,2]],[[1,3],[1,0],[0,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[1,0],[1,3],[0,2]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[2,1],[2,2],[1,0]],[[1,1],[2,2],[2,1]],[[0,0],[2,2],[1,1]],[[1,1],[2,1],[0,1]],[[0,1],[2,1],[0,2]],[[2,3],[1,2],[2,0]],[[2,3],[0,3],[0,0]],[[2,3],[2,0],[1,3]],[[2,3],[0,0],[1,2]],[[0,1],[2,0],[1,2]],[[1,1],[1,2],[0,0]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]]].map(((e,a)=>{m=e[0][0],d=e[1][0],g=e[2][0],v=e[0][1],y=e[1][1],b=e[2][1],u.push([f[g][b],f[d][y],f[m][v]])})),l.push(...u);var R=l,E=[];for(n=0;n<R.length;n++){u=[];for(var M=R[n].length;M--;){switch(M){case 0:s=0,c=0;break;case 1:s=1,c=0;break;case 2:s=1,c=1;break;case 3:s=0,c=.5;break;case 4:s=0,c=1}u.push([s,c])}E.push(u)}return q(R,E,1,a,t,r,!1,o)},ee=async(e=1,a=0,t=0,n=!1,i="dodecahedron")=>{var s,c,l,p,h,u,f,m,d,g,v=[],y=[];let b=-6e6;for(g=5;g--;)s=r(u=2*Math.PI/5*g+Math.PI/5),c=o(u),l=0,c>b&&(b=c),y.push([s,c,l]);y=y.map((e=>(s=e[0],c=e[1]-=b,l=e[2],R(s,c,l,{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0})))),(h=structuredClone(y)).map((e=>{var a=Math.atan2(e[0],e[1])+Math.PI,t=Math.hypot(e[0],e[1]);e[0]=r(a)*t,e[1]=o(a)*t})),v.push(y,h),b=-6e6,v.map((e=>{e.map((e=>{s=e[0],c=e[1],(l=e[2])>b&&(b=l)}))})),p=Math.hypot(v[0][0][0]-v[0][1][0],v[0][0][1]-v[0][1][1],v[0][0][2]-v[0][1][2]),v.map((e=>{e.map((e=>{e[2]-=b+p/2}))})),(h=structuredClone(v)).map((e=>{e.map((e=>{var a=Math.atan2(e[0],e[2])+Math.PI,t=Math.hypot(e[0],e[2]);e[0]=r(a)*t,e[2]=o(a)*t}))})),v.push(...h),(h=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=E(s,c,l,{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),(x=structuredClone(v)).map((e=>{e.map((e=>{s=e[0],c=e[1],l=e[2],f=E(s,c,l,{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=f[0],e[1]=f[1],e[2]=f[2]}))})),v.push(...h,...x);var x=v.map(((e,a)=>e.map(((a,t)=>{var r=t;return[e[r][0],e[r][1],e[r][2]]})))),M=[];for(g=0;g<x.length;g++){y=[];for(var A=x[g].length;A--;){switch(A){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y.push([m,d])}M.push(y)}return q(x,M,e/Math.max(1,2-t)/1.5,a,t,n,!1,i)},ae=(e=1,a=0,t=0,n=!1,i="cube")=>{var s,c,l,p,h,u,f,m,d=Math.PI,g=[];for(h=6;h--;g.push(l))for(l=[],u=4;u--;)h<3?l.push([(c=[r(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+0)%3]*(p=2**.5/2),c[(h+1)%3]*p,c[(h+2)%3]*p]):l.push([(c=[r(s=2*d/4*u+d/4),o(s),2**.5/2])[(h+2)%3]*(p=-(2**.5)/2),c[(h+1)%3]*p,c[(h+0)%3]*p]);var v=[];for(h=0;h<g.length;h++){c=[];for(var y=g[h].length;y--;){switch(y){case 0:f=0,m=0;break;case 1:f=1,m=0;break;case 2:f=1,m=1;break;case 3:f=0,m=1}c.push([f,m])}v.push(c)}return q(g,v,e,a,t,n,!0,i)},te=async(e=1,a=0,t=0,r=!1,o="rectangle")=>{Math.PI;return q([[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]]],[[[0,0],[1,0],[1,1],[0,1]]],e/1.5,Math.max("sprite"==o?0:2,a),"sprite"==o||"point light"==o?0:t,r,!0,o)},re=(e,a=0)=>!(a>300)&&(2==e||re(e/2,a+1)),oe=(e,a,t,n,i,s,c,l=!1)=>{let p,h,u,f,m,d,g,v,y,b=(e,a,t,r,o,n,i,s)=>(d=((i-o)*(a-n)-(s-n)*(e-o))/(g=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&d<=1&&(v=((t-e)*(a-n)-(r-a)*(e-o))/g)>=0&&v<=1?[e+d*(t-e),a+d*(r-a)]:0,x=(e,a,t,n)=>{let i=Math,s=i.atan2,c=i.hypot;p=r(y=s(p,h)+e)*(f=c(p,h)),h=o(y)*f,p=r(y=s(p,u)+t)*(f=c(p,u)),u=o(y)*f,h=r(y=s(h,u)+a)*(f=c(h,u)),u=o(y)*f,n&&(p+=oX,h+=oY,u+=oZ)},R=e=>{switch(e){case 0:x(0,0,Math.PI/2);break;case 1:x(0,Math.PI/2,0);break;case 2:x(Math.PI/2,0,Math.PI/2)}},E=0,M=0,A=0;c.map((e=>{E+=e[0],M+=e[1],A+=e[2]})),E/=c.length,M/=c.length,A/=c.length;let T=c[2][0]-c[1][0],_=c[2][1]-c[1][1],P=c[2][2]-c[1][2],I=c[1][0]-c[0][0],w=c[1][1]-c[0][1],F=c[1][2]-c[0][2],L=[_*F-P*w,P*I-T*F,T*w-_*I];f=Math.hypot(...L)+.001;L=L.map((e=>e/f*1));let C=E,k=M,U=A,z=1;if(l){let r=Math.hypot(C-e,k-a,U-t);z=Math.hypot(e-(E+L[0]/99),a-(M+L[1]/99),t-(A+L[2]/99))>r?-1:1}let S=E+(L[0]*=z),N=M+(L[1]*=z),B=A+(L[2]*=z),O=Math.atan2(S-C,B-U),V=-(Math.acos((N-k)/(Math.hypot(S-C,N-k,B-U)+.001))+Math.PI/2),D=!1,Y=[!1,!1,!1];p=e,h=a,u=t,x(0,-V,-O);let X=p,H=h,q=u;for(let e=3;e--;)!1===D&&(p=X,h=H,u=q,R(e),C=p,k=h,U=u=5,p=n,h=i,u=s,x(0,-V,-O),R(e),S=p,N=h,B=u,c.map(((a,t)=>{if(!1===D){let a=t;p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);let r=p,o=h;a=(t+1)%c.length,p=c[a][0],h=c[a][1],u=c[a][2],x(0,-V,-O),R(e);(m=b(C,k,S,N,r,o,p,h))&&(Y[e]=m)}})));if(3==Y.filter((e=>!1!==e)).length){let e=Y[1][0],a=Y[0][1],t=Y[0][0],r=!0;E=0,M=0,A=0,c.map(((e,a)=>{E+=e[0],M+=e[1],A+=e[2]})),E/=c.length,M/=c.length,A/=c.length,p=E,h=M,u=A,x(0,-V,-O),C=p,k=h,U=u,S=e,N=a,B=t,c.map(((e,a)=>{if(r){let e=a;p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);let t=p,o=h;e=(a+1)%c.length,p=c[e][0],h=c[e][1],u=c[e][2],x(0,-V,-O);b(C,k,S,N,t,o,p,h)&&(r=!1)}})),r&&(p=e,h=a,u=t,x(0,V,0),x(0,0,O),D=[[p,h,u],[L[0],L[1],L[2]]])}return D},ne=async(e,a)=>{var t,r=[],o=a.omitShape;(a.omitShape=!0,a.geometryData.map((async t=>{var o,n,i,s,c,l,p=t[0][0],h=t[0][1],u=t[0][2],f=t[1][0],m=t[1][1],d=t[1][2];"horizontal"!=a.alignment&&(Math.abs(f-p)>Math.abs(m-h)||"vertical"==a.alignment)?(o=p,n=(h+m)/2,i=(u+d)/2,s=f,c=(h+m)/2,l=(u+d)/2):(o=(p+f)/2,n=h,i=(u+d)/2,s=(p+f)/2,c=m,l=(u+d)/2),a.geometryData=[[p,-h,u],[o,-n,i],[s,-c,l],[f,-m,d]],await ie(e,a).then((e=>{r.push(...e.curve)}))})),o)||(a.shapeType="lines",a.geometryData=r,L(e,a).then((e=>{t=e})),r=t);return r},ie=async(e,a)=>{var t=[],r=10;void 0!==a&&Object.keys(a).forEach(((e,t)=>{if("steps"===e.toLowerCase())r=Math.floor(a[e])}));var o,n,i,s=structuredClone(a.geometryData);o=s[0][0]-(s[1][0]-s[0][0]),n=s[0][1]-(s[1][1]-s[0][1]),i=s[0][2]-(s[1][2]-s[0][2]),s[0][0]=o,s[0][1]=n,s[0][2]=i;var c=s.length-1;o=s[c][0]+(s[c][0]-s[c-1][0]),n=s[c][1]+(s[c][1]-s[c-1][1]),i=s[c][2]+(s[c][2]-s[c-1][2]),s[c][0]=o,s[c][1]=n,s[c][2]=i,s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,p=s[c][0],h=s[c][1],u=s[c][2],f=s[l][0],m=s[l][1],d=s[l][2],g=(o+p)/2,v=(n+h)/2,y=(i+u)/2,b=(p+f)/2,x=(h+m)/2,R=(u+d)/2;t.push([g,v,y]),a==s.length-3&&t.push([b,x,R]);for(var E=0;E<r+1;E++);}}));var l,p=[];return s.map(((e,a)=>{var o=e[0],n=e[1],i=e[2];if(a<s.length-2){var c=a+1,l=a+2,h=s[c][0],u=s[c][1],f=s[c][2],m=(o+h)/2,d=(n+u)/2,g=(i+f)/2,v=(h+s[l][0])/2,y=(u+s[l][1])/2,b=(f+s[l][2])/2;t.push([m,d,g]);for(var x=m,R=d,E=g,M=0;M<r+1;M++){if(M){var A=le(m+(h-m)/r*M,d+(u-d)/r*M,h+(v-h)/r*M,u+(y-u)/r*M,m+(h-m)/r*(M+1),d+(u-d)/r*(M+1),h+(v-h)/r*(M+1),u+(y-u)/r*(M+1));M<r&&(A?(p.push([x,R,E],[...A,0]),x=A[0],R=A[1],E=0):(p.push([x,R,E],[v,y,b]),x=v,R=y,E=b)),M>=r&&p.push([x,R,E],[v,y,0])}}}})),a.omitShape?{curve:p,midPoints:t,controlPoints:s}:(a.shapeType="lines",a.geometryData=p,L(e,a).then((async e=>l=e)),{curve:p,shape:l,midPoints:t,controlPoints:s})},se=(e,a)=>{let t=Math.hypot(...e)+1e-5,r=Math.hypot(...a)+1e-5;e[0]/=t,e[1]/=t,e[2]/=t,a[0]/=r,a[1]/=r,a[2]/=r;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2];return[-(-e[0]-2*a[0]*o)*t,-(-e[1]-2*a[1]*o)*t,-(-e[2]-2*a[2]*o)*t]},ce=(e,a,t)=>{var r,o,n,i,s,c,l,p=0;return t.map((e=>{e[0],e[1],p++})),p,p,r=e,o=a,1e6,1e6,p=0,t.map(((e,a)=>{n=t[l=a][0],i=t[l][1],l=(a+1)%t.length,s=t[l][0],c=t[l][1],le(r,o,1e6,1e6,n,i,s,c)&&p++})),1==p},le=(e,a,t,r,o,n,i,s)=>{var c,l,p;return(c=((i-o)*(a-n)-(s-n)*(e-o))/(l=(s-n)*(t-e)-(i-o)*(r-a)))>=0&&c<=1&&(p=((t-e)*(a-n)-(r-a)*(e-o))/l)>=0&&p<=1&&[e+c*(t-e),a+c*(r-a)]},pe=(e,a=!1,t=0,r=0,o=0)=>{var n,i,s=0,c=0,l=0;e.map((e=>{s+=e[0],c+=e[1],l+=e[2]})),s/=e.length,c/=e.length,l/=e.length;var p=e[2][0]-e[1][0],h=e[2][1]-e[1][1],u=e[2][2]-e[1][2],f=e[1][0]-e[0][0],m=e[1][1]-e[0][1],d=e[1][2]-e[0][2];n=[h*d-u*m,u*f-p*d,p*m-h*f],i=Math.hypot(...n)+1e-4;n=n.map((e=>e/i*1));var g=s,v=c,y=l,b=1;if(a){var x=Math.hypot(g-t,v-r,y-o);b=Math.hypot(t-(s+n[0]/99),r-(c+n[1]/99),o-(l+n[2]/99))>x?-1:1}return[g,v,y,s+(n[0]*=b),c+(n[1]*=b),l+(n[2]*=b)]},he=async(a,t)=>{a.grav=.01,a.mspeed=1,a.rspeed=1,a.cameraMode="fps",a.crosshairMap="",a.showCrosshair=!0,a.crosshairSize=1,a.lastInteraction=0,a.hasTraction=!0,a.focusRequiredForMouse=!0,a.flyMode=!1,a.useKeys=!0,a.crosshairSel=0,a.crosshairAlpha=.6,a.useFPSControls=!0;var n=Array(4).fill().map(((a,t)=>`${e}/resources/crosshairs/crosshair${t+1}.png`));void 0!==t&&Object.keys(t).forEach(((e,r)=>{switch(e.toLowerCase()){case"mspeed":a.mspeed=+t[e];break;case"rspeed":a.rspeed=+t[e];break;case"grav":a.grav=+t[e];break;case"crosshairsel":a.crosshairSel=+t[e];break;case"crosshairsize":a.crosshairSize=+t[e];break;case"flymode":a.flyMode=!!t[e];break;case"usekeys":a.useKeys=!!t[e];break;case"crosshairmap":a.crosshairMap=t[e];break;case"crosshairalpha":a.crosshairAlpha=+t[e];break;case"showcrosshair":a.showCrosshair=!!t[e];break;case"focusrequiredformouse":a.focusRequiredForMouse=!!t[e]}}));if(a.crosshairImages=Array(n.length).fill(),a.crosshairImages.map((async(e,t)=>{a.crosshairImages[t]={img:new Image,loaded:!1},a.crosshairImages[t].img.onload=()=>{a.crosshairImages[t].loaded=!0},await fetch(n[t]).then((e=>e.blob())).then((e=>{a.crosshairImages[t].img.src=URL.createObjectURL(e)}))})),a.crosshairMap&&(a.crosshairSel=n.length,a.crosshairImages.push({img:new Image,loaded:!1}),a.crosshairImages[a.crosshairImages.length-1].img.onload=()=>{a.crosshairImages[a.crosshairImages.length-1].loaded=!0},await fetch(a.crosshairMap).then((e=>e.blob())).then((e=>{a.crosshairImages[a.crosshairImages.length-1].img.src=URL.createObjectURL(e)}))),a.useKeys){var i=.1*a.mspeed,s=.005*a.rspeed,c=0,l=0,p=0,h=0,u=0,f=1;a.keys=Array(256).fill().map(((e,a)=>!1)),a.keyTimers=Array(256).fill(0),a.keyTimerInterval=.2,window.addEventListener("keydown",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!0,a.lastInteraction=a.t)})),window.addEventListener("keyup",(e=>{"CANVAS"==document.activeElement.nodeName&&(a.keys[e.keyCode]=!1,a.lastInteraction=a.t)})),window.addEventListener("mousedown",(e=>{(a.lastInteraction=a.t,0===e.button)&&(!0,document.querySelectorAll(".genericPopup").length||"CANVAS"!=document.activeElement.nodeName||a.c.requestPointerLock({unadjustedMovement:!0}))})),window.addEventListener("mouseup",(e=>{a.lastInteraction=a.t,0===e.button&&!1})),window.addEventListener("mousemove",(e=>{if(a.lastInteraction=a.t,document.pointerLockElement==a.c||!a.focusRequiredForMouse){var t=a.c.getBoundingClientRect();(e.pageX-t.left)/a.c.clientWidth*a.c.width,(e.pageY-t.top)/a.c.clientHeight*a.c.height,c-=e.movementX*s,l+=e.movementY*s}})),a.doKeys=async()=>{if(i=.1*a.mspeed,s=.005*a.rspeed,a.yaw+=c,a.pitch+=l,a.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,a.pitch)),c/=1.66,l/=1.66,a.x+=p,a.y+=h,a.z+=u,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&(p/=1.2,h/=1.2,u/=1.2),a.flyMode&&"CANVAS"==document.activeElement.nodeName){var e=-a.yaw+Math.PI,t=a.pitch;switch(a.mouseButton){case 1:p-=r(e)*r(t)*i*f,h+=o(t)*i*f,u-=o(e)*r(t)*i*f;break;case 2:p+=r(e)*r(t)*i*f,h-=o(t)*i*f,u+=o(e)*r(t)*i*f}}f=1,"CANVAS"==document.activeElement.nodeName&&(a.hasTraction||a.flyMode)&&a.keys.map(((e,t)=>{if(a.keys[t])switch(t){case 16:f=3;break;case 37:c+=12*s;break;case 38:l-=12*s;break;case 39:c-=12*s;break;case 40:l+=12*s;break;case 87:var n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p+=r(n)*r(m)*i*f,h-=o(m)*i*f,u+=o(n)*r(m)*i*f):(p+=r(n)*i*f,u+=o(n)*i*f);break;case 65:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=r(n)*i*f,u+=o(n)*i*f;break;case 83:n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(p-=r(n)*r(m)*i*f,h+=o(m)*i*f,u-=o(n)*r(m)*i*f):(p-=r(n)*i*f,u-=o(n)*i*f);break;case 68:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,p+=-r(n)*i*f,u+=-o(n)*i*f}}))}}},ue=(e,a)=>{const t=async()=>{Le.margin=e.margin,Le.rsz(),Le.width=e.width,Le.height=e.height,Le.c.width=e.c.width,Le.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a]();if(["alphaQueue","lineQueue","particleQueue"].forEach((a=>{if(e[a].length){var t,r=[];e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,i=a.y+e.y,s=a.z+e.z;t=R(n,i,s,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),r.push({idx:o,z:Math.hypot(e.x+t[0],e.y+t[1],e.z+t[2])})})),r.sort(((e,a)=>a.z-e.z)),e[a].map((async(t,o)=>{var n=e[a][r[o].idx].geometry,i=n.vertices,s=n.size;n.size=e[a][r[o].idx].size,n.vertices=e[a][r[o].idx].vertices,n.x=e[a][r[o].idx].x,n.y=e[a][r[o].idx].y,n.z=e[a][r[o].idx].z,n.roll=e[a][r[o].idx].roll,n.pitch=e[a][r[o].idx].pitch,n.yaw=e[a][r[o].idx].yaw;for(var c=n.penumbra,l=1+((n.isLine||n.isParticle)&&c?1:0);l--;)e.Draw(n,!0,(n.isParticle||n.isLine)&&c&&!l);n.vertices=i,n.size=s})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e[a]=[]})),e.t+=1/60,requestAnimationFrame(t),"fps"==e.cameraMode&&(e.useKeys&&e.doKeys&&await e.doKeys(),e.showCrosshair&&e.crosshairImages[e.crosshairSel].loaded)){var r=200*e.crosshairSize;Le.ctx.globalAlpha=e.crosshairAlpha,Le.ctx.drawImage(e.crosshairImages[e.crosshairSel].img,Le.width/2-r/2,Le.height/2-r/2,r,r),Le.ctx.globalAlpha=1}};window.addEventListener("load",(()=>{e.ready=!0,t()}))},fe=(e,a,t)=>me(e,a,t),me=(e,a,t)=>{let r=e/255,o=a/255,n=t/255,i=Math.min(r,o,n),s=Math.max(r,o,n),c=s,l=s-i,p=s?l/s:0,h=Math.min(e,a,t),u=Math.max(e,a,t),f=0;for(l&&(e>=a&&e>=t&&(f=(a-t)/(u-h)),a>=e&&a>=t&&(f=2+(t-e)/(u-h)),t>=a&&t>=e&&(f=4+(e-a)/(u-h))),f*=60;f<0;)f+=360;for(;f>=360;)f-=360;return[f,p,c]},de=(e,a)=>{for(var t=Array(e.length).fill(),r=0;r<e.length;r++){var o=r%e.length;switch(a){case"left":o--;break;case"right":o++}o<0&&(o=width-1);var n=o%=width;t[r]=e[n]}for(r=0;r<e.length;r++)e[r]=t[r];return t},ge=(e,a,t)=>{for(var r=Array(e.length).fill(),o=0;o<e.length;o++){var n=o%t,i=o/t|0;switch(a){case"left":n--;break;case"up":i++;break;case"right":n++;break;case"down":i--}n<0&&(n=t-1),i<0&&(i+=e.length/t|0);var s=(n%=t)+(i%=e.length/t|0)*t;r[o]=e[s]}for(o=0;o<e.length;o++)e[o]=r[o];return r},ve=(e,a,t,r)=>{for(var o=Array(e.length).fill(),n=0;n<e.length;n++){var i=n%t,s=(n/t|0)%r,c=n/t/r|0;switch(a){case"left":i--;break;case"up":s++;break;case"right":i++;break;case"down":s--;break;case"forward":c++;break;case"backward":c--}i<0&&(i=t-1),s<0&&(s+=r),c<0&&(c+=e.length/t/r|0);var l=(i%=t)+(s%=r)*t+(c%=e.length/t/r|0)*t*r;o[n]=e[l]}for(n=0;n<e.length;n++)e[n]=o[n];return o},ye=e=>void 0!==e.length&&void 0!==e.forEach,be=(e,a,t)=>xe(e,a,t),xe=(e,a,t)=>{let r=Ee(e,a,t);return Ae(...r)},Re=(e,a,t)=>Ee(e,a,t),Ee=(e,a,t)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let r,o,n,i=t*a,s=i*(1-Math.abs(e/60%2-1)),c=t-i;return e>=0&&e<60&&(r=i,o=s,n=0),e>=60&&e<120&&(r=s,o=i,n=0),e>=120&&e<180&&(r=0,o=i,n=s),e>=180&&e<240&&(r=0,o=s,n=i),e>=240&&e<300&&(r=s,o=0,n=i),e>=300&&e<360&&(r=i,o=0,n=s),[255*(r+c),255*(o+c),255*(n+c)]},Me=(e,a,t)=>Ae(e,a,t),Ae=(e,a,t)=>{let r="0123456789abcdef",o="";return o+=r[e/16|0],o+=r[e-16*(e/16|0)|0],o+=r[a/16|0],o+=r[a-16*(a/16|0)|0],o+=r[t/16|0],o+=r[t-16*(t/16|0)|0],Number("0x"+o)},Te=e=>_e(e),_e=e=>[e/256**3-(e/256**3|0),e/65536-(e/65536|0),e/256-(e/256|0)],Pe=e=>{var a=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map((t=>{a.push({name:t,val:e.getParameter(e[t])})}));var t=document.createElement("div");t.style.position="fixed",t.style.zIndex=1e5,t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.background="#0008",t.style.padding="20px",t.style.width="600px",t.style.height="350px",t.style.border="1px solid #fff4",t.style.borderRadius="5px",t.style.fontFamily="monospace",t.style.fontSize="20px",t.style.color="#fff";var r=document.createElement("div");r.style.fontSize="24px",r.style.color="#0f8c",r.innerHTML="rendering context parameters<br><br>",t.appendChild(r);var o=document.createElement("div");o.style.minWidth="100%",o.style.height="250px",o.style.background="#333",o.style.border="1px solid #fff4",o.style.overflowY="auto",o.style.wordWrap="break-word",o.style.color="#888",o.style.fontSize="10px",t.appendChild(o);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="ðŸ“‹ copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(o),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout((()=>{n.innerHTML="ðŸ“‹ copy"}),1e3)},t.appendChild(n);var i=document.createElement("button");i.onclick=()=>t.remove(),i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="close",t.appendChild(i),o.innerHTML=JSON.stringify(a),document.body.appendChild(t)},Ie=e=>{var a=Math.sin,t=Math.cos,r=t(e[0]),o=a(e[0]),n=t(e[1]),i=a(e[1]),s=t(e[2]),c=a(e[2]);return[r*n+(r*i*c-o*s)+(r*i*s+o*c),o*n+(o*i*c+r*s)+(o*i*s-r*c),-i+n*c+n*s]},we={push:async(e,a)=>{console.log("push"),e.dataArray.items.push(a)},pop:async(e,a)=>{console.log("pop")},insert:async(e,a)=>{console.log("insert")},slice:async(e,a)=>{console.log("slice")},test:(e,a,t,n,i)=>{var s,c,l,p,h,u=a.length**.5|0,f=0,m=u;u+=1,s=n/2,c=i/2;var d,g,v,y=!1;if(e.dataArray.items.length){y=!1;do{for(var b=Math.hypot(n,i),x=0;!y&&x<b;x+=1*u|0){for(var R=3;!y&&R--;)if(!y&&(p=s+r(l=2*Math.PI/3*R+f/3+16*e.t)*x-u/2|0,h=c+o(l)*x/(16/9)-u/2|0,p>=0&&p+u<n&&h>=0&&h+u<i)){var E=[[p,h],[p+u,h],[p+u,h+u],[p,h+u]];v=!1,e.dataArray.items.forEach(((e,a)=>{if(!v){var t=[[e.posx,e.posy],[e.posx+e.width,e.posy],[e.posx+e.width,e.posy+e.width],[e.posx,e.posy+e.width]];E.forEach((e=>{ce(e[0],e[1],t)&&(v=!0)})),t.forEach((e=>{ce(e[0],e[1],E)&&(v=!0)}))}})),v||y||(y=!0,d=p,g=h)}f++}}while(f<1e4&&!y)}else y=!0,d=0|s,g=0|c;e.dataArray.items.push({array:a,posx:d,posy:g,width:u}),a.forEach(((e,a)=>{var r=4*(d+a%m+(g+a/m|0)*n|0)|0;t[r+0]=0|e[0],t[r+1]=0|e[1],t[r+2]=0|e[2],t[r+3]=255}));var M=-6e6,A=-6e6,T=6e6,_=6e6;return e.dataArray.items.forEach(((e,a)=>{e.posx<T&&(T=e.posx),e.posx>M&&(M=e.posx),e.posy<_&&(_=e.posy),e.posy>A&&(A=e.posy)})),[M,A]}},Fe=e=>a.GenHash(e);var Le;(Le=await u({context:{mode:"2d",margin:0}})).c.style.background="#0000",Le.c.style.zIndex=10;var Ce,ke=document.createElement("canvas"),Ue=ke.getContext("2d",{willReadFrequently:!0});export{u as Renderer,L as LoadGeometry,V as BasicShader,m as DestroyRenderer,f as ResizeRenderer,g as DestroyShape,ue as AnimationLoop,Z as Tetrahedron,ae as Cube,Q as Octahedron,J as Icosahedron,ee as Dodecahedron,j as Cylinder,we as ShapeArray,Y as ShapeFromArray,$ as Torus,w as DownloadCustomShape,_ as LoadAnimationFromZip,P as DrawAnimation,K as TorusKnot,te as Rectangle,x as Q,R,E as R_ypr,M as R_pyr,A as R_rpy,z as ComputeNormalAssocs,S as SyncNormals,le as Intersects,ce as PointInPoly2D,oe as PointInPoly3D,X as ShapeToLines,B as ShowBounding,D as ProcessShapeArray,N as GetShaderCoord,se as Reflect,pe as Normal,ie as BSpline,Ie as Quat,ne as CurveTo,de as ShiftArray,ge as ShiftArray2D,ve as ShiftArray3D,k as ImageToPo2,b as LoadOBJ,re as IsPowerOf2,fe as RGBToHSV,be as HSVToHex,me as HSVFromRGB,xe as HexFromHSV,Re as HSVToRGB,Ee as RGBFromHSV,Me as HexFromRGB,Ae as RGBToHex,Te as RGBFromHex,_e as HexToRGB,W as GeoSphere,e as ModuleBase,he as LoadFPSControls,Le as Overlay,Fe as GenHash,ye as IsArray};